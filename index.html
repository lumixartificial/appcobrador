<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LUMIX Cobrador">
    <link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO---LUMIX-FINANZAS-REDUCIDO.png?alt=media&token=0b4c34d2-f2e3-44b3-a380-7aadfb9c0991">
    <link rel="icon" href="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO---LUMIX-FINANZAS-REDUCIDO.png?alt=media&token=0b4c34d2-f2e3-44b3-a380-7aadfb9c0991" type="image/png">
    <link rel="preload" href="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO%20WHATSAPP%20OFI.png?alt=media&token=e022ad51-a151-4812-bb3d-9be867dac891" as="image">
    <title>Painel do Cobrador</title>


     <!-- === INICIO: Meta Tags Optimizadas (Open Graph) === -->

<!-- URL Canónica (MUY IMPORTANTE) - Diles cuál es tu link oficial -->
<!-- Reemplaza esto con tu URL real cuando la tengas en producción -->
<meta property="og:url" content="https://cobrador.lumixartificial.com/">

<!-- Tipo de contenido -->
<meta property="og:type" content="website">

<!-- Título -->
<meta property="og:title" content="LUMIX Finanzas - APP Cobrador">

<!-- Descripción -->
<meta property="og:description" content="Gerencie suas finanças e operações em tempo real.">

<!-- Imagen (Tu URL) -->
<meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/Miniatura---CobradorJPG.jpg?alt=media&token=30ce7dc9-b4f7-49b5-8846-1b4f0b533b0e">

<!-- Dimensiones de la Imagen (Opcional, pero recomendado) -->
<!-- <meta property="og:image:width" content="1200"> -->
<!-- <meta property="og:image:height" content="630"> -->

<!-- Tags para Twitter (usan las de OG, pero es bueno tenerlas) -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="LUMIX Admin - Painel do Administrador">
<meta name="twitter:description" content="Gerencie sua equipe de cobradores, finanças e operações em tempo real.">
<meta name="twitter:image" content="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/Miniatura---CobradorJPG.jpg?alt=media&token=30ce7dc9-b4f7-49b5-8846-1b4f0b533b0e">

<!-- === FIN: Meta Tags === -->

    
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-green: #28a745;
            --accent-yellow: #facc15;
            --accent-orange: #fb923c;
            --accent-purple: #6f42c1;
            --accent-purple-darker: #5a349c;
            --border-color: #e9ecef;
            --danger-color: #dc3545;
        }
        body.dark-mode {
            --bg: #020617;
            --surface: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
            --danger-color: #f87171;
            --accent-yellow: #fde047;
            --accent-orange: #fdba74;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        @keyframes subtle-glow {
            0%, 100% {
                filter: drop-shadow(0 0 8px rgba(138, 43, 226, 0.7));
            }
            50% {
                filter: drop-shadow(0 0 16px rgba(57, 255, 20, 0.7));
            }
        }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen img {
            width: 150px; 
            height: 150px; 
            animation: pulse 2.5s infinite ease-in-out;
        }

        #login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            background-color: var(--bg);
        }
        .login-card {
            background-color: transparent;
            box-shadow: none;
            border: none;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-card .logo {
            display: flex;
            justify-content: center;
        }
        .login-card .logo img {
            width: 140px; 
            height: 140px; 
            margin-bottom: 30px; 
            animation: subtle-glow 5s ease-in-out infinite;
        }
        .login-card h2 {
            margin-bottom: 10px;
            font-size: 1.8em; 
            font-weight: 700;
            color: var(--text-primary);
        }
        .login-card p {
            margin-bottom: 40px;
            color: var(--text-secondary);
        }
        .login-card .form-group {
            text-align: left;
            margin-bottom: 20px;
        }
        .login-card .form-group label {
             display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary);
        }
        .login-card .form-group input { 
            width: 100%; 
            padding: 15px; 
            font-size: 1em; 
            border-radius: 8px; 
            border: 1px solid #334155; 
            background-color: #1e293b; 
            color: var(--text-primary); 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-card .form-group input:focus {
            border-color: var(--accent-purple);
            outline: none;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.3);
        }

        .login-card .btn-primary {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-purple);
            color: white;
            transition: background-color 0.2s;
        }
        .login-card .btn-primary:hover {
            background-color: var(--accent-purple-darker);
        }

        #app-container { 
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        main {
            flex-grow: 1; 
            overflow-y: auto; 
        }
        .container { padding: 20px; }
        
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; transition: background-color 0.3s, border-color 0.3s; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { height: 40px; width: 40px; object-fit: cover; }
        .logo-text { font-size: 1.2em; font-weight: 700; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .header-btn:hover { background-color: var(--bg); }
        .lang-dropdown { display: none; position: absolute; top: 40px; right: 0; background-color: var(--surface); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-color); overflow: hidden; z-index: 110; }
        .lang-dropdown button { display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; color: var(--text-primary); cursor: pointer; }
        .lang-dropdown button:hover { background-color: var(--bg); }
        .profile { display: flex; align-items: center; gap: 10px; text-align: right; }
        .profile-info { display: flex; flex-direction: column; }
        .profile-name { font-weight: 600; font-size: 0.9em; }
        .profile-role { font-size: 0.8em; color: var(--text-secondary); }
        .profile img { height: 40px; width: 40px; border-radius: 50%; border: 2px solid var(--accent-purple); object-fit: cover; }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
        .kpi-card { background-color: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        body.dark-mode .kpi-card { box-shadow: none; }
        .kpi-title { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px; }
        .kpi-value {
            font-size: 1.6em; 
            font-weight: 700;
            margin: 0;
            overflow-wrap: break-word; 
            word-break: break-all;
        }
        .kpi-value.green { color: var(--accent-green); }

        .progress-card { text-align: center; }
        .progress-circle { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        .progress-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-circle circle { fill: none; stroke-width: 10; }
        .progress-circle .bg-circle { stroke: var(--border-color); }
        .progress-circle .progress-bar { stroke: var(--accent-green); stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; font-weight: 700; }

        .kpi-grid-profile {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid var(--accent-purple); padding-bottom: 10px; }
        .client-list, .expense-list, .notification-list { display: flex; flex-direction: column; gap: 15px; }
        .client-card, .expense-card, .notification-card { background-color: var(--surface); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border-color); transition: background-color 0.2s, box-shadow 0.2s, border-color 0.3s, transform 0.2s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); cursor: pointer; }
        .client-card:hover, .expense-card:hover, .notification-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.07); }
        body.dark-mode .client-card, body.dark-mode .expense-card, body.dark-mode .notification-card { box-shadow: none; }
        .client-card:active, .expense-card:active, .notification-card:active { background-color: var(--bg); transform: translateY(0); }
        .client-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        .client-info, .expense-info, .notification-info { flex-grow: 1; }
        .client-name, .expense-category, .notification-title { font-weight: 600; margin: 0 0 5px; }
        .client-address, .expense-obs, .notification-subtitle { font-size: 0.9em; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .payment-info, .expense-value-info { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .payment-amount, .expense-amount { font-size: 1.2em; font-weight: 700; color: var(--accent-green); }
        .expense-amount { color: var(--danger-color); }
        .payment-status, .expense-date { font-size: 0.8em; padding: 3px 8px; border-radius: 10px; font-weight: 500; margin-top: 5px; }
        .status-pending { background-color: #fff3cd; color: #856404; } .status-paid { background-color: #d4edda; color: #155724; } .status-late { background-color: #f8d7da; color: #721c24; }
        .status-finished { background-color: #e0e7ff; color: #4338ca; }
        body.dark-mode .status-pending { background-color: #b98c3633; color: #f6e05e; } body.dark-mode .status-paid { background-color: #38a16933; color: #68d391; } body.dark-mode .status-late { background-color: #c5303033; color: #fc8181; }
        body.dark-mode .status-finished { background-color: #4f46e533; color: #a5b4fc; }
        
        .reputation-score { display: flex; align-items: center; gap: 4px; font-size: 0.8em; font-weight: 700; padding: 3px 8px; border-radius: 10px; margin-top: 5px; }
        .rep-perfect { background-color: rgba(40, 167, 69, 0.15); color: var(--accent-green); }
        .rep-good { background-color: rgba(251, 146, 60, 0.15); color: #b45309; }
        body.dark-mode .rep-good { color: var(--accent-orange); }
        .rep-regular { background-color: rgba(250, 204, 21, 0.15); color: #856404; }
        body.dark-mode .rep-regular { color: var(--accent-yellow); }
        .rep-bad { background-color: rgba(220, 53, 69, 0.15); color: var(--danger-color); }
        .client-card .payment-info { flex-shrink: 0; }
        .reputation-bar-container { width: 100%; background-color: var(--border-color); border-radius: 8px; height: 16px; overflow: hidden; margin-bottom: 10px; }
        .reputation-bar { height: 100%; border-radius: 8px; width: 0%; transition: width 1s ease-out, background-color 0.5s; }
        .reputation-bar.status-perfect { background-color: var(--accent-green); }
        .reputation-bar.status-good { background-color: var(--accent-orange); }
        .reputation-bar.status-regular { background-color: var(--accent-yellow); }
        .reputation-bar.status-bad { background-color: var(--danger-color); }
        .reputation-status { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .reputation-value { font-weight: 700; }
        .reputation-text { font-weight: 500; padding: 2px 8px; border-radius: 10px; }
        .reputation-text.status-perfect { color: var(--accent-green); background-color: rgba(40, 167, 69, 0.1); }
        .reputation-text.status-good { color: #b45309; background-color: rgba(251, 146, 60, 0.15); }
        body.dark-mode .reputation-text.status-good { color: var(--accent-orange); background-color: rgba(253, 186, 116, 0.1); }
        .reputation-text.status-regular { color: #856404; background-color: rgba(250, 204, 21, 0.15); }
        body.dark-mode .reputation-text.status-regular { color: var(--accent-yellow); background-color: rgba(253, 224, 71, 0.1); }
        .reputation-text.status-bad { color: var(--danger-color); background-color: rgba(220, 53, 69, 0.1); }

        .bottom-nav { position: static; flex-shrink: 0; background-color: var(--surface); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05); transition: background-color 0.3s, border-color 0.3s; z-index: 150; }
        body.dark-mode .bottom-nav { box-shadow: none; }
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
            color: var(--text-secondary); 
            text-decoration: none; 
            font-size: 0.8em; 
            padding: 5px 15px; 
            cursor: pointer; 
            position: relative; 
            /* NUEVO: Para centrar las dos líneas de texto */
            text-align: center; 
            line-height: 1.2; 
        }
        .nav-item.active { color: var(--accent-purple); }
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--surface);
            transform: scale(0);
            transition: transform 0.2s;
        }
        .notification-badge.visible { transform: scale(1); }
        .notification-card img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .notification-card { cursor: pointer; } 
        #verification-receipt-img {
            width: 100%;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--bg);
        }
        
        /* CORRECCIÓN: Z-INDEX 9999 PARA QUE SALGA SIEMPRE ENCIMA DEL MAPA */
        .modal-view { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--bg); 
            z-index: 9999; /* Prioridad Máxima */
            transform: translateX(100%); 
            transition: transform 0.3s ease-in-out; 
            display: flex; 
            flex-direction: column; 
        }
        .modal-view.active { transform: translateX(0); }

        /* --- REGLAS AÑADIDAS PARA OVERLAYS (MODALES TRANSPARENTES) --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 10000; /* Prioridad SUPERIOR (por encima de modal-view) */
            opacity: 0; 
            transition: opacity 0.2s ease-in-out; 
        }
/* --- FIN REGLAS AÑADIDAS --- */

/* --- REGLA AÑADIDA PARA MOSTRAR OVERLAY ACTIVO --- */
.modal-overlay.active { 
    display: flex; /* CAMBIA a flex para mostrar y centrar */ 
    opacity: 1; /* Lo hace visible */
}
/* --- FIN REGLA AÑADIDA --- */
        .modal-header { display: flex; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 210; flex-shrink: 0; }
        .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 0; margin-right: 15px; }
        .modal-title { font-size: 1.2em; font-weight: 600; }
        .modal-content-wrapper { flex-grow: 1; overflow-y: auto; }
        .loan-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .payment-history-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        .payment-history-details { flex-basis: 100%; }
        .payment-history-title { font-weight: 600; font-size: 1em; margin: 0 0 4px; }
        .payment-history-description { font-size: 0.9em; color: var(--text-secondary); margin: 0; }
        .payment-history-info { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .payment-date { color: var(--text-secondary); font-size: 0.9em; }
        .payment-history-amount { font-weight: 600; color: var(--accent-green); }
        .no-history, .no-items { color: var(--text-secondary); text-align: center; padding: 20px; }
        
        /* Contenedor principal de las pestañas */


    .loan-tabs-wrapper {
            background-color: var(--surface);
            border-bottom: 1px solid var(--border-color);
            /* El padding horizontal (20px) se aplica aquí, en el marco */
            padding: 0 20px; 
        }



        .loan-tabs-container {
            display: flex;
            gap: 8px;
            
            /* El padding y el fondo se movieron al .loan-tabs-wrapper */
            /* padding: 12px 0; */ /* <-- ELIMINADO */
            padding: 12px 0; /* <-- [CORRECCIÓN] Dejamos el padding vertical */
            /* background-color: var(--surface); */ /* <-- ELIMINADO */
            /* border-bottom: 1px solid var(--border-color); */ /* <-- ELIMINADO */

            overflow-x: auto; /* Permite scroll horizontal */
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }


        


/* Oculta la barra de scroll en Chrome/Safari/Opera */
.loan-tabs-container::-webkit-scrollbar {
    display: none;
}

/* Estilo base de cada pestaña */

                .loan-tab {
                    padding: 10px 20px; 
                    border: 2px solid transparent; 
                    background-color: var(--bg); 
                    color: var(--text-secondary); 
                    border-radius: 20px; 
                    font-weight: 600; 
                    font-size: 0.9em; 
                    cursor: pointer;
                    white-space: nowrap; 
                    transition: background-color 0.2s, color 0.2s, border-color 0.2s; 
                    
                    /* --- INICIO DE LA NUEVA CORRECCIÓN --- */
                    flex-shrink: 0; /* <-- CORRECCIÓN: Añadir de nuevo */
                    display: flex; /* <-- CORRECCIÓN: Volver a flex */
                    
                    /* CORRECCIÓN: Eliminar las propiedades de inline-flex */
                    /* margin-right: 8px; */
                    /* vertical-align: top; */
                    /* display: inline-flex; */
                    /* --- FIN DE LA NUEVA CORRECCIÓN --- */
                    
                    align-items: center; /* (Sigue funcionando gracias a flex) */
                    justify-content: center; /* (Sigue funcionando gracias a flex) */
                }



/* Estilo de la pestaña activa */
.loan-tab.active {
    background-color: var(--accent-purple); /* Color de fondo activo */
    color: white; /* Texto blanco */
    border-color: var(--accent-purple); /* Borde del mismo color */
    font-weight: 700; /* Texto más grueso para la activa */
}

/* Estilo hover para pestañas inactivas */
.loan-tab:not(.active):hover {
    background-color: var(--border-color); /* Ligero cambio de fondo al pasar el mouse */
    color: var(--text-primary);
}

        .action-buttons {
    background-color: var(--surface);
    border-top: 1px solid var(--border-color);
    padding: 15px 20px;
    padding-bottom: calc(15px + env(safe-area-inset-bottom));
    display: flex;
    gap: 10px;
    margin-top: auto;
    position: sticky;
    bottom: 0;
    flex-shrink: 0;
    flex-wrap: wrap;
}
.action-buttons button, .action-buttons a {
    flex-grow: 1;
    flex-basis: 160px;
    padding: 15px;
    font-size: 1em;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
    text-decoration: none;
}

        .btn-primary { background-color: var(--accent-purple); color: white; }
        .btn-secondary { background-color: transparent; color: var(--accent-purple); border: 2px solid var(--accent-purple); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .action-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .action-buttons button:active { transform: translateY(0); }
        .btn-primary:hover { background-color: var(--accent-purple-darker); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group input[readonly] { background-color: var(--bg); opacity: 0.7; }
        .radio-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .radio-group label, .day-selector label { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; background-color: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; cursor: pointer; text-align: center; }
        .radio-group input, .day-selector input { display: none; }
        .radio-group input:checked + label, .day-selector input:checked + label { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        .radio-group input:checked + label .icon { color: white !important; }
        .day-selector { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 20px; }
        .day-selector label { padding: 10px; flex-grow: 1; font-weight: 600; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--accent-purple); color: white; border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 160; transition: transform 0.2s, opacity 0.3s; }
        .fab:hover { transform: scale(1.1); }
        .fab.hidden { transform: scale(0.5); opacity: 0; pointer-events: none; }
        
        #doc-preview-container .preview-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg); padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; }
        .document-list-item a { color: var(--accent-purple); text-decoration: none; font-weight: 500; }
        .view { display: none; }
        .view.active { display: block; }
        .search-bar-wrapper { position: relative; margin-bottom: 20px; }
        .search-bar-wrapper input { width: 100%; padding: 12px 12px 12px 40px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .search-bar-wrapper .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .filter-buttons::-webkit-scrollbar { display: none; } /* Oculta scrollbar en webkit */
        .filter-buttons.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); } /* For expense categories */
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-secondary); border-radius: 20px; font-weight: 500; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        
        #map-view.view.active {
            display: flex; 
            height: 100%;
        }
        #map-container {
            flex-grow: 1; 
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-size: 1em; }
        .popup-client-name { font-weight: 600; margin-bottom: 5px; }
        .popup-client-amount { color: var(--accent-green); font-weight: 700; margin-bottom: 10px; }
        .popup-navigate-btn { width: 100%; padding: 10px; font-size: 0.9em; }
        
        .settings-item { display: flex; align-items: center; gap: 15px; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 500; text-decoration: none; color: var(--text-primary); }
        .settings-item:active { background-color: var(--bg); }
        .settings-item i { color: var(--text-secondary); }
        .settings-item.logout { color: var(--danger-color); }
        .settings-item.logout i { color: var(--danger-color); }
        .profile-pic-wrapper { position: relative; cursor: pointer; }
        .profile-pic-wrapper::after { content: '✎'; position: absolute; bottom: 5px; right: 5px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .profile-pic-wrapper img.loading { opacity: 0.5; }
        #profile-view-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-purple); object-fit: cover; }
        #cropper-container { height: calc(100% - 150px); }
        #cropper-container img { max-width: 100%; height: auto; }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20000; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-error { background-color: var(--danger-color); }
        .toast.toast-success { background-color: var(--accent-green); }

        #confirmationModal.modal-view {
            background-color: rgba(10, 14, 26, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            padding: 20px;
            transform: none; /* Override the slide-in */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        #confirmationModal.modal-view.active {
            transform: none;
            opacity: 1;
            pointer-events: auto;
        }
        .confirmation-dialog {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 25px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }
        #confirmationModal.active .confirmation-dialog {
            transform: scale(1);
        }
        .confirmation-dialog h3 { margin: 0 0 10px; font-size: 1.3em; }
        .confirmation-dialog p { margin: 0 0 25px; color: var(--text-secondary); line-height: 1.5; }
        .confirmation-buttons { display: flex; gap: 10px; }
        .confirmation-buttons button { flex-grow: 1; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .form-group .grid-2 {
                grid-template-columns: 1fr; /* Apila los campos del formulario */
            }
            .profile-info {
                display: none; /* Oculta nombre y rol en cabecera muy pequeña */
            }
            .day-selector label {
                padding: 8px;
                font-size: 0.8em;
            }
            .login-card {
                padding: 20px;
            }
        }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .switch label { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 34px; }
        
        .switch label:before {
            position: absolute;
            content: "";
            height: 18px; /* O círculo (bola) */
            width: 18px;  /* O círculo (bola) */
            left: 4px;    /* Posição horizontal inicial */
            top: 50%;     /* Põe o TOPO do círculo no meio */
            background-color: white;
            transition: .4s; /* Transição para todas as propriedades (incluindo transform) */
            border-radius: 50%;
            transform: translateY(-50%); /* Move o círculo para CIMA 50% da SUA altura */
        }
        .switch input:checked + label { background-color: var(--accent-purple); }
        .switch input:checked + label:before {
            /* Agora combinamos os dois transforms: mover para o lado E manter centrado */
            transform: translateX(18px) translateY(-50%); 
        }

        .leaflet-marker-icon.next-client-marker {
            background: none;
            border: none;
        }
        .next-client-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: var(--accent-purple);
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            animation: pulse-purple 2s infinite;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .next-client-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        @keyframes pulse-purple {
            0% {
                transform: rotate(-45deg) scale(0.95);
                box-shadow: 0 0 0 0 rgba(111, 66, 193, 0.7);
            }
            70% {
                transform: rotate(-45deg) scale(1);
                box-shadow: 0 0 0 10px rgba(111, 66, 193, 0);
            }
            100% {
                transform: rotate(-45deg) scale(0.95);
                box-shadow: 0 0 0 0 rgba(111, 66, 193, 0);
            }
        }
        .collector-marker-icon {
            background: none;
            border: none;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    
    <div id="install-banner" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 380px; background-color: var(--surface); color: var(--text-primary); padding: 25px; border-radius: 16px; z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid var(--border-color); text-align: center;">

    <button id="close-install-banner" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; line-height: 1; padding: 0;">&times;</button>

    <img src="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO---LUMIX-FINANZAS-REDUCIDO.png?alt=media&token=0b4c34d2-f2e3-44b3-a380-7aadfb9c0991" alt="App Icon" style="width: 64px; height: 64px; margin-bottom: 15px;">

    <h3 style="margin: 0 0 8px; font-size: 1.2em; font-weight: 600;" data-lang-key="installAppTitle">Instale nosso aplicativo</h3>

    <p style="margin: 0 0 25px; font-size: 0.9em; color: var(--text-secondary); line-height: 1.5;" data-lang-key="installAppMsg">Uma experiência mais rápida e completa.</p>

    <button id="install-btn" style="background-color: var(--accent-purple); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1em;" data-lang-key="installBtn">Instalar</button>

</div>

    <div id="splash-screen">
        <img id="splash-logo" src="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO---LUMIX-FINANZAS-REDUCIDO.png?alt=media&token=0b4c34d2-f2e3-44b3-a380-7aadfb9c0991" alt="Logo">
    </div>

    <div id="login-view">
        <div class="login-card">
            <div class="logo">
                <img id="login-logo" src="https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO---LUMIX-FINANZAS-REDUCIDO.png?alt=media&token=0b4c34d2-f2e3-44b3-a380-7aadfb9c0991" alt="Logo">
            </div>
            <h2>Bem-vindo, Cobrador!</h2>
            <p>Faça login para acessar seu painel.</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <!-- El contenido principal se genera con JS -->
    </div>

    <div id="clientDetailView" class="modal-view"></div>

    <!-- El Header ahora existe permanentemente -->
    <header class="modal-header" style="justify-content: space-between;">
        <!-- El contenido del header (botones, título) será inyectado por JS aquí -->
        <div id="detail-header-content" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <!-- El JS pondrá el botón de volver, título y botones de acción (WA, Editar) aquí -->
        </div>
    </header>
    
    <!-- El contenedor de Pestañas será llenado por JS -->
    <div id="detail-loan-tabs-wrapper"></div>

    <!-- El Content Wrapper es estático, pero su contenido (scrollable) es dinámico -->
    <div class="modal-content-wrapper" id="detail-content-area">
        <!-- El JS llenará esto con los KPIs, historial, etc. -->
    </div>
    
    <!-- El Action Bar es estático, pero sus botones son dinámicos -->
    <div class="action-buttons" id="detail-action-area">
        <!-- El JS llenará esto con los botones (Pagar, Aplazar, etc.) -->
    </div>

</div>
<!-- [FIN DE LA MODIFICACIÓN ESTRUCTURAL] -->


    <div id="paymentModal" class="modal-view"></div>
    <div id="clientFormModal" class="modal-view"></div>
    <div id="expenseFormModal" class="modal-view"></div>
    <div id="reportOptionsModal" class="modal-overlay"></div>
    <div id="cropperModal" class="modal-view"></div>
    <div id="shareCredentialsModal" class="modal-view"></div>
    <div id="locationPermissionModal" class="modal-view" style="--bg: rgba(10, 14, 26, 0.8); backdrop-filter: blur(5px); z-index: 9999;"></div>
    <div id="paymentSettingsModal" class="modal-view"></div>
    <div id="refinanceModal" class="modal-view"></div>
    <div id="paymentDetailModal" class="modal-view"></div>
    <div id="confirmationModal" class="modal-view"></div>
    <div id="mapPinModal" class="modal-view"></div>
    <div id="settlementFormModal" class="modal-view"></div>
    <div id="refinanceModal" class="modal-view"></div>
    <div id="verificationModal" class="modal-view"></div>
    <div id="toast-container"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, arrayUnion, addDoc, setDoc, query, where, serverTimestamp, getDocs, enableIndexedDbPersistence, deleteDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
            authDomain: "lumix-financas-app.firebaseapp.com",
            projectId: "lumix-financas-app",
            storageBucket: "lumix-financas-app.firebasestorage.app",
            messagingSenderId: "463777495321",
            // [CORRECCIÓN CRÍTICA] Se ha corregido el appId para que coincida con el del Service Worker y el de la app del cliente.
            appId: "1:463777495321:web:106118f53f56abd206ed88"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        // --- INICIO CÓDIGO PARA HABILITAR MODO OFFLINE ---
try {
    enableIndexedDbPersistence(db)
        .then(() => {
            console.log("Persistencia offline de Firestore HABILITADA.");
        })
        .catch((err) => {
            if (err.code == 'failed-precondition') {
                // Posiblemente múltiples pestañas abiertas, eso desactiva la persistencia.
                console.warn("Falha ao habilitar persistencia offline: Múltiplas abas abertas?");
            } else if (err.code == 'unimplemented') {
                // Navegador no compatible (muy raro hoy en día).
                console.error("Falha ao habilitar persistencia offline: Navegador não suportado.");
            } else {
                console.error("Erro desconhecido ao habilitar persistencia offline:", err);
            }
        });
} catch (e) {
     console.error("Erro geral ao tentar habilitar persistencia:", e);
}
// --- FIN CÓDIGO PARA HABILITAR MODO OFFLINE ---

        // Función simplificada para desactivar notificaciones y evitar errores
        async function setupFCM(collectorId, swRegistration) {
            // Lógica de notificaciones desactivada intencionalmente.
            // Esto evita el error "Falha ao configurar as notificações push".
            console.log("FCM setup ignorado: Notificaciones desactivadas por código.");
            return;
        }
        
        
        const DEFAULT_LOGO_URL = "https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO---LUMIX-FINANZAS-REDUCIDO.png?alt=media&token=0b4c34d2-f2e3-44b3-a380-7aadfb9c0991";
        const LOGO_BASE64_JPG = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAOEAcIDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigA"

        let allClients = [];
        let currentDetailClientId = null; // Guarda el ID del cliente en vista detallada
        let currentDetailLoanIndex = null; // Guarda el índice del préstamo en vista detallada
        let allExpenses = [];
        let allSettlements = [];
        let allCapitalInjections = []; // <-- AÑADE ESTA LÍNEA
        let currentCapitalOnHand = 0;    // <-- AÑADE ESTA LÍNEA
        let currentCollectorData = null;
        
        // --- INICIO: LISTA NEGRA (NUEVA FUNCIÓN) ---
// ¡Por favor, rellena esta lista con tus datos!
const BLACKLIST_DATA = {
    // Añade números de documento (normalizados, sin puntos ni guiones)
    documentos: [
        "03061865195", "90929799534", "43091675866", "56573219104", "85567698100", "04924017132", "99363585115", "93478577187", "02511430150", "04147652140", "77961749187", "84325844104", "05615695170", "98281453168", "04941261160", "01411143396", "70139947159", "06162154106", "02150989352", "81141351153", "73347043120", "93707029115", "01202226124", "8820730178", "01311279423", "62059300215", "04873719176", "12172845833", "02766460373", "05602861122", "014475444102", "00811278557", "70219410135", "40925839825", "70219410135", "70219410135", "05467798162", "22214939822", "00333065166", "01012027171", "01849813108", "56537310130", "03054122131", "29088704287", "02958030105", "010160516010", "70518224112", "01065774508", "06899066173", "020040171", "1621284875", "04488063128", "77388747168", "07265531159", "03378174137", "01125760281", "01564017117", "02430297132", "00231706111", "73677094100", "03972110154", "03411326166", "03382926164", "86654233115", "54250544249", "03394722356" 
    ],
    // Añade nombres (en minúsculas para una comparación fácil)
    nomes: [
        "renner vinicius Pedrosa Araujo", "marcos pecinatti", "ana caroline souza oda", "Nilton días machado", "Alessandra maria dos santos moura", "marco Aurelio Gomes luz", "Claudio Dione da silva", "Rafael carossi Barbosa", "ozeias Barbosa pereira", "nilzete gama da costa", "divino Pereira da silva", "carlos jose da silva goncalves", "tainy costa couto", "luciene maria do couto", "Sergio Rufino da silva", "ana Amelia silva", "ana carolyna de freitas silva", "vinicios Alves días", "Antonio da cruz Sousa leite Barbosa", "fabio junior augusto de jesus", "Gabriel santos alchuffi", "ana maria barbosa", "edileidi matias gocalves", "pedro Goncalves canedo", "luiz carlos da silva", "ronie clei gouveia do nascimiento", "tulio nunes da silva", "cleber de Oliveira castro", "elson Pereira de arruda", "Gabriel fernandes", "thiago henrique santa barros", "Nelson dos santos carvalho", "weslaine de Olinda da silva", "deivid dinapoli Fernando tosto", "weslaine de Olinda da silva", "ana carolina Sousa da silva", "ana karolina Sousa da silva", "thiago leocaido dos santos", "Anderson Pereira Alves", "Elder Oliveira da silva", "alex de paula Carvalho", "leonildo rodrigues vitorino", "fabrizio amaral porto", "moema lina povoa", "jose cileno de sousa", "charleston toledo da silsa", "paulo henrrique nogueira", "arthur miguel nieves alecrim", "adilson de sousa joaquim", "datila sabrina lopes da silva espindola", "liniker ferreira da silva", "maione galdino dos santos", "dywlia samara albino da silva soares", "roberta santos galvao", "yasmim cristina de santana bueno de souza", "tatiane correa nascimento", "francisca eliane holanda de souza", "wuardensom arrais da luz", "santiago blanco nunez", "florisvaldo junio de moura", "rogerio macedo campos", "jesse da silva vieira", "patricia raimunda barbosa", "robsom dooglas pereira dos santos", "elenildo barbosa pinheiro", "dhon alacy carvalho da conceicao", "elenilda lima custodio cajado"
    ]
};
// --- FIN: LISTA NEGRA ---



        
        
        
        
        let currentLang = localStorage.getItem('language') || 'pt';
        // === PEGA ESTE BLOQUE COMPLETO DEBAJO DE let currentLang ===
        const translations = {
            pt: { 
                noClientsFound: 'Nenhum cliente encontrado.', 
                biweekly: 'QUINZENAL', registerOutflow: 'Registrar Nova Saída', addExpenseOption: 'Adicionar Gasto', expenseOptionDesc: 'Registrar combustível, alimentação, etc.', cashWithdrawal: 'Retirada de Caixa', withdrawalOptionDesc: 'Enviar dinheiro entregue ao admin.', amountDeliveredAdmin: 'Valor entregue ao Admin:', sendForApproval: 'Enviar para Aprovação',
                postponePayment: 'Adiar Pagamento', postponeConfirmTitle: 'Confirmar Adiamento', postponeConfirmMsg: 'Isso moverá a data de vencimento do cliente em um dia útil, sem gerar atraso. Deseja continuar?', confirm: 'Confirmar', paymentApproved: 'Pagamento aprovado com sucesso!', paymentRejected: 'Pagamento rejeitado.', approve: 'Aprobar', reject: 'Rejeitar', paymentReceipt: 'Comprovante de Pagamento', sentAmount: 'Valor Enviado', paymentVerification: 'Verificação de Pagamento', reputation: 'Reputação', reputationScore: 'Pontuação de Reputação', reputationPerfect: 'Excelente', reputationGood: 'Bom', reputationRegular: 'Regular', reputationBad: 'Ruim', reputationInfo: 'Mantenha seus pagamentos em dia para uma boa reputação.', collector: 'Cobrador', dailyGoal: 'Meta Diária', receivedToday: 'Recebido Hoje', clientsRemaining: 'Clientes Restantes', 
                todaysRoute: 'Rota de Cobrança (Ativos)', 
                navHome: 'Rota', 
                navClients: 'Clientes', navMap: 'Mapa', navProfile: 'Perfil', pending: 'Pendente', paid: 'Pago', late: 'Atrasado', addNewClient: 'Adicionar Novo Cliente', clientName: 'Nome do Cliente', address: 'Endereço', totalLoan: 'Valor do Empréstimo', installmentValue: 'Valor da Parcela', numInstallments: 'Número de Parcelas', paymentDays: 'Dias de Pagamento', saveClient: 'Salvar Cliente', city: 'Cidade', location: 'Localização GPS', interest: 'Juros (%)', totalToPay: 'Valor Total a Pagar', clientDocs: 'Documentos do Cliente (Opcional)', takePhoto: 'Tirar Foto', uploadFile: 'Carregar Arquivo', attachedDocs: 'Documentos Anexados', editClient: 'Editar Cliente', saveChanges: 'Salvar Alterações', startRoute: 'IR', searchClient: 'Buscar cliente...', all: 'Todos', navigate: 'Navegar', capitalTotal: 'Capital em Mãos', dailyTotal: 'Total do Dia', weeklyTotal: 'Total da Semana', monthlyTotal: 'Total do Mês', accountSettings: 'Configurações da Conta', changePassword: 'Mudar Senha', exportReport: 'Exportar Relatório Diário (PDF)', logout: 'Sair da Conta', reportTitle: 'Relatório Diário de Cobrança', reportDate: 'Data', reportCollector: 'Cobrador', reportTotalCollected: 'Total Arrecadado', reportNumPayments: 'Nº de Pagamentos', reportClient: 'Cliente', reportAmount: 'Valor', reportTime: 'Hora', noPaymentsToday: 'Nenhum pagamento registrado hoje.', cropImage: 'Recortar Imagem', confirmCrop: 'Confirmar Recorte', cancel: 'Cancelar', 
                
                navExpenses: 'Gastos<br>Retiradas', 

                myExpenses: 'Meus Gastos', addExpense: 'Adicionar Gasto', expenseType: 'Tipo de Gasto', expenseValue: 'Valor do Gasto', observations: 'Observações (Opcional)', uploadReceipt: 'Anexar Recibo (Opcional)', saveExpense: 'Salvar Gasto', fuel: 'Combustível', food: 'Alimentação', rent: 'Aluguel', mechanics: 'Mecânica', other: 'Outros', filterPeriod: 'Filtrar por Período', filterCategory: 'Filtrar por Categoria', today: 'Hoje', thisWeek: 'Esta Semana', thisMonth: 'Este Mes', fromBeginning: 'Desde o Início', reportTotalExpenses: 'Total de Gastos', reportNetBalance: 'Saldo Líquido', clientAccess: 'Acesso do Cliente', username: 'Usuário', password: 'Senha', usernameTaken: 'Este nome de usuário já existe.', usernameAvailable: 'Nome de usuário disponível.', usernameRequired: 'O nome de usuário é obrigatório.', whatsapp: 'WhatsApp', shareOnWhatsApp: 'Compartilhar no WhatsApp', clientRegisteredSuccess: 'Cliente Registrado com Sucesso!', clientUpdatedSuccess: 'Cliente Atualizado com Sucesso!', accessData: 'Dados de Acesso', appInstructions: 'Use estes dados para acessar o app do cliente:', appLink: 'Link do App', whatsappMessageTemplate: `Olá {clientName}! 👋 Seu acesso ao nosso app foi criado com sucesso.\n\n*LINK DO APP*\n{appLink}\n\n*EMAIL*\n{email}\n\n*SENHA*\n{password}`, navNotifications: 'Notificações', paymentSent: 'enviou um pagamento de', pleaseVerify: 'Por favor, verifique.', noNotifications: 'Nenhuma notificação pendente.', refinanceRequested: 'solicitou um refinanciamiento de', reviewRequest: 'Revisar solicitação.', installAppMsg: 'Instale o app para uma melhor experiência!', installBtn: 'Instalar', receivedInCash: 'Recebido em Dinheiro', receivedInDigital: 'Recebido em PIX/Cartão', finished: 'Finalizado', createNewLoan: 'Criar Novo Empréstimo', updateClientData: 'Atualizar Dados', paymentFrequency: 'Forma de Pagamento', daily: 'Diario', weekly: 'Semanal', biweekly: 'Quinzenal', monthly: 'Mensal', dayOfWeek: 'Dia da Semana', dayOfMonth: 'Dia do Mês', sunday: 'Domingo', monday: 'Segunda-feira', tuesday: 'Terça-feira', wednesday: 'Quarta-feira', thursday: 'Quinta-feira', friday: 'Sexta-feira', saturday: 'Sábado', collectionTimeLabel: 'Horário de Cobrança Preferencial', documentNumber: 'Número do Documento', systemHistory: 'Histórico no Sistema', verifySystem: 'Verificar no Sistema', searchingSystem: 'Buscando no sistema...', clientClean: 'Cliente Limpo', clientCleanMsg: 'Nenhum outro empréstimo ativo encontrado para este documento no sistema.', loansFound: 'Empréstimos Encontrados', loansFoundMsg: 'Os seguintes empréstimos ativos foram encontrados para este documento:', otherLoanCollector: 'Cobrador', otherLoanStatus: 'Status', loanDetails: 'Detalhes do Empréstimo', amountPaid: 'Valor Pago', paymentApprovedClientTitle: 'Pagamento Aprovado', paymentApprovedClientBody: 'Seu pagamento de {amount} foi aprovado!', paymentRejectedClientTitle: 'Pagamento Rejeitado', paymentRejectedClientBody: 'Seu comprovante foi rejeitado. Entre em contato com seu cobrador.', refinanceApprovedClientTitle: 'Refinanciamento Aprovado', refinanceApprovedClientBody: 'Sua solicitação de refinanciamento foi aprovada com sucesso.', refinanceRejectedClientTitle: 'Refinanciamento Rejeitado', refinanceRejectedClientBody: 'Sua solicitação de refinanciamento foi rejeitada.', realtimeTracking: 'Rastreamento em Tempo Real', 
                paymentTitle: 'Pagamento Parcela #{start}', 
                paymentTitleRange: 'Pagamento Parcelas #{start} - #{end}', 
                paymentDescFull: 'Parcela #{start} paga integralmente.', 
                paymentDescPartial: 'Pagamento parcial ({percent}%) da parcela.', 
                paymentDescMultiple: 'Cobre {fullInstallments} parcela(s) e {percent}% da próxima.', 
                paymentDescOverpay: 'Cobre a parcela #{start} e adianta {overpayAmount} para a próxima.',
                paymentInstallmentTitle: 'Pagamento Parcela #{installment}',
                paymentInstallmentsTitle: 'Pagamento Parcelas #{start} - #{end}',
                fullPaymentDesc: 'Parcela #{installment} paga integralmente.',
                partialPaymentDesc: 'Pagamento parcial ({percent}%) da parcela.',
                multiplePaymentDesc: 'Cobre {count} parcela(s) e {percent}% da próxima.',
                multipleFullPaymentDesc: 'Cobre {count} parcela(s) integralmente.',
                emailLogin: 'Email (Login)',
                username: 'Usuário (Login)',
                collectorOnTheWayTitle: 'Cobrador a caminho!', collectorOnTheWayBody: 'Nosso cobrador está a caminho e chegará em alguns minutos.', paymentSettings: 'Configurações de Pagamento', currency: 'Moeda de Operação', paymentMethods: 'Métodos de Pagamento', 
                save: 'Salvar',
                statusPaidToday: 'PAGO HOJE',
                statusToPay: 'FALTA PAGAR',
                statusPending: 'PENDIENTE',
                adminApprovedRefinance: 'Admin aprovou a solicitação de',
                approveToCreate: 'Aprove para criar o novo empréstimo.',
                settlementHistory: 'Histórico de Liquidações',
                noExpenses: 'Nenhum gasto encontrado.',
                noSettlements: 'Nenhuma liquidação encontrada.',
                loadingSettlements: 'Carregando liquidações...',
                totalAssets: 'Capital Total (Patrimônio)',
                distributedCapital: 'Capital Distribuído',
                routeLabel: 'Rota:',
                methodDigitalLabel: 'PIX',
                methodCardLabel: 'Cartão',
                salary: 'Salário',
                routeProgress: 'Progresso da Rota',
                microInsuranceLabel: 'Micro Seguro (Valor a Descontar)'
            },
            es: { 
                noClientsFound: 'Ningún cliente encontrado.', 
                biweekly: 'QUINCENAL', registerOutflow: 'Registrar Nueva Salida', addExpenseOption: 'Añadir Gasto', expenseOptionDesc: 'Registrar combustible, comida, etc.', cashWithdrawal: 'Retiro de Caja', withdrawalOptionDesc: 'Enviar dinero entregado al admin.', amountDeliveredAdmin: 'Monto entregado al Admin:', sendForApproval: 'Enviar para Aprobación',
                postponePayment: 'Aplazar Pago', postponeConfirmTitle: 'Confirmar Aplazamiento', postponeConfirmMsg: 'Esto moverá la fecha de vencimiento del cliente un día hábil, sin generar atraso. ¿Desea continuar?', confirm: 'Confirmar', paymentApproved: '¡Pago aprobado con éxito!', paymentRejected: 'Pago rechazado.', approve: 'Aprobar', reject: 'Rechazar', paymentReceipt: 'Comprobante de Pago', sentAmount: 'Monto Enviado', paymentVerification: 'Verificación de Pago', reputation: 'Reputación', reputationScore: 'Puntuación de Reputación', reputationPerfect: 'Excelente', reputationGood: 'Bueno', reputationRegular: 'Regular', reputationBad: 'Mala', reputationInfo: 'Mantén tus pagos al día para tener una buena reputación.', collector: 'Cobrador', dailyGoal: 'Meta Diaria', receivedToday: 'Recibido Hoy', clientsRemaining: 'Clientes Restantes', 
                todaysRoute: 'Ruta de Cobro (Activos)', 
                navHome: 'Ruta', 
                navClients: 'Clientes', navMap: 'Mapa', navProfile: 'Perfil', pending: 'Pendiente', paid: 'Pagado', late: 'Atrasado', addNewClient: 'Añadir Nuevo Cliente', clientName: 'Nombre del Cliente', address: 'Dirección', totalLoan: 'Valor del Préstamo', installmentValue: 'Valor de la Cuota', numInstallments: 'Número de Cuotas', paymentDays: 'Días de Pago', saveClient: 'Guardar Cliente', city: 'Ciudad', location: 'Ubicación GPS', interest: 'Interés (%)', totalToPay: 'Valor Total a Pagar', clientDocs: 'Documentos del Cliente (Opcional)', takePhoto: 'Tomar Foto', uploadFile: 'Cargar Archivo', attachedDocs: 'Documentos Adjuntos', editClient: 'Editar Cliente', saveChanges: 'Guardar Cambios', startRoute: 'IR', searchClient: 'Buscar cliente...', all: 'Todos', navigate: 'Navegar', capitalTotal: 'Capital en Mano', dailyTotal: 'Total del Día', weeklyTotal: 'Total Semanal', monthlyTotal: 'Total Mensual', accountSettings: 'Ajustes de la Cuenta', changePassword: 'Cambiar Contraseña', exportReport: 'Exportar Reporte Diario (PDF)', logout: 'Cerrar Sesión', reportTitle: 'Reporte Diario de Cobranza', reportDate: 'Fecha', reportCollector: 'Cobrador', reportTotalCollected: 'Total Recaudado', reportNumPayments: 'Nº de Pagos', reportClient: 'Cliente', reportAmount: 'Valor', reportTime: 'Hora', noPaymentsToday: 'No hay pagos registrados hoy.', cropImage: 'Recortar Imagen', confirmCrop: 'Confirmar Recorte', cancel: 'Cancelar', 
                
                navExpenses: 'Gastos<br>Retiros', 

                myExpenses: 'Mis Gastos', addExpense: 'Añadir Gasto', expenseType: 'Tipo de Gasto', expenseValue: 'Valor del Gasto', observations: 'Observaciones (Opcional)', uploadReceipt: 'Adjuntar Recibo (Opcional)', saveExpense: 'Guardar Gasto', fuel: 'Combustible', food: 'Alimentación', rent: 'Alquiler', mechanics: 'Mecánica', other: 'Otros', filterPeriod: 'Filtrar por Período', filterCategory: 'Filtrar por Categoría', today: 'Hoy', thisWeek: 'Esta Semana', thisMonth: 'Este Mes', fromBeginning: 'Desde el Inicio', reportTotalExpenses: 'Total de Gastos', reportNetBalance: 'Saldo Neto', clientAccess: 'Acceso del Cliente', username: 'Usuario', password: 'Contraseña', usernameTaken: 'Este usuario ya existe.', usernameAvailable: 'Usuario disponible.', usernameRequired: 'El nombre de usuario es obligatorio.', whatsapp: 'WhatsApp', shareOnWhatsApp: 'Compartir por WhatsApp', clientRegisteredSuccess: '¡Cliente Registrado con Éxito!', clientUpdatedSuccess: '¡Cliente Actualizado con Éxito!', accessData: 'Datos de Acceso', appInstructions: 'Usa estos datos para acceder a la app del cliente:', appLink: 'Link de la App', whatsappMessageTemplate: `¡Hola {clientName}! 👋 Tu acceso a nuestra app ha sido creado con éxito.\n\n*LINK DE LA APP*\n{appLink}\n\n*EMAIL*\n{email}\n\n*CONTRASEÑA*\n{password}`, navNotifications: 'Notificaciones', paymentSent: 'envió un pago de', pleaseVerify: 'Por favor, verifique.', noNotifications: 'Ninguna notificación pendiente.', refinanceRequested: 'solicitó un refinanciamiento de', reviewRequest: 'Revisar solicitud.', installAppMsg: '¡Instala la app para una mejor experiencia!', installBtn: 'Instalar', receivedInCash: 'Recibido en Efectivo', receivedInDigital: 'Recibido en PIX/Tarjeta', finished: 'Finalizado', createNewLoan: 'Crear Nuevo Préstamo', updateClientData: 'Actualizar Datos', paymentFrequency: 'Forma de Pago', daily: 'Diario', weekly: 'Semanal', biweekly: 'Quincenal', monthly: 'Mensal', dayOfWeek: 'Día de la Semana', dayOfMonth: 'Día del Mes', sunday: 'Domingo', monday: 'Lunes', tuesday: 'Martes', wednesday: 'Miércoles', thursday: 'Jueves', friday: 'Viernes', saturday: 'Sábado', collectionTimeLabel: 'Hora de Cobro Preferida', documentNumber: 'Número de Documento', systemHistory: 'Historial en el Sistema', verifySystem: 'Verificar en el Sistema', searchingSystem: 'Buscando en el sistema...', clientClean: 'Cliente Limpo', clientCleanMsg: 'No se encontraron otros préstamos activos para este documento en el sistema.', loansFound: 'Préstamos Encontrados', loansFoundMsg: 'Se encontraron los siguientes préstamos activos para este documento:', otherLoanCollector: 'Cobrador', otherLoanStatus: 'Estado', loanDetails: 'Detalles del Préstamo', amountPaid: 'Monto Pagado', paymentApprovedClientTitle: 'Pago Aprobado', paymentApprovedClientBody: '¡Tu pago de {amount} ha sido aprobado!', paymentRejectedClientTitle: 'Pago Rechazado', paymentRejectedClientBody: 'Tu comprobante fue rechazado. Por favor, contacta a tu cobrador.', refinanceApprovedClientTitle: 'Refinanciación Aprobada', refinanceApprovedClientBody: 'Tu solicitud de refinanciación ha sido aprobada con éxito.', refinanceRejectedClientTitle: 'Refinanciación Rechazada', refinanceRejectedClientBody: 'Tu solicitud de refinanciación ha sido rechazada.', realtimeTracking: 'Seguimiento en Tiempo Real', 
                paymentTitle: 'Pago Cuota #{start}', 
                paymentTitleRange: 'Pago Cuotas #{start} - #{end}', 
                paymentDescFull: 'Cuota #{start} pagada en su totalidad.', 
                paymentDescPartial: 'Pago parcial ({percent}%) de la cuota.', 
                paymentDescMultiple: 'Cubre {fullInstallments} cuota(s) y {percent}% de la próxima.', 
                paymentDescOverpay: 'Cubre la cuota #{start} y adelanta {overpayAmount} para la próxima.',
                paymentInstallmentTitle: 'Pago Cuota #{installment}',
                paymentInstallmentsTitle: 'Pago Cuotas #{start} - #{end}',
                fullPaymentDesc: 'Cuota #{installment} pagada completamente.',
                partialPaymentDesc: 'Pago parcial ({percent}%) de la cuota.',
                multiplePaymentDesc: 'Cubre {count} cuota(s) y un {percent}% de la siguiente.',
                multipleFullPaymentDesc: 'Cubre {count} cuota(s) completamente.',
                emailLogin: 'Email (Login)',
                username: 'Usuário (Login)',
                collectorOnTheWayTitle: '¡Cobrador en camino!', collectorOnTheWayBody: 'Nuestro cobrador está en camino y llegará en unos minutos.', paymentSettings: 'Configuración de Pagos', currency: 'Moneda de Operación', paymentMethods: 'Métodos de Pago', 
                save: 'Guardar',
                statusPaidToday: 'PAGADO HOY',
                statusToPay: 'FALTA POR PAGAR',
                statusPending: 'PENDIENTE',
                adminApprovedRefinance: 'Admin aprobó la solicitud de',
                approveToCreate: 'Aprueba para crear el nuevo préstamo.',
                settlementHistory: 'Historial de Liquidaciones',
                noExpenses: 'Ningún gasto encontrado.',
                noSettlements: 'Ninguna liquidación encontrada.',
                loadingSettlements: 'Cargando liquidaciones...',
                totalAssets: 'Capital Total (Patrimonio)',
                distributedCapital: 'Capital Distribuido',
                routeLabel: 'Ruta:',
                methodDigitalLabel: 'Pago Electrónico',
                methodCardLabel: 'Tarjeta',
                salary: 'Salario',
                routeProgress: 'Progreso de la Ruta',
                microInsuranceLabel: 'Micro Seguro (A Descontar)'
            },
            en: { 
                // ... (No es crítico si no usas inglés, pero lo dejo por si acaso)
                noClientsFound: 'No clients found.', 
                navExpenses: 'Expenses<br>Withdrawals', 
                // ...
            }
        };
        let mapInstance = null;
        let mapMarkers = [];
        let collectorMarker = null; // Marker para la moto del cobrador
        let deferredPrompt; // Para la instalación de PWA
        const collectorId = 'joao_silva'; 
        let collectorCurrentLocation = null; // Guardará tu ubicación en tiempo real
        let locationWatchId = null; // ID para controlar el rastreador de GPS
        let lastLocationUpdateTime = 0; // Controla la frecuencia de actualización en Firestore

        let currentCompanyId = null;     // Guarda o ID da empresa do cobrador
        let currentCompanyData = null;   // Guarda os dados da empresa (logo, nome, status)
        let currentCollectorUid = null;  // Guarda o ID de autenticação (Auth UID) do cobrador
        let currentCollectorUsername = null; // Guarda o 'username' (ID de Firestore) do cobrador
        let unsubscribeNotifications = null;
        let internalNotifications = [];

        
        const nationalHolidays = [ '01/01', '21/04', '01/05', '07/09', '12/10', '02/11', '15/11', '25/12' ];
        

        const money = val => (typeof val !== 'number' || isNaN(val)) ? (currentLang === 'pt' ? 'R$ 0,00' : '$ 0.00') : val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });


        function calculateDailyTotals() {
            let dailyTotal = 0;
            let dailyTotalCash = 0;
            let dailyTotalDigital = 0;
            
            const now = new Date();
            const todayStr = now.toLocaleDateString('pt-BR');

            allClients.forEach(client => {
                (client.loans || []).forEach(loan => {
                    (loan.history || []).forEach(h => {
                        
                        // --- [INICIO DE LA CORRECCIÓN (calculateDailyTotals)] ---
                        
                        // 1. Obtener la fecha (ya sea JS Date o Firestore Timestamp)
                        let paymentDate = null;
                        if (h.date?.seconds) { // Es un Firestore Timestamp
                            paymentDate = new Date(h.date.seconds * 1000);
                        } else if (h.date instanceof Date) { // Es un JS Date (pago local)
                            paymentDate = h.date;
                        }

                        // 2. Comprobar si la fecha es válida Y el pago es válido
                        //    (Se ignora 'migration' como antes)
                        if (paymentDate && h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration') {
                        // --- [FIN DE LA CORRECCIÓN] ---

                            // 3. Filtro de Fecha (sin cambios)
                            if (paymentDate.toLocaleDateString('pt-BR') === todayStr) {
                                const amount = h.amount || 0;
                                
                                // 4. Suma al Total del Día (sin cambios)
                                dailyTotal += amount; 
                                
                                // 5. Lógica de Categoría (sin cambios)
                                if (h.method === 'dinheiro') {
                                    dailyTotalCash += amount;
                                } else {
                                    dailyTotalDigital += amount;
                                }
                            }
                        }
                    });
                });
            });
            
            // Devuelve un objeto con los 3 valores correctos
            return { dailyTotal, dailyTotalCash, dailyTotalDigital };
        }


        
        function showToast(message, isError = false) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3500);
        }

        function showBlockedView(message) {
    console.error("Acceso bloqueado:", message);
    // Ocultamos todas as vistas principais
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('app-container').style.display = 'none';

    // Creamos y mostramos el mensaje de bloqueo (si no existe ya)
    let blockedView = document.getElementById('blocked-view');
    if (!blockedView) {
        blockedView = document.createElement('div');
        blockedView.id = 'blocked-view';
        blockedView.style.cssText = 'display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; text-align: center; background-color: var(--bg);';
        document.body.appendChild(blockedView);
    }

    blockedView.innerHTML = `
        <i data-lucide="shield-off" style="width: 64px; height: 64px; color: var(--danger-color); margin-bottom: 20px;"></i>
        <h2 style="color: var(--text-primary); margin-bottom: 10px;">Acesso Negado</h2>
        <p style="color: var(--text-secondary); max-width: 400px; line-height: 1.5;">${message}</p>
        <button id="logout-blocked-btn" class="btn-primary" style="margin-top: 30px; background-color: var(--danger-color); border: none;">Sair (Log Out)</button>
    `;
    lucide.createIcons({ nodes: [blockedView.querySelector('i')] });

    const logoutBtn = document.getElementById('logout-blocked-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(err => console.error("Error en logout forzado:", err));
        });
    }
}


        function getAllTodaysClients() {
           const clientsForToday = [];
           const today = new Date();
           today.setHours(0, 0, 0, 0);
           const dayOfWeek = today.getDay();
           const dayOfMonth = today.getDate();

           allClients.forEach(client => {
               (client.loans || []).forEach((loan, index) => {
                   if (loan.status === 'finished') return;

                   let isPaymentDay = false;
                   const frequency = loan.paymentFrequency || 'daily';
                   const paymentDays = loan.paymentDays || [];

                   if (frequency === 'daily') {
                       isPaymentDay = paymentDays.includes(dayOfWeek);
                   } else if (frequency === 'weekly') {
                       isPaymentDay = paymentDays.length > 0 && paymentDays[0] === dayOfWeek;
                   } else if (frequency === 'biweekly') {
                       // LÓGICA QUINCENAL: Mismo día de la semana cada 14 días
                       if (paymentDays.length > 0 && paymentDays[0] === dayOfWeek) {
                           const startDate = loan.startDate?.seconds ? new Date(loan.startDate.seconds * 1000) : new Date(loan.startDate);
                           startDate.setHours(0,0,0,0);
                           
                           const diffTime = Math.abs(today - startDate);
                           const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                           
                           // Verificamos si han pasado semanas pares (0, 2, 4...) desde el inicio
                           if (Math.floor(diffDays / 7) % 2 === 0) {
                               isPaymentDay = true;
                           }
                       }
                   } else if (frequency === 'monthly') {
                       isPaymentDay = paymentDays.length > 0 && paymentDays[0] === dayOfMonth;
                   }

                   if (isPaymentDay) {
                        const loanDetails = calculateLoanDetails(loan);
                        const updatedLoan = { ...loan, status: loanDetails.status };
                        clientsForToday.push({ client, loan: updatedLoan, loanIndex: index });
                   }
               });
           });
           return clientsForToday;
       }

        function getTodaysRouteClients() {
            // 1. Obtiene todos los clientes que deberían pagar hoy (sin cambios)
            const todaysClients = getAllTodaysClients();
            
            // 2. Obtiene el inicio del día de HOY (medianoche)
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            // 3. Filtra la lista
            return todaysClients.filter(item => {
                const loan = item.loan;
                
                // 4. Regla 1: ¿El estado es 'pendiente' o 'atrasado'? (Sin cambios)
                const isStatusPendingOrLate = (loan.status === 'pending' || loan.status === 'late');
                
                // 5. Regla 2: ¿El cliente HA PAGADO HOY? (¡NUEVA LÓGICA!)
                let hasPaidToday = false;
                if (loan.history && loan.history.length > 0) {
                    
                    // Función auxiliar robusta para obtener la fecha (igual a la de showClientDetails)
                    const getPaymentDate = (dateObj) => {
                        if (!dateObj) return null;
                        if (typeof dateObj.toDate === 'function') {
                            return dateObj.toDate(); // Es un Timestamp de Firestore
                        }
                        if (dateObj instanceof Date) {
                            return dateObj; // Es un JS Date (pago local recién hecho)
                        }
                        return null;
                    };

                    hasPaidToday = loan.history.some(h => {
                        // Ignorar pagos que no sean 'approved' (o 'migracion')
                        if (h.status === 'postponed' || h.status === 'rejected' || h.status === 'pending_verification' || h.method === 'migration') {
                            return false; 
                        }

                        const paymentDate = getPaymentDate(h.date);
                        
                        // Compara si la fecha del pago es MAYOR O IGUAL al inicio de hoy
                        return paymentDate && paymentDate >= todayStart;
                    });
                }
                
                // 6. Regla Final:
                // Mostrar en la ruta SÓLO SI (está pendiente/atrasado) Y (NO ha pagado hoy)
                return isStatusPendingOrLate && !hasPaidToday;
            });
        }

        
        function renderMainLayout() {
            document.getElementById('app-container').innerHTML = `
                <header class="main-header">
                    <div class="logo"><img id="header-logo" src="${DEFAULT_LOGO_URL}" alt="Logo da Empresa"><span id="header-logo-text" class="logo-text">Portal do Cobrador</span></div>
                    <div class="header-controls">
                        <div style="position: relative;">
                            <!-- BOTÓN IDIOMA -->
                            <button class="header-btn" id="lang-toggle" title="Mudar idioma" style="flex-direction: column; border-radius: 8px; width: auto; height: auto; padding: 4px 8px;">
                                <i data-lucide="globe" style="width: 24px; height: 24px;"></i>
                                <span style="font-size: 0.85em; font-weight: 700; margin-top: 2px;">Idioma</span>
                            </button>
                            <div class="lang-dropdown" id="lang-dropdown"><button data-lang="pt">Português</button><button data-lang="es">Español</button><button data-lang="en">English</button></div>
                        </div>
                        
                        <!-- BOTÓN TEMA -->
                        <button class="header-btn" id="theme-toggle" title="Mudar tema" style="flex-direction: column; border-radius: 8px; width: auto; height: auto; padding: 4px 8px;">
                            <i data-lucide="moon" style="width: 24px; height: 24px;"></i>
                            <span style="font-size: 0.85em; font-weight: 700; margin-top: 2px;">Tema</span>
                        </button>

                        <div class="profile" id="header-profile-link" style="cursor: pointer;">
                            <div class="profile-info"><span class="profile-name">João Silva</span><span class="profile-role" data-lang-key="collector"></span></div>
                            <img id="header-profile-img" src="" alt="Foto do Cobrador">
                        </div>
                    </div>
                </header>
                <main>
                    <div id="home-view" class="view active container">
                        
                        <!-- KPI CARD (Progresso da Rota) -->
                        <div class="kpi-card progress-card" style="margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;">
                            <h3 class="kpi-title" style="justify-content: center; width: 100%;" data-lang-key="routeProgress">Progresso da Rota</h3>
                            
                            <div class="progress-circle" style="margin: 0 auto 15px auto;">
                                <svg><circle class="bg-circle" cx="60" cy="60" r="54"></circle><circle id="route-progress-bar" class="progress-bar" cx="60" cy="60" r="54" style="stroke-dasharray: 339.292;"></circle></svg>
                                <div class="progress-text" id="route-progress-text">0/0</div>
                            </div>
                            
                            <!-- NOMBRE DE LA RUTA (COLOR SUAVE Y SIN BRILLO MOLESTO) -->
                            <div style="width: 100%; display: flex; justify-content: center; margin-bottom: 5px; position: relative;">
                                <input type="text" id="route-name-input" placeholder="Nome da Rota" disabled
                                    style="border: none; background: transparent; text-align: center; 
                                    color: #2dd4bf; /* Turquesa Suave (Menta) */
                                    font-weight: 700; font-size: 1.3em; width: 100%; outline: none; opacity: 1; letter-spacing: 0.5px; text-transform: uppercase;"
                                    value="${(typeof currentCollectorData !== 'undefined' && currentCollectorData?.routeName) ? currentCollectorData.routeName : ''}"
                                >
                                <!-- Botón invisible para habilitar edición con doble clic -->
                                <div id="enable-route-edit-btn" style="position: absolute; top:0; left:0; width:100%; height:100%; cursor: pointer;"></div>
                            </div>

                        </div>

                        <section class="kpi-grid">
                            <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="dailyGoal"><i data-lucide="target"></i></h3>
                                <p class="kpi-value" id="kpi-goal"></p>
                            </div>
                            
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="receivedToday"><i data-lucide="check-circle"></i></h3><p class="kpi-value green" id="kpi-received"></p></div>
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="clientsRemaining"><i data-lucide="users"></i></h3><p class="kpi-value" id="kpi-remaining"></p></div>
                        </section>
                        <section class="route-section"><h2 class="section-title" data-lang-key="todaysRoute"></h2><div class="client-list" id="todays-route-list"><div class="loading">Carregando clientes...</div></div></section>
                    </div>
                    <div id="clients-view" class="view container">
                        <div class="search-bar-wrapper">
                            <i class="icon" data-lucide="search"></i>
                            <input type="text" id="client-search-input" placeholder="Buscar cliente...">
                        </div>

                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">TODOS</button>
                            <button class="filter-btn" data-filter="weekly">SEMANALES</button>
                            <button class="filter-btn" data-filter="biweekly">QUINCENAL</button>
                            <button class="filter-btn" data-filter="todo_today">FALTA POR PAGAR</button>
                            <button class="filter-btn" data-filter="paid">PAGADOS</button>
                            <button class="filter-btn" data-filter="late">ATRASADOS</button>
                            <button class="filter-btn" data-filter="finished">FINALIZADOS</button>
                        </div>

                        <div class="client-list" id="all-clients-list"></div>
                    </div>

                    <div id="notifications-view" class="view container">
                         <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-purple);">
                            <span data-lang-key="navNotifications" style="font-size: 1.3em; font-weight: 600; padding-bottom: 10px;"></span>
                            <button id="clear-collector-notifications-btn" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size: 0.8em; font-weight: 500; display:flex; align-items:center; gap: 4px; padding-bottom: 10px;">
                                <i data-lucide="trash-2" style="width:14px; height:14px;"></i>
                                <span>Limpar Tudo</span>
                            </button>
                        </div>
                         <div class="notification-list" id="notifications-list-container"></div>
                    </div>

                     <div id="expenses-view" class="view container">
                         <h2 class="section-title" data-lang-key="myExpenses"></h2>
                         <div class="filter-buttons">
                             <button class="filter-btn active" data-period="today" data-lang-key="today"></button>
                             <button class="filter-btn" data-period="week" data-lang-key="thisWeek"></button>
                             <button class="filter-btn" data-period="month" data-lang-key="thisMonth"></button>
                             <button class="filter-btn" data-period="all" data-lang-key="fromBeginning"></button>
                         </div>
                          <div class="filter-buttons grid">
                             <button class="filter-btn active" data-category="all" data-lang-key="all"></button>
                             <button class="filter-btn" data-category="fuel" data-lang-key="fuel"></button>
                             <button class="filter-btn" data-category="food" data-lang-key="food"></button>
                             <button class="filter-btn" data-category="salary" data-lang-key="salary"></button>
                             <button class="filter-btn" data-category="rent" data-lang-key="rent"></button>
                             <button class="filter-btn" data-category="mechanics" data-lang-key="mechanics"></button>
                             <button class="filter-btn" data-category="other" data-lang-key="other"></button>
                         </div>
                         <div class="expense-list" id="expenses-list-container"></div>
                         
                         <section style="margin-top: 30px;">
                             <h2 class="section-title" data-lang-key="settlementHistory"></h2>
                             <div class="item-list" id="settlements-list-container">
                                 <p class="loading" data-lang-key="loadingSettlements">Carregando liquidações...</p>
                             </div>
                         </section>

                     </div>
                    <div id="map-view" class="view container">
                        <div id="map-container"></div>
                    </div>
                    
                    <div id="profile-view" class="view container">
                        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                            <label for="profile-pic-input" class="profile-pic-wrapper">
                                <img id="profile-view-img" src="" alt="Foto do Cobrador">
                            </label>
                            <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                            <h2 style="margin: 15px 0 0; font-size: 1.5em;" class="profile-name"></h2>
                            <p style="margin: 5px 0 0; color: var(--text-secondary);" data-lang-key="collector"></p>
                        </div>

                        <div class="kpi-card" style="display: none !important; margin-bottom: 20px; text-align: center; border-color: var(--accent-purple); border-width: 2px;">
                            <h3 class="kpi-title" style="justify-content: center; color: var(--accent-purple);">
                                <i data-lucide="gem"></i> <span data-lang-key="totalAssets">Capital Total (Patrimônio)</span>
                            </h3>
                            <p class="kpi-value" id="kpi-total-patrimonio" style="color: var(--accent-purple); font-size: 1.8em;"></p>
                        </div>

                        <div class="kpi-card" style="margin-bottom: 20px; text-align: center; border-color: var(--accent-green); border-width: 2px;">
                            <h3 class="kpi-title" style="justify-content: center; color: var(--accent-green);">
                                <i data-lucide="banknote"></i> <span data-lang-key="capitalTotal">Capital em Mãos</span>
                            </h3>
                            <p class="kpi-value" id="kpi-capital-total"></p>
                        </div>

                        <div class="kpi-card" style="display: none !important; margin-bottom: 20px; text-align: center; border-color: var(--accent-orange);">
                            <h3 class="kpi-title" style="justify-content: center; color: var(--accent-orange);">
                                <i data-lucide="briefcase"></i> <span data-lang-key="distributedCapital">Capital Distribuído</span>
                            </h3>
                            <p class="kpi-value" id="kpi-distributed-capital" style="color: var(--accent-orange);"></p>
                        </div>

                        <section class="kpi-grid-profile">
                             <div class="kpi-card">
                                 <h3 class="kpi-title" data-lang-key="dailyTotal"><i data-lucide="sun"></i></h3>
                                 <p class="kpi-value green" id="kpi-daily-total"></p>
                             </div>
                             <div class="kpi-card" style="background-color: color-mix(in srgb, var(--accent-green) 5%, var(--surface));">
                                 <h3 class="kpi-title" data-lang-key="receivedInCash"><i data-lucide="banknote" style="color: var(--accent-green);"></i></h3>
                                 <p class="kpi-value" id="kpi-daily-cash"></p>
                             </div>
                             <div class="kpi-card" style="background-color: color-mix(in srgb, var(--accent-purple) 5%, var(--surface));">
                             <h3 class="kpi-title" data-lang-key="receivedInDigital"><i data-lucide="smartphone" style="color: var(--accent-purple);"></i></h3>
                             <p class="kpi-value" id="kpi-daily-digital"></p>
                         </div>
                        </section>
                         <section>
                            <h2 class="section-title" data-lang-key="accountSettings"></h2>
                            <div class="client-list">
                                <div class="settings-item" id="realtime-tracking-item">
                                    <i data-lucide="map-pin"></i>
                                    <span data-lang-key="realtimeTracking" style="flex-grow: 1;"></span>
                                    <div class="switch">
                                        <input type="checkbox" id="realtime-tracking-toggle">
                                        <label for="realtime-tracking-toggle"></label>
                                    </div>
                                </div>
                                <a class="settings-item" id="payment-settings-btn">
                                    <i data-lucide="dollar-sign"></i><span data-lang-key="paymentSettings"></span>
                                </a>
                                <a class="settings-item" id="change-password-btn">
                                    <i data-lucide="key-round"></i><span data-lang-key="changePassword"></span>
                                </a>
                                <a class="settings-item" id="export-report-btn">
                                    <i data-lucide="download"></i><span data-lang-key="exportReport"></span>
                                </a>
                                 <a class="settings-item logout" id="logout-btn">
                                     <i data-lucide="log-out"></i><span data-lang-key="logout"></span>
                                 </a>
                            </div>
                        </section>
                    </div>
                </main>
                <nav class="bottom-nav">
                    <a class="nav-item active" data-view="home"><i data-lucide="home"></i><span data-lang-key="navHome"></span></a>
                    <a class="nav-item" data-view="clients"><i data-lucide="users"></i><span data-lang-key="navClients"></span></a>
                    <a class="nav-item" data-view="notifications">
                        <i data-lucide="bell"></i>
                        <span data-lang-key="navNotifications"></span>
                        <span class="notification-badge" id="notification-badge">0</span>
                    </a>
                    <a class="nav-item" data-view="expenses"><i data-lucide="receipt"></i><span data-lang-key="navExpenses"></span></a>
                    <a class="nav-item" data-view="map"><i data-lucide="map"></i><span data-lang-key="navMap"></span></a>
                </nav>
                <button class="fab" id="addClientBtn" title="Adicionar Cliente"><i data-lucide="plus"></i></button>
                <button class="fab hidden" id="addExpenseBtn" title="Adicionar Gasto"><i data-lucide="plus"></i></button>`;
        }




        
        
        
        
        function updateNotifications() {
            console.log("[COBRADOR-APP][DIAG] updateNotifications() iniciada.");
            const container = document.getElementById('notifications-list-container');
            const badge = document.getElementById('notification-badge');
            if (!container || !badge) return;

            const finalNotifications = internalNotifications.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            const unreadCount = finalNotifications.filter(n => n.read === false).length;
            badge.textContent = unreadCount;
            badge.classList.toggle('visible', unreadCount > 0);
            
            if (finalNotifications.length === 0) {
                container.innerHTML = `<div class="no-items" data-lang-key="noNotifications">${translations[currentLang].noNotifications}</div>`;
                return;
            }

            container.innerHTML = finalNotifications.map(p => {
                    const nameInitial = (p.from || 'C').charAt(0).toUpperCase();
                    const placeholderUrl = `https://placehold.co/80x80/6f42c1/FFFFFF?text=${nameInitial}`;
                    const photoUrl = p.profilePictureUrl || placeholderUrl;

                    let subtitle = p.body || 'Nova notificação'; 

                    // --- [BLOQUE ACTUALIZADO PARA USAR TRADUCCIONES DINÁMICAS] ---
                    if (!p.body) {
                        if (p.type === 'payment') {
                            subtitle = `${translations[currentLang].paymentSent} ${money(p.amount || 0)}. ${translations[currentLang].pleaseVerify}`;
                        } else if (p.type === 'refinance') {
                            subtitle = `${translations[currentLang].refinanceRequested} ${money(p.amount || 0)}. ${translations[currentLang].reviewRequest}`;
                        } else if (p.type === 'refinance_admin_approved') {
                            // AHORA USA EL DICCIONARIO
                            subtitle = `${translations[currentLang].adminApprovedRefinance} ${money(p.amount || 0)}. ${translations[currentLang].approveToCreate}`;
                        }
                    }
                    // --- [FIN BLOQUE ACTUALIZADO] ---

                    const loanIndexAttr = p.loanIndex !== undefined ? `data-loan-index="${p.loanIndex}"` : '';
                    const historyIndexAttr = p.historyIndex !== undefined ? `data-history-index="${p.historyIndex}"` : '';
                    const notificationIdAttr = p.id ? `data-notification-id="${p.id}"` : '';
                    const readClass = p.read === true ? 'read' : 'unread'; 

                    return `
                    <div class="notification-card ${readClass}" data-client-id="${p.clientId}" ${loanIndexAttr} ${historyIndexAttr} data-type="${p.type}" ${notificationIdAttr}>
                        <img src="${photoUrl}" alt="Foto" class="client-avatar">
                        <div class="notification-info">
                            <h4 class="notification-title">${p.from}</h4>
                            <p class="notification-subtitle">${subtitle}</p>
                        </div>
                    </div>`;
                }).join('');

            applyLanguage(currentLang);
            lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
        }


        // Pega este bloque completo dentro de <script type="module">

async function showRefinanceModal(clientId, notificationId) {
    const modal = document.getElementById('refinanceModal');
    const client = allClients.find(c => c.id === clientId);

    if (!client || !client.refinanceRequest) {
        showToast('Solicitação de refinanciamento não encontrada ou já processada.', true);
        return;
    }
    console.log(`[DIAG-REFI] showRefinanceModal chamada com clientId=${clientId}, notifId=${notificationId}`);

    const request = client.refinanceRequest;

    const nameInitial = (client.name || 'C').charAt(0).toUpperCase();
    const placeholderUrl = `https://placehold.co/80x80/6f42c1/FFFFFF?text=${nameInitial}`;
    const photoUrl = client.profilePictureUrl || placeholderUrl;

    modal.innerHTML = `
        <header class="modal-header">
            <button id="closeRefinanceModal"><i data-lucide="arrow-left"></i></button>
            <span class="modal-title">Refinanciamento Pré-Aprovado</span>
        </header>
        <div class="modal-content-wrapper container">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <img src="${photoUrl}" alt="Foto do Cliente" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover;">
                <div>
                    <h3 style="margin: 0 0 5px;">${client.name}</h3>
                    <p style="color: var(--text-secondary); margin: 0; font-weight: 500;">
                        Verificado pelo Administrador
                    </p>
                </div>
            </div>

            <div class="kpi-card">
                <h3 class="kpi-title">Detalhes da Solicitação</h3>
                <div class="loan-summary" style="grid-template-columns: 1fr; gap: 10px; text-align: center;">
                    <div>
                        <p class="kpi-title" style="justify-content: center;">Valor Solicitado</p>
                        <p class="kpi-value">${money(request.amount)}</p>
                    </div>
                    <div>
                        <p class="kpi-title" style="justify-content: center;">Nº de Parcelas</p>
                        <p class="kpi-value">${request.installments}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn-danger" id="reject-refinance-btn"><i data-lucide="x-circle"></i> <span data-lang-key="reject"></span></button>
            <button class="btn-primary" id="approve-refinance-btn"><i data-lucide="check-circle"></i> Aprovar e Criar</button>
        </div>`;

    history.pushState({ modal: 'refinanceModal' }, 'Refinance Modal', '#refinance');
    modal.classList.add('active');
    lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });
    applyLanguage(currentLang);

    modal.querySelector('#closeRefinanceModal').addEventListener('click', () => window.history.back());

    const clientRef = doc(db, 'companies', currentCompanyId, 'clients', clientId);

    // --- Botón APROBAR (¡AQUÍ ESTÁ LA CORRECCIÓN!) ---
    modal.querySelector('#approve-refinance-btn').addEventListener('click', async (e) => {
        const approveBtn = e.currentTarget;
        approveBtn.disabled = true;
        approveBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Aprovando...`;
        lucide.createIcons({ nodes: [approveBtn.querySelector('i')] });

        try {
            // --- INICIO DE LA NUEVA LÓGICA (EL ARREGLO) ---
            
            // 1. Construir el objeto del nuevo préstamo (lógica de showClientFormModal)
            const loanAmount = parseFloat(request.amount);
            const installments = parseInt(request.installments, 10);
            const interest = parseFloat(client.interestRate || '20'); 

            // --- LÓGICA FINANCIERA PERFECTA (REDONDEO) ---
            let rawTotal = loanAmount * (1 + (interest / 100));
            
            // Redondeamos la cuota a 2 decimales
            let rawInstallment = installments > 0 ? rawTotal / installments : 0;
            const installmentValue = Math.round(rawInstallment * 100) / 100;

            // Recalculamos el Total exacto
            const totalToPay = installmentValue * installments;
            // ----------------------------------------------
            
            // Heredar la tasa de mora y la frecuencia del último préstamo (o usar defaults)
            const lastLoan = client.loans && client.loans.length > 0 ? client.loans[client.loans.length - 1] : {};
            const lateFeeRate = lastLoan.lateFeeRate !== undefined ? lastLoan.lateFeeRate : (currentCompanyData?.defaultInterest || 0);

            const loanSpecificData = {
                principalAmount: loanAmount,
                lateFeeRate: lateFeeRate,
                totalLoan: totalToPay,
                amount: installmentValue,
                originalInstallmentAmount: installmentValue,
                installments: `0/${installments}`,
                paid: 0,
                paymentBalance: 0,
                status: 'active', // Estado inicial
                startDate: new Date(), // ¡Nuevo préstamo empieza hoy!
                history: [],
                paymentFrequency: lastLoan.paymentFrequency || 'daily',
                paymentDays: lastLoan.paymentDays || [1, 2, 3, 4, 5, 6],
                collectionTime: lastLoan.collectionTime || '',
            };

            // 2. Añadir el nuevo préstamo al array del cliente (activando el multi-préstamo)
            console.log("[COBRADOR-APP] Aprobando refinanciamento. Añadiendo nuevo préstamo...");
            await updateDoc(clientRef, {
                loans: arrayUnion(loanSpecificData)
            });
            console.log("[COBRADOR-APP] Préstamo añadido.");

            // 3. Limpiar la solicitud de refinanciamiento
            console.log("[COBRADOR-APP] Limpando 'refinanceRequest' del cliente...");
            await updateDoc(clientRef, {
                refinanceRequest: null // Limpia la solicitud
            });
            console.log("[COBRADOR-APP] 'refinanceRequest' limpiado.");

            // 4. Eliminar la notificación interna (lógica existente)
            if (notificationId) {
                await deleteDoc(doc(db, 'collectors', currentCollectorUsername, 'notifications', notificationId));
            }

            // 5. Notificar al cliente (lógica existente)
            const notifTitle = translations[currentLang].refinanceApprovedClientTitle;
            const notifBody = translations[currentLang].refinanceApprovedClientBody;
            sendNotificationToClient(clientId, notifTitle, notifBody, 'refinance_approved', 'trending-up');
            
            // 6. Cerrar este modal
            window.history.back();

            // 7. (ELIMINADO) Ya no abrimos showClientFormModal
            // showClientFormModal(clientId, true, null, { ... });

            showToast('Refinanciamento aprovado e novo empréstimo criado!');
            
            // --- FIN DE LA NUEVA LÓGICA ---

        } catch (error) {
            console.error("Error approving refinance:", error);
            showToast('Erro ao aprovar refinanciamento.', true);
            approveBtn.disabled = false;
            approveBtn.innerHTML = `<i data-lucide="check-circle"></i> Aprovar e Criar`;
            lucide.createIcons({ nodes: [approveBtn.querySelector('i')] });
            applyLanguage(currentLang);
        }
    });

    // --- Botón RECHAZAR (Sin cambios, pero se incluye por completitud) ---
    modal.querySelector('#reject-refinance-btn').addEventListener('click', async (e) => {
        const rejectBtn = e.currentTarget;
        rejectBtn.disabled = true;
        rejectBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Rejeitando...`;
        lucide.createIcons({ nodes: [rejectBtn.querySelector('i')] });

        try {
            // 1. Actualiza el estado a 'rejected_collector'
            await updateDoc(clientRef, {
                'refinanceRequest.status': 'rejected_collector',
            });

            // 2. Elimina la notificación interna
            if (notificationId) {
                await deleteDoc(doc(db, 'collectors', currentCollectorUsername, 'notifications', notificationId));
            }

            // 3. Notifica al cliente
            const notifTitle = translations[currentLang].refinanceRejectedClientTitle;
            const notifBody = translations[currentLang].refinanceRejectedClientBody;
            sendNotificationToClient(clientId, notifTitle, notifBody, 'refinance_rejected', 'trending-down');
            
            showToast('Solicitação rejeitada.');
            window.history.back();

        } catch (error) {
            console.error("Error rejecting refinance:", error);
            showToast('Erro ao rejeitar solicitação.', true);
            rejectBtn.disabled = false;
            rejectBtn.innerHTML = `<i data-lucide="x-circle"></i> <span data-lang-key="reject"></span>`;
            lucide.createIcons({ nodes: [rejectBtn.querySelector('i')] });
            applyLanguage(currentLang);
        }
    });
}

// Fin del bloque para pegar

    function showPaymentDetailModal(clientId, loanIndex, historyIndex) {
            const modal = document.getElementById('paymentDetailModal');
            const client = allClients.find(c => c.id === clientId);
            
            const loan = client?.loans ? client.loans[loanIndex] : null; 
            const payment = loan?.history ? loan.history[historyIndex] : null;

            if (!client || !loan || !payment) { 
                console.error("Error: Datos no encontrados", { clientId, loanIndex, historyIndex });
                showToast('Detalhe do pagamento não encontrado.', true);
                return;
            }
            
            // --- 1. NORMALIZACIÓN DE FECHAS (La corrección clave) ---
            // Convertimos la fecha del pago a un objeto Date estándar, venga de donde venga
            let paymentDateObj = null;
            if (payment.date?.seconds) {
                paymentDateObj = new Date(payment.date.seconds * 1000); // Es Timestamp de Firestore
            } else if (payment.date instanceof Date) {
                paymentDateObj = payment.date; // Es fecha local (recién creado)
            } else {
                paymentDateObj = new Date(payment.date); // Intento de fallback
            }

            const dateStr = paymentDateObj.toLocaleDateString('pt-BR');
            const timeStr = paymentDateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            // --- 2. LÓGICA DE EXCLUSIÓN ROBUSTA ---
            let canDelete = false;
            let deleteTitle = "Exclusão não permitida";
            
            // Obtenemos fecha de hoy sin hora para comparar
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const paymentDay = new Date(paymentDateObj);
            paymentDay.setHours(0, 0, 0, 0);

            // A. ¿Es el pago de HOY?
            const isToday = paymentDay.getTime() === today.getTime();

            // B. ¿Es el ÚLTIMO pago registrado? (Para no romper la matemática)
            // Ordenamos el historial temporalmente para verificar
            const sortedHistory = [...loan.history].sort((a, b) => {
                const timeA = a.date?.seconds ? a.date.seconds : (a.date instanceof Date ? a.date.getTime()/1000 : 0);
                const timeB = b.date?.seconds ? b.date.seconds : (b.date instanceof Date ? b.date.getTime()/1000 : 0);
                return timeA - timeB;
            });
            
            const lastPayment = sortedHistory[sortedHistory.length - 1];
            // Comparamos por referencia o por valor exacto y fecha
            const isLastPayment = (payment === lastPayment) || 
                                  (payment.amount === lastPayment.amount && paymentDateObj.getTime() === (lastPayment.date?.seconds ? lastPayment.date.seconds*1000 : lastPayment.date.getTime()));

            // C. Decisión final
            if (isToday && isLastPayment) {
                canDelete = true;
                deleteTitle = "Excluir este pagamento permanentemente";
            } else if (!isToday) {
                deleteTitle = "Só é possível excluir pagamentos feitos HOJE.";
            } else if (!isLastPayment) {
                deleteTitle = "Só é possível excluir o ÚLTIMO pagamento lançado.";
            }
            
            // --- 3. BOTONES (OCULTO POR SEGURIDAD: display: none) ---
            let deleteButtonHtml = `
                <button id="delete-payment-btn" class="btn-danger" 
                    ${canDelete ? '' : 'disabled'} 
                    title="${deleteTitle}" 
                    style="display: none !important; ${canDelete ? '' : 'opacity: 0.5; cursor: not-allowed; background-color: var(--text-secondary); border-color: var(--text-secondary);'}">
                    <i data-lucide="trash-2"></i> Excluir Pagamento
                </button>`;
            

            let receiptPreviewHtml = `<p class="no-items">Nenhum comprovante anexado.</p>`;
            let receiptButtonHtml = '';

            if (payment.receiptUrl) {
                receiptPreviewHtml = `<img src="${payment.receiptUrl}" alt="Comprovante" style="width: 100%; max-height: 60vh; object-fit: contain; border-radius: 8px; border: 1px solid var(--border-color);">`;
                receiptButtonHtml = `<a href="${payment.receiptUrl}" target="_blank" class="btn-primary" style="flex-grow:1;"><i data-lucide="download"></i> Baixar</a>`;
            }

            const invoiceButtonHtml = `<button id="generate-invoice-btn" class="btn-secondary" style="flex-grow:1;"><i data-lucide="receipt"></i> Fatura</button>`;

            // --- 4. RENDERIZADO ---
            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentDetailModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Detalhes do Pagamento</span>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="kpi-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 class="kpi-title">Data</h3>
                                <p class="kpi-value" style="font-size: 1.2em;">${dateStr} às ${timeStr}</p>
                            </div>
                            <div>
                                <h3 class="kpi-title" style="justify-content: flex-end;">Valor Pago</h3>
                                <p class="kpi-value green" style="font-size: 1.4em;">${money(payment.amount)}</p>
                            </div>
                        </div>
                        ${!canDelete ? `<p style="font-size:0.85em; color:var(--text-secondary); text-align:center; background:#f0f0f0; padding:5px; border-radius:4px;">${deleteTitle}</p>` : ''}
                    </div>
                    <h3 class="section-title" style="border: none;">Comprovante</h3>
                    <div class="kpi-card">
                        ${receiptPreviewHtml}
                    </div>
                </div>
                <div class="action-buttons" style="flex-wrap: wrap;">
                    <div style="display: flex; gap: 10px; width: 100%; margin-bottom: 10px;">
                        ${receiptButtonHtml}
                        ${invoiceButtonHtml}
                    </div>
                    ${deleteButtonHtml} <!-- El botón de borrar ocupa todo el ancho abajo -->
                </div>
            `;

            history.pushState({ modal: 'paymentDetailModal' }, 'Payment Details', '#payment-detail');
            modal.classList.add('active');

            lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });
            
            modal.querySelector('#closePaymentDetailModal').addEventListener('click', () => window.history.back());
            modal.querySelector('#generate-invoice-btn').addEventListener('click', () => generateInvoicePDF(client, payment));
            
            // --- 5. LISTENER DE BORRADO ---
            const deleteBtn = modal.querySelector('#delete-payment-btn');
            if (deleteBtn && canDelete) {
                deleteBtn.addEventListener('click', async () => {
                    showConfirmationModal(
                        'Excluir Pagamento?',
                        'Esta ação removerá o pagamento do saldo e do histórico. O valor da dívida aumentará. Tem certeza?',
                        async () => {
                            // Bloqueamos el botón
                            if(deleteBtn) {
                                deleteBtn.disabled = true;
                                deleteBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Excluindo...`;
                                lucide.createIcons({nodes: [deleteBtn.querySelector('i')]});
                            }
                            
                            try {
                                const clientRef = doc(db, 'companies', currentCompanyId, "clients", clientId);
                                
                                // Recargamos datos frescos para evitar conflictos
                                const clientIdx = allClients.findIndex(c => c.id === clientId);
                                if (clientIdx === -1) throw new Error("Cliente no encontrado en memoria");
                                const currentClientData = allClients[clientIdx];
                                const updatedLoans = JSON.parse(JSON.stringify(currentClientData.loans));
                                const currentLoan = updatedLoans[loanIndex];

                                // Borramos el pago del array
                                currentLoan.history.splice(historyIndex, 1);
                                
                                // RECALCULAMOS SALDOS (Lógica contable unificada)
                                const historyPaid = (currentLoan.history || [])
                                    .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration')
                                    .reduce((sum, h) => sum + (h.amount || 0), 0);
                                
                                const initialPaid = currentLoan.initialMigratedAmount || 0;
                                const newTotalPaid = historyPaid + initialPaid;
                                const installmentValue = currentLoan.originalInstallmentAmount || 1;
                                const totalInstallmentsStr = (currentLoan.installments || '0/0').split('/')[1] || '0';
                                const totalInstallments = parseInt(totalInstallmentsStr, 10);
                                
                                let paidInstallmentsCount = installmentValue > 0 ? Math.floor(newTotalPaid / installmentValue) : 0;
                                if (paidInstallmentsCount > totalInstallments) paidInstallmentsCount = totalInstallments;
                                
                                const newBalance = installmentValue > 0 ? newTotalPaid - (paidInstallmentsCount * installmentValue) : newTotalPaid;

                                currentLoan.paid = newTotalPaid;
                                currentLoan.paymentBalance = newBalance;
                                currentLoan.installments = `${paidInstallmentsCount}/${totalInstallmentsStr}`;

                                // Guardamos en Firebase
                                await updateDoc(clientRef, { loans: updatedLoans });

                                showToast('Pagamento excluído com sucesso!');
                                window.history.back(); // Cierra confirmación
                                window.history.back(); // Cierra detalle
                                
                                // Refrescamos vista
                                showClientDetails(clientId, loanIndex); 
                                
                            } catch (error) {
                                console.error("Erro ao excluir pagamento:", error);
                                showToast('Falha ao excluir o pagamento.', true);
                                if(deleteBtn) {
                                    deleteBtn.disabled = false;
                                    deleteBtn.innerHTML = `<i data-lucide="trash-2"></i> Excluir Pagamento`;
                                    lucide.createIcons({nodes: [deleteBtn.querySelector('i')]});
                                }
                                window.history.back(); // Cierra confirmación
                            }
                        }
                    );
                });
            }
        }    

             // --- [BLOQUE DE RECIBOS: SOLO DESCARGA (DISEÑO AJUSTADO)] ---

        // 1. GENERAR ESTADO DE CUENTA (Botón "Enviar Comprovante")
        async function generateStatusReceiptPDF(clientId, loanIndex) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: [80, 230] }); 
                
                const client = allClients.find(c => c.id === clientId);
                if (!client || !client.loans || !client.loans[loanIndex]) {
                    showToast("Erro: Dados não encontrados.", true);
                    return;
                }
                const loan = client.loans[loanIndex];
                const details = calculateLoanDetails(loan); 
                
                // --- CÁLCULOS FINANCIEROS ---
                const historyPaid = (loan.history || [])
                    .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration')
                    .reduce((sum, h) => sum + (parseFloat(h.amount) || 0), 0);
                
                const totalPaid = (loan.initialMigratedAmount || 0) + historyPaid;
                const totalDebt = (parseFloat(loan.totalLoan) || 0) + (details.lateFeesAccumulated || 0);
                const remainingBalance = Math.max(0, totalDebt - totalPaid);
                const totalInstallmentsStr = (loan.installments || "0/0").split('/')[1];
                const totalInstallments = parseInt(totalInstallmentsStr, 10) || 0;
                const installmentValue = parseFloat(loan.originalInstallmentAmount || loan.amount || 1);
                
                let paidInstallments = 0;
                if (installmentValue > 0) {
                    paidInstallments = Math.floor(totalPaid / installmentValue);
                }
                if (paidInstallments > totalInstallments) paidInstallments = totalInstallments;

                // Calcular Pago de HOY
                const todayStart = new Date();
                todayStart.setHours(0,0,0,0);
                const paidToday = (loan.history || []).reduce((sum, h) => {
                    let pDate = null;
                    if (h.date?.seconds) pDate = new Date(h.date.seconds * 1000);
                    else if (h.date instanceof Date) pDate = h.date;
                    
                    if (pDate && pDate >= todayStart && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration') {
                        return sum + (parseFloat(h.amount) || 0);
                    }
                    return sum;
                }, 0);

                const isEs = currentLang === 'es';
                const texts = {
                    title: isEs ? "ESTADO DE CUENTA" : "EXTRATO DO EMPRÉSTIMO",
                    company: currentCompanyData?.name || "LUMIX Finanças",
                    date: isEs ? "Fecha:" : "Data:",
                    client: isEs ? "Cliente:" : "Cliente:",
                    frequency: isEs ? "Modalidad:" : "Frequência:",
                    progress: isEs ? "Cuotas Pagadas:" : "Parcelas Pagas:", 
                    paid_msg: `${paidInstallments} / ${totalInstallments}`,
                    loan_total: isEs ? "Total Préstamo:" : "Total Empréstimo:",
                    late_fees: isEs ? "Multas/Mora:" : "Multas/Juros:",
                    total_paid: isEs ? "Total Pagado:" : "Total Pago:",
                    to_pay: isEs ? "RESTA POR PAGAR:" : "RESTA A PAGAR:", // Movido a la lista
                    val_installment: isEs ? "VALOR CUOTA" : "VALOR PARCELA",
                    val_paid_today: isEs ? "PAGADO HOY" : "PAGO HOJE",
                    footer: isEs ? "Generado por LUMIX Finanzas" : "Gerado por LUMIX Finanças",
                    late: isEs ? "ATRASADO" : "ATRASADO",
                    up_to_date: isEs ? "AL DÍA" : "EM DIA",
                    finished: isEs ? "FINALIZADO" : "FINALIZADO"
                };

                const freqMap = { 'daily': isEs?'DIARIO':'DIÁRIO', 'weekly': isEs?'SEMANAL':'SEMANAL', 'biweekly': isEs?'QUINCENAL':'QUINZENAL', 'monthly': isEs?'MENSUAL':'MENSAL' };
                const modalidade = freqMap[loan.paymentFrequency] || 'DIÁRIO';

                let y = 10;
                const centerX = 40;

                // PDF Content
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text(texts.company, centerX, y, { align: 'center' });
                y += 6;
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                doc.text(texts.title, centerX, y, { align: 'center' });
                y += 5; doc.setLineWidth(0.5); doc.line(5, y, 75, y); y += 5;

                doc.setFontSize(9);
                doc.setFont(undefined, 'bold'); doc.text(texts.date, 5, y);
                doc.setFont(undefined, 'normal'); doc.text(new Date().toLocaleDateString('pt-BR'), 75, y, { align: 'right' });
                y += 5;
                doc.setFont(undefined, 'bold'); doc.text(texts.client, 5, y);
                y += 4;
                doc.setFont(undefined, 'normal');
                const splitName = doc.splitTextToSize(client.name, 70);
                doc.text(splitName, 5, y);
                y += (splitName.length * 4) + 2;

                doc.setFont(undefined, 'bold'); doc.text(texts.frequency, 5, y);
                doc.setFont(undefined, 'normal'); doc.text(modalidade, 75, y, { align: 'right' });
                y += 8;

                doc.setFont(undefined, 'bold'); doc.text(texts.progress, 5, y);
                doc.text(texts.paid_msg, 75, y, { align: 'right' });
                y += 4;
                const barWidth = 70; 
                const progressPct = totalInstallments > 0 ? paidInstallments / totalInstallments : 0;
                doc.setFillColor(230, 230, 230); doc.rect(5, y, barWidth, 6, 'F');
                doc.setFillColor(111, 66, 193); doc.rect(5, y, barWidth * progressPct, 6, 'F');
                y += 10; doc.setLineWidth(0.2); doc.setDrawColor(200); doc.line(5, y, 75, y); y += 6;

                // --- TABLA FINANCIERA (MODIFICADA) ---
                const addRow = (label, value, color='#000000', bold=false) => {
                    doc.setFont(undefined, bold ? 'bold' : 'normal'); doc.setTextColor(color);
                    doc.text(label, 5, y); doc.text(money(value), 75, y, { align: 'right' });
                    y += 6;
                };
                
                doc.setFontSize(10);
                // 1. Total Préstamo
                addRow(texts.loan_total, loan.totalLoan);
                // 2. Mora (si hay)
                if (details.lateFeesAccumulated > 0) addRow(texts.late_fees, details.lateFeesAccumulated, '#dc3545');
                // 3. Total Pagado
                addRow(texts.total_paid, totalPaid, '#28a745');
                
                // 4. Resta por Pagar (MOVIDO AQUÍ, en la lista)
                addRow(texts.to_pay, remainingBalance, '#d97706', true); // Naranja/Negrita
                
                y += 4;
                
                // --- CAJA GRANDE (LO QUE PAGÓ HOY o VALOR CUOTA) ---
                const showPaidToday = paidToday > 0;
                const bigBoxValue = showPaidToday ? paidToday : installmentValue;
                const bigBoxLabel = showPaidToday ? texts.val_paid_today : texts.val_installment;
                const bigBoxColor = showPaidToday ? '#28a745' : '#6f42c1'; // Verde si pagó, Morado si es informativo

                doc.setFillColor(245, 245, 245); doc.rect(5, y - 4, 70, 14, 'F');
                doc.setFont(undefined, 'bold'); doc.setTextColor(0);
                doc.text(bigBoxLabel, centerX, y + 1, { align: 'center' }); // Etiqueta (Ej: PAGO HOJE)
                
                doc.setFontSize(14); doc.setTextColor(bigBoxColor);
                doc.text(money(bigBoxValue), centerX, y + 7, { align: 'center' }); // Valor
                y += 18;

                // Estado
                let statusColor = '#28a745'; 
                let statusText = texts.up_to_date; 
                let bgColor = '#d4edda';
                let subStatusText = ''; // Variable para los días

                if (details.status === 'late') { 
                    statusColor = '#721c24'; 
                    statusText = texts.late; 
                    bgColor = '#f8d7da'; 
                    
                    // Lógica para mostrar días
                    const daysLabel = currentLang === 'es' ? 'Días' : (currentLang === 'en' ? 'Days' : 'Dias');
                    subStatusText = `(${details.lateDays} ${daysLabel})`;
                }
                else if (details.status === 'finished') { 
                    statusColor = '#004085'; 
                    statusText = texts.finished; 
                    bgColor = '#cce5ff'; 
                }

                // Ajustamos la altura de la caja si hay subtítulo (días)
                const boxHeight = subStatusText ? 16 : 12;

                doc.setDrawColor(statusColor); 
                doc.setFillColor(bgColor);
                doc.roundedRect(5, y, 70, boxHeight, 2, 2, 'FD');
                
                doc.setFontSize(12); 
                doc.setFont(undefined, 'bold'); 
                doc.setTextColor(statusColor);

                if (subStatusText) {
                    // Si hay atraso, imprimimos en dos líneas
                    doc.text(statusText, centerX, y + 6, { align: 'center' }); // ATRASADO
                    doc.setFontSize(10); // Un poco más pequeño para los días
                    doc.text(subStatusText, centerX, y + 12, { align: 'center' }); // (X Dias)
                } else {
                    // Si es normal, centrado simple
                    doc.text(statusText, centerX, y + 8, { align: 'center' });
                }
                
                y += (boxHeight + 8);

                doc.setFontSize(8); doc.setTextColor(150); doc.setFont(undefined, 'normal');
                doc.text(texts.footer, centerX, y, { align: 'center' });

                const fileName = `extrato_${client.name.replace(/\s/g, '_')}.pdf`;
                doc.save(fileName);
                showToast(isEs ? "Recibo descargado." : "Recibo baixado.");

            } catch (err) {
                console.error("Erro PDF:", err);
                showToast("Erro ao gerar extrato.", true);
            }
        }

        // 2. GENERAR FACTURA INDIVIDUAL (Botón "Fatura")
        async function generateInvoicePDF(clientData, payment) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: [80, 230] }); 

                const realClient = allClients.find(c => c.id === clientData.id) || clientData;
                
                let activeLoan = null;
                if (realClient.loans) {
                    activeLoan = realClient.loans.find(l => l.history && l.history.some(h => 
                        h === payment || (h.amount === payment.amount && h.date?.seconds === payment.date?.seconds)
                    ));
                    if (!activeLoan) activeLoan = realClient.loans.find(l => l.status !== 'finished');
                    if (!activeLoan && realClient.loans.length > 0) activeLoan = realClient.loans[realClient.loans.length - 1];
                }

                let remainingBalance = 0;
                let paidInstallmentsMsg = "0 / 0";
                let totalLoanVal = 0;
                let totalPaidVal = 0;

                if (activeLoan) {
                    const details = calculateLoanDetails(activeLoan);
                    const historyPaid = (activeLoan.history || [])
                        .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration')
                        .reduce((sum, h) => sum + (parseFloat(h.amount) || 0), 0);
                    
                    const initialPaid = activeLoan.initialMigratedAmount || 0;
                    totalPaidVal = initialPaid + historyPaid;
                    totalLoanVal = (parseFloat(activeLoan.totalLoan) || 0) + (details.lateFeesAccumulated || 0);
                    remainingBalance = Math.max(0, totalLoanVal - totalPaidVal);

                    const totalInstallmentsStr = (activeLoan.installments || "0/0").split('/')[1];
                    const totalInstallments = parseInt(totalInstallmentsStr, 10) || 0;
                    const installmentValue = parseFloat(activeLoan.originalInstallmentAmount || activeLoan.amount || 1);
                    
                    let paidCount = 0;
                    if (installmentValue > 0) paidCount = Math.floor(totalPaidVal / installmentValue);
                    if (paidCount > totalInstallments) paidCount = totalInstallments;
                    paidInstallmentsMsg = `${paidCount} / ${totalInstallments}`;
                }

                const isEs = currentLang === 'es';
                const texts = {
                    title: isEs ? "RECIBO DE PAGO" : "RECIBO DE PAGAMENTO",
                    company: currentCompanyData?.name || "LUMIX Finanças",
                    date: isEs ? "Fecha Pago:" : "Data Pagto:",
                    client: isEs ? "Cliente:" : "Cliente:",
                    method: isEs ? "Método:" : "Método:",
                    collector: isEs ? "Cobrador:" : "Cobrador:",
                    signature: isEs ? "Firma del Recibidor" : "Assinatura do Recebedor",
                    summary_title: isEs ? "ESTADO DEL PRÉSTAMO" : "SITUAÇÃO DO EMPRÉSTIMO",
                    progress: isEs ? "Cuotas Pagadas:" : "Parcelas Pagas:", 
                    paid_msg: paidInstallmentsMsg,
                    loan_total: isEs ? "Total Préstamo:" : "Total Empréstimo:",
                    total_paid_global: isEs ? "Total Pagado (Acum.):" : "Total Pago (Acum.):",
                    to_pay: isEs ? "RESTA PAGAR:" : "RESTA PAGAR:"
                };

                let y = 10;
                const centerX = 40;

                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text(texts.company, centerX, y, { align: 'center' });
                y += 6;
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                doc.text(texts.title, centerX, y, { align: 'center' });
                y += 5; doc.setLineWidth(0.5); doc.line(5, y, 75, y); y += 5;

                doc.setFontSize(9);
                let dateStr = "N/A", timeStr = "";
                if(payment.date) {
                    let d = payment.date.seconds ? new Date(payment.date.seconds * 1000) : (payment.date instanceof Date ? payment.date : new Date(payment.date));
                    dateStr = d.toLocaleDateString('pt-BR');
                    timeStr = d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                }
                
                doc.setFont(undefined, 'bold'); doc.text(texts.date, 5, y);
                doc.setFont(undefined, 'normal'); doc.text(`${dateStr} ${timeStr}`, 75, y, { align: 'right' });
                y += 6;

                doc.setFont(undefined, 'bold'); doc.text(texts.collector, 5, y);
                doc.setFont(undefined, 'normal'); doc.text(currentCollectorData?.name || 'N/A', 75, y, { align: 'right' });
                y += 6;

                doc.setFont(undefined, 'bold'); doc.text(texts.client, 5, y);
                y += 4;
                doc.setFont(undefined, 'normal');
                const splitName = doc.splitTextToSize(realClient.name, 70);
                doc.text(splitName, 5, y);
                y += (splitName.length * 4) + 2;

                let methodText = payment.method === 'dinheiro' ? (isEs ? 'Efectivo' : 'Dinheiro') : (payment.method === 'pix' ? 'PIX' : 'Cartão');
                doc.setFont(undefined, 'bold'); doc.text(texts.method, 5, y);
                doc.setFont(undefined, 'normal'); doc.text(methodText.toUpperCase(), 75, y, { align: 'right' });
                y += 8;

                doc.setFillColor(240, 240, 240); doc.rect(5, y - 4, 70, 12, 'F');
                doc.setFontSize(14); doc.setFont(undefined, 'bold');
                doc.text(money(payment.amount), centerX, y + 4, { align: 'center' });
                y += 12;

                y += 5; doc.setLineWidth(0.2); doc.setLineDash([1, 1], 0); doc.line(5, y, 75, y); doc.setLineDash([]); y += 6;

                if (activeLoan) {
                    doc.setFontSize(10); doc.setFont(undefined, 'bold');
                    doc.text(texts.summary_title, centerX, y, { align: 'center' });
                    y += 6;

                    doc.setFontSize(9);
                    doc.text(texts.progress, 5, y);
                    doc.text(texts.paid_msg, 75, y, { align: 'right' });
                    y += 4;
                    const barWidth = 70; 
                    const totalInst = parseInt((activeLoan.installments || "0/0").split('/')[1], 10) || 1;
                    const paidInst = parseInt((activeLoan.installments || "0/0").split('/')[0], 10) || 0;
                    const progressPct = totalInst > 0 ? paidInst / totalInst : 0;
                    doc.setFillColor(230, 230, 230); doc.rect(5, y, barWidth, 5, 'F');
                    doc.setFillColor(111, 66, 193); doc.rect(5, y, barWidth * progressPct, 5, 'F');
                    y += 8;

                    const addRow = (label, value, color='#000000', bold=false) => {
                        doc.setFont(undefined, bold ? 'bold' : 'normal'); doc.setTextColor(color);
                        doc.text(label, 5, y); doc.text(money(value), 75, y, { align: 'right' });
                        y += 5;
                    };
                    
                    doc.setFontSize(9);
                    addRow(texts.loan_total, totalLoanVal);
                    addRow(texts.total_paid_global, totalPaidVal, '#28a745');
                    
                    y += 2;
                    doc.setFont(undefined, 'bold'); doc.setTextColor(0);
                    doc.text(texts.to_pay, 5, y+4); 
                    doc.setFontSize(12); doc.setTextColor(111, 66, 193);
                    doc.text(money(remainingBalance), 75, y+4, { align: 'right' });
                    y += 10;
                }

                y += 10; doc.setLineWidth(0.2); doc.setTextColor(0); doc.setDrawColor(0);
                doc.line(15, y, 65, y); y += 4;
                doc.setFontSize(8); doc.setFont(undefined, 'normal'); doc.setTextColor(100);
                doc.text(texts.signature, centerX, y, { align: 'center' });

                // --- SOLO DESCARGAR ---
                const fileName = `fatura_${realClient.name.replace(/\s/g, '_')}.pdf`;
                doc.save(fileName);
                showToast(isEs ? "Fatura descargada." : "Fatura baixada.");
                
            } catch (error) {
                console.error("Erro fatura:", error);
                showToast("Erro ao gerar fatura.", true);
            }
        }

        
        

        // Ahora sí, la función applyTheme empieza limpia fuera de la anterior
        function applyTheme(theme) {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            body.classList.toggle('dark-mode', theme === 'dark');
            if (themeToggle) {
                // Aseguramos que al cambiar el icono, el texto se mantenga GRANDE (0.85em)
                themeToggle.innerHTML = `<i data-lucide="${theme === 'dark' ? 'sun' : 'moon'}" style="width: 24px; height: 24px;"></i><span style="font-size: 0.85em; font-weight: 700; margin-top: 2px;">Tema</span>`;
                lucide.createIcons({ nodes: [themeToggle] });
            }
        }

        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                // CAMBIO IMPORTANTE: Usamos innerHTML para permitir <br>
                if (translations[lang] && translations[lang][key]) {
                    el.innerHTML = translations[lang][key]; 
                }
            });
            // ... resto de la función ... (si hay más código como el placeholder, déjalo)
            const searchInput = document.getElementById('client-search-input');
            if(searchInput) searchInput.placeholder = translations[lang].searchClient;
        }

        

        /**
         * INSTRUCCIÓN 1: Reemplaza tu función 'updateRouteProgress' (aprox. línea 847)
         * con este bloque de código completo.
         */
        function updateRouteProgress() {
            let totalRouteCount = 0;
            let paidTodayCount = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayOfWeek = today.getDay();
            const dayOfMonth = today.getDate();

            const getPaymentDate = (dateObj) => {
                if (!dateObj) return null;
                if (typeof dateObj.toDate === 'function') return dateObj.toDate();
                if (dateObj instanceof Date) return dateObj;
                if (typeof dateObj === 'string') { const d = new Date(dateObj); if (!isNaN(d.getTime())) return d; }
                return null;
            };

            allClients.forEach(client => {
                if (!client.loans) return;
                
                client.loans.forEach(loan => {
                     const details = calculateLoanDetails(loan);
                     
                     // 1. Verificar si PAGÓ HOY
                     let hasPaidToday = false;
                     if (loan.history) {
                         hasPaidToday = loan.history.some(h => {
                             if (h.status === 'postponed' || h.status === 'rejected' || h.status === 'pending_verification' || h.method === 'migration') return false;
                             const pDate = getPaymentDate(h.date);
                             return pDate && pDate >= today;
                         });
                     }

                     // 2. Verificar si pertenece a la RUTA DE HOY
                     let isInRoute = false;
                     const frequency = loan.paymentFrequency || 'daily';
                     const paymentDays = loan.paymentDays || [];

                     if (frequency === 'daily') {
                         // --- CORRECCIÓN: IGUAL QUE LA LISTA VISUAL ---
                         // Si es diario, entra SIEMPRE en la ruta (no importa el día de la semana)
                         isInRoute = true; 
                     } else if (frequency === 'weekly') {
                         isInRoute = paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfWeek;
                     } else if (frequency === 'biweekly') {
                         if (paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfWeek) {
                             const startDate = loan.startDate?.seconds ? new Date(loan.startDate.seconds * 1000) : new Date(loan.startDate);
                             startDate.setHours(0,0,0,0);
                             const diffTime = Math.abs(today - startDate);
                             const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                             if (Math.floor(diffDays / 7) % 2 === 0) isInRoute = true;
                         }
                     } else if (frequency === 'monthly') {
                         isInRoute = paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfMonth;
                     }

                     const isLate = details.status === 'late';
                     const isFinished = details.status === 'finished';

                     // REGLA PARA NO SUMAR FINALIZADOS ANTIGUOS:
                     if (isFinished && !hasPaidToday) return;

                     // Entra en el conteo si: (Es ruta de hoy O es Atrasado O ya pagó hoy)
                     if (isInRoute || isLate || hasPaidToday) {
                         totalRouteCount++;
                         if (hasPaidToday) {
                             paidTodayCount++;
                         }
                     }
                });
            });

            // Renderizar la barra
            const progressPercentage = totalRouteCount > 0 ? (paidTodayCount / totalRouteCount) * 100 : 0;
            const progressBar = document.getElementById('route-progress-bar');
            const progressText = document.getElementById('route-progress-text');

            if (progressBar && progressText) {
                const circleCircumference = 2 * Math.PI * 54;
                const strokeDashoffset = circleCircumference - (progressPercentage / 100) * circleCircumference;
                progressBar.style.strokeDashoffset = strokeDashoffset;
                progressText.textContent = `${paidTodayCount}/${totalRouteCount}`;
            }
        }

        

        function updateDashboard(clientsForDashboard) { 
            const kpiGoal = document.getElementById('kpi-goal');
            const kpiReceived = document.getElementById('kpi-received');
            const kpiRemaining = document.getElementById('kpi-remaining');
            
            if (!kpiGoal) return;

            let calculatedDailyGoal = 0;      
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayOfWeek = today.getDay(); 
            const dayOfMonth = today.getDate();
            const todayStr = today.toLocaleDateString('pt-BR');

            const checkIsToday = (timestamp) => {
                if (!timestamp) return false;
                let d;
                if (timestamp.seconds) d = new Date(timestamp.seconds * 1000);
                else if (timestamp instanceof Date) d = timestamp;
                else d = new Date(timestamp);
                return !isNaN(d) && d.toLocaleDateString('pt-BR') === todayStr;
            };

            // Iteramos sobre TODOS los clientes para calcular la Meta Global Fija
            allClients.forEach(client => {
                (client.loans || []).forEach(loan => {
                    const isFinished = loan.status === 'finished';

                    // Cuánto ha pagado hoy
                    const paidToday = (loan.history || []).reduce((sum, h) => {
                        if (h.status !== 'rejected' && h.status !== 'pending_verification' && h.method !== 'migration' && checkIsToday(h.date)) {
                            return sum + (parseFloat(h.amount) || 0);
                        }
                        return sum;
                    }, 0);

                    if (isFinished && paidToday === 0) return;

                    // --- LÓGICA DE FRECUENCIA PARA LA META ---
                    let isPaymentDay = false;
                    const frequency = loan.paymentFrequency || 'daily';
                    const paymentDays = loan.paymentDays || [];

                    if (frequency === 'daily') {
                        isPaymentDay = paymentDays.some(d => parseInt(d) === dayOfWeek);
                    } else if (frequency === 'weekly') {
                        isPaymentDay = paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfWeek;
                    } else if (frequency === 'biweekly') {
                        if (paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfWeek) {
                            const startDate = loan.startDate?.seconds ? new Date(loan.startDate.seconds * 1000) : new Date(loan.startDate);
                            startDate.setHours(0,0,0,0);
                            const diffTime = Math.abs(today - startDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (Math.floor(diffDays / 7) % 2 === 0) {
                                isPaymentDay = true;
                            }
                        }
                    } else if (frequency === 'monthly') {
                        isPaymentDay = paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfMonth;
                    }

                    // Valor de la cuota
                    let installmentValue = parseFloat(loan.amount) || 0;
                    if (installmentValue === 0 && loan.originalInstallmentAmount) {
                        installmentValue = parseFloat(loan.originalInstallmentAmount);
                    }

                    // 1. Calcular deuda total actual
                    const totalPaidAllTime = (loan.history || []).reduce((sum, h) => 
                        (h.status === 'approved' || h.method === 'migration') ? sum + (h.amount || 0) : sum, 0
                    );
                    const totalLoan = parseFloat(loan.totalLoan) || 0;
                    const currentBalance = Math.max(0, totalLoan - totalPaidAllTime);
                    
                    // 2. Calcular deuda al INICIO del día
                    const debtAtStartOfDay = currentBalance + paidToday;
                    
                    // 3. La meta es la cuota, pero no puede ser mayor a lo que debía al amanecer.
                    let goalForThisClient = installmentValue;
                    if (goalForThisClient > debtAtStartOfDay) {
                        goalForThisClient = debtAtStartOfDay;
                    }

                    // Solo sumamos a la meta si hoy es día de pago según la frecuencia
                    if (isPaymentDay) {
                        calculatedDailyGoal += goalForThisClient;
                    }
                });
            });

            // Renderizar Meta
            kpiGoal.textContent = money(calculatedDailyGoal);
            
            // Renderizar Recibido Hoy
            const { dailyTotal } = calculateDailyTotals();
            kpiReceived.textContent = money(dailyTotal);

            // Renderizar Clientes Restantes (CORREGIDO: CUENTA TARJETAS)
            if (!clientsForDashboard || clientsForDashboard.length === 0) {
                 kpiRemaining.textContent = 0;
            } else {
                // Filtramos solo los que NO han pagado hoy
                const remainingItems = clientsForDashboard.filter(item => {
                    // Ignorar finalizados que no pagaron hoy (aunque updateTodaysRouteList ya los filtra)
                    if (item.loan.status === 'finished') return false;
                    
                    const loan = item.loan;
                    const paidTodayVal = (loan.history || []).reduce((sum, h) => {
                        if (h.status !== 'rejected' && h.status !== 'pending_verification' && h.method !== 'migration' && checkIsToday(h.date)) {
                            return sum + (parseFloat(h.amount) || 0);
                        }
                        return sum;
                    }, 0);
                    
                    // Si pagó 0 hoy, sigue contando como restante
                    return paidTodayVal === 0;
                });
                
                // CORRECCIÓN: Usamos .length directamente. 
                // Esto asegura que coincida exactamente con el número de tarjetas visuales.
                kpiRemaining.textContent = remainingItems.length;
            }
        }
        
        

    function updateProfileView(collectorData = null) {
            const dailyTotalEl = document.getElementById('kpi-daily-total');
            const capitalTotalEl = document.getElementById('kpi-capital-total'); 
            const distributedCapitalEl = document.getElementById('kpi-distributed-capital'); 
            const dailyCashEl = document.getElementById('kpi-daily-cash');
            const dailyDigitalEl = document.getElementById('kpi-daily-digital');
            const totalPatrimonioEl = document.getElementById('kpi-total-patrimonio'); 
            
            if (!dailyTotalEl || !capitalTotalEl || !distributedCapitalEl || !totalPatrimonioEl) return; 

            let totalLoansMade = 0; 
            let totalPaymentsReceived = 0; 
            let totalDistributedCapital_Outstanding = 0; 
            
            const { dailyTotal, dailyTotalCash, dailyTotalDigital } = calculateDailyTotals();
            
            const collectorId = typeof currentCollectorUsername !== 'undefined' ? currentCollectorUsername : (collectorData?.id);
            const collectorClients = allClients.filter(c => c.collectorId === collectorId);

            collectorClients.forEach(client => {
                (client.loans || []).forEach(loan => {
                    
                    if (!loan.migrationDate) {
                        if (loan.principalAmount) {
                            totalLoansMade += loan.principalAmount;
                            // CORRECCIÓN: NO SUMAMOS EL SEGURO AQUÍ.
                            // Dejamos que el préstamo reste el total completo, "escondiendo" el seguro.
                        } else if (loan.totalLoan && client.interestRate) { 
                            totalLoansMade += (loan.totalLoan / (1 + (client.interestRate / 100)));
                        }
                    }

                    (loan.history || []).forEach(h => {
                        if (h.date?.seconds && h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration') {
                            totalPaymentsReceived += (h.amount || 0);
                        }
                    });
                    
                    const loanDetails = calculateLoanDetails(loan);
                    if (loanDetails.status !== 'finished') {
                        const totalPaidForThisLoan = (loan.history || [])
                            .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed')
                            .reduce((sum, h) => sum + (h.amount || 0), 0);
                        const outstandingBalance = (loan.totalLoan || 0) - totalPaidForThisLoan;
                        totalDistributedCapital_Outstanding += outstandingBalance;
                    }
                });
            });
                        
            const totalExpenses = allExpenses.reduce((sum, expense) => sum + expense.value, 0);
            
            const currentStartingCapital = (collectorData && collectorData.startingCapitalOnHand !== undefined) 
                ? collectorData.startingCapitalOnHand 
                : (collectorData && collectorData.startingCapital) || 0;

            // === CORRECCIÓN CRÍTICA ===
            // Solo restamos los retiros de CAPITAL. 
            // Ignoramos los de SEGURO (type !== 'insurance') porque ese dinero es "invisible" en esta caja.
            const totalSettledByThisCollector = allSettlements
                .filter(s => s.status === 'approved' && s.type !== 'insurance') 
                .reduce((sum, s) => sum + (s.amount || 0), 0);

            const totalCapitalInjected = allCapitalInjections
                .filter(i => i.status === 'approved')
                .reduce((sum, i) => sum + (i.amount || 0), 0);

            // Fórmula Limpia: Inicio + Aportes + Pagos - Préstamos - Gastos - Retiros(Solo Capital)
            const capitalTotal = currentStartingCapital + totalCapitalInjected + totalPaymentsReceived - totalLoansMade - totalExpenses - totalSettledByThisCollector;
            
            if (typeof currentCapitalOnHand !== 'undefined') {
                currentCapitalOnHand = capitalTotal; 
            }

            dailyTotalEl.textContent = money(dailyTotal);
            capitalTotalEl.textContent = money(capitalTotal); 
            distributedCapitalEl.textContent = money(totalDistributedCapital_Outstanding); 
            
            const totalPatrimonio = capitalTotal + totalDistributedCapital_Outstanding;
            totalPatrimonioEl.textContent = money(totalPatrimonio); 
            
            if(dailyCashEl) dailyCashEl.textContent = money(dailyTotalCash);
            if(dailyDigitalEl) dailyDigitalEl.textContent = money(dailyTotalDigital);
    }


        
        


        // Nueva función mejorada que calcula días de atraso Y mora

    
    function calculateLoanDetails(loan) {
           let details = {
               lateDays: 0,
               lateFeesAccumulated: 0,
               status: 'pending', 
               nextDueDate: null, 
               amountDueToday: 0 
           };

           // --- 1. CALCULAR TOTAL PAGADO REAL ---
           const currentTotalPaid = (loan.history || [])
               .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed')
               .reduce((sum, h) => sum + (h.amount || 0), 0);

           // Si ya cubrió el total, finalizado
           // CORRECCIÓN: Eliminamos "loan.status === 'finished'" para obligar al sistema a recalcular si el saldo cambia.
           if (!loan || !loan.totalLoan || (currentTotalPaid >= loan.totalLoan - 0.1)) {
               details.status = 'finished';
               return details;
           }
           

           // --- 2. CONFIGURAR FECHAS ---
           const today = new Date();
           today.setHours(0, 0, 0, 0); // Hoy a las 00:00
           
           let startDateObj = null;
           if (loan.startDate) {
               if (loan.startDate.seconds) startDateObj = new Date(loan.startDate.seconds * 1000);
               else if (loan.startDate instanceof Date) startDateObj = loan.startDate;
               else if (typeof loan.startDate === 'string') startDateObj = new Date(loan.startDate);
           }

           if (!startDateObj || isNaN(startDateObj.getTime())) return details;
           
           startDateObj.setHours(0, 0, 0, 0);
           
           // --- CORRECCIÓN CLAVE: EMPEZAR A CONTAR DESDE EL DÍA SIGUIENTE ---
           // El día que se crea el préstamo NO se cobra. El primer cobro posible es mañana.
           let checkDate = new Date(startDateObj); 
           checkDate.setDate(checkDate.getDate() + 1); 
           
           let accumulatedLateDays = 0;
           let accumulatedLateFees = 0;
           const dailyLateRate = (loan.lateFeeRate || 0) / 100;
           const installmentAmount = loan.originalInstallmentAmount || 0;
           let installmentsDueCount = 0; 
           
           // Límite de seguridad
           let stopDate = new Date(today);
           stopDate.setDate(stopDate.getDate() + 60);

           if (checkDate > stopDate) return details;

           // --- 3. BUCLE DE COMPROBACIÓN ---
           while (checkDate <= stopDate) {
               const dayOfWeek = checkDate.getDay();
               const dayOfMonth = checkDate.getDate();
               const formattedDate = `${String(checkDate.getDate()).padStart(2, '0')}/${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
               const isHoliday = typeof nationalHolidays !== 'undefined' ? nationalHolidays.includes(formattedDate) : false;
               
               const frequency = loan.paymentFrequency || 'daily';
               let isPaymentDay = false;
               const pDays = loan.paymentDays || [];
               
               if (frequency === 'daily') isPaymentDay = pDays.some(d => String(d) === String(dayOfWeek));
               else if (frequency === 'weekly') isPaymentDay = pDays.length > 0 && String(pDays[0]) === String(dayOfWeek);
               else if (frequency === 'monthly') isPaymentDay = pDays.length > 0 && String(pDays[0]) === String(dayOfMonth);

               if (isPaymentDay && !isHoliday) {
                   
                   // === ANÁLISIS DEL PASADO (AYER HACIA ATRÁS) ===
                   if (checkDate.getTime() < today.getTime()) {
                       installmentsDueCount++; 
                       const expectedPaidByThisDate = installmentsDueCount * installmentAmount;
                       
                       // Compara deuda acumulada vs pagado total
                       const outstandingDueAmount = Math.max(0, expectedPaidByThisDate - currentTotalPaid);

                       // Si debe algo del pasado, suma un día de atraso
                       if (outstandingDueAmount > 0.9) { 
                           accumulatedLateDays++; 
                           if (dailyLateRate > 0) accumulatedLateFees += (outstandingDueAmount * dailyLateRate);
                       }
                   } 
                   
                   // === ANÁLISIS DEL PRESENTE (HOY) ===
                   else if (checkDate.getTime() === today.getTime()) {
                       const expectedTotalIncludingToday = (installmentsDueCount + 1) * installmentAmount;
                       
                       // Si debe la cuota de HOY, se marca el monto, pero NO aumenta 'accumulatedLateDays'
                       if (currentTotalPaid < expectedTotalIncludingToday - 0.1) {
                           details.amountDueToday = installmentAmount;
                       }
                       
                       if (!details.nextDueDate) details.nextDueDate = new Date(checkDate);
                   } 
                   
                   // === FUTURO ===
                   else if (checkDate > today && !details.nextDueDate) {
                       details.nextDueDate = new Date(checkDate);
                   }
               }
               
               if (details.nextDueDate && checkDate > today) break;
               checkDate.setDate(checkDate.getDate() + 1);
           }
           
           details.lateDays = accumulatedLateDays;
           details.lateFeesAccumulated = accumulatedLateFees;
           
           // --- 4. DETERMINAR ESTADO FINAL ---
           if (currentTotalPaid >= loan.totalLoan - 0.1) {
               details.status = 'finished';
           } 
           else if (accumulatedLateDays > 0) { 
               // Solo si debe días del PASADO (ayer o antes) se pone ROJO (Atrasado)
               details.status = 'late';
           } 
           else if (details.amountDueToday > 0) { 
               // Si debe HOY pero está al día con el pasado -> AMARILLO (Pendiente)
               details.status = 'pending'; 
           } 
           else {
               // Al día (o pagado hoy)
               details.status = 'pending'; 
           }
           
           return details;
       }



        function renderClientCards(container, clientsData) {
            if (!container) return;
            
            // --- CAMBIO AQUÍ: TEXTO TRADUCIDO ---
            if (!clientsData || clientsData.length === 0) {
                // Usamos la traducción o un texto por defecto si falla
                const msg = (translations[currentLang] && translations[currentLang].noClientsFound) ? translations[currentLang].noClientsFound : 'Nenhum cliente encontrado.';
                container.innerHTML = `<div class="no-items" data-lang-key="noClientsFound">${msg}</div>`;
                return;
            }
            // -------------------------------------

            container.innerHTML = ''; 

            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            clientsData.forEach(item => {
               const { client, loan, loanIndex } = item;
                
                const details = calculateLoanDetails(loan);
                const displayLoan = { 
                    ...loan, 
                    status: details.status,
                    lateDays: details.lateDays,
                    amountDueToday: details.amountDueToday || 0
                };

                const totalPaidSoFar = (loan.history || [])
                    .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed')
                    .reduce((sum, h) => sum + (h.amount || 0), 0);

                const totalDebt = (loan.totalLoan || 0) + (loan.lateFeesAccumulated || 0);
                const remainingBalance = Math.max(0, totalDebt - totalPaidSoFar);

                const getPaymentDate = (dateObj) => {
                    if (!dateObj) return null;
                    if (typeof dateObj.toDate === 'function') return dateObj.toDate();
                    if (dateObj instanceof Date) return dateObj;
                    return null;
                };

                let amountPaidToday = 0;
                if (displayLoan.history && displayLoan.history.length > 0) {
                     amountPaidToday = displayLoan.history.reduce((sum, h) => {
                        if (h.status === 'postponed' || h.status === 'rejected' || h.status === 'pending_verification' || h.method === 'migration') return sum;
                        const paymentDate = getPaymentDate(h.date);
                        if (paymentDate && paymentDate >= todayStart) {
                            return sum + (parseFloat(h.amount) || 0);
                        }
                        return sum;
                    }, 0);
                }

                const hasPaidToday = amountPaidToday > 0;
                const originalInstallmentValue = displayLoan.amount || 0;
                
                let mainValueToDisplay = 0;
                let secondaryLabelHtml = ''; 
                let mainValueColor = 'var(--accent-green)'; 
                let bottomStatusText = '';
                let bottomStatusStyle = '';

                const freqMap = { 
                    'daily': translations[currentLang].daily, 
                    'weekly': translations[currentLang].weekly, 
                    'biweekly': translations[currentLang].biweekly,
                    'monthly': translations[currentLang].monthly 
                };
                const rawFreq = displayLoan.paymentFrequency || 'daily';
                const freqText = (freqMap[rawFreq] || rawFreq).toUpperCase();

                // --- LÓGICA DE COLORES DE ESTADO ---
                const daysLate = displayLoan.lateDays || 0;
                let avatarHex = '6f42c1'; 
                let reputationLabel = '';
                let reputationColor = '#6f42c1';

                const langCode = (typeof currentLang !== 'undefined' && currentLang) ? currentLang : 'pt';
                const statusLabels = {
                    pt: { exc: 'Excelente', med: 'Médio', bad: 'Ruim', fin: 'Finalizado' },
                    es: { exc: 'Excelente', med: 'Regular', bad: 'Malo', fin: 'Finalizado' },
                    en: { exc: 'Excellent', med: 'Medium', bad: 'Bad', fin: 'Finished' }
                };
                const txt = statusLabels[langCode] || statusLabels.pt;

                if (displayLoan.status === 'finished') {
                    avatarHex = '4338ca'; reputationLabel = txt.fin; reputationColor = '#4338ca';
                } else if (daysLate < 2) { 
                    avatarHex = '28a745'; reputationLabel = txt.exc; reputationColor = '#28a745';
                } else if (daysLate < 5) { 
                    avatarHex = 'f59e0b'; reputationLabel = txt.med; reputationColor = '#d97706';
                } else { 
                    avatarHex = 'dc3545'; reputationLabel = txt.bad; reputationColor = '#dc3545';
                }

                // --- ETIQUETA NUEVO / RENOVADO ---
                let typeLabel = '';
                let typeColor = 'transparent';
                let isLoanFromToday = false; 
                
                let loanStartDate = null;
                if (loan.startDate) {
                     if (loan.startDate.seconds) loanStartDate = new Date(loan.startDate.seconds * 1000);
                     else if (loan.startDate instanceof Date) loanStartDate = loan.startDate;
                     else loanStartDate = new Date(loan.startDate);
                }

                if (loanStartDate) {
                    isLoanFromToday = loanStartDate.getDate() === todayStart.getDate() &&
                                            loanStartDate.getMonth() === todayStart.getMonth() &&
                                            loanStartDate.getFullYear() === todayStart.getFullYear();
                    
                    if (isLoanFromToday) {
                        const totalLoansCount = client.loans ? client.loans.length : 0;
                        const isEs = langCode === 'es';
                        
                        if (totalLoansCount > 1) {
                            typeLabel = 'RENOVADO'; 
                            typeColor = 'var(--accent-purple)'; 
                        } else {
                            typeLabel = isEs ? 'NUEVO' : 'NOVO';
                            typeColor = '#0ea5e9'; 
                        }
                    }
                }

                if (displayLoan.status === 'finished') {
                    mainValueToDisplay = hasPaidToday ? amountPaidToday : 0; 
                    secondaryLabelHtml = `<span style="font-size: 0.9em; color: var(--text-secondary); font-weight: 700;">FINALIZADO</span>`;
                    bottomStatusText = hasPaidToday ? translations[currentLang].statusPaidToday : '-';
                    bottomStatusStyle = 'color: #4338ca; background-color: #e0e7ff; font-weight: 700; border: 1px solid #c7d2fe;';
                    mainValueColor = '#4338ca';

                } else if (hasPaidToday) {
                    mainValueToDisplay = amountPaidToday;
                    secondaryLabelHtml = `<span style="font-size: 0.85em; color: var(--text-secondary); font-weight: 700; margin-top: 4px;">PARCELA: ${money(originalInstallmentValue)}</span>`;
                    bottomStatusText = translations[currentLang].statusPaidToday;

                    if (amountPaidToday < (originalInstallmentValue - 0.05)) {
                        mainValueColor = '#dc3545'; 
                        bottomStatusStyle = 'color: #ffffff; background-color: #ff0000; font-weight: 800; border: 2px solid #b30000; box-shadow: 0 2px 5px rgba(255,0,0,0.4);';
                    } else {
                        mainValueColor = '#198754'; 
                        bottomStatusStyle = 'color: #155724; background-color: #d4edda; font-weight: 700; border: 1px solid #c3e6cb;';
                    }

                } else {
                    mainValueToDisplay = originalInstallmentValue;
                    secondaryLabelHtml = `<span style="font-size: 0.9em; color: var(--text-secondary); font-weight: 800; text-transform: uppercase; margin-top: 4px;">${freqText}</span>`;
                    mainValueColor = 'var(--accent-green)';

                    if (isLoanFromToday) {
                        bottomStatusText = translations[currentLang].statusPending; 
                        bottomStatusStyle = 'color: #856404; background-color: #fff3cd; font-weight: 700; border: 1px solid #ffeeba;';
                    } 
                    else if (displayLoan.amountDueToday > 0) {
                        bottomStatusText = translations[currentLang].statusToPay;
                        bottomStatusStyle = 'color: #ff0000; background-color: #ffe6e6; font-weight: 800; border: 1px solid #ff0000;';
                    } else {
                        if (displayLoan.paymentFrequency === 'weekly' || displayLoan.paymentFrequency === 'monthly') {
                            bottomStatusText = translations[currentLang].statusPending;
                            bottomStatusStyle = 'color: #856404; background-color: #fff3cd; font-weight: 700; border: 1px solid #ffeeba;';
                        } else {
                            bottomStatusText = translations[currentLang].statusToPay;
                            bottomStatusStyle = 'color: #ff0000; background-color: #ffe6e6; font-weight: 800; border: 1px solid #ff0000;';
                        }
                    }
                }

                let statusLabelUnderName = '';
                if (displayLoan.status === 'late') {
                    statusLabelUnderName = `<span style="display: block; font-size: 0.75em; color: var(--danger-color); font-weight: 700; margin-top: 2px;">⚠️ ATRASADO (${displayLoan.lateDays} dias)</span>`;
                } else if (displayLoan.status === 'finished') {
                    statusLabelUnderName = `<span style="display: block; font-size: 0.75em; color: #4338ca; font-weight: 700; margin-top: 2px;">🏁 FINALIZADO</span>`;
                }

                const remainingDisplay = money(remainingBalance);
                
                const loanInfoLabel = `<span style="font-size: 0.95em; color: #d97706; font-weight: 800; display: block; margin-top: 0;">
                    <i data-lucide="trending-down" style="width: 14px; height: 14px; vertical-align: text-bottom;"></i> Resta: ${remainingDisplay}
                </span>`;

                const card = document.createElement('div');
                card.className = 'client-card';
                card.style.flexDirection = 'column'; 
                card.style.alignItems = 'stretch';
                card.style.gap = '8px';
                
                card.dataset.clientId = client.id;
                card.dataset.loanIndex = loanIndex; 

                const nameInitial = (client.name || 'C').charAt(0).toUpperCase();
                const placeholderUrl = `https://placehold.co/80x80/${avatarHex}/FFFFFF?text=${nameInitial}`;
                const photoUrl = client.profilePictureUrl || placeholderUrl;
                const borderStyle = client.profilePictureUrl ? `border: 3px solid ${reputationColor};` : '';

                const labelHtml = typeLabel 
                    ? `<span style="font-size: 0.6em; font-weight: 700; color: ${typeColor}; margin-top: 2px; letter-spacing: 0.5px; animation: pulse 2s infinite;">${typeLabel}</span>`
                    : '';

                card.innerHTML = `
                    <div style="width: 100%; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; margin-bottom: 2px;">
                        <h4 class="client-name" style="margin: 0; font-size: 1.1em; color: var(--text-primary); font-weight: 700; line-height: 1.2;">${client.name}</h4>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        
                        <div style="display: flex; flex-direction: column; align-items: center; margin-right: 15px; min-width: 55px;">
                            <img src="${photoUrl}" alt="Foto" class="client-avatar" style="${borderStyle} width: 50px; height: 50px;">
                            <span style="font-size: 0.65em; font-weight: 800; color: ${reputationColor}; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">${reputationLabel}</span>
                            ${labelHtml}
                        </div>

                        <div class="client-info" style="flex-grow: 1; min-width: 0; margin-right: 10px;">
                            ${loanInfoLabel} 
                            ${statusLabelUnderName}
                        </div>
                        
                        <div class="payment-info" style="display: flex; flex-direction: column; align-items: flex-end; justify-content: center; flex-shrink: 0;">
                            <span class="payment-amount" style="color: ${mainValueColor}; font-size: 1.5em; line-height: 1;">
                                ${money(mainValueToDisplay)}
                            </span> 
                            
                            ${secondaryLabelHtml}
                            
                            <span class="payment-status" style="margin-top: 6px; display: block; text-align: right; font-size: 0.75em; padding: 4px 8px; border-radius: 4px; ${bottomStatusStyle}">
                                ${bottomStatusText}
                            </span>
                        </div>
                    </div>`;
                
                container.appendChild(card); 
            }); 

            lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
            
            container.querySelectorAll('.client-card').forEach(card => card.addEventListener('click', (e) => {
                const clientId = e.currentTarget.dataset.clientId;
                const loanIndex = parseInt(e.currentTarget.dataset.loanIndex, 10); 
                showClientDetails(clientId, loanIndex); 
            }));
        }// Fin de renderClientCards

        const PAYMENT_CONFIGS = {
            // Suramérica
            "BRL": { name: "Real Brasileiro", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'brl_pix', label: 'Chave PIX', type: 'text', placeholder: 'CPF, e-mail, telefone...' }, { id: 'brl_qrcode_text', label: 'PIX Copia e Cola', type: 'textarea', placeholder: 'Cole o código BR...' }, { id: 'brl_qrcode_image', label: 'Imagem QR Code PIX', type: 'image' } ]},
            "ARS": { name: "Peso Argentino", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'ars_mercadopago', label: 'Mercado Pago (CVU/Alias)', type: 'text', placeholder: 'CVU ou Alias da conta' }, { id: 'ars_transferencia', label: 'Transferencia Bancaria (CBU)', type: 'text', placeholder: 'CBU da conta bancária' } ]},
            "BOB": { name: "Boliviano", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'bob_qr', label: 'QR Simple', type: 'image' }, { id: 'bob_tigomoney', label: 'Tigo Money', type: 'tel', placeholder: 'Número de Teléfono' } ]},
            "CLP": { name: "Peso Chileno", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'clp_transferencia', label: 'Transferencia (Cuenta RUT)', type: 'text', placeholder: 'RUT o datos de la cuenta' } ]},
            "COP": { name: "Peso Colombiano", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'cop_nequi', label: 'Nequi', type: 'tel', placeholder: 'Número de telefone Nequi' }, { id: 'cop_daviplata', label: 'Daviplata', type: 'tel', placeholder: 'Número de telefone Daviplata' }, { id: 'cop_bancolombia', label: 'Bancolombia A la Mano', type: 'text', placeholder: 'Número de cuenta o teléfono' }, { id: 'cop_qrcode_image', label: 'Imagem QR Code Genérico', type: 'image' } ]},
            "USD_EC": { name: "Dólar (Ecuador)", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'ec_transferencia_pichincha', label: 'Transferencia Banco Pichincha', type: 'text', placeholder: 'Datos de la cuenta' }, { id: 'ec_transferencia_guayaquil', label: 'Transferencia Banco Guayaquil', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "PYG": { name: "Guaraní Paraguayo", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'pyg_giros', label: 'Giros Tigo / Personal', type: 'tel', placeholder: 'Número de Teléfono' }, { id: 'pyg_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "PEN": { name: "Sol Peruano", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'pen_yape', label: 'Yape', type: 'tel', placeholder: 'Número de Celular o QR' }, { id: 'pen_plin', label: 'Plin', type: 'tel', placeholder: 'Número de Celular' } ]},
            "UYU": { name: "Peso Uruguayo", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'uyu_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "VES": { name: "Bolívar Venezuelano", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'ves_pagomovil', label: 'Pago Móvil', type: 'text', placeholder: 'C.I, Banco, Teléfono' } ]},
            // Centroamérica
            "CRC": { name: "Colón Costarricense", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'crc_sinpe', label: 'SINPE Móvil', type: 'tel', placeholder: 'Número de Teléfono' } ]},
            "GTQ": { name: "Quetzal Guatemalteco", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'gtq_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta (BAC, BI, etc.)' } ]},
            "HNL": { name: "Lempira Hondureña", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'hnl_tigomoney', label: 'Tigo Money', type: 'tel', placeholder: 'Número de Teléfono' }, { id: 'hnl_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "NIO": { name: "Córdoba Nicaragüense", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'nio_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta (Lafise, BAC)' } ]},
            "PAB": { name: "Balboa Panameño / USD", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'pab_yappy', label: 'Yappy (Banco General)', type: 'tel', placeholder: 'Número de Teléfono' }, { id: 'pab_nequi', label: 'Nequi Panamá', type: 'tel', placeholder: 'Número de Teléfono' } ]},
            "USD_SV": { name: "Dólar (El Salvador)", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'sv_chivo', label: 'Chivo Wallet', type: 'text', placeholder: 'Número de DUI o Teléfono' }, { id: 'sv_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            // Norteamérica y General
            "USD": { name: "Dólar Americano (General)", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'usd_zelle', label: 'Zelle', type: 'email', placeholder: 'E-mail ou telefone Zelle' }, { id: 'usd_cashapp', label: 'Cash App', type: 'text', placeholder: '$Cashtag' }, { id: 'usd_paypal', label: 'PayPal', type: 'email', placeholder: 'E-mail do PayPal.me' } ]},
            "MXN": { name: "Peso Mexicano", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'mxn_spei', label: 'Transferencia SPEI (CLABE)', type: 'text', placeholder: 'CLABE Interbancaria' }, { id: 'mxn_oxxo', label: 'Pago en OXXO', type: 'text', placeholder: 'Número de referência para OXXO Pay' } ]},
            "CAD": { name: "Dólar Canadiense", methods: [ { id: 'cash', label: 'Dinheiro em Espécie', type: 'cash' }, { id: 'cad_interac', label: 'Interac e-Transfer', type: 'email', placeholder: 'Email para transferencia' } ]}
        };

        function showPaymentSettingsModal(collectorData) {
            const modal = document.getElementById('paymentSettingsModal');
            const currentSettings = collectorData.paymentSettings || { currency: 'BRL', methods: {} };
            let filesToUpload = {};

            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentSettingsModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="paymentSettings"></span>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="form-group">
                        <label data-lang-key="currency"></label>
                        <select id="currency-selector">
                            ${Object.keys(PAYMENT_CONFIGS).map(code => 
                                `<option value="${code}" ${currentSettings.currency === code ? 'selected' : ''}>${code} - ${PAYMENT_CONFIGS[code].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <h3 class="section-title" data-lang-key="paymentMethods" style="margin-top: 30px;"></h3>
                    <div id="payment-methods-container"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="save-payment-settings-btn"><i data-lucide="save"></i> <span data-lang-key="save"></span></button>
                </div>
            `;
            
            history.pushState({ modal: 'paymentSettingsModal' }, 'Payment Settings', '#payment-settings');
            modal.classList.add('active');

            const currencySelector = document.getElementById('currency-selector');
            const methodsContainer = document.getElementById('payment-methods-container');

            function renderMethodsUI(currency) {
                const config = PAYMENT_CONFIGS[currency];
                if (!config) {
                    methodsContainer.innerHTML = '<p>Configuração não encontrada para esta moeda.</p>';
                    return;
                }

                methodsContainer.innerHTML = config.methods.map(method => {
                    const methodSettings = currentSettings.methods[method.id] || { active: false, data: '' };
                    const isChecked = methodSettings.active;
                    
                    if (method.type === 'cash') {
                        return `
                        <div class="kpi-card" style="margin-bottom: 15px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-weight: 600; flex-grow: 1;">${method.label}</label>
                                <div class="switch">
                                    <input type="checkbox" id="toggle-${method.id}" data-method-id="${method.id}" checked disabled>
                                    <label for="toggle-${method.id}"></label>
                                </div>
                            </div>
                        </div>`;
                    } else if (method.type === 'image') {
                        return `
                        <div class="kpi-card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label for="toggle-${method.id}" style="font-weight: 600; flex-grow: 1;">${method.label}</label>
                                <div class="switch">
                                    <input type="checkbox" id="toggle-${method.id}" data-method-id="${method.id}" ${isChecked ? 'checked' : ''}>
                                    <label for="toggle-${method.id}"></label>
                                </div>
                            </div>
                            <div id="fields-${method.id}" style="display: ${isChecked ? 'block' : 'none'};">
                                <label for="input-${method.id}" style="border: 2px dashed var(--border-color); padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; display: block;">
                                    <i data-lucide="upload-cloud"></i>
                                    <span id="label-text-${method.id}">Clique para anexar imagem</span>
                                    <img id="preview-${method.id}" src="${methodSettings.data || ''}" style="display:${methodSettings.data ? 'block' : 'none'}; max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">
                                </label>
                                <input type="file" id="input-${method.id}" accept="image/*" style="display:none;" data-method-id="${method.id}">
                            </div>
                        </div>`;
                    } else {
                         const inputType = method.type === 'textarea' ? 
                            `<textarea id="input-${method.id}" rows="4" placeholder="${method.placeholder || ''}" data-method-id="${method.id}">${methodSettings.data || ''}</textarea>` :
                            `<input type="${method.type}" id="input-${method.id}" placeholder="${method.placeholder || ''}" value="${methodSettings.data || ''}" data-method-id="${method.id}">`;

                        return `
                        <div class="kpi-card" style="margin-bottom: 15px;">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label for="toggle-${method.id}" style="font-weight: 600; flex-grow: 1;">${method.label}</label>
                                <div class="switch">
                                    <input type="checkbox" id="toggle-${method.id}" data-method-id="${method.id}" ${isChecked ? 'checked' : ''}>
                                    <label for="toggle-${method.id}"></label>
                                </div>
                            </div>
                            <div id="fields-${method.id}" class="form-group" style="display: ${isChecked ? 'block' : 'none'};">
                                ${inputType}
                            </div>
                        </div>`;
                    }
                }).join('');
                lucide.createIcons({nodes: methodsContainer.querySelectorAll('[data-lucide]')});
            }

            methodsContainer.addEventListener('change', e => {
                if (e.target.type === 'checkbox') {
                    const methodId = e.target.dataset.methodId;
                    document.getElementById(`fields-${methodId}`).style.display = e.target.checked ? 'block' : 'none';
                }
                 if (e.target.type === 'file') {
                    const file = e.target.files[0];
                    if (!file) return;
                    const methodId = e.target.dataset.methodId;
                    filesToUpload[methodId] = file;
                    const preview = document.getElementById(`preview-${methodId}`);
                    const label = document.getElementById(`label-text-${methodId}`);
                    preview.src = URL.createObjectURL(file);
                    preview.style.display = 'block';
                    label.textContent = file.name;
                }
            });
            
            currencySelector.addEventListener('change', (e) => renderMethodsUI(e.target.value));

            document.getElementById('save-payment-settings-btn').addEventListener('click', async (e) => {
                const saveBtn = e.currentTarget;
                const originalHTML = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Salvando...`;
                lucide.createIcons({nodes: [saveBtn.querySelector('i')]});

                try {
                    const newSettings = {
                        currency: currencySelector.value,
                        methods: {
                            'cash': { active: true, data: '' } // Siempre se guarda el efectivo como activo
                        }
                    };
                    
                    const methodToggles = methodsContainer.querySelectorAll('input[type="checkbox"]');
                    for (const toggle of methodToggles) {
                        const methodId = toggle.dataset.methodId;
                        if (methodId === 'cash') continue; // Ya lo manejamos, saltar

                        const isActive = toggle.checked;
                        const inputEl = document.getElementById(`input-${methodId}`);
                        let data = '';

                        if (isActive) {
                            if (inputEl.type === 'file') {
                                if (filesToUpload[methodId]) {
                                    // --- [INICIO MIGRACIÓN A FIREBASE STORAGE] ---
                                    try {
                                        // Ruta: companies/{companyId}/collectors/{collectorId}/paymentMethods/{methodId}/image.jpg
                                        const storageRef = ref(storage, `companies/${currentCompanyId}/collectors/${currentCollectorUsername}/paymentMethods/${methodId}/image.jpg`);
                                        console.log(`[COBRADOR-APP] Subiendo imagen de método de pago a: ${storageRef.fullPath}`);
                                        
                                        await uploadBytes(storageRef, filesToUpload[methodId]);
                                        data = await getDownloadURL(storageRef); // Obtiene la nueva URL de Firebase
                                        
                                        console.log(`[COBRADOR-APP] Imagen subida. URL: ${data}`);
                                    } catch (storageError) {
                                        console.error(`Upload da imagem para ${methodId} falhou (Firebase):`, storageError);
                                        throw new Error(`Upload da imagem para ${methodId} falhou.`);
                                    }
                                    // --- [FIN MIGRACIÓN A FIREBASE STORAGE] ---
                                } else {
                                    data = currentSettings.methods[methodId]?.data || ''; // Mantém a imagem antiga se não houver nova
                                }
                            } else {
                                data = inputEl.value;
                            }
                        }
                        
                        newSettings.methods[methodId] = { active: isActive, data: data };
                    }
                    
                    const collectorRef = doc(db, 'collectors', currentCollectorUsername);
                    await updateDoc(collectorRef, { paymentSettings: newSettings });

                    showToast('Configurações de pagamento salvas com sucesso!');
                    window.history.back();

                } catch(error) {
                    console.error("Erro ao salvar configurações de pagamento:", error);
                    showToast(error.message || 'Falha ao salvar configurações.', true);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalHTML;
                    lucide.createIcons({nodes: [saveBtn.querySelector('i')]});
                }
            });

            document.getElementById('closePaymentSettingsModal').addEventListener('click', () => window.history.back());
            
            renderMethodsUI(currentSettings.currency);
            applyLanguage(currentLang);
            lucide.createIcons({nodes: modal.querySelectorAll('[data-lucide]')});
        }

        function getClientsWithActiveLoans() {
            const result = [];
            allClients.forEach(client => {
                (client.loans || []).forEach((loan, index) => {
                    if (loan.status === 'active') {
                        result.push({ client, loan, loanIndex: index });
                    }
                });
            });
            return result;
        }

        
        /**
         * INSTRUCCIÓN: Reemplaza tu función 'updateTodaysRouteList' (aprox. línea 955)
         * con este bloque de código completo.
         */
        function updateTodaysRouteList() {
           const today = new Date();
           today.setHours(0, 0, 0, 0);
           const dayOfWeek = today.getDay();
           const dayOfMonth = today.getDate();

           const getPaymentDate = (dateObj) => {
               if (!dateObj) return null;
               if (typeof dateObj.toDate === 'function') return dateObj.toDate();
               if (dateObj instanceof Date) return dateObj;
               if (typeof dateObj === 'string') { const d = new Date(dateObj); if (!isNaN(d.getTime())) return d; }
               return null;
           };

           let clientsForRoute = [];

           allClients.forEach(client => {
               if (!client.loans || client.loans.length === 0) return;

               client.loans.forEach((loan, index) => {
                   const details = calculateLoanDetails(loan);
                   const currentStatus = details.status;

                   // 1. REGLA DE CALENDARIO
                   let isScheduledForToday = false;
                   const frequency = loan.paymentFrequency || 'daily';
                   const paymentDays = loan.paymentDays || [];

                   if (frequency === 'daily') {
                       // --- CAMBIO CLAVE: SI ES DIARIO, APARECE SIEMPRE ---
                       // Antes verificábamos si hoy estaba marcado en 'paymentDays'.
                       // Ahora forzamos true para que aparezcan todos los días hasta que paguen.
                       isScheduledForToday = true; 
                   } else if (frequency === 'weekly') {
                       isScheduledForToday = paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfWeek;
                   } else if (frequency === 'biweekly') {
                       if (paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfWeek) {
                           const startDate = loan.startDate?.seconds ? new Date(loan.startDate.seconds * 1000) : new Date(loan.startDate);
                           startDate.setHours(0,0,0,0);
                           const diffTime = Math.abs(today - startDate);
                           const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                           if (Math.floor(diffDays / 7) % 2 === 0) {
                               isScheduledForToday = true;
                           }
                       }
                   } else if (frequency === 'monthly') {
                       isScheduledForToday = paymentDays.length > 0 && parseInt(paymentDays[0]) === dayOfMonth;
                   }

                   // 2. REGLA DE LIMPIEZA (Si pagó hoy, se va)
                   let hasPaidToday = false;
                   if (loan.history && loan.history.length > 0) {
                        hasPaidToday = loan.history.some(h => {
                            if (h.status === 'postponed' || h.status === 'rejected' || h.status === 'pending_verification' || h.method === 'migration') return false;
                            const pDate = getPaymentDate(h.date);
                            return pDate && pDate >= today;
                        });
                   }

                   // 3. FILTRO FINAL
                   const isLate = (currentStatus === 'late');
                   const isFinished = (currentStatus === 'finished');
                   
                   // Muestra si: (Toca Hoy O es Atrasado) Y (No pagó) Y (No terminó)
                   // Nota: Al poner isScheduledForToday = true para diarios, aseguramos que siempre pasen este filtro.
                   if ((isScheduledForToday || isLate) && !hasPaidToday && !isFinished) {
                       const loanToRender = { 
                           ...loan, 
                           status: currentStatus, 
                           lateDays: details.lateDays, 
                           amountDueToday: details.amountDueToday 
                       };
                       clientsForRoute.push({ client, loan: loanToRender, loanIndex: index });
                   }
               });
           });
 
           // Ordenar: Atrasados primero, luego alfabéticamente
           clientsForRoute.sort((a, b) => {
               if (a.loan.status === 'late' && b.loan.status !== 'late') return -1;
               if (a.loan.status !== 'late' && b.loan.status === 'late') return 1;
               const daysA = a.loan.lateDays || 0;
               const daysB = b.loan.lateDays || 0;
               if (daysA > daysB) return -1;
               if (daysA < daysB) return 1;
               return a.client.name.localeCompare(b.client.name);
           });

           const optimizedClients = optimizeRoute(clientsForRoute, collectorCurrentLocation);
           
           updateDashboard(optimizedClients); 
           
           if (document.querySelector('#map-view.active')) plotClientsOnMap();
           renderClientCards(document.getElementById('todays-route-list'), optimizedClients);
       }




    function updateAllClientsList() {
        const container = document.getElementById('all-clients-list');
        const searchInput = document.getElementById('client-search-input');
        let activeFilter = document.querySelector('.filter-buttons .filter-btn.active');
        let filter = activeFilter ? activeFilter.dataset.filter : 'all';

        if (!container || !searchInput) return;

        const searchTerm = searchInput.value.toLowerCase().trim();
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);

        const getPaymentDate = (dateObj) => {
            if (!dateObj) return null;
            if (typeof dateObj.toDate === 'function') return dateObj.toDate();
            if (dateObj instanceof Date) return dateObj;
            if (typeof dateObj === 'string') { const d = new Date(dateObj); if (!isNaN(d.getTime())) return d; }
            return null;
        };

        let clientsWithLoans = [];

        allClients.forEach(client => {
            if (!client.loans || client.loans.length === 0) return;

            // --- LÓGICA ESPECIAL PARA "FINALIZADOS" (SIN DUPLICADOS) ---
            if (filter === 'finished') {
                // 1. Verificamos si coincide con la búsqueda (si hay texto escrito)
                let matchesSearch = true;
                if (searchTerm) {
                    const nameMatch = client.name.toLowerCase().includes(searchTerm);
                    const addressMatch = client.address && client.address.toLowerCase().includes(searchTerm);
                    if (!nameMatch && !addressMatch) matchesSearch = false;
                }

                if (matchesSearch) {
                    // 2. Verificamos si el cliente está TOTALMENTE finalizado
                    // (Es decir, que NO tenga ningún préstamo pendiente o atrasado)
                    const hasActiveLoan = client.loans.some(l => calculateLoanDetails(l).status !== 'finished');
                    
                    if (!hasActiveLoan) {
                        // 3. Si está limpio, mostramos SOLO UNA tarjeta (la del último préstamo registrado)
                        const lastLoanIndex = client.loans.length - 1;
                        const lastLoan = client.loans[lastLoanIndex];
                        clientsWithLoans.push({ client, loan: lastLoan, loanIndex: lastLoanIndex });
                    }
                }
                return; // IMPORTANTE: Saltamos el resto del bucle para este cliente en este filtro
            }

            // --- LÓGICA ESTÁNDAR PARA OTROS FILTROS (Por préstamo) ---
            client.loans.forEach((loan, loanIndex) => {
                const details = calculateLoanDetails(loan);
                const currentStatus = details.status; 
                
                // Verificar si PAGÓ HOY
                const hasPaidToday = (loan.history || []).some(h => {
                    if (h.status === 'postponed' || h.status === 'rejected' || h.status === 'pending_verification' || h.method === 'migration') return false; 
                    const pDate = getPaymentDate(h.date);
                    return pDate && pDate >= todayStart;
                });

                let passesCategory = true;

                if (searchTerm) {
                    // Si buscas por nombre, muestra TODO lo que coincida
                    const nameMatch = client.name.toLowerCase().includes(searchTerm);
                    const addressMatch = client.address && client.address.toLowerCase().includes(searchTerm);
                    if (!nameMatch && !addressMatch) passesCategory = false;
                
                } else {
                    if (filter === 'all') {
                        // "TODOS": Solo mostrar si PAGÓ HOY.
                        if (!hasPaidToday) passesCategory = false;
                    }
                    else if (filter === 'weekly') {
                        if (loan.paymentFrequency !== 'weekly' || currentStatus === 'finished') passesCategory = false;
                    }
                    else if (filter === 'biweekly') {
                        if (loan.paymentFrequency !== 'biweekly' || currentStatus === 'finished') passesCategory = false;
                    }
                    else if (filter === 'todo_today') {
                        // "Falta por Pagar": Activos o atrasados que no pagaron hoy
                        if (currentStatus === 'finished' || hasPaidToday) passesCategory = false;
                    }
                    else if (filter === 'paid') {
                        if (!hasPaidToday) passesCategory = false;
                    }
                    else if (filter === 'late') {
                        if (currentStatus !== 'late') passesCategory = false;
                    }
                }

                if (passesCategory) {
                    clientsWithLoans.push({ client, loan, loanIndex }); 
                }
            });
        });
        
        // Ordenar alfabéticamente
        clientsWithLoans.sort((a, b) => a.client.name.localeCompare(b.client.name));
        renderClientCards(container, clientsWithLoans);
    }
        
        // --- PEGAR ESTO ANTES DE function showClientDetails ---

async function sendNotificationToClient(clientId, title, body, type, icon) {
    try {
        // Verificamos si db y currentCompanyId existen antes de intentar guardar
        if (typeof db === 'undefined' || !currentCompanyId) return;
        
        const notification = {
            title: title,
            body: body,
            date: serverTimestamp(),
            read: false,
            type: type || 'info',
            icon: icon || 'bell'
        };
        // Guardar en la subcolección de notificaciones del cliente
        await addDoc(collection(db, 'companies', currentCompanyId, 'clients', clientId, 'notifications'), notification);
        console.log(`Notificação enviada ao cliente ${clientId}`);
    } catch (error) {
        console.error("Erro ao enviar notificação (ignorado para não travar app):", error);
    }
}

// ---------------------------------------------------------


        function showClientDetails(clientId, loanIndex = 0) {
            currentDetailClientId = clientId;
            currentDetailLoanIndex = loanIndex;
            console.log(`[DIAG-STATE] Vista de detalles abierta para Cliente: ${currentDetailClientId}, Préstamo Índice: ${currentDetailLoanIndex}`);
            const clientDetailView = document.getElementById('clientDetailView');
            const client = allClients.find(c => c.id == clientId);

            // --- WhatsApp (INTELIGENTE GLOBAL v2) ---
            const whatsappString = (client.whatsapp || '').toString(); 
            let cleanedWhatsapp = whatsappString ? whatsappString.replace(/\D/g, '') : '';

            const currencyToDDI = {
                'BRL': '55', 'ARS': '54', 'BOB': '591', 'CLP': '56', 'COP': '57', 
                'USD_EC': '593', 'PYG': '595', 'PEN': '51', 'UYU': '598', 'VES': '58',
                'CRC': '506', 'GTQ': '502', 'HNL': '504', 'NIO': '505', 'PAB': '507', 
                'USD_SV': '503', 'USD': '1', 'MXN': '52', 'CAD': '1'
            };

            const collectorCurrency = currentCollectorData?.paymentSettings?.currency || 'BRL';
            const countryDDI = currencyToDDI[collectorCurrency] || '55';
            const isNorthAmerica = (countryDDI === '1');
            const maxLocalLength = isNorthAmerica ? 10 : 11;

            if (cleanedWhatsapp.length >= 8 && cleanedWhatsapp.length <= maxLocalLength) {
                cleanedWhatsapp = countryDDI + cleanedWhatsapp;
            }

            const whatsappLogoUrl = "https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/LOGO%20WHATSAPP%20OFI.png?alt=media&token=e022ad51-a151-4812-bb3d-9be867dac891";
            
            const whatsappButtonHtml = cleanedWhatsapp
                ? `<a id="whatsappClientBtn" href="https://api.whatsapp.com/send?phone=${cleanedWhatsapp}" target="_blank" class="header-btn" title="Enviar WhatsApp">
                       <img src="${whatsappLogoUrl}" alt="WhatsApp" style="width: 24px; height: 24px;">
                   </a>`
                : `<button class="header-btn" disabled style="opacity: 0.3;" title="WhatsApp não disponível">
                       <img src="${whatsappLogoUrl}" alt="WhatsApp" style="width: 24px; height: 24px; opacity: 0.5;">
                   </button>`;
        

            const allLoans = client.loans || [];
            const firstActiveIndex = allLoans.findIndex(l => calculateLoanDetails(l).status !== 'finished');
            
            let targetIndex = loanIndex;
            if (targetIndex < 0 || targetIndex >= allLoans.length) {
                targetIndex = firstActiveIndex !== -1 ? firstActiveIndex : (allLoans.length - 1);
            }
            
            if (targetIndex === -1 && allLoans.length === 0) {
                 showToast("Erro: Cliente sem empréstimos.", true);
                 if(clientDetailView.classList.contains('active')) window.history.back();
                 return; 
            }

            const currentLoanIndex = targetIndex;
            const loan = allLoans[currentLoanIndex];
            const hasMultipleLoans = allLoans.length > 1;

            const originalInstallment = loan.originalInstallmentAmount || 0;
            let approvedCumulativePaidForNumbering = 0;

            const historyPaid = (loan.history || [])
                .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration') 
                .reduce((sum, h) => sum + (h.amount || 0), 0);
            const initialPaid = loan.initialMigratedAmount || 0;
            const displayTotalPaid = initialPaid + historyPaid;

            let historyHtml = `<p class="no-history">Nenhum pagamento registrado ainda.</p>`;
            if (loan.history && loan.history.length > 0) {
                const getSortableTimestamp = (dateObj) => {
                    if (!dateObj) return 0;
                    if (typeof dateObj.toDate === 'function') return dateObj.toDate().getTime();
                    if (typeof dateObj.getTime === 'function') return dateObj.getTime();
                    if (typeof dateObj === 'string') {
                        const d = new Date(dateObj);
                        if (!isNaN(d.getTime())) return d.getTime();
                    }
                    return 0;
                };

                const sortedHistory = loan.history
                    .map((p, index) => ({ ...p, originalIndex: index }))
                    .sort((a, b) => getSortableTimestamp(a.date) - getSortableTimestamp(b.date));

                historyHtml = sortedHistory.map(p => {
                    let title = '';
                    let description = '';
                    let dateString = 'Data inválida';
                    let timeString = '';
                    let hasReceipt = p.receiptUrl ? '<i data-lucide="file-text" style="width: 16px; height: 16px; color: var(--text-secondary);"></i>' : '';
                    let statusStyle = '';
                    let statusText = '';
                    let amountDisplay = money(p.amount || 0);

                    let d;
                    if (p.date?.toDate) d = p.date.toDate();
                    else if (p.date instanceof Date) d = p.date;
                    else if (typeof p.date === 'string') d = new Date(p.date);
                    
                    if (d && !isNaN(d.getTime())) {
                        dateString = d.toLocaleDateString('pt-BR');
                        timeString = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    }

                    if (p.status === 'pending_verification') {
                         statusText = 'Pendente'; statusStyle = 'color: var(--warning-color); font-weight: bold;';
                         title = 'Pagamento Enviado'; description = `Aguardando aprovação do admin`;
                         amountDisplay = money(p.amount || 0);
                    } else if (p.status === 'rejected') {
                         statusText = 'Rejeitado'; statusStyle = 'color: var(--danger-color); font-weight: bold;';
                         title = 'Pagamento Rejeitado'; description = `Comprovante não aceito pelo admin`;
                         amountDisplay = `<span style="text-decoration: line-through;">${money(p.amount || 0)}</span>`;
                    } else if (p.status === 'postponed') {
                         statusText = 'Adiado'; statusStyle = 'color: var(--text-secondary); font-style: italic;';
                         title = 'Pagamento Adiado'; description = `Data de vencimento movida`;
                         amountDisplay = ''; hasReceipt = ''; 
                    } else if (p.method === 'migration') {
                        statusText = 'Aprovado (Migração)'; statusStyle = 'color: var(--accent-green); font-style: italic;';
                        hasReceipt = ''; 
                        if (p.migrationType === 'full_installments') {
                            const fullAmount = p.amount || 0;
                            const installmentsString = (loan.installments || "0/0").split('/');
                            const initialInstallments = parseInt(installmentsString[0], 10) || 0;
                            title = `Migração: ${initialInstallments} Cuota(s) Completa(s)`;
                            description = `Valor total de ${money(fullAmount)} registrado.`;
                        } else if (p.migrationType === 'partial_payment') {
                            const partialAmount = p.amount || 0;
                            const installmentsString = (loan.installments || "0/0").split('/');
                            const initialInstallments = parseInt(installmentsString[0], 10) || 0;
                            const nextInstallmentNum = initialInstallments + 1;
                            title = `Migração: Pago Parcial (Cuota #${nextInstallmentNum})`;
                            description = `Valor parcial de ${money(partialAmount)} registrado.`;
                        } else {
                            const initialPaid = p.amount || 0;
                            const installmentsString = (loan.installments || "0/0").split('/');
                            const initialInstallments = parseInt(installmentsString[0], 10) || 0;
                            const totalInstallments = installmentsString[1] || 0;
                            title = `Registro de Migração (${initialInstallments}/${totalInstallments})`;
                            description = `Valor inicial de ${money(initialPaid)} registrado.`;
                        }
                        approvedCumulativePaidForNumbering += (p.amount || 0);
                    } else { 
                        const paymentAmount = p.amount || 0;
                        statusText = 'Aprovado';
                        statusStyle = 'color: var(--accent-green);';
                        
                        if (originalInstallment > 0) {
                            const cumulativeBefore = approvedCumulativePaidForNumbering;
                            const cumulativeAfter = cumulativeBefore + paymentAmount;
                            const fullPaidBefore = Math.floor(cumulativeBefore / originalInstallment);
                            const fullPaidAfter = Math.floor(cumulativeAfter / originalInstallment);
                            const startInstallmentNum = fullPaidBefore + 1;
                            const endInstallmentNum = Math.floor((cumulativeAfter - 0.01) / originalInstallment) + 1;
                            const partialAmountRaw = cumulativeAfter % originalInstallment;
                            const percentage = Math.round((partialAmountRaw / originalInstallment) * 100);
                            const numFullInstallmentsInThisPayment = fullPaidAfter - fullPaidBefore;

                            if (numFullInstallmentsInThisPayment === 0 && percentage > 0) {
                                title = translations[currentLang].paymentInstallmentTitle.replace('{installment}', startInstallmentNum);
                                description = translations[currentLang].partialPaymentDesc.replace('{percent}', percentage);
                            } else if (numFullInstallmentsInThisPayment === 1 && percentage === 0) {
                                title = translations[currentLang].paymentInstallmentTitle.replace('{installment}', startInstallmentNum);
                                description = translations[currentLang].fullPaymentDesc.replace('{installment}', startInstallmentNum);
                            } else if (numFullInstallmentsInThisPayment > 1 && percentage === 0) {
                                title = translations[currentLang].paymentInstallmentsTitle.replace('{start}', startInstallmentNum).replace('{end}', endInstallmentNum);
                                description = translations[currentLang].multipleFullPaymentDesc.replace('{count}', numFullInstallmentsInThisPayment);
                            } else if (numFullInstallmentsInThisPayment >= 1 && percentage > 0) {
                                 title = translations[currentLang].paymentInstallmentsTitle.replace('{start}', startInstallmentNum).replace('{end}', endInstallmentNum);
                                description = translations[currentLang].multiplePaymentDesc.replace('{count}', numFullInstallmentsInThisPayment).replace('{percent}', percentage);
                            } else {
                                 title = "Pagamento Recebido";
                                 description = "Valor creditado ao saldo.";
                                 if (percentage === 0 && startInstallmentNum === endInstallmentNum) {
                                    title = translations[currentLang].paymentInstallmentTitle.replace('{installment}', startInstallmentNum);
                                    description = translations[currentLang].fullPaymentDesc.replace('{installment}', startInstallmentNum);
                                 }
                            }
                        } else {
                            title = "Pagamento Recebido";
                            description = "Valor creditado ao saldo.";
                        }
                        approvedCumulativePaidForNumbering += paymentAmount;
                    }

                    return `<div class="payment-history-item" data-history-index="${p.originalIndex}" style="cursor: ${p.status !== 'postponed' ? 'pointer' : 'default'};">
                                <div class="payment-history-details">
                                    <h4 class="payment-history-title">${title}</h4>
                                    <p class="payment-history-description">${description}</p>
                                    <p class="payment-history-description" style="${statusStyle}; font-size: 0.8em; margin-top: 5px;">${statusText}</p>
                                </div>
                                <div class="payment-history-info">
                                    <span class="payment-date">${dateString} - ${timeString}</span>
                                    <span class="payment-history-amount" style="${p.status === 'rejected' ? 'color: var(--danger-color);' : ''}">${amountDisplay}</span>
                                    ${hasReceipt}
                                </div>
                            </div>`;
                }).reverse().join(''); 
            }

            const loanDetails = calculateLoanDetails(loan);
            const currentStatus = loanDetails.status;
            const statusClass = `status-${currentStatus}`;
            const statusText = (translations[currentLang] && translations[currentLang][currentStatus]) || currentStatus;

            const lateDays = loanDetails.lateDays;
            const score = Math.max(0, 10 - lateDays);
            let reputationStatusKey = 'reputationBad';
            if (score === 10) reputationStatusKey = 'reputationPerfect';
            else if (score >= 7) reputationStatusKey = 'reputationGood';
            else if (score >= 3) reputationStatusKey = 'reputationRegular';
            let barStatusClass = 'status-bad';
            if (score === 10) barStatusClass = 'status-perfect';
            else if (score >= 7) barStatusClass = 'status-good';
            else if (score >= 3) barStatusClass = 'status-regular';

            let picoValue = 0;
            const instVal = loan.originalInstallmentAmount || 0;
            if (instVal > 0 && displayTotalPaid > 0) {
                const remainder = displayTotalPaid % instVal;
                if (remainder > 0.05 && (instVal - remainder) > 0.05) {
                    picoValue = remainder;
                }
            }

            const labels = {
                pt: { progress: 'Progresso do Empréstimo', status: 'Estado do Empréstimo', loc: 'Endereço', pico: 'Valor de Pico (Pago Parcial)', contractDateTitle: 'Datas do Contrato' },
                es: { progress: 'Progreso del Préstamo', status: 'Estado del Préstamo', loc: 'Dirección', pico: 'Valor de Pico (Pago Parcial)', contractDateTitle: 'Fechas del Contrato' },
                en: { progress: 'Loan Progress', status: 'Loan Status', loc: 'Address', pico: 'Partial Payment Balance', contractDateTitle: 'Contract Dates' }
            };
            const l = labels[currentLang] || labels.pt;

            let startDateStr = '--/--';
            let endDateStr = 'Calculando...';

            if (loan.startDate) {
                let startD = null;
                if (loan.startDate.seconds) startD = new Date(loan.startDate.seconds * 1000);
                else if (loan.startDate instanceof Date) startD = loan.startDate;
                else startD = new Date(loan.startDate);

                if (startD && !isNaN(startD.getTime())) {
                    startDateStr = startD.toLocaleDateString('pt-BR');

                    const totalInst = parseInt((loan.installments || "0/0").split('/')[1], 10) || 0;
                    
                    if (totalInst > 0) {
                        if (currentStatus === 'finished' && loan.history && loan.history.length > 0) {
                             const lastPayment = loan.history[loan.history.length - 1];
                             let endD = null;
                             if (lastPayment.date.seconds) endD = new Date(lastPayment.date.seconds * 1000);
                             else if (lastPayment.date instanceof Date) endD = lastPayment.date;
                             
                             if (endD) endDateStr = endD.toLocaleDateString('pt-BR') + ' (Real)';
                        } 
                        else {
                            let count = 0;
                            let currentD = new Date(startD);
                            currentD.setDate(currentD.getDate() + 1); 

                            let safetyLoop = 0;
                            while (count < totalInst && safetyLoop < 2000) { 
                                const dayW = currentD.getDay();
                                const dayM = currentD.getDate();
                                const fDate = `${String(dayM).padStart(2, '0')}/${String(currentD.getMonth() + 1).padStart(2, '0')}`;
                                const isHol = typeof nationalHolidays !== 'undefined' ? nationalHolidays.includes(fDate) : false;

                                let isPayDay = false;
                                const freq = loan.paymentFrequency || 'daily';
                                const pDays = loan.paymentDays || [];

                                if (!isHol) {
                                    if (freq === 'daily') isPayDay = pDays.some(d => String(d) === String(dayW));
                                    else if (freq === 'weekly') isPayDay = pDays.length > 0 && String(pDays[0]) === String(dayW);
                                    else if (freq === 'monthly') isPayDay = pDays.length > 0 && String(pDays[0]) === String(dayM);
                                    else if (freq === 'biweekly') {
                                         if (pDays.length > 0 && String(pDays[0]) === String(dayW)) {
                                            const diffT = Math.abs(currentD - startD);
                                            const diffD = Math.ceil(diffT / (1000 * 60 * 60 * 24));
                                            if (Math.floor(diffD / 7) % 2 === 0) isPayDay = true;
                                         }
                                    }
                                }

                                if (isPayDay) count++;
                                if (count < totalInst) currentD.setDate(currentD.getDate() + 1);
                                safetyLoop++;
                            }
                            endDateStr = currentD.toLocaleDateString('pt-BR');
                        }
                    } else {
                        endDateStr = '--/--';
                    }
                }
            }

            // --- CONSTRUCCIÓN DE BOTONES ---
            let receiptBtnText = 'Enviar<br>Comprovante'; 
            if (currentLang === 'pt') receiptBtnText = 'Enviar<br>Comprovante'; 
            else if (currentLang === 'es') receiptBtnText = 'Enviar<br>Recibo';
            else if (currentLang === 'en') receiptBtnText = 'Send<br>Receipt';
            
            let payBtnText = 'Registrar Pagamento'; 
            if (currentLang === 'pt') payBtnText = 'Registrar Pagamento';
            else if (currentLang === 'es') payBtnText = 'Registrar Pago';
            else if (currentLang === 'en') payBtnText = 'Register Payment';

            const actionButtonsHtml = currentStatus === 'finished' ? `
                <button class="btn-secondary" id="updateClientDataBtn" data-loan-index="${currentLoanIndex}"><i data-lucide="user-cog"></i> <span data-lang-key="updateClientData"></span></button>
                <button class="btn-primary" id="createNewLoanBtn"><i data-lucide="plus-circle"></i> <span data-lang-key="createNewLoan"></span></button>
            ` : `
                <button class="btn-secondary" id="startRouteBtn"><i data-lucide="navigation"></i> <span data-lang-key="startRoute"></span></button>
                <button class="btn-secondary" id="sendReceiptBtn" style="line-height: 1.2;">
                    <i data-lucide="file-text"></i> 
                    <span style="text-align: center;">${receiptBtnText}</span>
                </button>
                <button class="btn-secondary" id="createNewLoanBtn"><i data-lucide="plus-circle"></i> <span data-lang-key="createNewLoan"></span></button>
                <button class="btn-primary" id="registerPaymentBtn" data-loan-index="${currentLoanIndex}">
                    <i data-lucide="dollar-sign"></i> ${payBtnText}
                </button>
            `;

            clientDetailView.innerHTML = `
                <header class="modal-header" style="justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <button id="closeDetailView" class="header-btn" style="margin-right: 10px;"><i data-lucide="arrow-left"></i></button>
                        <div>
                            <span class="modal-title">${client.name}</span>
                            ${client.documentNumber ? `<span style="font-size: 0.8em; color: var(--text-secondary); display: block;">Doc: ${client.documentNumber}</span>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${whatsappButtonHtml}
                        <button id="editClientBtn" class="header-btn" title="Editar Cliente e Préstamo Atual"><i data-lucide="edit"></i></button>
                    </div>
                </header>

                ${hasMultipleLoans ? `
                <div class="loan-tabs-wrapper"> 
                    <div class="loan-tabs-container" id="loan-tabs-container">
                        ${allLoans.map((l, index) => {
                            const lStatus = calculateLoanDetails(l).status;
                            const isFinished = lStatus === 'finished';
                            return `<button class="loan-tab ${index === currentLoanIndex ? 'active' : ''}" data-loan-index="${index}" style="${isFinished ? 'opacity: 0.7;' : ''}">
                                        Préstamo ${index + 1} ${isFinished ? '(Finalizado)' : ''}
                                    </button>`;
                        }).join('')}
                    </div>
                </div>` : ''}

                <div class="modal-content-wrapper">
                  <div class="container">
                    
                    <div class="kpi-card progress-card" style="margin-bottom: 20px;">
                        <h3 class="kpi-title" style="justify-content: center;">${l.progress} ${currentLoanIndex + 1}</h3>
                        <div class="progress-circle">
                            <svg><circle class="bg-circle" cx="60" cy="60" r="54"></circle><circle id="client-detail-progress-bar" class="progress-bar" cx="60" cy="60" r="54" style="stroke-dasharray: 339.292; stroke: var(--accent-purple);"></circle></svg>
                            <div class="progress-text" id="client-detail-progress-text"></div>
                        </div>
                    </div>
                    
                    <div class="kpi-card" style="margin-bottom: 20px; text-align: center; padding: 15px;">
                        <!-- NUEVO TÍTULO AGREGADO AQUÍ -->
                        <h3 class="kpi-title" style="justify-content: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; font-weight: 700; color: var(--text-primary);">
                            ${l.contractDateTitle}
                        </h3>

                        <!-- Grid de Fechas original (Sin cambios en los textos internos) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="border-right: 1px solid var(--border-color);">
                                <h3 class="kpi-title" style="justify-content: center; margin-bottom: 5px; color: var(--accent-purple);">
                                    <i data-lucide="calendar" style="width: 16px; height: 16px;"></i> Início
                                </h3>
                                <p class="kpi-value" style="font-size: 1.1em; font-weight: 600;">${startDateStr}</p>
                            </div>
                            <div>
                                <h3 class="kpi-title" style="justify-content: center; margin-bottom: 5px; color: var(--text-secondary);">
                                    <i data-lucide="flag" style="width: 16px; height: 16px;"></i> Fim Est.
                                </h3>
                                <p class="kpi-value" style="font-size: 1.1em; font-weight: 600;">${endDateStr}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="kpi-card" style="margin-bottom: 20px; text-align: center;">
                        <h3 class="kpi-title" style="justify-content: center;">${l.status} ${currentLoanIndex + 1}</h3>
                        <span class="payment-status ${statusClass}" style="font-size: 1.2em; font-weight: 600; padding: 8px 20px;">
                            ${statusText}
                        </span>
                    </div>

                    <div class="kpi-card" style="margin-bottom: 20px; padding: 15px; display: flex; align-items: center; gap: 15px; background-color: var(--surface);">
                        <div style="background-color: color-mix(in srgb, var(--accent-purple) 10%, transparent); padding: 10px; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
                            <i data-lucide="map-pin" style="color: var(--accent-purple); width: 20px; height: 20px;"></i>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-size: 0.8em; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">${l.loc}</span>
                            <span style="font-size: 1.05em; font-weight: 500; color: var(--text-primary); line-height: 1.3;">${client.address}</span>
                            ${client.city ? `<span style="font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;">${client.city}</span>` : ''}
                        </div>
                    </div>

                    <section class="kpi-grid-profile" style="margin-bottom: 30px;">
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="coins"></i> Total</h3><p class="kpi-value">${money(loan.totalLoan)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="receipt"></i> <span data-lang-key="installmentValue"></span></h3><p class="kpi-value" style="color: var(--accent-purple);">${money(loan.originalInstallmentAmount)}</p></div>
                        <div class="kpi-card" style="border-color: var(--accent-orange); border-width: 1px;">
                            <h3 class="kpi-title"><i data-lucide="trending-up" style="color: var(--accent-orange);"></i> ${l.pico}</h3>
                            <p class="kpi-value" style="color: var(--accent-orange);">${money(picoValue)}</p>
                        </div>
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="trending-up"></i> Pago</h3><p class="kpi-value green">${money(displayTotalPaid)}</p></div>
                       
                        <!-- NUEVA TARJETA: MICRO SEGURO - SE OCULTA SI FINALIZADO -->
                        ${currentStatus !== 'finished' ? `
                        <div class="kpi-card" style="background-color: color-mix(in srgb, #0ea5e9 10%, var(--surface)); border-color: #0ea5e9;">
                           <h3 class="kpi-title"><i data-lucide="shield-check" style="color: #0ea5e9;"></i> Micro Seguro</h3>
                           <p class="kpi-value" style="color: #0ea5e9;">${money(loan.microInsurance || 0)}</p>
                        </div>` : ''}
                        <!-- FIN TARJETA -->

                       <div class="kpi-card" style="border-color: var(--danger-color);">
                           <h3 class="kpi-title"><i data-lucide="receipt-text"></i> Total Devido Agora</h3>
                           <p class="kpi-value" style="color: var(--danger-color); font-size: 1.4em;">${money(Math.max(0, (loan.totalLoan - displayTotalPaid) + (loan.lateFeesAccumulated || 0)))}</p>
                       </div>
                    </section>
                    <section>
                         <h2 class="section-title" data-lang-key="reputationScore"></h2>
                         <div class="kpi-card">
                             <div class="reputation-bar-container">
                                 <div class="reputation-bar ${barStatusClass}" style="width: ${score * 10}%"></div>
                             </div>
                             <div class="reputation-status">
                                 <span class="reputation-value">${score} / 10</span>
                                 <span class="reputation-text ${barStatusClass}" data-lang-key="${reputationStatusKey}"></span>
                             </div>
                         </div>
                    </section>
                    <section style="margin-top: 30px;">
                        <h2 class="section-title">Histórico de Pagamentos (Préstamo ${currentLoanIndex + 1})</h2>
                        <div class="client-list">${historyHtml}</div>
                    </section>
                  </div>
                </div>
                <div class="action-buttons">
                    ${actionButtonsHtml}
                </div>`;

            history.pushState({ modal: 'clientDetailView', clientId: clientId, loanIndex: currentLoanIndex }, `Details for ${client.name}`, `#client/${clientId}/${currentLoanIndex}`);
            clientDetailView.classList.add('active');

            const totalInstallmentsString = (loan.installments || "0/0").split('/')[1];
            const totalInstallments = totalInstallmentsString ? parseInt(totalInstallmentsString, 10) : 0;
            let paidInstallments = 0;
            if (originalInstallment > 0) {
                paidInstallments = Math.floor(displayTotalPaid / originalInstallment);
            }
            if (paidInstallments > totalInstallments) paidInstallments = totalInstallments;

            const progressPercentage = totalInstallments > 0 ? (paidInstallments / totalInstallments) * 100 : 0;
            const circleCircumference = 2 * Math.PI * 54;
            const strokeDashoffset = circleCircumference - (progressPercentage / 100) * circleCircumference;
            const progressBar = document.getElementById('client-detail-progress-bar');
            const progressText = document.getElementById('client-detail-progress-text');
            
            if(progressBar && progressText) {
                progressBar.style.strokeDashoffset = strokeDashoffset;
                progressText.textContent = `${paidInstallments}/${totalInstallments}`;
            }

            if (hasMultipleLoans) {
                clientDetailView.querySelectorAll('.loan-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const newLoanIndex = parseInt(e.currentTarget.dataset.loanIndex, 10);
                        showClientDetails(clientId, newLoanIndex);
                    });
                });
            }

            lucide.createIcons({ nodes: clientDetailView.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            document.getElementById('closeDetailView').addEventListener('click', () => {
                window.history.back(); 
            });

            document.getElementById('editClientBtn').addEventListener('click', () => showClientFormModal(clientId, false, currentLoanIndex));

            if (currentStatus === 'finished') {
                document.getElementById('createNewLoanBtn').addEventListener('click', () => showClientFormModal(clientId, true));
                document.getElementById('updateClientDataBtn').addEventListener('click', (e) => showClientFormModal(clientId, false, parseInt(e.currentTarget.dataset.loanIndex, 10)));
            } else {
                document.getElementById('registerPaymentBtn').addEventListener('click', (e) => showPaymentModal(clientId, parseInt(e.currentTarget.dataset.loanIndex, 10)));
                document.getElementById('createNewLoanBtn').addEventListener('click', () => showClientFormModal(clientId, true));
                
                const sendReceiptBtn = document.getElementById('sendReceiptBtn');
                if (sendReceiptBtn) {
                    sendReceiptBtn.addEventListener('click', () => {
                        generateStatusReceiptPDF(clientId, currentLoanIndex);
                    });
                }
                
                const startRouteBtn = document.getElementById('startRouteBtn');
                let navigationUrl = client.location;
                if (!navigationUrl || navigationUrl.trim() === '') {
                    if (client.address && client.address.trim() !== '') {
                        const fullAddress = `${client.address}, ${client.city || ''}`;
                        navigationUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
                    }
                }

                if (startRouteBtn) {
                    if (navigationUrl) {
                        startRouteBtn.disabled = false;
                        startRouteBtn.style.opacity = '1';
                        startRouteBtn.title = 'Navegar até o cliente'; 
                        const newBtn = startRouteBtn.cloneNode(true);
                        startRouteBtn.parentNode.replaceChild(newBtn, startRouteBtn);
                        newBtn.addEventListener('click', async (e) => {
                            e.preventDefault(); 
                            showToast('Abrindo mapa...', false);
                            try {
                                const t = translations[currentLang] || translations['pt'];
                                const notifTitle = t.collectorOnTheWayTitle || 'Cobrador a caminho!';
                                const notifBody = t.collectorOnTheWayBody || 'Nosso cobrador está a caminho.';
                                if (typeof sendNotificationToClient === 'function') {
                                    sendNotificationToClient(clientId, notifTitle, notifBody, 'on_the_way', 'navigation');
                                }
                            } catch (err) {
                                console.warn("Aviso: No se pudo notificar, pero el mapa se abrirá igual.", err);
                            }
                            setTimeout(() => { window.open(navigationUrl, '_blank'); }, 100);
                        });
                    } else {
                        startRouteBtn.disabled = true;
                        startRouteBtn.style.opacity = '0.5';
                        startRouteBtn.title = 'Endereço não disponível';
                    }
                }
            }  

            clientDetailView.querySelectorAll('.payment-history-item[data-history-index]').forEach(item => {
                item.addEventListener('click', (e) => {
                    const historyIndex = parseInt(e.currentTarget.dataset.historyIndex, 10);
                    const freshClient = allClients.find(c => c.id === clientId);
                    const freshLoan = freshClient?.loans ? freshClient.loans[currentLoanIndex] : null;
                    const clickedPayment = freshLoan?.history ? freshLoan.history[historyIndex] : null;

                    if (!clickedPayment) {
                         showToast('Erro ao obter detalhes do pagamento.', true);
                         return;
                    }
                    if (clickedPayment.status === 'pending_verification') {
                        const notification = internalNotifications.find(n => n.clientId === clientId && n.loanIndex === currentLoanIndex && n.historyIndex === historyIndex && n.type === 'payment');
                        showVerificationModal(clientId, historyIndex, currentLoanIndex, notification?.id);
                    }
                    else if (clickedPayment.status === 'postponed') { return; }
                    else {
                        showPaymentDetailModal(clientId, currentLoanIndex, historyIndex);
                    }
                });
            });
        }
                





        function showMapPinModal() {
            const mapPinModal = document.getElementById('mapPinModal');
            
            // Usamos la misma imagen del 'blobito azul' que en el mapa principal
            // Ajustamos el 'transform' para que la PUNTA del pin quede exactamente en el centro de la mira
            const markerImage = "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png";

            mapPinModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeMapPinModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Selecionar Localização</span>
                </header>
                <div class="modal-content-wrapper" style="padding:0; position:relative; display:flex; justify-content:center; align-items:center; background-color: var(--border-color);">
                    <div id="pin-map-container" style="width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s;"></div>
                    
                    <!-- LOADING OVERLAY -->
                    <div id="map-loading-overlay" style="position: absolute; z-index: 1001; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <i data-lucide="loader-circle" style="animation: spin 1s linear infinite; width: 32px; height: 32px;"></i>
                        <p style="margin: 10px 0 0;">Carregando mapa...</p>
                    </div>

                    <!-- BLOBITO AZUL (IMAGEN REAL) EN EL CENTRO EXACTO -->
                    <!-- transform: translate(-50%, -100%) coloca la PUNTA inferior en el centro exacto de la pantalla -->
                    <img src="${markerImage}" 
                         style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 1000; pointer-events: none; width: 25px; height: 41px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));">

                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="confirmPinLocationBtn" disabled><i data-lucide="check-circle"></i> Confirmar Localização</button>
                </div>
            `;
            
            history.pushState({ modal: 'mapPinModal' }, 'Map Pin', '#map-pin');
            mapPinModal.classList.add('active');
            lucide.createIcons({ nodes: mapPinModal.querySelectorAll('[data-lucide]') });

            const mapContainer = document.getElementById('pin-map-container');
            const loadingOverlay = document.getElementById('map-loading-overlay');
            const confirmBtn = document.getElementById('confirmPinLocationBtn');

            // Función para iniciar el mapa en las coordenadas dadas
            const initializeMap = (centerCoords) => {
                loadingOverlay.style.display = 'none';
                confirmBtn.disabled = false;
                mapContainer.style.opacity = '1';
                
                const map = L.map(mapContainer).setView(centerCoords, 18); // Zoom cercano para precisión
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);

                // Botón Confirmar: Guarda el centro actual del mapa
                mapPinModal.querySelector('#confirmPinLocationBtn').addEventListener('click', () => {
                    const { lat, lng } = map.getCenter();
                    // Guardamos el enlace estándar de Google Maps
                    const locationUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                    
                    const locationInput = document.getElementById('client-location');
                    if (locationInput) {
                        locationInput.value = locationUrl;
                        // Disparamos un evento 'change' por si acaso hay listeners
                        locationInput.dispatchEvent(new Event('change'));
                    }
                    
                    showToast('Localização capturada!');
                    window.history.back();
                });
            };

            mapPinModal.querySelector('#closeMapPinModal').addEventListener('click', () => window.history.back());
            
            // --- LÓGICA INTELIGENTE DE UBICACIÓN ---
            // 1. ¿El cliente ya tiene ubicación guardada?
            const existingUrl = document.getElementById('client-location')?.value;
            let existingCoords = null;
            
            if (existingUrl) {
                const match = existingUrl.match(/query=([\d.-]+),([\d.-]+)/);
                if (match) {
                    existingCoords = [parseFloat(match[1]), parseFloat(match[2])];
                }
            }

            if (existingCoords) {
                // Si ya tiene, abrimos el mapa DIRECTAMENTE ahí
                console.log("Usando ubicación existente del cliente...");
                initializeMap(existingCoords);
            } else {
                // Si no tiene, buscamos GPS
                console.log("Buscando GPS actual...");
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            initializeMap([position.coords.latitude, position.coords.longitude]);
                        },
                        (error) => {
                            console.warn(`Error GPS: ${error.message}`);
                            showToast('Não foi possível obter GPS. Usando padrão.', true);
                            initializeMap([-16.68, -49.25]); // Fallback
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    initializeMap([-16.68, -49.25]); // Fallback no soporte
                }
            }
        }
        


       


function showVerificationModal(clientId, historyIndex, loanIndex, notificationId) { // <-- [CAMBIO 1/4] Añadir notificationId
    // [MODIFICADO] Usa el nuevo modal #verificationModal con estilo .modal-view
    console.log(`[DIAG-VERIF] showVerificationModal llamada con clientId=${clientId}, loanIndex=${loanIndex}, historyIndex=${historyIndex}, notifId=${notificationId}`);
    const modal = document.getElementById('verificationModal'); // <-- CAMBIO: Usa el nuevo ID
    const client = allClients.find(c => c.id === clientId);

    if (!client) {
        console.error("[DIAG-VERIF] Error: Cliente no encontrado con ID:", clientId);
        showToast('Erro: Cliente não encontrado.', true);
        return;
    }
    console.log("[DIAG-VERIF] Cliente encontrado:", client.name);

    // Lógica para encontrar préstamo y pago (SIN CAMBIOS)
    if (loanIndex === undefined || loanIndex === null || !client.loans || !client.loans[loanIndex]) {
        console.error(`[DIAG-VERIF] Error: loanIndex ('${loanIndex}') es inválido o no se encontró el préstamo para el cliente ${clientId}`);
        const guessedIndex = (client.loans || []).findIndex(l => l.status !== 'finished');
        loanIndex = guessedIndex !== -1 ? guessedIndex : (client.loans?.length ? 0 : -1);
        if (loanIndex === -1) {
            showToast('Erro: Índice de empréstimo inválido.', true);
            return;
        }
        console.warn(`[DIAG-VERIF] ¡ADVERTENCIA! loanIndex no fue proporcionado. Se usó el índice adivinado: ${loanIndex}`);
    }
    console.log(`[DIAG-VERIF] Usando loanIndex=${loanIndex}`);
    const loan = client.loans[loanIndex];
    const payment = loan?.history ? loan.history[historyIndex] : null;

    if (!loan || !payment || payment.status !== 'pending_verification') {
        console.error("[DIAG-VERIF] Error: No se pudo encontrar el PAGO PENDIENTE o el préstamo:", { clientId, loanIndex, historyIndex, loan, payment });
        showToast('Erro: Pagamento pendente não encontrado ou já processado.', true);
        // [NUEVO] Si el pago no es pendiente, intenta cerrar el modal si está abierto
        if (modal.classList.contains('active')) {
             window.history.back(); // Cierra el modal si ya no es relevante
        }
        return;
    }
    console.log("[DIAG-VERIF] Pago pendiente validado.");

    const paymentDate = payment.date?.seconds ? new Date(payment.date.seconds * 1000) : new Date();
    const dateStr = paymentDate.toLocaleDateString(currentLang === 'pt' ? 'pt-BR' : 'es-ES');
    const timeStr = paymentDate.toLocaleTimeString(currentLang === 'pt' ? 'pt-BR' : 'es-ES', { hour: '2-digit', minute: '2-digit' });

    // --- INICIO: NUEVA ESTRUCTURA HTML del Modal ---
    modal.innerHTML = `
        <header class="modal-header">
            <button id="closeVerificationModal"><i data-lucide="arrow-left"></i></button>
            <span class="modal-title" data-lang-key="paymentVerification">Verificação de Pagamento</span>
        </header>
        <div class="modal-content-wrapper container"> 
            <p style="color: var(--text-secondary); margin-bottom: 25px;">
                Cliente: <strong>${client.name}</strong><br>
                Data: ${dateStr} às ${timeStr}
            </p>

            <div class="kpi-card" style="margin-bottom: 20px; text-align: center;">
                <h4 class="kpi-title" style="justify-content: center;" data-lang-key="sentAmount">Valor Enviado</h4>
                <p class="kpi-value green" style="font-size: 1.8em;">${money(payment.amount)}</p>
            </div>

            <h4 style="margin-bottom: 10px;" data-lang-key="paymentReceipt">Comprovante de Pagamento</h4>
            <div style="background-color: var(--bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; min-height: 150px; display: flex; justify-content: center; align-items: center;">
                ${payment.receiptUrl ?
                    // Reutilizamos el ID para la imagen, no hay problema
                    `<img id="verification-receipt-img" src="${payment.receiptUrl}" alt="Comprovante" style="max-width: 100%; max-height: 50vh; object-fit: contain; border-radius: 4px;">` :
                    `<p class="no-items">Nenhum comprovante anexado.</p>`
                }
            </div>
        </div> 
        <div class="action-buttons"> 
            <button id="reject-payment-btn" class="btn-danger" style="flex-grow: 1;">
                <i data-lucide="x-circle"></i> <span data-lang-key="reject"></span>
            </button>
            <button id="approve-payment-btn" class="btn-primary" style="flex-grow: 1;">
                <i data-lucide="check-circle"></i> <span data-lang-key="approve"></span>
            </button>
        </div>
    `;
    // --- FIN: NUEVA ESTRUCTURA HTML ---
    console.log("[DIAG-VERIF] HTML del modal rediseñado generado.");

    history.pushState({ modal: 'verificationModal' }, 'Verification', '#verify'); // <-- CAMBIO: Usa el nuevo ID y #hash
    modal.classList.add('active'); // Muestra el modal (con la animación de slide)
    lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });
    applyLanguage(currentLang); // Aplica traducciones
    console.log("[DIAG-VERIF] Modal mostrado y configurado.");

    // --- Lógica de los botones (MODIFICADA para borrar notificación) ---
    modal.querySelector('#closeVerificationModal').addEventListener('click', () => window.history.back()); // <-- CAMBIO: Usa el nuevo ID del botón

    // Botón RECHAZAR
    modal.querySelector('#reject-payment-btn').addEventListener('click', async (e) => {
        console.log("[DIAG-VERIF] Botón RECHAZAR presionado.");
        const rejectBtn = e.currentTarget;
        rejectBtn.disabled = true;
        rejectBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Rejeitando...`;
        lucide.createIcons({ nodes: [rejectBtn.querySelector('i')] });
        try {
            const clientRef = doc(db, 'companies', currentCompanyId, "clients", clientId);
            // Obtenemos una copia ACTUALIZADA del cliente por si acaso hubo cambios mientras el modal estaba abierto
            const currentClientData = allClients.find(c => c.id === clientId); 
            if (!currentClientData) throw new Error("Cliente no encontrado en datos locales actualizados.");
            const updatedLoans = JSON.parse(JSON.stringify(currentClientData.loans)); // Copia profunda de los préstamos actuales

            if (updatedLoans[loanIndex]?.history?.[historyIndex]) {
                updatedLoans[loanIndex].history[historyIndex].status = 'rejected';
            } else { throw new Error("Índice de préstamo o historial inválido al intentar rechazar."); }
            
            await updateDoc(clientRef, { loans: updatedLoans });
            showToast(translations[currentLang].paymentRejected);
            
            // --- [INICIO CAMBIO 2/4] ---
            // Elimina la notificación interna AHORA que fue procesada
            if (notificationId) {
                console.log(`[DIAG-VERIF] Rechazado. Eliminando notificación interna: collectors/${currentCollectorUsername}/notifications/${notificationId}`);
                await deleteDoc(doc(db, 'collectors', currentCollectorUsername, 'notifications', notificationId));
                console.log(`[DIAG-VERIF] Notificación ${notificationId} eliminada.`);
            } else {
                 console.warn("[DIAG-VERIF] No se proporcionó notificationId para eliminar.");
            }
            // --- [FIN CAMBIO 2/4] ---

            window.history.back(); // Cierra el modal DESPUÉS de borrar la notificación
            const notifTitle = translations[currentLang].paymentRejectedClientTitle;
            const notifBody = translations[currentLang].paymentRejectedClientBody;
            sendNotificationToClient(clientId, notifTitle, notifBody, 'payment_rejected', 'alert-circle');
        } catch (error) {
            console.error("[DIAG-VERIF] Erro ao rejeitar pagamento:", error);
            showToast('Falha ao rejeitar pagamento.', true);
            rejectBtn.disabled = false; // Re-habilita en error
            rejectBtn.innerHTML = `<i data-lucide="x-circle"></i> <span data-lang-key="reject"></span>`;
            lucide.createIcons({ nodes: [rejectBtn.querySelector('i')] });
            applyLanguage(currentLang);
        }
    });

    // Botón APROBAR
    modal.querySelector('#approve-payment-btn').addEventListener('click', async (e) => {
        console.log("[DIAG-VERIF] Botón APROVAR presionado.");
        const approveBtn = e.currentTarget;
        approveBtn.disabled = true;
        approveBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Aprovando...`;
        lucide.createIcons({ nodes: [approveBtn.querySelector('i')] });
        try {
            const clientRef = doc(db, 'companies', currentCompanyId, "clients", clientId);
            // Obtenemos una copia ACTUALIZADA del cliente por si acaso
            const currentClientData = allClients.find(c => c.id === clientId);
            if (!currentClientData) throw new Error("Cliente no encontrado en datos locales actualizados.");
            const updatedLoans = JSON.parse(JSON.stringify(currentClientData.loans));
            const currentLoan = updatedLoans[loanIndex];

            if (!currentLoan?.history?.[historyIndex]) { throw new Error("Índice de préstamo o historial inválido al intentar aprobar."); }
            
            // 1. Cambia estado del pago en la copia
            currentLoan.history[historyIndex].status = 'approved';

            // 2. Recalcula finanzas (Tu lógica existente, pero sobre la copia 'currentLoan')
            const installmentValue = currentLoan.originalInstallmentAmount || 0;
            // Recalcula newTotalPaid DESDE EL HISTORIAL ACTUALIZADO de currentLoan
            const newTotalPaid = (currentLoan.history || [])
                                .filter(h => h.status === 'approved') // Solo aprobados
                                .reduce((sum, h) => sum + (h.amount || 0), 0);
            const paidInstallmentsCount = installmentValue > 0 ? Math.floor(newTotalPaid / installmentValue) : 0;
            const newBalance = installmentValue > 0 ? newTotalPaid - (paidInstallmentsCount * installmentValue) : newTotalPaid;
            currentLoan.paid = newTotalPaid;
            currentLoan.paymentBalance = newBalance;
            const totalInstallmentsStr = (currentLoan.installments || '0/0').split('/')[1] || '0';
            currentLoan.installments = `${paidInstallmentsCount}/${totalInstallmentsStr}`;
            
            await updateDoc(clientRef, { loans: updatedLoans }); // Guarda la copia actualizada
            showToast(translations[currentLang].paymentApproved);

            // --- [INICIO CAMBIO 3/4] ---
            // Elimina la notificación interna AHORA que fue procesada
            if (notificationId) {
                console.log(`[DIAG-VERIF] Aprobado. Eliminando notificación interna: collectors/${currentCollectorUsername}/notifications/${notificationId}`);
                await deleteDoc(doc(db, 'collectors', currentCollectorUsername, 'notifications', notificationId));
                console.log(`[DIAG-VERIF] Notificación ${notificationId} eliminada.`);
            } else {
                 console.warn("[DIAG-VERIF] No se proporcionó notificationId para eliminar.");
            }
            // --- [FIN CAMBIO 3/4] ---

            window.history.back(); // Cierra el modal DESPUÉS de borrar la notificación
            const amountStr = money(payment.amount);
            const notifTitle = translations[currentLang].paymentApprovedClientTitle;
            const notifBody = translations[currentLang].paymentApprovedClientBody.replace('{amount}', amountStr);
            sendNotificationToClient(clientId, notifTitle, notifBody, 'payment_approved', 'check-check');
        } catch (error) {
            console.error("[DIAG-VERIF] Erro ao aprovar pagamento:", error);
            showToast('Falha ao aprovar pagamento.', true);
            approveBtn.disabled = false; // Re-habilita en error
            approveBtn.innerHTML = `<i data-lucide="check-circle"></i> <span data-lang-key="approve"></span>`;
            lucide.createIcons({ nodes: [approveBtn.querySelector('i')] });
            applyLanguage(currentLang);
        }
    });
}



        /**
         * [VERSIÓN REFINADA v2 - MODO OSCURO, CENTRADO PROFESIONAL]
         * Genera un PDF profesional con los datos de acceso del cliente.
         * @param {object} clientData - Datos del cliente (name, email, password, username).
         * @returns {Blob} - El PDF generado como un Blob.
         */
        async function generateClientAccessPDF(clientData) {
            // Usa la instancia global de jsPDF cargada en el <head>
            const { jsPDF } = window.jspdf;
            
            // --- INICIO: CORRECCIÓN DE DISEÑO 1/5 ---
            // Aumentamos la altura a 150mm para mejor espaciado y margen inferior
            const doc = new jsPDF({ unit: 'mm', format: [100, 150] }); 
            const margin = 8; // Margen lateral más estrecho (8mm)
            const width = doc.internal.pageSize.getWidth(); // 100mm
            const cardWidth = width - (margin * 2); // Ancho de tarjeta (84mm)
            const cardCenterX = width / 2; // Centro horizontal (50mm)
            // --- FIN: CORRECCIÓN DE DISEÑO 1/5 ---
            
            // Colores Dark Mode (sin cambios)
            const pdfBg = '#0f172a';
            const cardBg = '#1e293b';
            const textColor = '#e2e8f0';
            const secondaryTextColor = '#94a3b8';
            const primaryColor = '#6f42c1';
            const cardBorder = '#334155';

            // 1. Fondo del PDF (sin cambios)
            doc.setFillColor(pdfBg);
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), 'F');

            // --- INICIO: CORRECCIÓN DE DISEÑO 2/5 ---
            // Re-cálculo de todo el espaciado vertical (variable 'y')
            let y = 15; // Margen superior (15mm)

            // 2. Encabezado: Nombre de la Empresa
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(primaryColor);
            doc.text(currentCompanyData?.name || 'LUMIX Finanças', cardCenterX, y, { align: 'center' });
            y += 12; // y = 27

            // 3. Mensaje de Bienvenida
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(textColor);
            doc.text('Bem-vindo!', cardCenterX, y, { align: 'center' });
            y += 8; // y = 35
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(secondaryTextColor);
            doc.text(clientData.name, cardCenterX, y, { align: 'center' });
            y += 10; // y = 45

            doc.setFontSize(10);
            const introText = "Estes são seus dados para o acesso ao seu aplicativo da área do cliente.";
            const splitText = doc.splitTextToSize(introText, cardWidth); // Usa el nuevo cardWidth (84mm)
            doc.text(splitText, cardCenterX, y, { align: 'center' });
            y += (splitText.length * 5) + 10; // y = 45 + (10) + 10 = 65 (Más espacio)
            // --- FIN: CORRECCIÓN DE DISEÑO 2/5 ---

            // 4. Tarjeta de Credenciales
            const cardX = margin; // 8mm
            const cardY = y; // y = 65
            // --- INICIO: CORRECCIÓN DE DISEÑO 3/5 ---
            // Tarjeta más alta (50mm) para centrar mejor el contenido
            const cardHeight = 50; 
            const cardRadius = 5; // Bordes más redondeados
            // --- FIN: CORRECCIÓN DE DISEÑO 3/5 ---

            // Dibuja la tarjeta (fondo, borde, barra púrpura)
            doc.setDrawColor(cardBorder);
            doc.setFillColor(cardBg);
            doc.roundedRect(cardX, cardY, cardWidth, cardHeight, cardRadius, cardRadius, 'FD');
            doc.setFillColor(primaryColor);
            doc.roundedRect(cardX, cardY, cardWidth, 8, cardRadius, cardRadius, 'F');
            doc.rect(cardX, cardY + 4, cardWidth, 4, 'F'); // Relleno inferior de esquinas
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#FFFFFF');
            doc.text('Seus Dados de Acesso', cardX + 5, cardY + 5.5);

            // --- INICIO: CORRECCIÓN DE DISEÑO 4/5 ---
            // Nueva lógica de centrado vertical para la tarjeta de 50mm

            // Centro vertical del ÁREA DE CONTENIDO (todo bajo la barra púrpura de 8mm)
            // Altura del contenido = 50mm (altura tarjeta) - 8mm (barra) = 42mm
            // Punto medio del contenido = (Altura de contenido / 2) + 8mm (offset barra) + cardY
            const contentCenterY = (42 / 2) + 8 + cardY; // (21) + 8 + 65 = 94

            // Posiciones Y para los campos, distribuidos simétricamente alrededor de 94
            const y_label1 = contentCenterY - 12;  // y = 82
            const y_value1 = contentCenterY - 6;   // y = 88
            const y_label2 = contentCenterY + 4;   // y = 98
            const y_value2 = contentCenterY + 10;  // y = 104

            // Campo 1: Usuário (PERFECTAMENTE CENTRADO)
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(secondaryTextColor);
            doc.text('Usuário (Login):', cardCenterX, y_label1, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(textColor);
            doc.text(clientData.username, cardCenterX, y_value1, { align: 'center' });

            // Campo 2: Senha (PERFECTAMENTE CENTRADO)
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(secondaryTextColor);
            doc.text('Senha:', cardCenterX, y_label2, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(textColor);
            doc.text(clientData.password, cardCenterX, y_value2, { align: 'center' });
            // --- FIN: CORRECCIÓN DE DISEÑO 4/5 ---

            // 5. Botón Clicable
            // --- INICIO: CORRECCIÓN DE DISEÑO 5/5 ---
            // Posiciona el botón 10mm debajo de la tarjeta
            y = cardY + cardHeight + 10; // y = 65 + 50 + 10 = 125
            // --- FIN: CORRECCIÓN DE DISEÑO 5/5 ---
            
            const linkText = 'Acessar o Portal do Cliente';
            const appLink = 'https://cliente.lumixartificial.com';
            const btnHeight = 10;
            const btnWidth = cardWidth - 10; // 74mm
            const btnX = (width - btnWidth) / 2; // Centrado
            const btnY = y; // y = 125
            const btnRadius = 5;

            // Dibuja el botón (sin cambios)
            doc.setFillColor(primaryColor);
            doc.roundedRect(btnX, btnY, btnWidth, btnHeight, btnRadius, btnRadius, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#FFFFFF');
            doc.text(linkText, cardCenterX, btnY + (btnHeight / 2), { align: 'center', baseline: 'middle' });
            doc.link(btnX, btnY, btnWidth, btnHeight, { url: appLink });

            // El botón termina en y = 135.
            // La página termina en y = 150.
            // Margen inferior = 15mm. (¡Corregido!)

            // 6. Devolver como Blob (sin cambios)
            return doc.output('blob');
        }


        
             function showClientFormModal(clientId = null, isNewLoan = false, loanIndex = 0, prefillData = null) {
            const isEditMode = clientId !== null && !isNewLoan;
            const client = isEditMode ? allClients.find(c => c.id === clientId) : (clientId ? allClients.find(c => c.id === clientId) : {});
            const loan = (isEditMode && client && client.loans && client.loans[loanIndex]) ? client.loans[loanIndex] : {};

            let filesToUpload = [];
            let existingDocs = client.documents ? [...client.documents] : [];

            const clientFormModal = document.getElementById('clientFormModal');
            
            let modalTitleKey = 'addNewClient';
            let saveButtonKey = 'saveClient';
            if (isNewLoan) {
                modalTitleKey = 'createNewLoan';
                saveButtonKey = 'saveClient'; 
            } else if (isEditMode) {
                modalTitleKey = 'editClient';
                saveButtonKey = 'saveChanges';
            }

            const prefillLoanAmount = prefillData ? prefillData.amount : '';
            const prefillInstallments = prefillData ? prefillData.installments : '';

            // --- GENERACIÓN AUTOMÁTICA DE CREDENCIALES ---
            const timestampSuffix = Date.now().toString().slice(-6);
            const autoUsername = client.username || `user${timestampSuffix}`;
            const autoPassword = client.password || Math.random().toString(36).slice(-6).toUpperCase();

            clientFormModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeClientFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="${modalTitleKey}"></span>
                </header>
                <div class="modal-content-wrapper">
                  <div class="container">
                    <form id="client-form">
                        
                        <h3 class="section-title" style="margin-top: 10px; border: none; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="user-round"></i> Dados Pessoais
                        </h3>
                        <hr style="border: 1px solid var(--border-color); margin-top: 10px; margin-bottom: 25px;">

                        <div class="form-group"><label data-lang-key="clientName"></label><input type="text" id="client-name" required value="${client.name || ''}" ${isNewLoan ? 'readonly' : ''}></div>
                        
                        <div class="form-group">
                            <label data-lang-key="documentNumber"></label>
                            <input type="text" id="client-document" value="${client.documentNumber || ''}" ${isNewLoan ? 'readonly' : ''} placeholder="Digite apenas números">
                        </div>

                        <div id="blacklist-alert-box" style="display: none; background-color: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h4 style="color: #b91c1c; margin: 0 0 5px; display: flex; align-items: center; gap: 8px; font-size: 1em;">
                                <i data-lucide="alert-triangle"></i> ALERTA DE LISTA DE ADVERTÊNCIA
                            </h4>
                            <p id="blacklist-alert-msg" style="color: #7f1d1d; margin: 0; font-size: 0.9em; line-height: 1.4;"></p>
                        </div>

                        <div id="system-verification-results" style="margin-bottom: 20px;"></div>
                        <div class="form-group"><label data-lang-key="address"></label><input type="text" id="client-address" required value="${client.address || ''}" ${isNewLoan ? 'readonly' : ''}></div>
                        <div class="form-group"><label data-lang-key="city"></label><input type="text" id="client-city" required value="${client.city || ''}" ${isNewLoan ? 'readonly' : ''}></div>
                        <div class="form-group"><label data-lang-key="whatsapp"></label><input type="tel" id="client-whatsapp" required value="${client.whatsapp || ''}" ${isNewLoan ? 'readonly' : ''}></div>
                        
                        <div class="form-group" style="${isNewLoan ? 'display: none;' : ''}">
                            <label data-lang-key="location"></label>
                            <input type="text" id="client-location" readonly placeholder="Clique no botão para obter" value="${client.location || ''}">
                            <button type="button" class="btn-secondary" id="get-location-btn" style="width: 100%; margin-top: 10px;">
                                <i data-lucide="map-pin"></i> Obter Localização GPS
                            </button>
                        </div>
                        
                        <div style="display: none;">
                            <h3 class="section-title">Acesso Oculto (Automático)</h3>
                            <div class="form-group">
                                <label data-lang-key="username"></label>
                                <input type="text" id="client-username" value="${autoUsername}" 
                                       autocomplete="off" autocapitalize="none">
                                <div id="username-validation-msg" class="validation-message"></div>
                            </div>
                            
                            <div class="form-group">
                                <label data-lang-key="password"></label>
                                <input type="text" id="client-password" value="${autoPassword}">
                            </div>
                        </div>

                        <h3 class="section-title" style="margin-top:30px; border-top: 1px solid var(--border-color); padding-top: 20px; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                           <i data-lucide="dollar-sign"></i> 
                           ${isNewLoan ? 'Detalhes do Novo Empréstimo' : (isEditMode ? 'Detalhes do Empréstimo' : 'Detalhes do Primeiro Empréstimo')}
                        </h3>
                        
                        <div class="form-group" id="migration-toggle-group" style="display: ${isEditMode || isNewLoan ? 'none' : 'block'}; background-color: var(--border-color); padding: 15px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="migration-toggle-input" style="font-weight: 600; font-size: 1.05em; color: var(--text-primary); margin: 0;">
                                    <i data-lucide="arrow-right-circle" style="width: 18px; height: 18px; margin-right: 5px; vertical-align: -3px;"></i>
                                    Préstamo Antigo (Migração)
                                </label>
                                <div class="switch">
                                    <input type="checkbox" id="migration-toggle-input">
                                    <label for="migration-toggle-input"></label>
                                </div>
                            </div>
                            <p style="font-size: 0.85em; color: var(--text-secondary); margin: 8px 0 0;">
                                Ative esta opção <strong>APENAS</strong> se estiver migrando um empréstimo antigo que já possui pagamentos.
                            </p>
                        </div>

                        <div class="form-group grid-2">
                            <div>
                                <label data-lang-key="totalLoan"></label>
                                <input type="number" id="client-loan-amount" required 
                                       value="${(isEditMode ? (loan.principalAmount || (loan.totalLoan / (1 + client.interestRate/100))) : prefillLoanAmount)}">
                                       ${prefillData ? 'readonly' : ''}
                            </div>
                            <div>
                                <label data-lang-key="interest"></label>
                                <input type="number" id="client-interest" required 
                                       value="${client.interestRate || '20'}" ${isNewLoan || isEditMode ? 'readonly' : ''}>
                            </div>
                        </div>
                        
                        <div class="form-group" id="migration-paid-installments-group" style="display: none;">
                            <label for="client-initial-paid-installments" style="font-weight: 600; color: var(--accent-purple);">Cuotas Pagadas ao Início</label>
                            <input type="number" id="client-initial-paid-installments" value="0" min="0" style="background-color: var(--surface);">
                        </div>

                        <div class="form-group" id="migration-partial-payment-group" style="display: none;">
                            <label for="client-initial-partial-payment" style="font-weight: 600; color: var(--accent-orange);">Valor Parcial Adicional (${money(0).replace(/\d+,\d+/g, '')})</label>
                            <input type="number" id="client-initial-partial-payment" value="0.00" step="0.01" min="0" style="background-color: var(--surface);">
                        </div>
                        
                        <div id="migration-info-box" style="background-color: color-mix(in srgb, var(--accent-purple) 5%, var(--surface)); border: 1px solid color-mix(in srgb, var(--accent-purple) 30%, transparent); padding: 15px; border-radius: 12px; margin: -10px 0 20px 0; display: none; align-items: flex-start; gap: 12px;">
                            <i data-lucide="info" style="color: var(--accent-purple); width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px;"></i>
                            <div style="font-size: 0.85em; color: var(--text-secondary); line-height: 1.5;">
                                <strong style="color: var(--text-primary);">Guia de Migração:</strong>
                                <ul style="margin: 8px 0 0 18px; padding: 0;">
                                    <li><strong>Parcelas Pagas:</strong> Insira o número de parcelas <strong>completas</strong> (ex: 12).</li>
                                    <li><strong>Valor Parcial:</strong> Se o cliente pagou uma parte da parcela seguinte (ex: R$50 da parcela #13), insira o valor aqui.</li>
                                    <li>Deixe em <strong>R$ 0,00</strong> se não houver valor parcial.</li>
                                </ul>
                            </div>
                        </div>

                        <!-- CAMBIO: MICRO SEGURO EN LUGAR DE TASA DE MORA -->
                        <div class="form-group">
                            <label for="client-micro-insurance" style="color: #0ea5e9; font-weight: 700;">
                                <i data-lucide="shield-check" style="width: 14px; height: 14px; vertical-align: middle;"></i> 
                                Micro Seguro (Valor a Descontar)
                            </label>
                            <input type="number" id="client-micro-insurance" step="0.01" 
                                   value="${loan.microInsurance || '0'}" 
                                   placeholder="Ex: 60.00"
                                   style="border-color: #0ea5e9;">
                        </div>

                        <div class="form-group"><label data-lang-key="totalToPay"></label><input type="text" id="client-total-to-pay" readonly></div>
                        <div class="form-group grid-2">
                            <div>
                                <label data-lang-key="numInstallments"></label>
                                <input type="number" id="client-installments" required 
                                       value="${(isEditMode ? (loan.installments || '').split('/')[1] : prefillInstallments)}">
                                       ${prefillData ? 'readonly' : ''} 
                            </div>
                            <div><label data-lang-key="installmentValue"></label><input type="text" id="client-installment-value" readonly></div>
                        </div>

                        <div class="form-group">
                            <label data-lang-key="paymentFrequency"></label>
                            <select id="payment-frequency" class="form-control">
                                <option value="daily" data-lang-key="daily"></option>
                                <option value="weekly" data-lang-key="weekly"></option>
                                <option value="biweekly" data-lang-key="biweekly"></option>
                                <option value="monthly" data-lang-key="monthly"></option>
                            </select>
                        </div>
                        <div id="payment-days-container">
                            <div id="daily-payment-selector">
                                <label data-lang-key="paymentDays"></label>
                                <div class="day-selector">
                                    ${['D','S','T','Q','Q','S','S'].map((day, i) => `<div><input type="checkbox" id="form-day-${i}" value="${i}"><label for="form-day-${i}">${day}</label></div>`).join('')}
                                </div>
                            </div>
                            <div id="weekly-payment-selector" style="display: none;">
                                 <div class="form-group">
                                    <label data-lang-key="dayOfWeek"></label>
                                    <select id="weekly-day-select" class="form-control">
                                        <option value="1" data-lang-key="monday"></option>
                                        <option value="2" data-lang-key="tuesday"></option>
                                        <option value="3" data-lang-key="wednesday"></option>
                                        <option value="4" data-lang-key="thursday"></option>
                                        <option value="5" data-lang-key="friday"></option>
                                        <option value="6" data-lang-key="saturday"></option>
                                        <option value="0" data-lang-key="sunday"></option>
                                    </select>
                                </div>
                            </div>
                            <div id="monthly-payment-selector" style="display: none;">
                                 <div class="form-group">
                                    <label data-lang-key="dayOfMonth"></label>
                                    <input type="number" id="monthly-day-input" min="1" max="31" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="collectionTimeLabel"></label>
                            <input type="time" id="client-collection-time" value="${loan.collectionTime || ''}">
                        </div>
                        
                        <div class="form-group" style="${isNewLoan ? 'display: none;' : ''}">
                            <h3 class="section-title" style="margin-top:30px; border-top: 1px solid var(--border-color); padding-top: 20px; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="file-check"></i> <span data-lang-key="clientDocs"></span>
                            </h3>
                            <div id="doc-preview-container" style="margin-bottom: 15px;"></div>
                            <div class="grid-2">
                                <button type="button" class="btn-secondary" id="take-photo-btn"><i data-lucide="camera"></i> <span data-lang-key="takePhoto"></span></button>
                                <button type="button" class="btn-secondary" id="upload-file-btn"><i data-lucide="upload"></i> <span data-lang-key="uploadFile"></span></button>
                            </div>
                            <input type="file" id="doc-file-input" multiple accept="image/*,application/pdf" style="display: none;">
                        </div>
                    </form>
                  </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="saveClientBtn"><i data-lucide="save"></i> <span data-lang-key="${saveButtonKey}"></span></button>
                </div>`;
            
            history.pushState({ modal: 'clientFormModal' }, 'Client Form', '#client-form');
            clientFormModal.classList.add('active');
            
            // LÓGICA DE VERIFICACIÓN DE RIESGO
            const docInput = document.getElementById('client-document');
            const alertBox = document.getElementById('blacklist-alert-box');
            const alertMsg = document.getElementById('blacklist-alert-msg');

            const checkBlacklist = async () => {
                const cpfRaw = docInput.value.trim();
                const cpfClean = cpfRaw.replace(/\D/g, ''); 
                if (cpfClean.length < 5) {
                    alertBox.style.display = 'none';
                    return;
                }
                try {
                    const q = query(collection(db, 'blacklisted_customers'), where('cpf', '==', cpfClean));
                    const snap = await getDocs(q);
                    if (!snap.empty) {
                        const data = snap.docs[0].data();
                        const reason = data.reason || "Sem motivo especificado.";
                        alertBox.style.display = 'block';
                        alertMsg.innerHTML = `<strong>ATENÇÃO!</strong> O documento <strong>${cpfRaw}</strong> está na lista de advertência.<br><br><strong>Motivo:</strong> ${reason}`;
                        lucide.createIcons({ nodes: [alertBox.querySelector('i')] });
                    } else {
                        alertBox.style.display = 'none';
                    }
                } catch (err) {
                    console.error("Erro ao verificar blacklist:", err);
                }
            };

            if (docInput) {
                docInput.addEventListener('blur', checkBlacklist);
                if (docInput.value) checkBlacklist();
            }

            const paymentFrequencySelect = document.getElementById('payment-frequency');
            const dailySelector = document.getElementById('daily-payment-selector');
            const weeklySelector = document.getElementById('weekly-payment-selector');
            const monthlySelector = document.getElementById('monthly-payment-selector');

            const handleFrequencyChange = (frequency) => {
                dailySelector.style.display = 'none';
                weeklySelector.style.display = 'none';
                monthlySelector.style.display = 'none';
                if (frequency === 'daily') {
                    dailySelector.style.display = 'block';
                } else if (frequency === 'weekly') {
                    weeklySelector.style.display = 'block';
                } else if (frequency === 'monthly') {
                    monthlySelector.style.display = 'block';
                }
            };

            paymentFrequencySelect.addEventListener('change', (e) => handleFrequencyChange(e.target.value));

            const frequency = loan.paymentFrequency || client.loans?.[0]?.paymentFrequency || 'daily';
            paymentFrequencySelect.value = frequency;
            handleFrequencyChange(frequency);
            
            const paymentDays = loan.paymentDays || client.loans?.[0]?.paymentDays || [1,2,3,4,5,6];
            if (frequency === 'daily') {
                paymentDays.forEach(day => {
                    const checkbox = document.getElementById(`form-day-${day}`);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (frequency === 'weekly') {
                document.getElementById('weekly-day-select').value = paymentDays[0];
            } else if (frequency === 'monthly') {
                document.getElementById('monthly-day-input').value = paymentDays[0];
            }

            let isUsernameAvailable = (isEditMode || isNewLoan);
            const usernameInput = document.getElementById('client-username');
            const validationMsg = document.getElementById('username-validation-msg');

            if (usernameInput) { 
                usernameInput.addEventListener('blur', async () => {
                    const username = usernameInput.value.trim();
                    if (!username) { validationMsg.textContent = ''; isUsernameAvailable = false; return; }
                    if (isEditMode && username === client.username) { validationMsg.textContent = ''; isUsernameAvailable = true; return; }
                    
                    const q = query(collection(db, 'companies', currentCompanyId, 'clients'), where("username", "==", username));
                    const querySnapshot = await getDocs(q);
                    let isTaken = !querySnapshot.empty;
                    if (isTaken) {
                        usernameInput.value = username + Math.floor(Math.random()*100);
                        isUsernameAvailable = true;
                    } else {
                        isUsernameAvailable = true;
                    }
                });
            }
            
            const docPreviewContainer = document.getElementById('doc-preview-container');
            
            function renderDocPreviews() {
                if (!docPreviewContainer) return;
                docPreviewContainer.innerHTML = '';
                const allDocs = [...existingDocs, ...filesToUpload];
                allDocs.forEach((doc, index) => {
                    const isExisting = index < existingDocs.length;
                    const item = document.createElement('div');
                    item.className = 'preview-item';
                    item.innerHTML = `
                        <span>${isExisting ? doc.name : doc.name}</span>
                        <button type="button" class="remove-doc-btn" data-index="${index}" style="background:none; border:none; color:var(--danger-color); cursor:pointer;"><i data-lucide="x-circle"></i></button>
                    `;
                    item.querySelector('.remove-doc-btn').addEventListener('click', (e) => {
                        const i = parseInt(e.currentTarget.dataset.index, 10);
                        if (i < existingDocs.length) {
                            existingDocs.splice(i - 0, 1);
                        } else {
                            filesToUpload.splice(i - existingDocs.length, 1);
                        }
                        renderDocPreviews();
                    });
                    docPreviewContainer.appendChild(item);
                });
                lucide.createIcons({ nodes: docPreviewContainer.querySelectorAll('[data-lucide]') });
            }
            if (docPreviewContainer) renderDocPreviews();

            function handleFiles(selectedFiles) {
                filesToUpload = [...filesToUpload, ...Array.from(selectedFiles)];
                renderDocPreviews();
            }
            const takePhotoBtn = document.getElementById('take-photo-btn');
            const uploadFileBtn = document.getElementById('upload-file-btn');
            const docFileInput = document.getElementById('doc-file-input');
            
            if (takePhotoBtn) {
                takePhotoBtn.addEventListener('click', () => {
                    docFileInput.accept = "image/*";
                    docFileInput.capture = "environment";
                    docFileInput.click();
                });
            }
            if (uploadFileBtn) {
                uploadFileBtn.addEventListener('click', () => {
                    docFileInput.accept = "image/*,application/pdf";
                    docFileInput.removeAttribute('capture');
                    docFileInput.click();
                });
            }
            if (docFileInput) {
                docFileInput.addEventListener('change', (e) => {
                    if (e.target.files) {
                        handleFiles(e.target.files);
                    }
                });
            }

            const loanAmountInput = document.getElementById('client-loan-amount');
            const interestInput = document.getElementById('client-interest');
            const installmentsInput = document.getElementById('client-installments');
            const totalToPayInput = document.getElementById('client-total-to-pay');
            const installmentValueInput = document.getElementById('client-installment-value');
            function calculateLoanValues() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const interest = parseFloat(interestInput.value) || 0;
                const installments = parseInt(installmentsInput.value) || 0;
                
                let rawTotal = loanAmount * (1 + (interest / 100));
                let rawInstallment = installments > 0 ? rawTotal / installments : 0;
                const installmentValue = Math.round(rawInstallment * 100) / 100;
                const totalToPay = installmentValue * installments;

                totalToPayInput.value = money(totalToPay);
                installmentValueInput.value = money(installmentValue);
            }
            [loanAmountInput, interestInput, installmentsInput].forEach(input => input.addEventListener('input', calculateLoanValues));
            calculateLoanValues();

            const migrationToggle = document.getElementById('migration-toggle-input');
            const migrationInstallmentsGroup = document.getElementById('migration-paid-installments-group');
            const migrationInstallmentsInput = document.getElementById('client-initial-paid-installments');
            const migrationPartialGroup = document.getElementById('migration-partial-payment-group'); 
            const migrationPartialInput = document.getElementById('client-initial-partial-payment'); 
            const migrationInfoBox = document.getElementById('migration-info-box');
            
            if (migrationToggle && migrationInstallmentsGroup && migrationInstallmentsInput && migrationPartialGroup && migrationPartialInput && migrationInfoBox) {
                migrationToggle.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    migrationInstallmentsGroup.style.display = isChecked ? 'block' : 'none';
                    migrationPartialGroup.style.display = isChecked ? 'block' : 'none'; 
                    migrationInfoBox.style.display = isChecked ? 'flex' : 'none';
                    if (!isChecked) {
                        migrationInstallmentsInput.value = '0';
                        migrationPartialInput.value = '0.00'; 
                    }
                });
            }
            
            const gpsBtn = document.getElementById('get-location-btn');
            if(gpsBtn) { gpsBtn.addEventListener('click', () => showMapPinModal()); }
            
            document.getElementById('closeClientFormModal').addEventListener('click', () => window.history.back());
            
            const saveButton = document.getElementById('saveClientBtn');
            saveButton.dataset.isRefinance = prefillData ? 'true' : 'false';
            const clientIdToSave = isEditMode || isNewLoan ? client.id : null; 

            saveButton.addEventListener('click', async (e) => {
                const saveButton = e.currentTarget;
                const originalButtonHTML = saveButton.innerHTML;

                if (!document.getElementById('client-form').checkValidity()) {
                    showToast('Por favor, preencha os campos obrigatórios.', true);
                    return;
                }

                saveButton.disabled = true;
                saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Salvando...`;
                lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

                try {
                    const username = document.getElementById('client-username').value.trim();
                    const password = document.getElementById('client-password').value.trim();
                    const email = `${username}@gmail.com`;

                    let newUploadedDocuments = [];
                    if (!isNewLoan && filesToUpload.length > 0) {
                        const uploadPromises = filesToUpload.map(async (file) => {
                            const targetClientId = isEditMode ? clientIdToSave : username; 
                            const uniqueFileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                            const storageRef = ref(storage, `companies/${currentCompanyId}/clients/${targetClientId}/docs/${uniqueFileName}`);
                            await uploadBytes(storageRef, file);
                            const downloadURL = await getDownloadURL(storageRef);
                            return { name: file.name, url: downloadURL };
                        });
                        newUploadedDocuments = await Promise.all(uploadPromises);
                    }

                    const loanAmount = parseFloat(document.getElementById('client-loan-amount').value) || 0;
                    const interest = parseFloat(document.getElementById('client-interest').value);
                    const installments = parseInt(document.getElementById('client-installments').value);
                    
                    let rawTotal = loanAmount * (1 + (interest / 100));
                    let rawInstallment = installments > 0 ? rawTotal / installments : 0;
                    const installmentValue = Math.round(rawInstallment * 100) / 100;
                    const totalToPay = installmentValue * installments;
                    const principalAmount = loanAmount;

                    // --- CAMBIO: GUARDAR MICRO SEGURO Y ANULAR TASA DE MORA ---
                    const microInsurance = parseFloat(document.getElementById('client-micro-insurance').value) || 0;
                    const lateFeeRate = 0; // Desactivada para usar Micro Seguro
                    // ---------------------------------------------------------

                    const paymentFrequency = document.getElementById('payment-frequency').value;
                    let paymentDaysValue = [];
                    if (paymentFrequency === 'daily') {
                        paymentDaysValue = Array.from(document.querySelectorAll('#daily-payment-selector input:checked')).map(el => parseInt(el.value));
                    } else if (paymentFrequency === 'weekly') {
                        paymentDaysValue = [parseInt(document.getElementById('weekly-day-select').value)];
                    } else if (paymentFrequency === 'monthly') {
                        paymentDaysValue = [parseInt(document.getElementById('monthly-day-input').value)];
                    }
                    
                    const finalDocuments = [...existingDocs, ...newUploadedDocuments];

                    const clientGeneralData = {
                        name: document.getElementById('client-name').value,
                        documentNumber: document.getElementById('client-document').value,
                        address: document.getElementById('client-address').value,
                        city: document.getElementById('client-city').value,
                        whatsapp: document.getElementById('client-whatsapp').value,
                        location: document.getElementById('client-location').value,
                        username: username,
                        email: email, 
                        password: password,
                        documents: finalDocuments,
                        collectorId: currentCollectorUsername,
                        interestRate: interest
                    };

                    const loanSpecificData = {
                        principalAmount: principalAmount,
                        lateFeeRate: lateFeeRate, // Siempre 0 ahora
                        microInsurance: microInsurance, // NUEVO CAMPO
                        totalLoan: totalToPay,
                        amount: installmentValue,
                        originalInstallmentAmount: installmentValue,
                        installments: `0/${installments}`,
                        paid: 0,
                        paymentBalance: 0,
                        status: 'active',
                        startDate: new Date(),
                        history: [],
                        paymentFrequency: paymentFrequency,
                        paymentDays: paymentDaysValue,
                        collectionTime: document.getElementById('client-collection-time').value,
                    };
                    
                    if (migrationToggle && migrationToggle.checked) {
                        const initialPaidInstallments = parseInt(document.getElementById('client-initial-paid-installments').value, 10) || 0;
                        const initialPartialAmount = parseFloat(document.getElementById('client-initial-partial-payment').value) || 0.0;
                        if ((initialPaidInstallments > 0 || initialPartialAmount > 0) && (initialPaidInstallments <= installments)) {
                            const fullInstallmentsAmount = installmentValue * initialPaidInstallments;
                            const totalMigratedAmount = fullInstallmentsAmount + initialPartialAmount;
                            loanSpecificData.paid = totalMigratedAmount;
                            loanSpecificData.installments = `${initialPaidInstallments}/${installments}`; 
                            loanSpecificData.initialMigratedAmount = totalMigratedAmount; 
                            loanSpecificData.migrationDate = new Date(); 
                            if (!loanSpecificData.history) loanSpecificData.history = [];
                            const migrationTimestamp = new Date();
                            if (fullInstallmentsAmount > 0) {
                                loanSpecificData.history.push({
                                    amount: fullInstallmentsAmount, date: migrationTimestamp,
                                    status: 'approved', method: 'migration', migrationType: 'full_installments'
                                });
                            }
                            if (initialPartialAmount > 0) {
                                loanSpecificData.history.push({
                                    amount: initialPartialAmount, date: migrationTimestamp,
                                    status: 'approved', method: 'migration', migrationType: 'partial_payment'
                                });
                            }
                        }
                    }
                    
                    if (isNewLoan) {
                        const clientRef = doc(db, 'companies', currentCompanyId, 'clients', clientIdToSave);
                        await updateDoc(clientRef, {
                            loans: arrayUnion(loanSpecificData)
                        });
                    } else if (isEditMode) {
                        if (password && password !== client.password) {
                            showToast("Atualizando senha...", false);
                            if (!auth.currentUser) throw new Error("Cobrador não está autenticado.");
                            const idToken = await auth.currentUser.getIdToken(true);
                            const functionUrl = "https://us-central1-lumix-financas-app.cloudfunctions.net/updateClientAuth";
                            const response = await fetch(functionUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                                body: JSON.stringify({ data: { clientUsername: clientIdToSave, newPassword: password } })
                            });
                            if (!response.ok) throw new Error("Erro ao alterar senha.");
                        }

                        const clientRef = doc(db, 'companies', currentCompanyId, 'clients', clientIdToSave);
                        const updatedLoans = [...client.loans];
                        updatedLoans[loanIndex] = {
                             ...updatedLoans[loanIndex], 
                             lateFeeRate: lateFeeRate, // 0
                             microInsurance: microInsurance, // ACTUALIZAR
                             totalLoan: totalToPay,
                             amount: installmentValue,
                             originalInstallmentAmount: installmentValue,
                             installments: `${(loan.installments || '0/0').split('/')[0]}/${installments}`,
                             paymentFrequency: paymentFrequency,
                             paymentDays: paymentDaysValue,
                             collectionTime: document.getElementById('client-collection-time').value,
                         };
                        await updateDoc(clientRef, {
                             loans: updatedLoans,
                             ...clientGeneralData
                        });
                    } else { 
                        let newClientAuthUid = null;
                        try {
                            if (!auth.currentUser) throw new Error("Cobrador não autenticado.");
                            const idToken = await auth.currentUser.getIdToken(true);
                            const functionUrl = "https://us-central1-lumix-financas-app.cloudfunctions.net/createClientAuthAndLink";
                            const response = await fetch(functionUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                                body: JSON.stringify({ data: { clientEmail: email, clientPassword: password } }) 
                            });
                            const result = await response.json();
                            if (!response.ok || !result.result?.success) throw new Error(result.error?.message || "Erro na criação");
                            newClientAuthUid = result.result.clientUid;
                        } catch (authCreationError) {
                             console.error("Erro auth:", authCreationError);
                             throw authCreationError;
                        }
                        
                        const newClientId = username; 
                        const newClientData = {
                            ...clientGeneralData,
                            authUid: newClientAuthUid,
                            loans: [loanSpecificData],
                            fcmTokens: [],
                            notifications: []
                        };
                        const newClientRef = doc(db, 'companies', currentCompanyId, "clients", newClientId);
                        await setDoc(newClientRef, newClientData);
                    }
                    
                    if (saveButton.dataset.isRefinance === 'true') {
                        const clientRef = doc(db, 'companies', currentCompanyId, 'clients', clientIdToSave);
                        await updateDoc(clientRef, { refinanceRequest: null });
                    }

                    window.history.back();
                    const successToastMessage = isEditMode ? translations[currentLang].clientUpdatedSuccess : translations[currentLang].clientRegisteredSuccess;
                    showToast(successToastMessage);

                    if (!isEditMode) { 
                        setTimeout(() => { showShareCredentialsModal(clientGeneralData, isEditMode); }, 400);
                    }
                } catch (error) {
                    console.error("Error al guardar cliente:", error);
                    showToast(error.message || 'Ocurrió un error al guardar los datos.', true);
                } finally {
                    if (clientFormModal.classList.contains('active')) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalButtonHTML;
                        lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
                    }
                }
            });
            
            lucide.createIcons({ nodes: clientFormModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            const docInput2 = document.getElementById('client-document');
            const nameInput = document.getElementById('client-name');
            const editingId = isEditMode ? clientId : null;

            if (docInput2 && !isNewLoan) { 
                docInput2.addEventListener('blur', () => performClientChecks(editingId));
            }
            if (nameInput && !isNewLoan) {
                nameInput.addEventListener('blur', () => performClientChecks(editingId));
            }
            if (isEditMode && (client.documentNumber || client.name)) {
                performClientChecks(editingId);
            }
        }
         
         
         
        

        

        function showShareCredentialsModal(clientData, isEditMode) {
            const modal = document.getElementById('shareCredentialsModal');
            const titleKey = isEditMode ? 'clientUpdatedSuccess' : 'clientRegisteredSuccess';
            const appLink = 'https://cliente.lumixartificial.com'; // Link actualizado

            // --- INICIO DE LA CORRECCIÓN EN EL HTML DEL MODAL ---
            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closeShareModal"><i data-lucide="x"></i></button>
                    <span class="modal-title" data-lang-key="${titleKey}"></span>
                </header>
                <div class="modal-content-wrapper">
                    <div class="container" style="text-align: center;">
                        <i data-lucide="check-circle" style="color: var(--accent-green); width: 80px; height: 80px; stroke-width: 1.5; margin-bottom: 20px;"></i>
                        <h3 data-lang-key="appInstructions"></h3>
                        <div style="background-color: var(--surface); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; margin-top: 20px; text-align: left; display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <strong data-lang-key="appLink"></strong>: <a href="${appLink}" target="_blank" style="color: var(--accent-purple);">${appLink}</a>
                            </div>
                            <div>
                                <!-- CORREGIDO: data-lang-key="username" y valor clientData.username -->
                                <strong data-lang-key="username"></strong>: ${clientData.username}
                            </div>
                            <div>
                                <strong data-lang-key="password"></strong>: ${clientData.password}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <!-- BOTÓN MODIFICADO: Ahora llama a la función de compartir PDF -->
                    <button class="btn-primary" id="share-credentials-pdf-btn">
                        <i data-lucide="share-2"></i> <span>Compartilhar Acesso (PDF)</span>
                    </button>
                </div>
            `;
            // --- FIN DE LA CORRECCIÓN EN EL HTML DEL MODAL ---

            history.pushState({ modal: 'shareCredentialsModal' }, 'Share Credentials', '#share');
            modal.classList.add('active');
            
            applyLanguage(currentLang);
            lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });

            document.getElementById('closeShareModal').addEventListener('click', () => {
                window.history.back();
            });

            // --- INICIO: LÓGICA DEL BOTÓN DE COMPARTIR PDF (Sin cambios) ---
            document.getElementById('share-credentials-pdf-btn').addEventListener('click', async (e) => {
                const shareBtn = e.currentTarget;
                const originalHTML = shareBtn.innerHTML;
                shareBtn.disabled = true;
                shareBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Gerando PDF...`;
                lucide.createIcons({nodes: [shareBtn.querySelector('i')]});

                try {
                    // 1. Generar el PDF usando la nueva función (ahora corregida)
                    const pdfBlob = await generateClientAccessPDF(clientData);
                    const pdfFile = new File([pdfBlob], `Acesso_Cliente_${clientData.name.replace(/\s/g, '_')}.pdf`, { type: 'application/pdf' });

                    // 2. Verificar si el navegador soporta 'navigator.share' para archivos
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                        
                        // 3. Usar la API de Share nativa
                        const shareData = {
                            files: [pdfFile],
                            title: `Acesso - ${clientData.name}`,
                            text: `Olá ${clientData.name}! Segue seu acesso ao portal do cliente.`
                        };

                        await navigator.share(shareData);
                        console.log('PDF compartido com sucesso via API nativa.');
                        
                    } else {
                        // 4. Fallback: Si no soporta 'share', forzar el 'download'
                        console.warn("API Web Share (para arquivos) não suportada. Recorrendo ao download.");
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(pdfBlob);
                        link.download = pdfFile.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast('PDF baixado. O compartilhamento nativo não é suportado neste navegador.');
                    }

                } catch (err) {
                    console.error("Erro ao gerar ou compartilhar PDF:", err);
                    // No mostrar error si el usuario simplemente canceló la ventana de compartir
                    if (err.name !== 'AbortError') { 
                        showToast('Erro ao compartilhar o PDF.', true);
                    }
                } finally {
                    // 5. Restaurar el botón
                    shareBtn.disabled = false;
                    shareBtn.innerHTML = originalHTML;
                    lucide.createIcons({nodes: [shareBtn.querySelector('i')]});
                }
            });
            // --- FIN: LÓGICA DEL BOTÓN ---
        }



        
        

        // --- MÓDULO DE GASTOS ---
        function renderExpensesList(expenses) {
            const container = document.getElementById('expenses-list-container');
            if (!container) return;
            if (expenses.length === 0) {
                // AHORA USA LA CLAVE DE TRADUCCIÓN 'noExpenses'
                container.innerHTML = `<div class="no-items" data-lang-key="noExpenses">${translations[currentLang].noExpenses}</div>`;
                return;
            }
            container.innerHTML = expenses
                .sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0))
                .map(expense => {
                    const categoryText = (translations[currentLang] && translations[currentLang][expense.category]) || expense.category;
                    const dateText = expense.date?.seconds ? new Date(expense.date.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A';
                    return `
                        <div class="expense-card" data-expense-id="${expense.id}">
                            <div class="expense-info">
                                <h4 class="expense-category">${categoryText}</h4>
                                <p class="expense-obs">${expense.observations || 'Sem observações'}</p>
                            </div>
                            <div class="expense-value-info">
                                <span class="expense-amount">-${money(expense.value)}</span>
                                <span class="expense-date">${dateText}</span>
                            </div>
                        </div>`;
                }).join('');
        }

        // Pega la copia de renderExpensesList aquí y modifica como sigue:
function renderSettlementsList(settlements) { 
            const container = document.getElementById('settlements-list-container');
            if (!container) return;
            if (settlements.length === 0) {
                container.innerHTML = `<div class="no-items" data-lang-key="noSettlements">${translations[currentLang].noSettlements}</div>`;
                return;
            }
            container.innerHTML = settlements 
                .sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)) 
                .map(settlement => { 
                    const dateText = settlement.date?.seconds ? new Date(settlement.date.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A';
                    const timeText = settlement.date?.seconds ? new Date(settlement.date.seconds * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '';

                    let statusText = 'Pendente';
                    let statusStyle = 'color: var(--warning-color); font-weight: bold;';
                    if (settlement.status === 'approved') {
                        statusText = 'Aprovada';
                        statusStyle = 'color: var(--accent-green);';
                    } else if (settlement.status === 'rejected') {
                        statusText = 'Rejeitada';
                        statusStyle = 'color: var(--danger-color);';
                    }

                    // --- ETIQUETA DE MOTIVO ---
                    const isInsurance = settlement.type === 'insurance';
                    let reasonLabel = settlement.notes ? settlement.notes : (isInsurance ? 'Micro Seguro' : 'Retirada');
                    
                    // Cortamos si es muy largo
                    if (reasonLabel.length > 18) reasonLabel = reasonLabel.substring(0, 18) + '...';

                    return `
                        <div class="payment-history-item" data-settlement-id="${settlement.id}" style="cursor: default;"> 
                             <div class="payment-history-details">
                                <h4 class="payment-history-title">${dateText} - ${timeText}</h4>
                                <p class="payment-history-description" style="${statusStyle}">${statusText}</p>
                            </div>
                            
                            <!-- CAMBIOS AQUÍ: gap: 20px y color azul bonito -->
                            <div class="payment-history-info" style="display: flex; align-items: center; gap: 20px;">
                                <span class="payment-history-amount" style="color: var(--danger-color); font-size: 1.1em; white-space: nowrap;">-${money(settlement.amount)}</span>
                                <span style="font-size: 0.9em; color: #0ea5e9; font-weight: 600; text-transform: capitalize; letter-spacing: 0.3px;">${reasonLabel}</span>
                                ${settlement.receiptUrl ? '<div><i data-lucide="camera" style="color: var(--text-secondary); width: 16px; height: 16px;"></i></div>' : ''}
                            </div>
                        </div>`;
                }).join('');
             lucide.createIcons({nodes: container.querySelectorAll('[data-lucide]')}); 
        }

        function updateExpensesView() {
    const expensesContainer = document.getElementById('expenses-list-container'); // Renombrado para claridad
    const periodFilter = document.querySelector('#expenses-view [data-period].active');
    const categoryFilter = document.querySelector('#expenses-view [data-category].active');
    // Asegúrate que el contenedor de liquidaciones también exista
    const settlementsContainer = document.getElementById('settlements-list-container');

    if (!expensesContainer || !periodFilter || !categoryFilter || !settlementsContainer) return;

    const period = periodFilter.dataset.period;
    const category = categoryFilter.dataset.category;

    // --- Filtra solo los gastos ---
    let filteredExpenses = [...allExpenses]; // Usa allExpenses (que ahora solo contendrá type: 'expense')

    // Filter by period (la lógica existente está bien)
    const now = new Date();
    
    let startDate;
let endDate; // <-- AÑADE ESTA LÍNEA
if (period !== 'all') {
    endDate = new Date(now); // Por defecto, el fin es ahora
    endDate.setHours(23, 59, 59, 999); // Fin del día actual

    if (period === 'today') {
        startDate = new Date(now.setHours(0, 0, 0, 0));
    } else if (period === 'week') {
        startDate = new Date(now); // Usa una copia para no modificar 'now'
        startDate.setDate(startDate.getDate() - startDate.getDay()); // Inicio semana (Domingo)
        startDate.setHours(0, 0, 0, 0);
    } else if (period === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    }
}

// Modifica la lógica de filtrado para usar startDate Y endDate
if (startDate || endDate) { // Si hay al menos una fecha
    filteredExpenses = filteredExpenses.filter(e => {
        if (!e.date?.seconds) return false; // Ignora gastos sin fecha
        const expenseDate = new Date(e.date.seconds * 1000);
        // Comprueba si está DESPUÉS O IGUAL a startDate (si existe)
        const afterStart = startDate ? expenseDate >= startDate : true;
        // Comprueba si está ANTES O IGUAL a endDate (si existe)
        const beforeEnd = endDate ? expenseDate <= endDate : true;
        return afterStart && beforeEnd; // Debe cumplir ambas condiciones
    });
}

    // Filter by category (la lógica existente está bien)
    if (category !== 'all') {
        filteredExpenses = filteredExpenses.filter(e => e.category === category);
    }

    // --- Renderiza las dos listas ---
    renderExpensesList(filteredExpenses);
    renderSettlementsList(allSettlements); // allSettlements ya está filtrado por cobrador por el onSnapshot
}


        function showOutflowTypeModal() {
            const modal = document.getElementById('reportOptionsModal');
            if (!modal) return;

            modal.classList.add('active');

            const t = translations[currentLang];
            const selectTypeLabel = currentLang === 'es' ? 'Selecciona el tipo de registro:' : (currentLang === 'en' ? 'Select record type:' : 'Selecione o tipo de registro:');

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 380px; padding: 25px; background-color: var(--surface); border-radius: 16px;"> 
                    <button class="close-modal-btn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; line-height: 1;">&times;</button>

                    <h3 style="margin: 0 0 20px; text-align: center; font-size: 1.3em; font-weight: 600; color: var(--text-primary);">${t.registerOutflow}</h3>
                    <p style="text-align: center; color: var(--text-secondary); margin: -10px 0 30px; font-size: 0.95em;">${selectTypeLabel}</p>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;"> 

                        <button class="btn-primary" id="add-expense-option-btn" style="padding: 18px 15px; text-align: left; display: flex; align-items: center; gap: 12px; font-size: 1em; background-color: color-mix(in srgb, var(--accent-purple) 90%, black);"> 
                            <i data-lucide="receipt" style="width: 28px; height: 28px; flex-shrink: 0;"></i> 
                            <div>
                                <span style="font-weight: 600;">${t.addExpenseOption}</span>
                                <span style="display: block; font-size: 0.8em; opacity: 0.8;">${t.expenseOptionDesc}</span>
                            </div>
                        </button>

                        <button class="btn-secondary" id="add-settlement-option-btn" style="padding: 18px 15px; text-align: left; display: flex; align-items: center; gap: 12px; font-size: 1em; border-width: 2px;"> 
                            <i data-lucide="arrow-down-circle" style="width: 28px; height: 28px; flex-shrink: 0;"></i> 
                            <div>
                                <span style="font-weight: 600;">${t.cashWithdrawal}</span>
                                <span style="display: block; font-size: 0.8em; opacity: 0.8;">${t.withdrawalOptionDesc}</span>
                            </div>
                        </button>

                    </div>
                </div>
            `;

            lucide.createIcons({nodes: modal.querySelectorAll('[data-lucide]')}); 

            const closeModal = () => modal.classList.remove('active');

            modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);
            modal.querySelector('#add-expense-option-btn').addEventListener('click', () => {
                closeModal();
                showExpenseFormModal(); 
            });
            modal.querySelector('#add-settlement-option-btn').addEventListener('click', () => {
                 closeModal();
                 showSettlementFormModal(); 
            });
        }

        // Pega esta NUEVA función aquí
function showSettlementFormModal() {
            const modal = document.getElementById('settlementFormModal');
            if (!modal) return; 

            let receiptFile = null;
            const t = translations[currentLang];
            const receiptLabel = currentLang === 'es' ? 'Comprobante (Opcional):' : (currentLang === 'en' ? 'Receipt (Optional):' : 'Comprovante (Opcional):');
            const attachLabel = currentLang === 'es' ? 'Anexar Comprobante' : (currentLang === 'en' ? 'Attach Receipt' : 'Anexar Comprovante');

            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closeSettlementFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">${t.cashWithdrawal}</span> 
                </header>
                <div class="modal-content-wrapper container">
                    <div class="form-group">
                        <label for="settlement-form-amount">${t.amountDeliveredAdmin}</label>
                        <input type="number" id="settlement-form-amount" step="0.01" placeholder="0.00" required style="font-size: 1.5em; text-align: center; padding: 15px;">
                    </div>
                    <div class="form-group">
                        <label for="settlement-form-notes" data-lang-key="observations"></label>
                        <textarea id="settlement-form-notes" rows="2" placeholder="..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>${receiptLabel}</label>
                        <div id="settlement-receipt-preview-container" style="margin-bottom: 15px;"></div>
                        <button type="button" class="btn-secondary" id="upload-settlement-receipt-btn" style="width: 100%;">
                            <i data-lucide="camera"></i> ${attachLabel}
                        </button>
                        <input type="file" id="settlement-receipt-file-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="saveSettlementBtn"><i data-lucide="send"></i> ${t.sendForApproval}</button>
                </div>
            `;

            history.pushState({ modal: 'settlementFormModal' }, 'Settlement Form', '#settlement-form');
            modal.classList.add('active');
            lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            modal.querySelector('#closeSettlementFormModal').addEventListener('click', () => window.history.back());

            modal.querySelector('#upload-settlement-receipt-btn').addEventListener('click', () => {
                document.getElementById('settlement-receipt-file-input').click();
            });

            modal.querySelector('#settlement-receipt-file-input').addEventListener('change', e => {
                receiptFile = e.target.files[0];
                if (receiptFile) {
                    const previewContainer = document.getElementById('settlement-receipt-preview-container');
                    previewContainer.innerHTML = `
                        <div class="preview-item" style="display: flex; align-items: center; justify-content: space-between; background-color: var(--bg); padding: 8px 12px; border-radius: 6px; font-size: 0.9em;">
                            <span>${receiptFile.name}</span>
                            <img id="settlement-receipt-preview" style="max-height: 40px; border-radius: 4px; margin-left: 10px;">
                        </div>`;
                    const previewImg = document.getElementById('settlement-receipt-preview');
                    previewImg.src = URL.createObjectURL(receiptFile);
                }
            });

            modal.querySelector('#saveSettlementBtn').addEventListener('click', async (e) => {
                 const saveButton = e.currentTarget;
                 const amountInput = document.getElementById('settlement-form-amount');
                 const amount = parseFloat(amountInput.value);

                 if (isNaN(amount) || amount <= 0) {
                     showToast('Valor inválido', true);
                     return;
                 }

                 saveButton.disabled = true;
                 saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i>...`;
                 lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

                 try {
                    let receiptUrl = '';
                    if (receiptFile) {
                         const tempSettlementId = `settlement_${Date.now()}`;
                         const storageRef = ref(storage, `companies/${currentCompanyId}/settlements/${currentCollectorUsername}/${tempSettlementId}/${receiptFile.name.replace(/\s+/g, '_')}`)
                         await uploadBytes(storageRef, receiptFile);
                         receiptUrl = await getDownloadURL(storageRef);
                    }

                    const collectorName = document.querySelector('.profile-name')?.textContent || currentCollectorUsername; 

                    const settlementData = {
                        type: 'settlement',
                        collectorId: currentCollectorUsername,
                        collectorName: collectorName, 
                        amount: amount,
                        notes: document.getElementById('settlement-form-notes').value.trim(),
                        receiptUrl: receiptUrl,
                        date: serverTimestamp(),
                        
                        // === CAMBIO: ESTADO APROBADO DIRECTAMENTE ===
                        // Esto descuenta el dinero inmediatamente sin esperar al admin
                        status: 'approved' 
                    };

                    await addDoc(collection(db, 'companies', currentCompanyId, 'settlements'), settlementData);
                    window.history.back();
                    
                    // Cambiamos el mensaje para reflejar que ya se hizo
                    showToast('Retirada registrada e descontada!');
                 } catch (err) {
                     console.error(err);
                     showToast('Erro ao enviar', true);
                 } finally {
                     saveButton.disabled = false;
                     saveButton.innerHTML = `<i data-lucide="send"></i> ${t.sendForApproval}`;
                     lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
                 }
            });
        }






        function showExpenseFormModal() {
            const expenseFormModal = document.getElementById('expenseFormModal');
            let receiptFile = null;

            expenseFormModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeExpenseFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="addExpense"></span>
                </header>
                <div class="modal-content-wrapper">
                  <div class="container">
                    <form id="expense-form">
                        <div class="form-group">
                            <label data-lang-key="expenseType"></label>
                            <select id="expense-category" required>
                                <option value="fuel" data-lang-key="fuel"></option>
                                <option value="food" data-lang-key="food"></option>
                                
                                <!-- AQUI AGREGAMOS LA OPCIÓN SALARIO -->
                                <option value="salary" data-lang-key="salary"></option>
                                <!-- FIN OPCIÓN SALARIO -->

                                <option value="rent" data-lang-key="rent"></option>
                                <option value="mechanics" data-lang-key="mechanics"></option>
                                <option value="other" data-lang-key="other"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="expenseValue"></label>
                            <input type="number" id="expense-value" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="observations"></label>
                            <textarea id="expense-obs"></textarea>
                        </div>
                         <div class="form-group">
                            <label data-lang-key="uploadReceipt"></label>
                            <div id="receipt-preview-container" style="margin-bottom: 15px;"></div>
                            <button type="button" class="btn-secondary" id="upload-receipt-btn" style="width: 100%;">
                                <i data-lucide="upload"></i> <span>Anexar Recibo</span>
                            </button>
                            <input type="file" id="receipt-file-input" accept="image/*,application/pdf" style="display: none;">
                        </div>
                    </form>
                  </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="saveExpenseBtn"><i data-lucide="save"></i> <span data-lang-key="saveExpense"></span></button>
                </div>`;
            history.pushState({ modal: 'expenseFormModal' }, 'Expense Form', '#expense-form');
            expenseFormModal.classList.add('active');
            
            document.getElementById('upload-receipt-btn').addEventListener('click', () => {
                document.getElementById('receipt-file-input').click();
            });

            document.getElementById('receipt-file-input').addEventListener('change', e => {
                receiptFile = e.target.files[0];
                if (receiptFile) {
                    document.getElementById('receipt-preview-container').innerHTML = `<div class="preview-item"><span>${receiptFile.name}</span></div>`;
                }
            });

            document.getElementById('closeExpenseFormModal').addEventListener('click', () => window.history.back());

            document.getElementById('saveExpenseBtn').addEventListener('click', async (e) => {
                const saveButton = e.currentTarget;
                const valueInput = document.getElementById('expense-value');

                if (!valueInput.value || parseFloat(valueInput.value) <= 0) {
                    showToast('O valor do gasto é obrigatório.', true);
                    valueInput.style.borderColor = 'var(--danger-color)';
                    setTimeout(() => { valueInput.style.borderColor = ''; }, 2500);
                    return;
                }
                
                saveButton.disabled = true;
                saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> <span>Salvando...</span>`;
                lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

                try {
                    
                    let receiptUrl = ''; // Inicializa receiptUrl
if (receiptFile) {
     // Usaremos un ID temporal para la ruta, Firestore generará el ID real después
     const tempExpenseId = `expense_${Date.now()}`;
     // 1. Crear referencia (expenses/ID_COBRADOR/ID_GASTO/receipt.ext)
     const storageRef = ref(storage, `companies/${currentCompanyId}/expenses/${currentCollectorUsername}/${tempExpenseId}/${receiptFile.name.replace(/\s+/g, '_')}`);

     // 2. Subir archivo
     await uploadBytes(storageRef, receiptFile);

     // 3. Obtener URL
     receiptUrl = await getDownloadURL(storageRef); // Asigna la URL
}

const expenseData = {
    type: 'expense', // Asegúrate que este campo exista
    collectorId: currentCollectorUsername,
    category: document.getElementById('expense-category').value,
    value: parseFloat(valueInput.value),
    observations: document.getElementById('expense-obs').value,
    receiptUrl, // Aquí ya va la URL de Firebase
    date: serverTimestamp()
};
// Guardar en Firestore (igual que antes)
await addDoc(collection(db, 'companies', currentCompanyId, 'expenses'), expenseData);

                    
                    window.history.back();
                    showToast('Gasto salvo com sucesso!');

                } catch (err) {
                    console.error("Falha ao salvar gasto:", err);
                    showToast('Falha ao salvar o gasto.', true);
                    saveButton.disabled = false;
                    saveButton.innerHTML = `<i data-lucide="save"></i> <span data-lang-key="saveExpense"></span>`;
                    applyLanguage(currentLang);
                    lucide.createIcons({nodes: [saveButton.querySelector('i')]});
                }
            });
            
            applyLanguage(currentLang);
            lucide.createIcons({ nodes: expenseFormModal.querySelectorAll('[data-lucide]') });
        }

            function showPaymentModal(clientId, loanIndex) {
            const paymentModal = document.getElementById('paymentModal');
            const client = allClients.find(c => c.id === clientId);
            const loan = client.loans[loanIndex];

            // --- INICIO: CÁLCULO INTELIGENTE DE DEUDA RESTANTE ---
            const details = calculateLoanDetails(loan);
            const historyPaid = (loan.history || [])
                .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration')
                .reduce((sum, h) => sum + (h.amount || 0), 0);
            
            const initialPaid = loan.initialMigratedAmount || 0;
            const totalPaidSoFar = initialPaid + historyPaid;
            const totalDebt = (loan.totalLoan || 0) + (details.lateFeesAccumulated || 0);
            let remainingBalance = Math.max(0, totalDebt - totalPaidSoFar);
            remainingBalance = Math.round(remainingBalance * 100) / 100;

            const standardInstallment = loan.amount || loan.originalInstallmentAmount || 0;
            let suggestedValue = standardInstallment;
            if (remainingBalance < (standardInstallment - 0.05)) {
                suggestedValue = remainingBalance;
            }
            // --- FIN CÁLCULO INTELIGENTE ---

            paymentModal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Registrar Pagamento para ${client.name} (Préstamo ${loanIndex + 1})</span>
                </header>
                <div class="modal-content-wrapper container">
                    
                    <div class="kpi-card" style="text-align:center; display: flex; justify-content: space-around; align-items: center;">
                        <div>
                            <h3 class="kpi-title" style="justify-content:center; margin-bottom: 4px;" data-lang-key="installmentValue">Valor Parcela</h3>
                            <p class="kpi-value" style="font-size: 1.1em; color: var(--text-secondary);">${money(standardInstallment)}</p>
                        </div>
                        <div style="border-left: 1px solid var(--border-color); height: 40px;"></div>
                        <div>
                            <h3 class="kpi-title" style="justify-content:center; margin-bottom: 4px;">Resta</h3>
                            <p class="kpi-value" style="font-size: 1.1em; color: var(--accent-orange);">${money(remainingBalance)}</p>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label for="payment-amount-input" data-lang-key="amountPaid"></label>
                        <input type="number" id="payment-amount-input" step="0.01" value="${suggestedValue.toFixed(2)}" style="font-size: 1.6em; text-align: center; font-weight: 700; color: var(--accent-green); padding: 15px;">
                        
                        ${suggestedValue < standardInstallment ? 
                            `<p style="text-align: center; font-size: 0.85em; color: var(--accent-purple); margin-top: 8px; font-weight: 600;">
                                <i data-lucide="sparkles" style="width: 14px; height: 14px; vertical-align: middle;"></i> Valor ajustado para liquidar o restante.
                            </p>` : ''
                        }
                    </div>

                    <h3 class="section-title" style="margin-top: 30px;">Método de Pagamento</h3>
                    <div class="radio-group" id="payment-method-selector">
                        <input type="radio" name="paymentMethod" id="method-dinheiro" value="dinheiro" checked>
                        <label for="method-dinheiro"><i class="icon" data-lucide="banknote"></i><span data-lang-key="receivedInCash"></span></label>
                        
                        <input type="radio" name="paymentMethod" id="method-pix" value="pix">
                        <label for="method-pix"><i class="icon" data-lucide="smartphone"></i><span data-lang-key="methodDigitalLabel"></span></label>
                        
                        <input type="radio" name="paymentMethod" id="method-cartao" value="cartao">
                        <label for="method-cartao"><i class="icon" data-lucide="credit-card"></i><span data-lang-key="methodCardLabel"></span></label>
                    </div>
                    <div class="form-group" id="receipt-upload-section" style="display: none; margin-top: 20px;">
                        <label data-lang-key="uploadReceipt"></label>
                        <label for="payment-receipt-input" style="border: 2px dashed var(--border-color); padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; display: block;">
                            <i data-lucide="upload-cloud"></i>
                            <span id="payment-upload-label-text">Clique para anexar</span>
                            <img id="payment-receipt-preview" style="display:none; max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">
                        </label>
                        <input type="file" id="payment-receipt-input" accept="image/*" style="display:none;">
                    </div>
                </div>
                <div class="action-buttons">
                    <!-- BOTÓN ADIAR TRADUCIDO -->
                    <button class="btn-secondary" id="postponePaymentBtnInModal" style="border-color: var(--text-secondary); color: var(--text-secondary);">
                        <i data-lucide="calendar-plus"></i> <span data-lang-key="postponePayment">Adiar</span>
                    </button>
                    
                    <button class="btn-primary" id="confirmPaymentBtn" style="flex-grow: 2;">
                        <i data-lucide="check-circle"></i> Confirmar Pagamento
                    </button>
                </div>`;
            
            history.pushState({ modal: 'paymentModal' }, 'Payment', '#payment');
            paymentModal.classList.add('active');
            lucide.createIcons({ nodes: paymentModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            paymentModal.querySelector('#closePaymentModal').addEventListener('click', () => window.history.back());
            
            const paymentMethodSelector = paymentModal.querySelector('#payment-method-selector');
            const receiptUploadSection = paymentModal.querySelector('#receipt-upload-section');
            let receiptFile = null;

            paymentMethodSelector.addEventListener('change', (e) => {
                const selectedInputs = document.querySelectorAll('input[name="paymentMethod"]');
                selectedInputs.forEach(input => {
                    const method = input.value;
                     if(input.checked && (method === 'pix' || method === 'cartao')) {
                        receiptUploadSection.style.display = 'block';
                     } else if (input.checked && method === 'dinheiro') {
                        receiptUploadSection.style.display = 'none';
                        receiptFile = null;
                        const preview = document.getElementById('payment-receipt-preview');
                        if (preview) {
                            preview.style.display = 'none';
                            preview.src = '';
                        }
                        const label = document.getElementById('payment-upload-label-text');
                        if (label) label.textContent = 'Clique para anexar';
                     }
                });
            });

            paymentModal.querySelector('#payment-receipt-input').addEventListener('change', e => {
                if (e.target.files && e.target.files[0]) {
                    receiptFile = e.target.files[0];
                    const preview = document.getElementById('payment-receipt-preview');
                    const uploadLabel = document.getElementById('payment-upload-label-text');
                    preview.src = URL.createObjectURL(receiptFile);
                    preview.style.display = 'block';
                    uploadLabel.textContent = receiptFile.name;
                }
            });
            
            // --- LÓGICA BOTÓN ADIAR (CORREGIDA PARA NUEVO MODAL) ---
            const postponeBtn = paymentModal.querySelector('#postponePaymentBtnInModal');
            if (postponeBtn) {
                postponeBtn.addEventListener('click', async () => {
                     // CORRECCIÓN: Usamos await
                     const confirmed = await showConfirmationModal(
                        translations[currentLang].postponeConfirmTitle || 'Confirmar Adiamento',
                        translations[currentLang].postponeConfirmMsg || 'Isso moverá a data de vencimento em 1 dia. Deseja continuar?',
                        translations[currentLang].confirm || 'Confirmar',
                        'btn-secondary'
                    );

                    if (!confirmed) return;

                    const clientRef = doc(db, 'companies', currentCompanyId, "clients", clientId);
                    try {
                        const freshClientIdx = allClients.findIndex(c => c.id === clientId);
                        const freshClient = allClients[freshClientIdx];
                        const loansCopy = JSON.parse(JSON.stringify(freshClient.loans));
                        const targetLoan = loansCopy[loanIndex];
                        
                        if (!targetLoan.history) targetLoan.history = [];
                        
                        targetLoan.history.push({ 
                            amount: 0, 
                            date: new Date(), 
                            status: 'postponed' 
                        });
                        
                        await updateDoc(clientRef, { loans: loansCopy });

                        showToast('Pagamento adiado com sucesso!');
                        window.history.back(); // Cierra modal de pago
                        
                        // Refrescamos todo
                        showClientDetails(clientId, loanIndex);
                        updateTodaysRouteList();
                        updateAllClientsList();
                    } catch(error) {
                        console.error("Error postponing:", error);
                        showToast('Erro ao adiar.', true);
                    }
                });
            }
            

            paymentModal.querySelector('#confirmPaymentBtn').addEventListener('click', async (e) => {
                const confirmBtn = e.currentTarget;
                const originalBtnHTML = confirmBtn.innerHTML;
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Processando...`;
                lucide.createIcons({nodes: confirmBtn.querySelectorAll('[data-lucide]')});

                const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                try {
                    const clientIndex = allClients.findIndex(c => c.id === clientId);
                    if (clientIndex === -1) throw new Error("Cliente não encontrado em allClients.");
                    
                    const currentClient = allClients[clientIndex]; 
                    if (!currentClient || !currentClient.loans || !currentClient.loans[loanIndex]) {
                         throw new Error("Cliente ou empréstimo não encontrado para registrar o pagamento.");
                    }
                    
                    const currentLoan = currentClient.loans[loanIndex]; 

                    let receiptUrl = '';
                    if (receiptFile && (selectedMethod === 'pix' || selectedMethod === 'cartao')) {
                        try {
                            const tempPaymentId = `payment_${Date.now()}`;
                            const storageRef = ref(storage, `companies/${currentCompanyId}/clients/${clientId}/payments/${tempPaymentId}/${receiptFile.name.replace(/\s+/g, '_')}`);
                            await uploadBytes(storageRef, receiptFile);
                            receiptUrl = await getDownloadURL(storageRef);
                        } catch (storageError) {
                             console.error("Error al subir recibo a Firebase Storage:", storageError);
                             showToast('Falha ao subir o recibo. O pagamento será salvo sem ele.', true);
                        }
                    }

                    const actualPaidAmount = parseFloat(document.getElementById('payment-amount-input').value);
                    if (isNaN(actualPaidAmount) || actualPaidAmount < 0) {
                        showToast('Por favor, insira um valor de pagamento válido.', true);
                        confirmBtn.disabled = false; 
                        confirmBtn.innerHTML = originalBtnHTML;
                        lucide.createIcons({nodes: confirmBtn.querySelectorAll('[data-lucide]')});
                        return;
                    }

                    const clientRef = doc(db, 'companies', currentCompanyId, "clients", clientId);

                    const newPayment = {
                        amount: actualPaidAmount,
                        date: new Date(), 
                        status: 'approved', 
                        method: selectedMethod
                    };
                    
                    if(receiptUrl) {
                        newPayment.receiptUrl = receiptUrl;
                    }

                    if (!currentLoan.history) currentLoan.history = [];
                    currentLoan.history.push(newPayment);

                    const newTotalPaid = (currentLoan.history || [])
                        .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed')
                        .reduce((sum, h) => sum + (h.amount || 0), 0);
                        
                    const installmentValue = currentLoan.originalInstallmentAmount || 0; 
                    const paidInstallmentsCount = installmentValue > 0 ? Math.floor(newTotalPaid / installmentValue) : 0;
                    const newBalance = installmentValue > 0 ? newTotalPaid - (paidInstallmentsCount * installmentValue) : newTotalPaid;

                    currentLoan.paid = newTotalPaid;
                    currentLoan.paymentBalance = newBalance;
                    const totalInstallmentsStr = (currentLoan.installments || '0/0').split('/')[1] || '0';
                    currentLoan.installments = `${paidInstallmentsCount}/${totalInstallmentsStr}`;
                    
                    await updateDoc(clientRef, {
                        loans: currentClient.loans 
                    });

                    showToast('Pagamento registrado com sucesso!');
                    window.history.back(); 
                    showClientDetails(clientId, loanIndex); 
                    updateTodaysRouteList();
                    updateRouteProgress(); 
                    updateAllClientsList(); 
                    updateProfileView(currentCollectorData); 
                    
                } catch(error) {
                    console.error("Error updating document: ", error);
                    showToast('Falha ao registrar pagamento.', true);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = originalBtnHTML;
                    lucide.createIcons({nodes: [confirmBtn.querySelector('i')]});
                }
            });
        }
        
        // --- MAPA E OUTRAS FUNÇÕES ---
        function initMap() {
            if (mapInstance) {
                mapInstance.invalidateSize();
                return;
            };
            mapInstance = L.map('map-container').setView([-16.68, -49.25], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
        }

        function plotClientsOnMap() {
            if (!mapInstance) return;
            
            // Reajuste crítico para visualización correcta
            mapInstance.invalidateSize();

            // Limpiar marcadores antiguos
            if (window.mapMarkers && Array.isArray(window.mapMarkers)) {
                window.mapMarkers.forEach(marker => marker.remove());
            }
            window.mapMarkers = [];

            // --- 1. COBRADOR (Icono de Moto) ---
            const collectorIcon = L.icon({
                iconUrl: 'https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/MotoIcono.png?alt=media&token=e8add7cd-e8d3-424d-8f05-5d04e0d10ec1',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36]
            });

            const collectorPosition = collectorCurrentLocation 
                ? [collectorCurrentLocation.lat, collectorCurrentLocation.lng]
                : [-16.68, -49.25]; 

            if (!collectorMarker) {
                collectorMarker = L.marker(collectorPosition, { icon: collectorIcon, zIndexOffset: 1000 }).addTo(mapInstance);
                collectorMarker.bindPopup("Sua Posição Atual");
            } else {
                collectorMarker.setLatLng(collectorPosition);
            }

            // --- 2. CLIENTES (TODOS - Icono Azul Clásico) ---
            const clientIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], // Tamaño estándar
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            const locations = [collectorPosition];

            // CAMBIO CLAVE: Usamos 'allClients' para mostrar a todos, no solo la ruta de hoy
            allClients.forEach((client) => {
                
                if (client.location) {
                    const match = client.location.match(/query=([\d.-]+),([\d.-]+)/);
                    if (match) {
                        const lat = parseFloat(match[1]);
                        const lng = parseFloat(match[2]);
                        locations.push([lat, lng]);

                        // Buscamos el préstamo activo para mostrar el estado correcto en el mapa
                        let loan = null;
                        let loanIndex = 0;

                        if (client.loans && client.loans.length > 0) {
                            // Intentamos encontrar uno activo (no finalizado)
                            const activeIndex = client.loans.findIndex(l => calculateLoanDetails(l).status !== 'finished');
                            if (activeIndex !== -1) {
                                loanIndex = activeIndex;
                                loan = client.loans[activeIndex];
                            } else {
                                // Si todos están finalizados, mostramos el último
                                loanIndex = client.loans.length - 1;
                                loan = client.loans[loanIndex];
                            }
                        }

                        if (loan) {
                            // --- CÁLCULOS FINANCIEROS ---
                            const details = calculateLoanDetails(loan);
                            const status = details.status;
                            
                            let statusLabel = 'SEM DADOS';
                            let statusColor = '#94a3b8';

                            if (status === 'paid') { statusLabel = 'EM DIA'; statusColor = '#22c55e'; }
                            else if (status === 'late') { statusLabel = 'ATRASADO'; statusColor = '#ef4444'; }
                            else if (status === 'pending') { statusLabel = 'PENDENTE'; statusColor = '#f59e0b'; }
                            else if (status === 'finished') { statusLabel = 'FINALIZADO'; statusColor = '#3b82f6'; }

                            const historyPaid = (loan.history || [])
                                .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration')
                                .reduce((sum, h) => sum + (parseFloat(h.amount) || 0), 0);
                            
                            const totalPaid = (loan.initialMigratedAmount || 0) + historyPaid;
                            const totalDebt = (parseFloat(loan.totalLoan) || 0) + (details.lateFeesAccumulated || 0);
                            const remaining = Math.max(0, totalDebt - totalPaid);

                            // --- FICHA BLANCA COMPACTA ---
                            const popupContent = `
                                <div style="font-family: 'Inter', sans-serif; min-width: 170px; background-color: #ffffff; color: #1e293b; padding: 2px; border-radius: 8px;">
                                    <!-- CABECERA: NOMBRE + ESTADO + X -->
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px;">
                                        <div style="overflow: hidden;">
                                            <span style="font-size: 0.65em; text-transform: uppercase; color: #64748b; font-weight: 700; display: block;">CLIENTE</span>
                                            <strong style="font-size: 1em; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 110px;" title="${client.name}">${client.name}</strong>
                                        </div>
                                        
                                        <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                                            <span style="background-color: ${statusColor}; color: white; padding: 1px 5px; border-radius: 4px; font-size: 0.65em; font-weight: 700; text-transform: uppercase;">
                                                ${statusLabel}
                                            </span>
                                            <button class="close-popup-btn" style="background:none; border:none; color:#94a3b8; font-size: 1.6em; cursor:pointer; line-height: 0.8; padding: 0 0 0 4px;">&times;</button>
                                        </div>
                                    </div>

                                    <!-- INFO FINANCIERA (Vertical) -->
                                    <div style="font-size: 0.85em; color: #334155; display: flex; flex-direction: column; gap: 3px; margin-top: 5px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Total:</span> <strong style="color: #0f172a;">${money(totalDebt)}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Pago:</span> <strong style="color: #22c55e;">${money(totalPaid)}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; border-top: 1px dashed #e2e8f0; padding-top: 2px; margin-top: 1px;">
                                            <span style="font-weight: 600;">Resta:</span> <strong style="color: #ef4444; font-size: 1.1em;">${money(remaining)}</strong>
                                        </div>
                                    </div>

                                    <button class="popup-details-btn" data-client-id="${client.id}" data-loan-index="${loanIndex}" style="margin-top: 10px; width: 100%; background-color: #3b82f6; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">
                                        Ver Ficha
                                    </button>
                                </div>
                            `;

                            const marker = L.marker([lat, lng], { icon: clientIcon })
                                .addTo(mapInstance)
                                .bindPopup(popupContent, { closeButton: false, offset: [0, -25] });
                            
                            marker.on('popupopen', (e) => {
                                const popupNode = e.popup.getElement();
                                
                                const detailsBtn = popupNode.querySelector('.popup-details-btn');
                                if (detailsBtn) {
                                    detailsBtn.onclick = () => {
                                        showClientDetails(detailsBtn.dataset.clientId, parseInt(detailsBtn.dataset.loanIndex, 10));
                                    };
                                }

                                const closeBtn = popupNode.querySelector('.close-popup-btn');
                                if (closeBtn) {
                                    closeBtn.onclick = () => {
                                        mapInstance.closePopup();
                                    };
                                }
                            });

                            window.mapMarkers.push(marker);
                        }
                    }
                }
            });
            
            if (locations.length > 0) {
                mapInstance.fitBounds(locations, { padding: [50, 50] });
            }
        }

         async function exportDailyReport(customDate = null) {
            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();
            
            const todayLabel = currentLang === 'es' ? '(HOY)' : (currentLang === 'en' ? '(TODAY)' : '(HOJE)');

            const t = {
                title: currentLang === 'es' ? 'Reporte Diario' : (currentLang === 'en' ? 'Daily Report' : 'Relatório Diário'),
                collector: translations[currentLang].reportCollector || 'Cobrador',
                summary: currentLang === 'es' ? 'Resumen Contable' : (currentLang === 'en' ? 'Accounting Summary' : 'Resumo Contábil'),
                received: translations[currentLang].receivedToday || 'Recebido Hoje',
                expenses: translations[currentLang].reportTotalExpenses || 'Gastos',
                settlements: currentLang === 'es' ? 'Retiro de Caja' : (currentLang === 'en' ? 'Cash Withdrawal' : 'Retirada de Caixa'),
                generatedToday: currentLang === 'es' ? 'GENERADO HOY (Operativo)' : (currentLang === 'en' ? 'GENERATED TODAY' : 'GERADO HOJE (Operacional)'),
                cashFlow: currentLang === 'es' ? 'Variación de Caja (Neto)' : (currentLang === 'en' ? 'Net Cash Flow' : 'Variação de Caixa (Líquido)'),
                capitalHand: translations[currentLang].capitalTotal || 'Capital em Mãos',
                paymentsSection: currentLang === 'es' ? 'Pagos Recibidos' : (currentLang === 'en' ? 'Received Payments' : 'Pagamentos Recebidos'),
                expensesSection: currentLang === 'es' ? 'Gastos del Día' : (currentLang === 'en' ? 'Daily Expenses' : 'Gastos do Dia'),
                newLoansSection: currentLang === 'es' ? 'Nuevos Préstamos / Renovaciones' : (currentLang === 'en' ? 'New Loans / Renewals' : 'Novos Empréstimos / Renovações'),
                missedSection: currentLang === 'es' ? 'Restantes por Cobrar (Pendientes/Atrasados)' : (currentLang === 'en' ? 'Remaining to Collect' : 'Restantes a Receber (Pendentes/Atrasados)'),
                lateSection: currentLang === 'es' ? 'Reporte de Morosidad (Detalle)' : (currentLang === 'en' ? 'Delinquency Report' : 'Relatório de Inadimplência (Detalhe)'),
                finishedSection: currentLang === 'es' ? 'Clientes Finalizados (Histórico)' : (currentLang === 'en' ? 'Finished Clients' : 'Clientes Finalizados (Histórico)'),
                daysLate: currentLang === 'es' ? 'días' : 'dias',
                generatedBy: currentLang === 'es' ? 'Generado por LUMIX Finanzas' : (currentLang === 'en' ? 'Generated by LUMIX Finance' : 'Gerado por LUMIX Finanças'),
                page: currentLang === 'es' ? 'Página' : (currentLang === 'en' ? 'Page' : 'Página'),
                of: currentLang === 'es' ? 'de' : (currentLang === 'en' ? 'of' : 'de'),
                noLate: currentLang === 'es' ? '¡Felicidades! Ningún cliente atrasado actualmente.' : (currentLang === 'en' ? 'Congrats! No late clients currently.' : 'Parabéns! Nenhum cliente atrasado atualmente.'),
                routeLabel: translations[currentLang].routeLabel || 'Rota:',
                microInsurance: currentLang === 'es' ? 'Micro Seguro (Fondo)' : 'Micro Seguro (Fundo)',
                accumulatedInsurance: currentLang === 'es' ? 'FONDO SEGURO ACUMULADO' : 'FUNDO SEGURO ACUMULADO',
                injections: currentLang === 'es' ? 'Aportes' : 'Aportes',
                newLoans: currentLang === 'es' ? 'Nuevos Préstamos' : 'Novos Empréstimos'
            };
            
            const reportDate = customDate || new Date();
            const dateStr = reportDate.toLocaleDateString(currentLang === 'pt' ? 'pt-BR' : 'es-ES');
            showToast(currentLang === 'es' ? `Generando PDF para ${dateStr}...` : `Gerando PDF para ${dateStr}...`, false);

            const checkDateMatch = (timestamp) => {
                if (!timestamp) return false;
                let d;
                if (timestamp.seconds) d = new Date(timestamp.seconds * 1000);
                else if (timestamp instanceof Date) d = timestamp;
                else d = new Date(timestamp);
                return d.toLocaleDateString('pt-BR') === reportDate.toLocaleDateString('pt-BR');
            };

            // --- VARIABLES DEL DÍA ---
            let dailyTotal = 0;
            let dailyTotalCash = 0;
            let dailyTotalDigital = 0;
            const dailyPaymentsList = [];
            const missedPaymentsList = [];
            const finishedClientsList = [];

            // --- CÁLCULO DE FONDO DE SEGURO ACUMULADO (HISTÓRICO TOTAL) ---
            let lifetimeInsuranceGenerated = 0;
            allClients.forEach(c => {
                (c.loans || []).forEach(l => {
                    lifetimeInsuranceGenerated += (parseFloat(l.microInsurance) || 0);
                });
            });

            let lifetimeInsuranceWithdrawn = 0;
            allSettlements.forEach(s => {
                if (s.status === 'approved' && s.type === 'insurance') {
                    lifetimeInsuranceWithdrawn += (s.amount || 0);
                }
            });
            
            // Saldo disponible en la "Hucha" de seguros
            const insuranceFundBalance = Math.max(0, lifetimeInsuranceGenerated - lifetimeInsuranceWithdrawn);
            // -------------------------------------------------------------

            allClients.forEach(client => {
                (client.loans || []).forEach((loan, loanIndex) => { 
                    const details = calculateLoanDetails(loan);
                    let hasPaidToday = false;
                    (loan.history || []).forEach(h => {
                        if (h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed' && h.method !== 'migration') {
                            if (checkDateMatch(h.date)) {
                                hasPaidToday = true;
                                const amt = h.amount || 0;
                                dailyTotal += amt;
                                if (h.method === 'dinheiro') dailyTotalCash += amt;
                                else dailyTotalDigital += amt;

                                let pTime = '00:00';
                                if (h.date?.seconds) pTime = new Date(h.date.seconds*1000).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                                else if (h.date instanceof Date) pTime = h.date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});

                                dailyPaymentsList.push({
                                    clientName: client.name,
                                    amount: amt,
                                    time: pTime,
                                    method: h.method || 'dinheiro', 
                                    loanIndex: loanIndex + 1
                                });
                            }
                        }
                    });

                    if (details.status !== 'finished' && !hasPaidToday) {
                        missedPaymentsList.push({
                            clientName: client.name,
                            loanIndex: loanIndex + 1,
                            expectedAmount: loan.originalInstallmentAmount || 0,
                            status: details.status === 'late' ? 'ATRASADO' : 'PENDENTE'
                        });
                    }

                    const hasActiveLoan = client.loans.some(l => calculateLoanDetails(l).status !== 'finished');
                    if (details.status === 'finished' && !hasActiveLoan && loanIndex === client.loans.length - 1) {
                        finishedClientsList.push({
                            clientName: client.name,
                            loanIndex: loanIndex + 1,
                            totalLoan: loan.totalLoan || 0
                        });
                    }
                });
            });
            
            missedPaymentsList.sort((a, b) => a.clientName.localeCompare(b.clientName));
            dailyPaymentsList.sort((a, b) => a.time.localeCompare(b.time));
            finishedClientsList.sort((a, b) => a.clientName.localeCompare(b.clientName)); 

            const dailyExpenses = allExpenses.filter(e => checkDateMatch(e.date));
            const totalExpenses = dailyExpenses.reduce((sum, e) => sum + e.value, 0);
            dailyExpenses.sort((a, b) => (a.date.seconds || 0) - (b.date.seconds || 0));

            // Filtramos retiros de capital (los de seguro no afectan el flujo operativo del día)
            const dailySettlements = allSettlements.filter(s => checkDateMatch(s.date) && s.type !== 'insurance');
            const totalSettlements = dailySettlements.reduce((sum, s) => sum + s.amount, 0);
            
            const dailyInjections = allCapitalInjections.filter(i => checkDateMatch(i.date));
            const totalInjections = dailyInjections.reduce((sum, i) => sum + i.amount, 0);

            const dailyNewLoans = [];
            allClients.forEach(client => {
                (client.loans || []).forEach((loan, index) => {
                    if (checkDateMatch(loan.startDate) && !loan.migrationDate) {
                        let principal = loan.principalAmount;
                        if (!principal && loan.totalLoan) {
                             const rate = client.interestRate || 20;
                             principal = loan.totalLoan / (1 + (rate/100));
                        }
                        let loanTime = '00:00';
                        if (loan.startDate?.seconds) loanTime = new Date(loan.startDate.seconds*1000).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                        
                        dailyNewLoans.push({
                            clientName: client.name,
                            amount: principal || 0,
                            time: loanTime,
                            microInsurance: parseFloat(loan.microInsurance) || 0,
                            loanIndex: index + 1
                        });
                    }
                });
            });
            const totalLoansOutflow = dailyNewLoans.reduce((sum, l) => sum + l.amount, 0);
            
            // Total seguro DEL DÍA (solo informativo)
            const dailyMicroInsurance = dailyNewLoans.reduce((sum, l) => sum + l.microInsurance, 0);

            const lateClientsList = [];
            allClients.forEach(client => {
                (client.loans || []).forEach((loan, index) => {
                    const details = calculateLoanDetails(loan);
                    if (details.status === 'late') {
                        lateClientsList.push({
                            clientName: client.name,
                            loanIndex: index + 1,
                            lateDays: details.lateDays || 0,
                            amountDue: details.amountDueToday || loan.originalInstallmentAmount || 0
                        });
                    }
                });
            });
            lateClientsList.sort((a, b) => b.lateDays - a.lateDays);
            
            const operationalResult = dailyTotal - totalExpenses;
            
            // Flujo de Caja Operativo (Sin seguros)
            const netCashFlow = (operationalResult + totalInjections) - (totalSettlements + totalLoansOutflow);

            const pageMargin = 15;
            const pageWidth = pdfDoc.internal.pageSize.getWidth();
            const pageHeight = pdfDoc.internal.pageSize.getHeight();
            const center = pageWidth / 2;
            let y = 0;

            const checkPageBreak = (neededSpace = 0) => {
                const limit = pageHeight - 20; 
                if (y + neededSpace > limit) { 
                    pdfDoc.addPage(); 
                    y = 20; 
                }
            };

            const addSectionHeader = (title) => {
                checkPageBreak(50); 
                y += 10;
                pdfDoc.setFontSize(14);
                pdfDoc.setFont(undefined, 'bold');
                pdfDoc.setTextColor(0);
                pdfDoc.text(title, pageMargin, y);
                y += 2;
                pdfDoc.setLineWidth(0.5);
                pdfDoc.setDrawColor(200);
                pdfDoc.line(pageMargin, y, pageWidth - pageMargin, y);
                y += 8;
            };

            y = 25;
            pdfDoc.setFontSize(16);
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.text(currentCompanyData?.name || 'LUMIX Finanças', center, y, { align: 'center' });
            y += 7;
            pdfDoc.setFontSize(12);
            pdfDoc.setFont(undefined, 'normal');
            pdfDoc.setTextColor(100);
            pdfDoc.text(`${t.title} - ${dateStr}`, center, y, { align: 'center' });

            y += 15;
            pdfDoc.setFontSize(10);
            pdfDoc.setTextColor(150);
            pdfDoc.text(`${t.collector}:`, pageMargin, y);
            pdfDoc.setFontSize(12);
            pdfDoc.setTextColor(0);
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.text(currentCollectorData?.name || 'N/A', pageMargin + 20, y); 

            const routeName = currentCollectorData?.routeName || '---';
            pdfDoc.setFontSize(10);
            pdfDoc.setTextColor(150);
            pdfDoc.setFont(undefined, 'normal');
            pdfDoc.text(t.routeLabel, pageWidth - pageMargin - 40, y);
            
            pdfDoc.setFontSize(12);
            pdfDoc.setTextColor(0);
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.text(routeName, pageWidth - pageMargin, y, { align: 'right' });

            checkPageBreak(80); 

            y += 15;
            pdfDoc.setFontSize(14);
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.text(t.summary, pageMargin, y);
            y += 5;
            pdfDoc.setLineWidth(0.5);
            pdfDoc.setDrawColor(200);
            pdfDoc.line(pageMargin, y, pageWidth - pageMargin, y);

            const addSummaryLine = (label, value, color = '#000000', isBold = false) => {
                y += 8;
                pdfDoc.setFontSize(11);
                pdfDoc.setFont(undefined, 'normal');
                pdfDoc.setTextColor(100);
                pdfDoc.text(label, pageMargin + 5, y);
                pdfDoc.setFont(undefined, isBold ? 'bold' : 'bold'); 
                pdfDoc.setTextColor(color);
                pdfDoc.text(money(value), pageWidth - pageMargin - 5, y, { align: 'right' });
            };

            addSummaryLine(`(+) ${t.received} (${dateStr}):`, dailyTotal, '#28a745');
            addSummaryLine(`(-) ${t.expenses}:`, totalExpenses, '#dc3545');
            
            y += 2;
            pdfDoc.setLineWidth(0.1);
            pdfDoc.line(pageMargin + 5, y, pageWidth - pageMargin - 5, y); 
            y += 2;

            addSummaryLine(`(=) ${t.generatedToday}:`, operationalResult, operationalResult >= 0 ? '#6f42c1' : '#dc3545', true);

            y += 5; 

            addSummaryLine(`(-) ${t.newLoans}:`, totalLoansOutflow, '#dc3545');
            addSummaryLine(`(-) ${t.settlements}:`, totalSettlements, '#dc3545');
            addSummaryLine(`(+) ${t.injections}:`, totalInjections, '#28a745');
            
            // --- NUEVO: FONDO DE SEGURO (SEPARADO) ---
            if (insuranceFundBalance > 0) {
                // Línea separadora sutil
                y += 4;
                pdfDoc.setLineWidth(0.1);
                pdfDoc.setDrawColor(220); 
                pdfDoc.setLineDash([1, 1], 0);
                pdfDoc.line(pageMargin + 5, y, pageWidth - pageMargin - 5, y);
                pdfDoc.setLineDash([]);
                y += 2;
                
                addSummaryLine(`${t.accumulatedInsurance}:`, insuranceFundBalance, '#0ea5e9', true); 
            }

            y += 3;
            pdfDoc.setLineWidth(0.5);
            pdfDoc.setDrawColor(0); 
            pdfDoc.line(pageMargin + 5, y, pageWidth - pageMargin - 5, y); 
            
            y += 8;
            pdfDoc.setFontSize(12);
            pdfDoc.setFont(undefined, 'bold');
            pdfDoc.setTextColor(netCashFlow >= 0 ? '#000000' : '#dc3545');
            pdfDoc.text(`${t.cashFlow}:`, pageMargin + 5, y);
            pdfDoc.text(money(netCashFlow), pageWidth - pageMargin - 5, y, { align: 'right' });
            
            y += 10;
            pdfDoc.setFontSize(14);
            pdfDoc.setTextColor(currentCapitalOnHand >= 0 ? '#000000' : '#dc3545');
            pdfDoc.text(`${t.capitalHand} ${todayLabel}:`, pageMargin + 5, y);
            pdfDoc.text(money(currentCapitalOnHand), pageWidth - pageMargin - 5, y, { align: 'right' });

            y += 10;

            if (dailyPaymentsList.length > 0) {
                addSectionHeader(t.paymentsSection);
                dailyPaymentsList.forEach(p => {
                    checkPageBreak(12);
                    pdfDoc.setFontSize(10);
                    pdfDoc.setFont(undefined, 'normal');
                    pdfDoc.setTextColor(0);
                    
                    let methodDisplay = t.cash;
                    if (p.method === 'pix') {
                        methodDisplay = translations[currentLang].methodDigitalLabel || 'PIX';
                    } else if (p.method === 'cartao') {
                        methodDisplay = translations[currentLang].methodCardLabel || 'Cartão';
                    }

                    pdfDoc.text(`${p.time} - ${p.clientName} (${methodDisplay})`, pageMargin + 5, y);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.setTextColor('#28a745');
                    pdfDoc.text(money(p.amount), pageWidth - pageMargin - 5, y, { align: 'right' });
                    y += 7;
                });
            }
            
            if (missedPaymentsList.length > 0) {
                addSectionHeader(t.missedSection);
                missedPaymentsList.forEach(p => {
                    checkPageBreak(12);
                    pdfDoc.setFontSize(10);
                    pdfDoc.setFont(undefined, 'normal');
                    pdfDoc.setTextColor(0);
                    pdfDoc.text(p.clientName, pageMargin + 5, y);
                    pdfDoc.setFont(undefined, 'bold');
                    if (p.status === 'ATRASADO') pdfDoc.setTextColor('#dc3545'); else pdfDoc.setTextColor('#d97706'); 
                    pdfDoc.text(p.status, pageMargin + 100, y);
                    pdfDoc.setTextColor('#000000');
                    pdfDoc.text(money(p.expectedAmount), pageWidth - pageMargin - 5, y, { align: 'right' });
                    y += 7;
                });
            }
            if (finishedClientsList.length > 0) {
                addSectionHeader(t.finishedSection);
                finishedClientsList.forEach(f => {
                    checkPageBreak(12);
                    pdfDoc.setFontSize(10);
                    pdfDoc.setFont(undefined, 'normal');
                    pdfDoc.setTextColor(0);
                    pdfDoc.text(`${f.clientName} (Emp. #${f.loanIndex})`, pageMargin + 5, y);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.setTextColor('#4338ca'); 
                    pdfDoc.text('FINALIZADO', pageMargin + 100, y); 
                    pdfDoc.setTextColor('#000000'); 
                    pdfDoc.text(money(f.totalLoan), pageWidth - pageMargin - 5, y, { align: 'right' });
                    y += 7;
                });
            }

            if (dailyExpenses.length > 0) {
                addSectionHeader(t.expensesSection); 
                dailyExpenses.forEach(e => {
                    checkPageBreak(12); 
                    
                    // === CORREÇÃO DO ERRO ===
                    // Mudamos 'lang' para 'currentLang'
                    const cat = (translations[currentLang] && translations[currentLang][e.category]) ? translations[currentLang][e.category] : e.category;
                    // ========================

                    pdfDoc.setFontSize(10);
                    pdfDoc.setFont(undefined, 'normal');
                    pdfDoc.setTextColor(0);
                    pdfDoc.text(`${cat} - ${e.observations || ''}`, pageMargin + 5, y);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.setTextColor('#dc3545');
                    pdfDoc.text(`-${money(e.value)}`, pageWidth - pageMargin - 5, y, { align: 'right' });
                    y += 7;
                });
            }

            if (dailyNewLoans.length > 0) {
                addSectionHeader(t.newLoansSection);
                dailyNewLoans.forEach(l => {
                    checkPageBreak(12);
                    pdfDoc.setFontSize(10);
                    pdfDoc.setFont(undefined, 'normal');
                    pdfDoc.setTextColor(0);
                    const displayText = `${l.time} - ${l.clientName}`;
                    pdfDoc.text(displayText, pageMargin + 5, y);
                    
                    // --- MOSTRAR SEGURO EN EL DETALLE ---
                    if (l.microInsurance > 0) {
                        pdfDoc.setTextColor('#0ea5e9'); // Azul
                        pdfDoc.setFont(undefined, 'bold');
                        pdfDoc.text(`(+Seguro: ${money(l.microInsurance)})`, pageMargin + 100, y);
                    }

                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.setTextColor('#dc3545'); 
                    pdfDoc.text(`-${money(l.amount)}`, pageWidth - pageMargin - 5, y, { align: 'right' });
                    y += 7;
                });
            }

            addSectionHeader(t.lateSection);
            if (lateClientsList.length > 0) {
                checkPageBreak(15); 
                pdfDoc.setFontSize(9);
                pdfDoc.setTextColor(100);
                pdfDoc.setFont(undefined, 'bold'); 
                pdfDoc.text('Cliente', pageMargin + 5, y);
                pdfDoc.text('Dias', pageMargin + 100, y);
                pdfDoc.text('Status', pageMargin + 140, y);
                y += 6;

                lateClientsList.forEach(c => {
                    checkPageBreak(12);
                    pdfDoc.setFontSize(10);
                    pdfDoc.setTextColor(0);
                    pdfDoc.setFont(undefined, 'normal');
                    const name = c.clientName.length > 25 ? c.clientName.substring(0, 25) + '...' : c.clientName;
                    pdfDoc.text(name, pageMargin + 5, y);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.setTextColor('#dc3545'); 
                    pdfDoc.text(`${c.lateDays} ${t.daysLate}`, pageMargin + 100, y);
                    
                    const maxBarWidth = 30; 
                    const maxDaysScale = 30; 
                    const daysToDraw = Math.min(c.lateDays, maxDaysScale);
                    const currentBarWidth = (daysToDraw / maxDaysScale) * maxBarWidth;

                    pdfDoc.setFillColor(230, 230, 230);
                    pdfDoc.rect(pageMargin + 140, y - 3, maxBarWidth, 4, 'F');
                    pdfDoc.setFillColor(220, 53, 69); 
                    pdfDoc.rect(pageMargin + 140, y - 3, currentBarWidth, 4, 'F');
                    y += 8; 
                });
            } else {
                checkPageBreak(20);
                pdfDoc.setFontSize(11);
                pdfDoc.setTextColor('#28a745');
                pdfDoc.setFont(undefined, 'bold');
                pdfDoc.text(t.noLate, pageMargin + 5, y);
                y += 10;
            }

            const pageCount = pdfDoc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdfDoc.setPage(i);
                pdfDoc.setFontSize(9);
                pdfDoc.setTextColor(150);
                pdfDoc.text(`${t.generatedBy} - ${t.page} ${i} ${t.of} ${pageCount}`, center, 285, { align: 'center' });
            }

            pdfDoc.save(`relatorio-${dateStr.replace(/\//g, '-')}.pdf`);
            const successMsg = currentLang === 'es' ? '¡Reporte PDF generado con éxito!' : (currentLang === 'en' ? 'PDF report generated successfully!' : 'Relatório PDF gerado com sucesso!');
            showToast(successMsg);

            // --- BLOQUEO AUTOMÁTICO (5 min) ---
            const isTodayReport = !customDate || (customDate.toDateString() === new Date().toDateString());

            if (isTodayReport) {
                if (typeof currentCollectorData !== 'undefined' && currentCollectorData) {
                    currentCollectorData.lastReportDate = new Date(); 
                }
                try {
                    const collectorRef = doc(db, 'collectors', currentCollectorUsername);
                    updateDoc(collectorRef, {
                        lastReportDate: serverTimestamp()
                    });
                    showToast("Bloqueio ativado (5 min).", false);
                } catch (err) {
                    console.error("Erro ao salvar bloqueio:", err);
                }
            }
        } 
        
        
        
        // --- [NUEVA FUNCIÓN] Modal para seleccionar fecha del reporte ---
// [CORREGIDO] Modal para seleccionar fecha del reporte (Usa hora LOCAL)
function showReportDateModal() {
    const modal = document.getElementById('reportOptionsModal');
    if (!modal) return;

    // 1. Obtener fecha LOCAL correcta (Año-Mes-Día)
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0'); // Meses van de 0-11
    const day = String(now.getDate()).padStart(2, '0');
    const todayISO = `${year}-${month}-${day}`; // Formato YYYY-MM-DD Local

    modal.classList.add('active');
    
    // Textos según idioma
    const titleText = currentLang === 'es' ? 'Generar Reporte' : (currentLang === 'en' ? 'Generate Report' : 'Gerar Relatório');
    const descText = currentLang === 'es' ? 'Selecciona la fecha para el PDF:' : (currentLang === 'en' ? 'Select date for PDF:' : 'Selecione a data para gerar o PDF:');
    const labelText = currentLang === 'es' ? 'Fecha del Reporte' : (currentLang === 'en' ? 'Report Date' : 'Data do Relatório');
    const btnText = currentLang === 'es' ? 'Descargar PDF' : (currentLang === 'en' ? 'Download PDF' : 'Baixar PDF');

    modal.innerHTML = `
        <div class="modal-content" style="max-width: 350px; padding: 25px; background-color: var(--surface); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);"> 
            <button class="close-modal-btn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; line-height: 1;">&times;</button>

            <h3 style="margin: 0 0 15px; text-align: center; font-size: 1.3em; font-weight: 600; color: var(--text-primary);">${titleText}</h3>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 25px; font-size: 0.9em;">${descText}</p>

            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">${labelText}</label>
                <input type="date" id="report-date-input" value="${todayISO}" style="width: 100%; padding: 12px; font-size: 1.1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg); color: var(--text-primary); text-align: center;">
            </div>

            <button class="btn-primary" id="confirm-generate-report-btn" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1em;">
                <i data-lucide="file-down"></i> ${btnText}
            </button>
        </div>
    `;

    lucide.createIcons({nodes: modal.querySelectorAll('[data-lucide]')});

    const closeModal = () => modal.classList.remove('active');
    
    // Evento Cerrar
    modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);

    // Evento Confirmar
    modal.querySelector('#confirm-generate-report-btn').addEventListener('click', () => {
        const dateVal = document.getElementById('report-date-input').value;
        if (dateVal) {
            // Convertimos el string "YYYY-MM-DD" a un objeto Date local
            const [y, m, d] = dateVal.split('-').map(Number);
            const selectedDate = new Date(y, m - 1, d); // Mes es base 0 en JS
            
            closeModal();
            // Llamamos a la función de exportar CON la fecha seleccionada
            exportDailyReport(selectedDate);
        }
    });
}

        async function handleProfilePictureChange(blob) {
            if (!blob) return;
            const profileImageView = document.getElementById('profile-view-img');
            const headerImageView = document.getElementById('header-profile-img');

            const localUrl = URL.createObjectURL(blob);
            profileImageView.src = localUrl;
            headerImageView.src = localUrl;
            profileImageView.classList.add('loading');
            
            try {
    // 1. Crear referencia en Firebase Storage
    const storageRef = ref(storage, `collectors/${currentCollectorUsername}/profile.jpg`);

    // 2. Subir el archivo (blob ya viene recortado)
    await uploadBytes(storageRef, blob);

    // 3. Obtener la URL de descarga
    const downloadURL = await getDownloadURL(storageRef);

    // 4. Guardar la URL en Firestore (igual que antes)
    const collectorRef = doc(db, 'collectors', currentCollectorUsername);
    await setDoc(collectorRef, { profilePictureUrl: downloadURL }, { merge: true });
    showToast('Foto de perfil atualizada!');
} catch (error) {
    console.error("Error al actualizar foto de perfil con Firebase Storage: ", error);
    showToast('Falha ao atualizar a foto de perfil.', true);
} finally {
    profileImageView.classList.remove('loading');
}
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            if (viewName !== 'profile') {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const navItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
                if (navItem) navItem.classList.add('active');
            } else {
                 document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            }

            const viewEl = document.getElementById(`${viewName}-view`);
            if (viewEl) viewEl.classList.add('active');

            document.getElementById('addClientBtn').classList.toggle('hidden', !['home', 'clients'].includes(viewName));
            document.getElementById('addExpenseBtn').classList.toggle('hidden', viewName !== 'expenses');
            
            if (viewName === 'map') {
                setTimeout(() => {
                    initMap();
                    plotClientsOnMap();
                }, 50);
            }
        }

        
        
        function setupEventListeners() {
    // --- NUEVO: SISTEMA DE EDICIÓN PROTEGIDA (DOBLE TOQUE) ---
    
    let lastTouchTime = 0; // Variable para controlar el doble toque

    // 1. Botón para desbloquear edición
    document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('#enable-route-edit-btn');
        if (btn) {
            const currentTime = new Date().getTime();
            const timeDiff = currentTime - lastTouchTime;
            
            // Si el segundo toque ocurre menos de 400ms después del primero = DOBLE TOQUE
            if (timeDiff < 400 && timeDiff > 0) {
                const input = document.getElementById('route-name-input');
                if (input) {
                    input.disabled = false; // Desbloquear
                    input.focus(); // Poner el cursor dentro
                    input.style.borderBottom = "1px solid var(--accent-purple)";
                    showToast("Edição liberada. Toque fora para salvar.");
                }
                lastTouchTime = 0; // Reiniciar
            } else {
                lastTouchTime = currentTime;
                // Opcional: Podrías mostrar un toast aquí diciendo "Toque de nuevo", pero puede ser molesto.
            }
        }
    });

    // 2. Al perder el foco (blur), GUARDAR y BLOQUEAR de nuevo
    document.body.addEventListener('focusout', async (e) => {
        if (e.target.id === 'route-name-input') {
            const input = e.target;
            const newName = input.value.trim();
            
            // Re-bloquear inmediatamente para seguridad
            input.disabled = true;
            input.style.borderBottom = "none"; // Quitar borde visual

            // Guardar solo si hay un usuario válido
            if (currentCollectorUsername) {
                try {
                    await updateDoc(doc(db, 'collectors', currentCollectorUsername), {
                        routeName: newName
                    });
                    showToast('Nome da rota salvo!');
                } catch (err) {
                    console.error("Erro ao salvar nome da rota:", err);
                    showToast('Erro ao salvar nome da rota.', true);
                }
            }
        }
    });
    // --- FIN NUEVO SISTEMA ---

    document.body.addEventListener('click', e => {
        const target = e.target;
        if (target.closest('#header-profile-link')) {
            location.hash = 'profile';
        }
        const navItem = target.closest('.nav-item[data-view]');
        if (navItem) {
            location.hash = navItem.dataset.view;
        }
        if (target.closest('#theme-toggle')) {
            const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        const langToggle = document.getElementById('lang-toggle');
        const langDropdown = document.getElementById('lang-dropdown');
        if (langToggle && target.closest('#lang-toggle')) {
            e.stopPropagation();
            langDropdown.style.display = langDropdown.style.display === 'block' ? 'none' : 'block';
        } else if (langDropdown) {
            langDropdown.style.display = 'none';
        }
        if (langDropdown && target.closest('[data-lang]')) {
            const newLang = target.dataset.lang;
            localStorage.setItem('language', newLang);
            currentLang = newLang; // Actualiza el idioma global
            
            applyLanguage(currentLang); 
            
            updateTodaysRouteList();
            updateRouteProgress();
            updateAllClientsList();
            updateExpensesView();
            updateProfileView(currentCollectorData); 
            updateNotifications(); 
            
            if(currentDetailClientId && currentDetailLoanIndex !== null) {
                showClientDetails(currentDetailClientId, currentDetailLoanIndex);
            }
        }
        if(target.closest('#addClientBtn')) showClientFormModal();
        if(target.closest('#addExpenseBtn')) {
            console.log("Botão + (Gastos/Liquidación) clicado. Llamando a showOutflowTypeModal...");
            showOutflowTypeModal();
        }
        if (target.closest('#logout-btn')) {
            stopRealtimeGeolocation(); 
            if (unsubscribeNotifications) {
                 console.log("[COBRADOR-APP] Cancelando listener de notificações...");
                 unsubscribeNotifications();
                 unsubscribeNotifications = null;
            }
            signOut(auth).catch((error) => {
                console.error("Erro ao fazer logout:", error);
                showToast("Erro ao tentar sair.", true);
            });
        }
        
        const notificationCard = target.closest('.notification-card');
        if (notificationCard) {
            const type = notificationCard.dataset.type;
            const clientId = notificationCard.dataset.clientId;
            const notificationId = notificationCard.dataset.notificationId; // ID del documento de notificación
            const loanIndex = parseInt(notificationCard.dataset.loanIndex, 10);
            const historyIndex = parseInt(notificationCard.dataset.historyIndex, 10);

            if (type === 'payment') {
                if (!isNaN(historyIndex) && !isNaN(loanIndex)) {
                     showVerificationModal(clientId, historyIndex, loanIndex, notificationId);
                } else {
                     console.error("Índices inválidos na notificação de pagamento:", notificationCard.dataset);
                     showToast("Erro ao abrir detalhes da notificação.", true);
                }
            } else if (type === 'refinance') {
                showRefinanceModal(clientId, notificationId); 
            } else if (type === 'refinance_admin_approved') {
                showRefinanceModal(clientId, notificationId);
            } else {
                 console.warn("Tipo de notificação desconhecido clicado:", type);
            }
        }

        const clearNotifsBtn = target.closest('#clear-collector-notifications-btn');
        if (clearNotifsBtn) {
            e.preventDefault();
            handleClearCollectorNotifications(); 
        }

        if (target.closest('#change-password-btn')) console.log("Mudar senha a ser implementado.");
        if (target.closest('#export-report-btn')) showReportDateModal();
        
        if (target.closest('#payment-settings-btn')) {
             if (currentCollectorData) {
                showPaymentSettingsModal(currentCollectorData);
             } else {
                 console.error("currentCollectorData no está disponible globalmente.");
             }
        }
    });
    
    window.addEventListener('popstate', (event) => {
        console.log("[POPSTATE] Evento popstate disparado. Novo estado:", event.state);
        document.querySelectorAll('.modal-view.active, .modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
        });
        if (event.state && event.state.modal) {
            console.log(`[POPSTATE] Reabrindo modal: ${event.state.modal}`);
            const modalToShow = document.getElementById(event.state.modal);
            if (modalToShow) {
                modalToShow.classList.add('active');
            }
            if (event.state.modal === 'clientDetailView') {
                currentDetailClientId = event.state.clientId;
                currentDetailLoanIndex = event.state.loanIndex;
                console.log(`[POPSTATE] Restaurando estado de clientDetailView: C=${currentDetailClientId}, L=${currentDetailLoanIndex}`);
            }
            return; 
        }
        console.log("[POPSTATE] Navegação de vista principal detectada.");
        currentDetailClientId = null;
        currentDetailLoanIndex = null;
        const viewName = location.hash.substring(1) || 'home';
        console.log(`[POPSTATE] Mostrando vista: ${viewName}`);
        showView(viewName);
    });
    
    document.body.addEventListener('change', async e => {
        if (e.target.id === 'realtime-tracking-toggle') {
            const isActive = e.target.checked;
            const toggle = e.target;
            toggle.disabled = true; 
            
            try {
                const collectorRef = doc(db, 'collectors', currentCollectorUsername);
                await updateDoc(collectorRef, { isRealtimeTrackingActive: isActive });
                
                if (isActive) startRealtimeGeolocation();
                else stopRealtimeGeolocation();
                
            } catch (error) {
                console.error("Error GPS:", error);
                showToast('Erro de conexão ao mudar GPS.', true);
                toggle.checked = !isActive; 
            } finally {
                toggle.disabled = false;
            }
        }

        if (e.target.id === 'profile-pic-input') {
            const file = e.target.files[0];
            if (file) showCropperModal(file);
        }
    });

    const clientsView = document.getElementById('clients-view');
    if (clientsView) {
        clientsView.addEventListener('input', e => {
            if (e.target.id === 'client-search-input') updateAllClientsList();
        });
        clientsView.addEventListener('click', e => {
            const filterBtn = e.target.closest('.filter-btn');
            if (filterBtn) {
                clientsView.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                filterBtn.classList.add('active');
                updateAllClientsList();
            }
        });
    }

    const expensesView = document.getElementById('expenses-view');
    if (expensesView) {
        expensesView.addEventListener('click', e => {
             const filterBtn = e.target.closest('.filter-btn');
             if(filterBtn) {
                 const parent = filterBtn.parentElement;
                 parent.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                 filterBtn.classList.add('active');
                 updateExpensesView();
             }
        });
    }
}



        
        
        function loadGlobalSettings(settings) {
            const companyName = settings.companyName || 'LUMIX Finanças';
            const companyLogo = settings.companyLogo || DEFAULT_LOGO_URL;
            
            const elements = {
                headerLogoText: document.getElementById('header-logo-text'),
                headerLogo: document.getElementById('header-logo'),
                splashLogo: document.getElementById('splash-logo'),
                loginLogo: document.getElementById('login-logo')
            };

            if (elements.headerLogoText) elements.headerLogoText.textContent = companyName;
            if (elements.headerLogo) elements.headerLogo.src = companyLogo;
            if (elements.splashLogo) elements.splashLogo.src = companyLogo;
            if (elements.loginLogo) elements.loginLogo.src = companyLogo;
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            // [CAMBIO] El ID 'username' ahora se trata como un 'username' real
            const usernameInput = document.getElementById('username'); 
            const passwordInput = document.getElementById('password');
            
            const username = usernameInput.value.trim(); // 1. Obtiene el 'username' (ej: 'joao.silva')
            const pass = passwordInput.value;
        
            // [CAMBIO] Construye el email con el sufijo @gmail.com
            const email = `${username}@gmail.com`; 

            // --- (El resto del código de manejo del botón es idéntico al original) ---
            const loginButton = event.target.querySelector('button[type="submit"]');
            let originalButtonHTML = ''; 

            if (loginButton) {
                originalButtonHTML = loginButton.innerHTML; 
                loginButton.disabled = true; 
                
                loginButton.innerHTML = `
                    <span style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i data-lucide="loader-circle" style="animation: spin 1s linear infinite; width: 20px; height: 20px;"></i>
                        Entrando...
                    </span>`;
                
                lucide.createIcons({ nodes: [loginButton.querySelector('i')] });
            }
            // --- (Fin del código del botón) ---
        
            try {
                // [CAMBIO] Inicia sesión con el 'email' construido
                console.log(`Tentando login com email construído: ${email}`);
                await signInWithEmailAndPassword(auth, email, pass);
        
                // SUCESSO! O onAuthStateChanged vai ser chamado automaticamente
                console.log("signInWithEmailAndPassword bem-sucedido. Aguardando onAuthStateChanged...");
        
            } catch (error) {
                // FALHA no login
                console.error("Erro de login (signInWithEmailAndPassword):", error.code, error.message);
                
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    showToast('Usuário ou senha inválidos.', true);
                } else if (error.code === 'auth/invalid-email') {
                    // Este error ahora significa que el 'username' tiene caracteres inválidos
                    showToast('Usuário inválido (não pode ser convertido em email).', true);
                } else if (error.code === 'auth/too-many-requests') {
                     showToast('Muitas tentativas falhadas. Tente novamente mais tarde.', true);
                } else {
                    showToast('Erro ao tentar fazer login. Verifique sua conexão.', true);
                }
                
                // --- (Restaurar el botón en error, idéntico al original) ---
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.innerHTML = originalButtonHTML;
                }
                // --- (Fin de restaurar botón) ---
            }
        }


        async function handleClearCollectorNotifications() {
            console.log("[COBRADOR-APP] Solicitado para limpar notificações...");
            
            if (!internalNotifications || internalNotifications.length === 0) {
                showToast("Não há notificações para limpar.");
                return;
            }

            // CORRECCIÓN: Usamos await con la nueva estructura de promesa
            const confirmed = await showConfirmationModal(
                'Limpar Notificações',
                'Tem certeza que deseja apagar todo o histórico de notificações? Esta ação não pode ser desfeita.',
                'Sim, Limpar',
                'btn-danger'
            );

            if (!confirmed) return;

            const deletePromises = [];
            internalNotifications.forEach(notif => {
                if (notif.id) {
                    const notifRef = doc(db, 'collectors', currentCollectorUsername, 'notifications', notif.id);
                    deletePromises.push(deleteDoc(notifRef));
                }
            });

            console.log(`[COBRADOR-APP] Apagando ${deletePromises.length} notificações...`);

            try {
                await Promise.all(deletePromises);
                showToast('Histórico de notificações limpo!');
            } catch (error) {
                console.error("Erro ao limpar notificações:", error);
                showToast('Erro ao limpar o histórico.', true);
            }
        }

        
        // --- INICIO: LÓGICA DE OPTIMIZACIÓN DE RUTA ---
        
        // Calcula la distancia haversine entre dos puntos en la Tierra
        function getDistance(coords1, coords2) {
            if (!coords1 || !coords2) return Infinity;
            const toRad = x => x * Math.PI / 180;
            const R = 6371; // Radio de la Tierra en km
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lng - coords1.lng);
            const lat1 = toRad(coords1.lat);
            const lat2 = toRad(coords2.lat);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Extrae las coordenadas de una URL de Google Maps
        function parseCoordinates(locationUrl) {
            if (!locationUrl) return null;
            const match = locationUrl.match(/query=([\d.-]+),([\d.-]+)/);
            if (match) {
                return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
            }
            return null;
        }

        // Función principal para optimizar la ruta
        function optimizeRoute(clients, startCoords) {
            if (clients.length === 0) return [];
            
            // Si no tenemos la ubicación del cobrador, ordena por hora y luego alfabéticamente
            if (!startCoords) {
                return clients.sort((a, b) => {
                    // [CORRECCIÓN] Se accede a las propiedades correctas 'loan' y 'client' dentro del objeto.
                    const timeA = a.loan.collectionTime;
                    const timeB = b.loan.collectionTime;
                    if (timeA && timeB) return timeA.localeCompare(timeB);
                    if (timeA) return -1;
                    if (timeB) return 1;
                    return a.client.name.localeCompare(b.client.name);
                });
            }

            clients.forEach(item => item.coords = parseCoordinates(item.client.location));
            const clientsWithTime = clients.filter(item => item.loan.collectionTime).sort((a, b) => a.loan.collectionTime.localeCompare(b.loan.collectionTime));
            let clientsWithoutTime = clients.filter(item => !item.loan.collectionTime);

            let optimizedRoute = [];
            let lastCoords = startCoords;

            const findAndRemoveNearest = (fromCoords, clientList) => {
                let nearestClient = null;
                let minDistance = Infinity;
                let nearestIndex = -1;

                clientList.forEach((clientItem, index) => {
                    if (clientItem.coords) {
                        const distance = getDistance(fromCoords, clientItem.coords);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestClient = clientItem;
                            nearestIndex = index;
                        }
                    }
                });

                if (nearestIndex !== -1) {
                    clientList.splice(nearestIndex, 1);
                }
                return nearestClient;
            };

            // Procesa clientes con hora primero
            clientsWithTime.forEach(timedClient => {
                // Antes de añadir el cliente con hora, busca los clientes sin hora más cercanos
                while (clientsWithoutTime.length > 0) {
                    const nearestUntimed = findAndRemoveNearest(lastCoords, clientsWithoutTime);
                    if (!nearestUntimed) break; 

                    // Heurística simple: ¿Es más corto ir a este cliente sin hora y LUEGO al cliente con hora?
                    const distToNearest = getDistance(lastCoords, nearestUntimed.coords);
                    const distFromNearestToTimed = getDistance(nearestUntimed.coords, timedClient.coords);
                    const distDirectToTimed = getDistance(lastCoords, timedClient.coords);

                    if (distToNearest + distFromNearestToTimed < distDirectToTimed * 1.5) { // Factor de desvío
                        optimizedRoute.push(nearestUntimed);
                        lastCoords = nearestUntimed.coords;
                    } else {
                        clientsWithoutTime.push(nearestUntimed); // Lo devolvemos a la lista
                        break;
                    }
                }
                
                optimizedRoute.push(timedClient);
                if (timedClient.coords) {
                    lastCoords = timedClient.coords;
                }
            });

            // Añade los clientes restantes sin hora al final, en orden de proximidad
            while (clientsWithoutTime.length > 0) {
                const nearest = findAndRemoveNearest(lastCoords, clientsWithoutTime);
                if (nearest) {
                    optimizedRoute.push(nearest);
                    if (nearest.coords) {
                        lastCoords = nearest.coords;
                    }
                } else {
                    // Si quedan clientes pero no tienen coordenadas, añádelos al final
                    const withoutCoords = clientsWithoutTime.filter(c => !c.coords);
                    optimizedRoute.push(...withoutCoords);
                    break;
                }
            }
            
            return optimizedRoute;
        }
        
        
        function stopRealtimeGeolocation() {
            // 1. Detener el proceso del navegador
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            // 2. Apagar visualmente el interruptor (SOLO VISUAL)
            // CORRECCIÓN IMPORTANTE: YA NO TOCAMOS LA BASE DE DATOS AQUÍ.
            // Esto evita que un error de conexión apague el sistema.
            const trackingToggle = document.getElementById('realtime-tracking-toggle');
            if (trackingToggle) {
                // Solo lo desmarcamos si la base de datos realmente dice que está apagado
                // (Esto lo maneja el onSnapshot, así que aquí solo limpiamos variables)
                if (!currentCollectorData?.isRealtimeTrackingActive) {
                    trackingToggle.checked = false;
                }
            }
            
            collectorCurrentLocation = null;
            console.log('GPS detenido localmente.');
            // No llamamos a updateTodaysRouteList() para evitar parpadeos innecesarios al salir
        }

        // --- FIN: LÓGICA DE OPTIMIZACIÓN DE RUTA ---
        
        



async function startRealtimeGeolocation() {
            if (locationWatchId) return; // Ya está activo
            
            if (!('geolocation' in navigator)) {
                showToast('GPS não suportado.', true);
                return;
            }

            try {
                locationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        // --- ÉXITO ---
                        collectorCurrentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('GPS OK:', collectorCurrentLocation);
                        
                        const now = Date.now();
                        // Guardar en DB cada 30 segundos
                        if (now - lastLocationUpdateTime > 30000) { 
                            lastLocationUpdateTime = now;
                            const collectorRef = doc(db, 'collectors', currentCollectorUsername);
                            // Enviamos actualización silenciosa
                            updateDoc(collectorRef, {
                                lastLocation: {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude
                                },
                                lastLocationUpdate: serverTimestamp()
                            }).catch(e => console.warn("Ping GPS fallido (sin importancia):", e));

                            updateTodaysRouteList(); 
                        }

                        // Actualizar mapa
                        if (mapInstance && collectorMarker) {
                            const newLatLng = [collectorCurrentLocation.lat, collectorCurrentLocation.lng];
                            collectorMarker.setLatLng(newLatLng);
                        }
                    },
                    (error) => {
                        console.warn("Aviso GPS:", error.code, error.message);
                        
                        // ÚNICO CASO DE APAGADO REAL: EL USUARIO DIJO "NO" AL PERMISO
                        if (error.code === 1) {
        // Solo mostramos el aviso, PERO NO APAGAMOS NADA
        showToast('Aviso: Permissão de GPS negada pelo celular.', true);
        console.warn("GPS sem permissão, mas mantendo switch ligado visualmente.");
        // stopRealtimeGeolocation(); // <--- COMENTADO O BORRADO
    }
                        // Cualquier otro error (señal, timeout, desconocido) SE IGNORA y el botón sigue prendido.
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 60000 }
                );

            } catch (err) {
                console.error("Error al iniciar GPS:", err);
            }
        }


    async function performClientChecks(editingClientId = null) {
    const docInput = document.getElementById('client-document');
    const nameInput = document.getElementById('client-name');
    const resultsContainer = document.getElementById('system-verification-results');

    if (!docInput || !nameInput || !resultsContainer) return;

    const documentNumber = docInput.value.trim();
    const clientName = nameInput.value.trim().toLowerCase();

    // Si ambos campos están vacíos, limpia y sal.
    if (!documentNumber && !clientName) {
        resultsContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
        return;
    }

    resultsContainer.style.display = 'block';
    resultsContainer.innerHTML = `
        <div class"kpi-card" style="padding: 15px; text-align: center; background-color: var(--surface); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--text-secondary);">
                <i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i>
                <span data-lang-key="searchingSystem"></span>
            </div>
        </div>
    `;
    lucide.createIcons({ nodes: resultsContainer.querySelectorAll('[data-lucide]') });
    applyLanguage(currentLang);

    let warnings = [];
    let systemLoans = [];

    // 1. Comprobación de la Lista Negra (NUEVA LÓGICA)
    const normalizedDoc = documentNumber.replace(/\D/g, ''); // Limpia doc
    if (normalizedDoc && BLACKLIST_DATA.documentos.includes(normalizedDoc)) {
        warnings.push(`<strong>ATENÇÃO!</strong> O documento <strong>${documentNumber}</strong> está na lista de advertência.`);
    }
    if (clientName && BLACKLIST_DATA.nomes.includes(clientName)) {
        warnings.push(`<strong>ATENÇÃO!</strong> O nome <strong>${nameInput.value}</strong> está na lista de advertência.`);
    }

    // 2. Comprobación del Sistema Global (LÓGICA REAL con collectionGroup)
    try {
        // Solo buscamos globalmente si se proporciona un número de documento
        if (documentNumber) {
            console.log(`[COBRADOR-APP] Verificando GLOBALMENTE el documento: ${documentNumber}`);

            // ¡AQUÍ ESTÁ LA BÚSQUEDA GLOBAL!
            const globalClientQuery = query(
                collectionGroup(db, 'clients'), 
                where('documentNumber', '==', documentNumber)
            );

            const querySnapshot = await getDocs(globalClientQuery);
            console.log(`[COBRADOR-APP] Búsqueda global encontró ${querySnapshot.size} coincidencias.`);

            querySnapshot.forEach(doc => {
                const client = { id: doc.id, ...doc.data() };

                // Excluimos al cliente que estamos editando actualmente
                if (!editingClientId || client.id !== editingClientId) {

                    (client.loans || []).forEach(loan => {
                        // Recalculamos el estado del préstamo encontrado
                        const details = calculateLoanDetails(loan); 
                        if (details.status !== 'finished') {
                            systemLoans.push({ 
                                ...loan, 
                                status: details.status, 
                                collectorId: client.collectorId,
                                // (Importante) Añadimos el ID de la empresa a la que pertenece
                                companyId: doc.ref.parent.parent.id 
                            });
                        }
                    });
                }
            });
        }
    } catch (error) {
        console.error("Error al verificar el historial del sistema global:", error);
        warnings.push("Error ao verificar o histórico global do sistema.");
    }

    // 3. Renderizar Resultados (warnings Y systemLoans)
    renderVerificationResults(resultsContainer, warnings, systemLoans);
}

/**
 * Renderiza los resultados de AMBAS verificaciones en el modal
 */
function renderVerificationResults(container, warnings, systemLoans) {

    // Si no hay nada, limpia y oculta.
    if (warnings.length === 0 && systemLoans.length === 0) {
        container.innerHTML = `
            <div class="kpi-card" style="padding: 15px; border-color: var(--accent-green); background-color: color-mix(in srgb, var(--accent-green) 5%, var(--surface));">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--accent-green);">
                    <i data-lucide="check-circle"></i>
                    <strong data-lang-key="clientClean"></strong>
                </div>
            </div>`;
        lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
        applyLanguage(currentLang);
        return;
    }

    let html = '';

    // Renderiza las advertencias de la lista negra
    if (warnings.length > 0) {
        html += `
        <div class="kpi-card" style="padding: 15px; border-color: var(--danger-color); background-color: color-mix(in srgb, var(--danger-color) 10%, var(--surface)); margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px; color: var(--danger-color); display: flex; align-items: center; gap: 8px;">
                <i data-lucide="alert-octagon"></i>
                ALERTA DE LISTA DE ADVERTÊNCIA
            </h4>
            <ul style="margin: 0; padding-left: 20px; font-size: 0.9em; color: var(--text-primary);">
                ${warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
        </div>
        `;
    }

    // Renderiza los préstamos del sistema (búsqueda global)
    if (systemLoans.length > 0) {
            html += `
        <div class="kpi-card" style="padding: 15px; border-color: var(--warning-color); background-color: color-mix(in srgb, var(--warning-color) 10%, var(--surface));">
            <h4 data-lang-key="loansFound" style="margin: 0 0 10px; color: #b45309;"></h4>
            ${systemLoans.map(loan => {
                const statusClass = `status-${loan.status}`;
                const statusText = (translations[currentLang] && translations[currentLang][loan.status]) || loan.status;

                // Muestra si el préstamo es de esta empresa o de otra
                const companyDisplay = (loan.companyId === currentCompanyId) 
                    ? `<strong style="color: var(--accent-purple);">(Esta Empresa)</strong>` 
                    : `<strong style="color: var(--danger-color);">(Empresa: ${loan.companyId})</strong>`;

                return `
                <div style="font-size: 0.9em; padding-top: 10px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 600;">
                        <span>
                            <i data-lucide="user-cog" style="width:14px;"></i> ${loan.collectorId || 'N/A'} ${companyDisplay}
                        </span>
                        <span class="payment-status ${statusClass}" style="font-size: 0.9em;">${statusText}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>Total: ${money(loan.totalLoan)}</span>
                        <span>Pago: ${money(loan.paid)}</span>
                    </div>
                </div>
                `;
            }).join('')}
        </div>
        `;
    }

    container.innerHTML = html;
    lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
    applyLanguage(currentLang);
}
// --- FIN: NUEVAS FUNCIONES DE VERIFICACIÓN ---



    function showMainApp(authUid) { 
    if (!authUid) { 
        console.error("showMainApp chamada sem authUid!");
        showBlockedView("Erro interno: ID do usuário não encontrado.");
        signOut(auth);
        return;
    }

    currentCollectorUid = authUid;

    document.getElementById('login-view').style.display = 'none';
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('app-container').style.display = 'flex';

    renderMainLayout();
    lucide.createIcons();
    setupEventListeners();
    const preferredTheme = localStorage.getItem('theme') || 'light';
    applyTheme(preferredTheme);
    
    const initialView = location.hash.substring(1) || 'home';
    showView(initialView);

    console.log(`Buscando documento do cobrador com authUid: ${authUid}...`); 
    const collectorQuery = query(collection(db, 'collectors'), where('authUid', '==', authUid));

    getDocs(collectorQuery).then(snapshot => {
        if (snapshot.empty) {
            console.error(`Nenhum documento de cobrador encontrado para authUid: ${authUid}`);
            showBlockedView("Erro: Dados do cobrador não encontrados no banco de dados."); 
            signOut(auth);
            return;
        }
        
        const collectorDoc = snapshot.docs[0];
        currentCollectorUsername = collectorDoc.id; 
        console.log(`Documento do cobrador encontrado. Username (Firestore ID): ${currentCollectorUsername}`);

        onSnapshot(doc(db, 'collectors', currentCollectorUsername), (docSnap) => {
            if (docSnap.exists()) {
                currentCollectorData = docSnap.data(); 
                
                // ACTUALIZAR DATOS DE PERFIL
                document.querySelectorAll('.profile-name').forEach(el => el.textContent = currentCollectorData.name || 'Cobrador'); 

                const imageUrl = currentCollectorData.profilePictureUrl; 
                const nameInitial = (currentCollectorData.name || 'C').charAt(0).toUpperCase();
                const placeholderUrl = `https://placehold.co/120x120/6f42c1/FFFFFF?text=${nameInitial}`;

                const headerImg = document.getElementById('header-profile-img');
                const profileImg = document.getElementById('profile-view-img');
                if (headerImg) headerImg.src = imageUrl || placeholderUrl.replace('120x120', '80x80');
                if (profileImg) profileImg.src = imageUrl || placeholderUrl;

                // --- NUEVO: ACTUALIZAR INPUT DE NOMBRE DE RUTA ---
                const routeInput = document.getElementById('route-name-input');
                if (routeInput && currentCollectorData.routeName) {
                    routeInput.value = currentCollectorData.routeName;
                }
                // --- FIN NUEVO ---

            } else {
                 console.error(`Documento do cobrador ${currentCollectorUsername} foi excluído ou inacessível?`);
                 showBlockedView("Erro: Seus dados de cobrador não puderam ser carregados.");
                 signOut(auth);
            }
        }, (error) => { 
             console.error(`Erro ao escutar dados do cobrador ${currentCollectorUsername}:`, error);
             showBlockedView("Erro de conexão ao carregar seus dados.");
             signOut(auth);
        }); 

        // Listener de Clientes
        const clientsQuery = query(
            collection(db, 'companies', currentCompanyId, "clients"), 
            where("collectorId", "==", currentCollectorUsername)
        );

        onSnapshot(clientsQuery, (snapshot) => {
            console.log("[COBRADOR-APP][DIAG] Client onSnapshot disparado! Processando clientes...");
            allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            allClients.forEach(client => {
                if (!client.loans && client.totalLoan) {
                    client.loans = [{
                        totalLoan: client.totalLoan,
                        paid: client.paid || 0,
                        installments: client.installments,
                        originalInstallmentAmount: client.amount,
                        totalInstallments: (client.installments || "0/0").split('/').map(Number)[1] || 0,
                        startDate: client.startDate,
                        history: client.history || [],
                        paymentBalance: client.paymentBalance || 0,
                        status: 'active',
                        paymentFrequency: client.paymentFrequency,
                        paymentDays: client.paymentDays,
                        collectionTime: client.collectionTime,
                        amount: client.amount
                    }];
                } else if (!client.loans) {
                    client.loans = [];
                }
            });
        
            updateTodaysRouteList();
            updateRouteProgress();
            updateAllClientsList();
            updateProfileView(currentCollectorData); 
            updateNotifications();
            if (document.querySelector('#map-view.active')) plotClientsOnMap();

            if (currentDetailClientId && currentDetailLoanIndex !== null) {
                const clientStillExists = allClients.some(c => c.id === currentDetailClientId);
                if (clientStillExists) {
                    const detailView = document.getElementById('clientDetailView');
                    const expectedHash = `#client/${currentDetailClientId}/${currentDetailLoanIndex}`;
                    if (detailView && location.hash === expectedHash) {
                        showClientDetails(currentDetailClientId, currentDetailLoanIndex);
                    }
                } else {
                    currentDetailClientId = null;
                    currentDetailLoanIndex = null;
                    const detailView = document.getElementById('clientDetailView');
                    if (detailView && detailView.classList.contains('active')) {
                        window.history.back();
                    }
                }
            }
            applyLanguage(currentLang);
        }, (error) => {
            console.error("Error al obtener clientes: ", error);
            showToast('Falha ao carregar clientes.', true);
        });

        // Listener de Gastos
        const expensesQuery = query(collection(db, 'companies', currentCompanyId, 'expenses'), where("collectorId", "==", currentCollectorUsername));
        onSnapshot(expensesQuery, (snapshot) => {
            allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateExpensesView();
            updateProfileView(currentCollectorData);
        }, (error) => {
            console.error("Error al obtener gastos: ", error);
            showToast('Falha ao carregar gastos.', true);
        });

        // Listener de Liquidaciones
        const settlementsQuery = query(
            collection(db, 'companies', currentCompanyId, 'settlements'), 
            where("collectorId", "==", currentCollectorUsername)
        );
        onSnapshot(settlementsQuery, (snapshot) => {
            allSettlements = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(s => s.status !== 'rejected'); 
            
            updateProfileView(currentCollectorData);
            updateExpensesView();
        }, (error) => {
            console.error("Error al obtener liquidaciones: ", error);
            showToast('Falha ao carregar dados de liquidação.', true);
        });

        // Listener de Aportes
        const capitalInjectionsQuery = query(collection(db, 'companies', currentCompanyId, 'capitalInjections'), where("collectorId", "==", currentCollectorUsername), where("status", "==", "approved"));
        onSnapshot(capitalInjectionsQuery, (snapshot) => {
            allCapitalInjections = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateProfileView(currentCollectorData); 
        }, (error) => {
            console.error("Error al obtener aportes de capital: ", error);
            showToast('Falha ao carregar dados de aportes de capital.', true);
        });

        // Listener de Notificaciones
        console.log(`[COBRADOR-APP] Iniciando listener para notificações em: collectors/${currentCollectorUsername}/notifications`);
        const notificationsQuery = collection(db, 'collectors', currentCollectorUsername, 'notifications');

        if (typeof unsubscribeNotifications !== 'undefined' && unsubscribeNotifications) {
            unsubscribeNotifications(); 
        }
        unsubscribeNotifications = onSnapshot(notificationsQuery, (snapshot) => {
            console.log("[COBRADOR-APP] Novas notificações INTERNAS recebidas do Firestore.");
            internalNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateNotifications();
        }, (error) => {
            console.error(`[COBRADOR-APP] Erro ao escutar notificações:`, error);
        });

    }).catch(error => { 
         console.error("Erro crítico ao buscar documento do cobrador por authUid:", error);
         showBlockedView("Erro crítico ao carregar seus dados iniciais.");
         signOut(auth);
    });
    }




        
        function init() {
            // --- VARIABLE DE CONTROL DE DÍA ---
            let lastCheckedDate = new Date().getDate();

            document.body.classList.add('dark-mode');

            // --- PWA Banner ---
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBanner = document.getElementById('install-banner');
                if (installBanner) {
                    installBanner.style.display = 'block';
                    if (typeof applyLanguage === 'function') applyLanguage(currentLang);
                }
            });
            const installBtn = document.getElementById('install-btn');
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    const installBanner = document.getElementById('install-banner');
                    if (installBanner) installBanner.style.display = 'none';
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        deferredPrompt = null;
                    }
                });
            }
            const closeInstallBtn = document.getElementById('close-install-banner');
            if (closeInstallBtn) {
                closeInstallBtn.addEventListener('click', () => {
                    document.getElementById('install-banner').style.display = 'none';
                });
            }

            // --- SISTEMA DE SEGURANÇA E MONITORAMENTO ---
            setInterval(() => {
                const now = new Date();
                const currentDay = now.getDate();
                const hour = now.getHours();
                
                // 1. AUTO-RELOAD AL CAMBIAR DE DÍA
                if (currentDay !== lastCheckedDate) {
                    console.log("Mudança de dia detectada. Reiniciando...");
                    window.location.reload(); 
                    return; 
                }

                // 2. REGLA: Bloqueo nocturno (00:00 a 07:00)
                let isRestricted = hour >= 0 && hour < 7;
                let lockMessage = "Por motivos de segurança, o aplicativo permanece inativo entre as <strong>00:00</strong> e as <strong>07:00</strong>.";

                // 3. REGLA: Bloqueo 5 minutos después del reporte
                if (typeof currentCollectorData !== 'undefined' && currentCollectorData && currentCollectorData.lastReportDate) {
                    let lastReport = null;
                    const rawDate = currentCollectorData.lastReportDate;
                    if (rawDate && rawDate.seconds) lastReport = new Date(rawDate.seconds * 1000);
                    else if (rawDate instanceof Date) lastReport = rawDate;

                    if (lastReport) {
                        const isReportFromToday = lastReport.getDate() === now.getDate() && lastReport.getMonth() === now.getMonth() && lastReport.getFullYear() === now.getFullYear();
                        
                        // === CORRECCIÓN: Solo bloqueamos si el reporte es de hoy Y se hizo DESPUÉS de las 7 AM ===
                        // Esto evita que las pruebas de madrugada (00:00 - 06:59) bloqueen el día siguiente.
                        if (isReportFromToday && lastReport.getHours() >= 7) {
                            const diffMinutes = (now.getTime() - lastReport.getTime()) / 1000 / 60;
                            if (diffMinutes > 5) {
                                isRestricted = true; 
                                lockMessage = "Expediente encerrado.<br>O app foi bloqueado automaticamente após o envio do Relatório Diário.";
                            }
                        }
                    }
                }

                // 4. EXCEPCIÓN: Desbloqueo de Administrador (30 min)
                let isAdminUnlocked = false;
                if (currentCollectorData && currentCollectorData.tempUnlockUntil) {
                    let unlockDate = null;
                    if (currentCollectorData.tempUnlockUntil.seconds) unlockDate = new Date(currentCollectorData.tempUnlockUntil.seconds * 1000);
                    else if (currentCollectorData.tempUnlockUntil instanceof Date) unlockDate = currentCollectorData.tempUnlockUntil;

                    if (unlockDate && now < unlockDate) isAdminUnlocked = true;
                }

                // --- APLICAR BLOQUEO VISUAL ---
                const lockScreenId = 'security-lock-overlay';
                let lockScreen = document.getElementById(lockScreenId);

                if (isRestricted && !isAdminUnlocked) {
                    if (!lockScreen) {
                        lockScreen = document.createElement('div');
                        lockScreen.id = lockScreenId;
                        lockScreen.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #020617; z-index: 100000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; color: white;`;
                        lockScreen.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            <h2 style="margin: 25px 0 10px; font-size: 1.8em; font-weight: 700;">Sistema Bloqueado</h2>
                            <p style="color: #94a3b8; font-size: 1.1em; max-width: 400px; line-height: 1.5;">${lockMessage}</p>
                            <div style="margin-top: 30px;"><span style="color: #ef4444; font-weight: bold; font-size: 1.2em;">${now.toLocaleTimeString()}</span></div>`;
                        document.body.appendChild(lockScreen);
                    } else {
                        const timeSpan = lockScreen.querySelector('div span');
                        if(timeSpan) timeSpan.textContent = now.toLocaleTimeString();
                    }
                } else {
                    if (lockScreen) lockScreen.remove();
                }
            }, 1000);

            // --- Service Worker ---
            if ('serviceWorker' in navigator) {
                if (window.location.protocol === 'blob:') {
                    console.warn("Service Worker ignorado em blob.");
                } else {
                    navigator.serviceWorker.register('firebase-messaging-sw.js')
                    .then(reg => {
                        console.log('Service Worker registrado.');
                        if (typeof currentCollectorUsername !== 'undefined' && currentCollectorUsername) {
                             setupFCM(currentCollectorUsername, reg);
                        }
                    })
                    .catch(console.error);
                }
            }

            // --- Auth State ---
            const splash = document.getElementById('splash-screen');
            onAuthStateChanged(auth, async (user) => {
                splash.style.opacity = '0';
                setTimeout(() => { splash.style.display = 'none'; }, 500);

                if (user) {
                    try {
                        console.log("Verificando permissões...");
                        const tokenResult = await user.getIdTokenResult(true); 
                        const claims = tokenResult.claims; 
                        
                        if (claims.role !== 'collector' || !claims.companyId) {
                            showBlockedView("Conta sem permissão de cobrador.");
                            await signOut(auth); 
                            return; 
                        }

                        currentCollectorUid = user.uid; 
                        currentCompanyId = claims.companyId; 
                        
                        const companySnap = await getDoc(doc(db, 'companies', currentCompanyId));
                        if (!companySnap.exists()) {
                            showBlockedView("Empresa não encontrada.");
                            await signOut(auth);
                            return;
                        }
                        currentCompanyData = companySnap.data(); 

                        if (currentCompanyData.status === 'suspended') {
                            showBlockedView("Conta da empresa suspensa."); 
                            return;
                        }

                        document.getElementById('login-view').style.display = 'none'; 
                        loadGlobalSettings(currentCompanyData); 
                        showMainApp(currentCollectorUid); 

                        // Setup FCM after login
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(reg => {
                                setupFCM(currentCollectorUsername, reg);
                            });
                        }

                    } catch (error) {
                        console.error("Erro auth:", error);
                        showBlockedView(`Erro de verificação: ${error.message}`);
                        await signOut(auth);
                    }
                } else {
                    document.getElementById('app-container').style.display = 'none'; 
                    document.getElementById('login-view').style.display = 'flex'; 
                    loadGlobalSettings({}); 
                    const loginForm = document.getElementById('login-form');
                    if (loginForm) {
                        loginForm.removeEventListener('submit', handleLogin); 
                        loginForm.addEventListener('submit', handleLogin); 
                    }
                }
            });
        }

        init();
    </script>
</body>
    </html>
