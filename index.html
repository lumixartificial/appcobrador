<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Painel do Cobrador</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-green: #28a745;
            --accent-purple: #6f42c1;
            --border-color: #e9ecef;
            --danger-color: #dc3545;
        }
        body.dark-mode {
            --bg: #0a0e1a;
            --surface: #121829;
            --text-primary: #f0f2f5;
            --text-secondary: #a0aec0;
            --border-color: #2d3748;
            --danger-color: #fc8181;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s; }
        #app-container { padding-bottom: 80px; }
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; transition: background-color 0.3s, border-color 0.3s; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { height: 40px; width: 40px; border-radius: 50%; }
        .logo-text { font-size: 1.2em; font-weight: 700; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .header-btn:hover { background-color: var(--bg); }
        .lang-dropdown { display: none; position: absolute; top: 40px; right: 0; background-color: var(--surface); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-color); overflow: hidden; z-index: 110; }
        .lang-dropdown button { display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; color: var(--text-primary); cursor: pointer; }
        .lang-dropdown button:hover { background-color: var(--bg); }
        .profile { display: flex; align-items: center; gap: 10px; text-align: right; }
        .profile-info { display: flex; flex-direction: column; }
        .profile-name { font-weight: 600; font-size: 0.9em; }
        .profile-role { font-size: 0.8em; color: var(--text-secondary); }
        .profile img { height: 40px; width: 40px; border-radius: 50%; border: 2px solid var(--accent-purple); object-fit: cover; }
        .container { padding: 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background-color: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        body.dark-mode .kpi-card { box-shadow: none; }
        .kpi-title { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px; }
        .kpi-value { font-size: 1.8em; font-weight: 700; margin: 0; }
        .kpi-value.green { color: var(--accent-green); }
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid var(--accent-purple); padding-bottom: 10px; }
        .client-list { display: flex; flex-direction: column; gap: 15px; }
        .client-card { background-color: var(--surface); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border-color); transition: background-color 0.2s, box-shadow 0.2s, border-color 0.3s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); cursor: pointer; }
        body.dark-mode .client-card { box-shadow: none; }
        .client-card:active { background-color: var(--bg); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); }
        .client-info { flex-grow: 1; }
        .client-name { font-weight: 600; margin: 0 0 5px; }
        .client-address { font-size: 0.9em; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .payment-info { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .payment-amount { font-size: 1.2em; font-weight: 700; color: var(--accent-green); }
        .payment-status { font-size: 0.8em; padding: 3px 8px; border-radius: 10px; font-weight: 500; margin-top: 5px; }
        .status-pending { background-color: #fff3cd; color: #856404; } .status-paid { background-color: #d4edda; color: #155724; } .status-late { background-color: #f8d7da; color: #721c24; }
        body.dark-mode .status-pending { background-color: #b98c3633; color: #f6e05e; } body.dark-mode .status-paid { background-color: #38a16933; color: #68d391; } body.dark-mode .status-late { background-color: #c5303033; color: #fc8181; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--surface); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05); transition: background-color 0.3s, border-color 0.3s; z-index: 150; }
        body.dark-mode .bottom-nav { box-shadow: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-secondary); text-decoration: none; font-size: 0.8em; padding: 5px 15px; cursor: pointer; }
        .nav-item.active { color: var(--accent-purple); }
        .modal-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); z-index: 200; transform: translateX(100%); transition: transform 0.3s ease-in-out; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-view.active { transform: translateX(0); }
        .modal-header { display: flex; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 210; }
        .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 0; margin-right: 15px; }
        .modal-title { font-size: 1.2em; font-weight: 600; }
        .modal-content-wrapper { flex-grow: 1; }
        .loan-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .payment-history-item, .document-list-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; }
        .payment-date { color: var(--text-secondary); font-size: 0.9em; }
        .payment-history-amount { font-weight: 600; color: var(--accent-green); }
        .no-history { color: var(--text-secondary); text-align: center; padding: 20px; }
        .action-buttons { background-color: var(--surface); border-top: 1px solid var(--border-color); padding: 15px 20px; display: flex; gap: 15px; margin-top: auto; position: sticky; bottom: 0; }
        .action-buttons button { flex-grow: 1; padding: 15px; font-size: 1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--accent-purple); color: white; }
        .btn-secondary { background-color: transparent; color: var(--accent-purple); border: 2px solid var(--accent-purple); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select { width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .form-group .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group input[readonly] { background-color: var(--bg); opacity: 0.7; }
        .radio-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .radio-group label, .day-selector label { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; background-color: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; cursor: pointer; text-align: center; }
        .radio-group input, .day-selector input { display: none; }
        .radio-group input:checked + label, .day-selector input:checked + label { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        .radio-group input:checked + label .icon { color: white !important; }
        .day-selector { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 20px; }
        .day-selector label { padding: 10px; flex-grow: 1; font-weight: 600; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background-color: var(--accent-purple); color: white; border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 160; }
        #doc-preview-container .preview-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg); padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; }
        .document-list-item a { color: var(--accent-purple); text-decoration: none; font-weight: 500; }
        .view { display: none; }
        .view.active { display: block; }
        .search-bar-wrapper { position: relative; margin-bottom: 20px; }
        .search-bar-wrapper input { width: 100%; padding: 12px 12px 12px 40px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .search-bar-wrapper .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-secondary); border-radius: 20px; font-weight: 500; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        #map-container { height: calc(100vh - 145px); width: 100%; border-radius: 12px; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-size: 1em; }
        .popup-client-name { font-weight: 600; margin-bottom: 5px; }
        .popup-client-amount { color: var(--accent-green); font-weight: 700; margin-bottom: 10px; }
        .popup-navigate-btn { width: 100%; padding: 10px; font-size: 0.9em; }
        .settings-item { display: flex; align-items: center; gap: 15px; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 500; text-decoration: none; color: var(--text-primary); }
        .settings-item:active { background-color: var(--bg); }
        .settings-item i { color: var(--text-secondary); }
        .settings-item.logout { color: var(--danger-color); }
        .settings-item.logout i { color: var(--danger-color); }
        .profile-pic-wrapper { position: relative; cursor: pointer; }
        .profile-pic-wrapper::after { content: '✎'; position: absolute; bottom: 5px; right: 5px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .profile-pic-wrapper img.loading { opacity: 0.5; }
        #profile-view-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--accent-purple);
            object-fit: cover;
        }
        #cropper-container { height: calc(100% - 150px); }
        #cropper-container img { max-width: 100%; height: auto; }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- El contenido principal se genera con JS -->
    </div>

    <div id="clientDetailView" class="modal-view"></div>
    <div id="paymentModal" class="modal-view"></div>
    <div id="clientFormModal" class="modal-view"></div>
    <div id="cropperModal" class="modal-view"></div>

    <nav class="bottom-nav">
        <!-- El contenido se genera con JS -->
    </nav>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, arrayUnion, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
          authDomain: "lumix-financas-app.firebaseapp.com",
          projectId: "lumix-financas-app",
          storageBucket: "lumix-financas-app.appspot.com",
          messagingSenderId: "463777495321",
          appId: "1:463777495321:web:106118f53f56abd206ed88"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let allClients = [];
        let currentLang = localStorage.getItem('language') || 'pt';
        let mapInstance = null;
        let mapMarkers = [];
        const collectorId = 'joao_silva'; // Hardcoded for now
        
        const nationalHolidays = [ '01/01', '21/04', '01/05', '07/09', '12/10', '02/11', '15/11', '25/12' ];
        const translations = {
            pt: { collector: 'Cobrador', dailyGoal: 'Meta Diária', receivedToday: 'Recebido Hoje', clientsRemaining: 'Clientes Restantes', todaysRoute: 'Rota de Hoje', navHome: 'Início', navClients: 'Clientes', navMap: 'Mapa', navProfile: 'Perfil', pending: 'Pendente', paid: 'Pago', late: 'Atrasado', addNewClient: 'Adicionar Novo Cliente', clientName: 'Nome do Cliente', address: 'Endereço', totalLoan: 'Valor do Empréstimo', installmentValue: 'Valor da Parcela', numInstallments: 'Número de Parcelas', paymentDays: 'Dias de Pagamento', saveClient: 'Salvar Cliente', city: 'Cidade', location: 'Localização GPS', interest: 'Juros (%)', totalToPay: 'Valor Total a Pagar', clientDocs: 'Documentos do Cliente (Opcional)', takePhoto: 'Tirar Foto', uploadFile: 'Carregar Arquivo', attachedDocs: 'Documentos Anexados', editClient: 'Editar Cliente', saveChanges: 'Salvar Alterações', viewOnMap: 'Ver no Mapa', searchClient: 'Buscar cliente...', all: 'Todos', navigate: 'Navegar', capitalTotal: 'Capital em Mãos', dailyTotal: 'Total do Dia', weeklyTotal: 'Total da Semana', monthlyTotal: 'Total do Mês', accountSettings: 'Configurações da Conta', changePassword: 'Mudar Senha', exportReport: 'Exportar Relatório Diário', logout: 'Sair da Conta', reportTitle: 'Relatório Diário de Cobrança', reportDate: 'Data', reportCollector: 'Cobrador', reportTotalCollected: 'Total Arrecadado', reportNumPayments: 'Nº de Pagamentos', reportClient: 'Cliente', reportAmount: 'Valor', reportTime: 'Hora', noPaymentsToday: 'Nenhum pagamento registrado hoje.', cropImage: 'Recortar Imagem', confirmCrop: 'Confirmar Recorte', cancel: 'Cancelar' },
            es: { collector: 'Cobrador', dailyGoal: 'Meta Diaria', receivedToday: 'Recibido Hoy', clientsRemaining: 'Clientes Restantes', todaysRoute: 'Ruta de Hoy', navHome: 'Inicio', navClients: 'Clientes', navMap: 'Mapa', navProfile: 'Perfil', pending: 'Pendiente', paid: 'Pagado', late: 'Atrasado', addNewClient: 'Añadir Nuevo Cliente', clientName: 'Nombre del Cliente', address: 'Dirección', totalLoan: 'Valor del Préstamo', installmentValue: 'Valor de la Cuota', numInstallments: 'Número de Cuotas', paymentDays: 'Días de Pago', saveClient: 'Guardar Cliente', city: 'Ciudad', location: 'Ubicación GPS', interest: 'Interés (%)', totalToPay: 'Valor Total a Pagar', clientDocs: 'Documentos del Cliente (Opcional)', takePhoto: 'Tomar Foto', uploadFile: 'Cargar Archivo', attachedDocs: 'Documentos Adjuntos', editClient: 'Editar Cliente', saveChanges: 'Guardar Cambios', viewOnMap: 'Ver en Mapa', searchClient: 'Buscar cliente...', all: 'Todos', navigate: 'Navegar', capitalTotal: 'Capital en Mano', dailyTotal: 'Total del Día', weeklyTotal: 'Total Semanal', monthlyTotal: 'Total Mensual', accountSettings: 'Ajustes de la Cuenta', changePassword: 'Cambiar Contraseña', exportReport: 'Exportar Reporte Diario', logout: 'Cerrar Sesión', reportTitle: 'Reporte Diario de Cobranza', reportDate: 'Fecha', reportCollector: 'Cobrador', reportTotalCollected: 'Total Recaudado', reportNumPayments: 'Nº de Pagos', reportClient: 'Cliente', reportAmount: 'Valor', reportTime: 'Hora', noPaymentsToday: 'No hay pagos registrados hoy.', cropImage: 'Recortar Imagen', confirmCrop: 'Confirmar Recorte', cancel: 'Cancelar' },
            en: { collector: 'Collector', dailyGoal: 'Daily Goal', receivedToday: 'Received Today', clientsRemaining: 'Remaining Clients', todaysRoute: 'Today\'s Route', navHome: 'Home', navClients: 'Clients', navMap: 'Map', navProfile: 'Profile', pending: 'Pending', paid: 'Paid', late: 'Late', addNewClient: 'Add New Client', clientName: 'Client Name', address: 'Address', totalLoan: 'Loan Amount', installmentValue: 'Installment Value', numInstallments: 'Number of Installments', paymentDays: 'Payment Days', saveClient: 'Save Client', city: 'City', location: 'GPS Location', interest: 'Interest (%)', totalToPay: 'Total Amount to Pay', clientDocs: 'Client Documents (Optional)', takePhoto: 'Take Photo', uploadFile: 'Upload File', attachedDocs: 'Attached Documents', editClient: 'Edit Client', saveChanges: 'Save Changes', viewOnMap: 'View on Map', searchClient: 'Search client...', all: 'All', navigate: 'Navigate', capitalTotal: 'Capital on Hand', dailyTotal: 'Daily Total', weeklyTotal: 'Weekly Total', monthlyTotal: 'Monthly Total', accountSettings: 'Account Settings', changePassword: 'Change Password', exportReport: 'Export Daily Report', logout: 'Log Out', reportTitle: 'Daily Collection Report', reportDate: 'Date', reportCollector: 'Collector', reportTotalCollected: 'Total Collected', reportNumPayments: '# of Payments', reportClient: 'Client', reportAmount: 'Amount', reportTime: 'Time', noPaymentsToday: 'No payments registered today.', cropImage: 'Crop Image', confirmCrop: 'Confirm Crop', cancel: 'Cancel' }
        };

        const money = val => (typeof val !== 'number' || isNaN(val)) ? (currentLang === 'pt' ? 'R$ 0,00' : '$ 0.00') : val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        function getTodaysRouteClients() {
            return allClients.filter(client => {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const isPaymentDay = (client.paymentDays || []).includes(dayOfWeek);
                return isPaymentDay && (client.status === 'pending' || client.status === 'late');
            });
        }

        function renderMainLayout() {
            document.getElementById('app-container').innerHTML = `
                <header class="main-header">
                    <div class="logo"><img src="https://placehold.co/100x100/6f42c1/FFFFFF?text=L" alt="Logo da Empresa"><span class="logo-text">LUMIX Finanças</span></div>
                    <div class="header-controls">
                        <div style="position: relative;">
                            <button class="header-btn" id="lang-toggle" title="Mudar idioma"><i data-lucide="globe"></i></button>
                            <div class="lang-dropdown" id="lang-dropdown"><button data-lang="pt">Português</button><button data-lang="es">Español</button><button data-lang="en">English</button></div>
                        </div>
                        <button class="header-btn" id="theme-toggle" title="Mudar tema"><i data-lucide="moon"></i></button>
                        <div class="profile">
                            <div class="profile-info"><span class="profile-name">João Silva</span><span class="profile-role" data-lang-key="collector">Cobrador</span></div>
                            <img id="header-profile-img" src="" alt="Foto do Cobrador">
                        </div>
                    </div>
                </header>
                <main>
                    <div id="home-view" class="view active container">
                        <section class="kpi-grid">
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="dailyGoal"><i data-lucide="target"></i> Meta Diária</h3><p class="kpi-value" id="kpi-goal">R$ 0,00</p></div>
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="receivedToday"><i data-lucide="check-circle"></i> Recebido Hoje</h3><p class="kpi-value green" id="kpi-received">R$ 0,00</p></div>
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="clientsRemaining"><i data-lucide="users"></i> Clientes Restantes</h3><p class="kpi-value" id="kpi-remaining">0</p></div>
                        </section>
                        <section class="route-section"><h2 class="section-title" data-lang-key="todaysRoute">Rota de Hoje</h2><div class="client-list" id="todays-route-list"><div class="loading">Carregando clientes...</div></div></section>
                    </div>
                    <div id="clients-view" class="view container">
                        <div class="search-bar-wrapper">
                            <i class="icon" data-lucide="search"></i>
                            <input type="text" id="client-search-input" placeholder="Buscar cliente...">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">Todos</button>
                            <button class="filter-btn" data-filter="pending">Pendentes</button>
                            <button class="filter-btn" data-filter="paid">Pagos</button>
                            <button class="filter-btn" data-filter="late">Atrasados</button>
                        </div>
                        <div class="client-list" id="all-clients-list"></div>
                    </div>
                    <div id="map-view" class="view container">
                        <div id="map-container"></div>
                    </div>
                    <div id="profile-view" class="view container">
                        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                            <label for="profile-pic-input" class="profile-pic-wrapper">
                                <img id="profile-view-img" src="" alt="Foto do Cobrador">
                            </label>
                            <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                            <h2 style="margin: 15px 0 0; font-size: 1.5em;" class="profile-name">João Silva</h2>
                            <p style="margin: 5px 0 0; color: var(--text-secondary);" data-lang-key="collector">Cobrador</p>
                        </div>

                         <div class="kpi-card" style="margin-bottom: 20px; text-align: center;">
                            <h3 class="kpi-title" style="justify-content: center;" data-lang-key="capitalTotal"><i data-lucide="wallet"></i> Capital em Mãos</h3>
                            <p class="kpi-value" id="kpi-capital-total">R$ 0,00</p>
                        </div>

                        <section class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));">
                             <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="dailyTotal"><i data-lucide="sun"></i> Total do Dia</h3>
                                <p class="kpi-value green" id="kpi-daily-total">R$ 0,00</p>
                            </div>
                            <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="weeklyTotal"><i data-lucide="calendar"></i> Total Semanal</h3>
                                <p class="kpi-value green" id="kpi-weekly-total">R$ 0,00</p>
                            </div>
                            <div class="kpi-card">
                                <h3 class="kpi-title" data-lang-key="monthlyTotal"><i data-lucide="calendar-days"></i> Total Mensal</h3>
                                <p class="kpi-value green" id="kpi-monthly-total">R$ 0,00</p>
                            </div>
                        </section>
                        <section>
                            <h2 class="section-title" data-lang-key="accountSettings">Ajustes da Conta</h2>
                            <div class="client-list">
                                <a class="settings-item" id="change-password-btn">
                                    <i data-lucide="key-round"></i>
                                    <span data-lang-key="changePassword">Mudar Senha</span>
                                </a>
                                <a class="settings-item" id="export-report-btn">
                                    <i data-lucide="download"></i>
                                    <span data-lang-key="exportReport">Exportar Relatório Diário</span>
                                </a>
                                 <a class="settings-item logout" id="logout-btn">
                                    <i data-lucide="log-out"></i>
                                    <span data-lang-key="logout">Sair da Conta</span>
                                </a>
                            </div>
                        </section>
                    </div>
                </main>
                <button class="fab" id="addClientBtn" title="Adicionar Cliente"><i data-lucide="plus"></i></button>`;
            
            document.querySelector('.bottom-nav').innerHTML = `
                <a class="nav-item active" data-view="home"><i data-lucide="home"></i><span data-lang-key="navHome">Início</span></a>
                <a class="nav-item" data-view="clients"><i data-lucide="users"></i><span data-lang-key="navClients">Clientes</span></a>
                <a class="nav-item" data-view="map"><i data-lucide="map"></i><span data-lang-key="navMap">Mapa</span></a>
                <a class="nav-item" data-view="profile"><i data-lucide="user-circle"></i><span data-lang-key="navProfile">Perfil</span></a>`;
        }
        
        function applyTheme(theme) {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            body.classList.toggle('dark-mode', theme === 'dark');
            if (themeToggle) {
                themeToggle.innerHTML = `<i data-lucide="${theme === 'dark' ? 'sun' : 'moon'}"></i>`;
                lucide.createIcons({ nodes: [themeToggle] });
            }
        }
        
        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) { el.textContent = translations[lang][key]; }
            });
            document.documentElement.lang = lang.startsWith('es') ? 'es' : (lang.startsWith('en') ? 'en' : 'pt-BR');
            const searchInput = document.getElementById('client-search-input');
            if(searchInput) searchInput.placeholder = translations[lang].searchClient;
            
            updateTodaysRouteList();
            updateAllClientsList();
            updateProfileView();
        }

        function updateDashboard(clientsForDashboard) {
            const kpiGoal = document.getElementById('kpi-goal');
            const kpiReceived = document.getElementById('kpi-received');
            const kpiRemaining = document.getElementById('kpi-remaining');
            if (!kpiGoal) return;
            if (!clientsForDashboard || clientsForDashboard.length === 0) {
                 kpiGoal.textContent = money(0);
                 kpiRemaining.textContent = 0;
            } else {
                const dailyGoal = clientsForDashboard.filter(c => c.status !== 'paid').reduce((sum, c) => sum + c.amount, 0);
                const remainingClients = clientsForDashboard.filter(c => c.status === 'pending' || c.status === 'late').length;
                kpiGoal.textContent = money(dailyGoal);
                kpiRemaining.textContent = remainingClients;
            }
            
            const todayStr = new Date().toLocaleDateString('pt-BR');
            const receivedToday = allClients.filter(c => c.history && Array.isArray(c.history)).flatMap(c => c.history).filter(h => h && h.date && h.date.seconds && new Date(h.date.seconds * 1000).toLocaleDateString('pt-BR') === todayStr).reduce((sum, h) => sum + h.amount, 0);
            kpiReceived.textContent = money(receivedToday);
        }

        function updateProfileView(collectorData = null) {
            const dailyTotalEl = document.getElementById('kpi-daily-total');
            const weeklyTotalEl = document.getElementById('kpi-weekly-total');
            const monthlyTotalEl = document.getElementById('kpi-monthly-total');
            const capitalTotalEl = document.getElementById('kpi-capital-total');
            if (!dailyTotalEl || !weeklyTotalEl || !monthlyTotalEl || !capitalTotalEl) return;

            const now = new Date();
            const todayStr = now.toLocaleDateString('pt-BR');
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(now.getDate() - 7);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            let dailyTotal = 0, weeklyTotal = 0, monthlyTotal = 0, totalPaymentsReceived = 0, totalLoansMade = 0;

            allClients.forEach(client => {
                if (client.collectorId === collectorId) {
                     if (client.totalLoan && client.interestRate) {
                        const principal = client.totalLoan / (1 + client.interestRate / 100);
                        totalLoansMade += principal;
                    }
                    (client.history || []).forEach(h => {
                        if (h.date && h.date.seconds) {
                            const paymentDate = new Date(h.date.seconds * 1000);
                            const amount = h.amount || 0;
                            totalPaymentsReceived += amount;

                            if (paymentDate.toLocaleDateString('pt-BR') === todayStr) { dailyTotal += amount; }
                            if (paymentDate >= oneWeekAgo) { weeklyTotal += amount; }
                            if (paymentDate >= startOfMonth) { monthlyTotal += amount; }
                        }
                    });
                }
            });
            
            const currentStartingCapital = (collectorData && collectorData.startingCapital) || 0;
            const capitalTotal = currentStartingCapital - totalLoansMade + totalPaymentsReceived;

            dailyTotalEl.textContent = money(dailyTotal);
            weeklyTotalEl.textContent = money(weeklyTotal);
            monthlyTotalEl.textContent = money(monthlyTotal);
            capitalTotalEl.textContent = money(capitalTotal);
        }

        function renderClientCards(container, clients) {
            if (!container) return;
            if (clients.length === 0) {
                container.innerHTML = `<div class="loading">Nenhum cliente encontrado.</div>`;
                return;
            }
            container.innerHTML = ''; 
            clients.forEach(client => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.dataset.clientId = client.id;
                const statusClass = `status-${client.status}`;
                const statusText = (translations[currentLang] && translations[currentLang][client.status]) || client.status;
                card.innerHTML = `<div class="client-info"><h4 class="client-name">${client.name}</h4><p class="client-address"><i data-lucide="map-pin" style="width: 14px; height: 14px; stroke-width: 2.5;"></i>${client.address}</p></div><div class="payment-info"><span class="payment-amount">${money(client.amount)}</span><span class="payment-status ${statusClass}">${statusText}</span></div>`;
                container.appendChild(card);
            });
            lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
            container.querySelectorAll('.client-card').forEach(card => card.addEventListener('click', (e) => showClientDetails(e.currentTarget.dataset.clientId)));
        }

        function updateTodaysRouteList() {
            const todaysRouteClients = getTodaysRouteClients();
            renderClientCards(document.getElementById('todays-route-list'), todaysRouteClients);
            updateDashboard(todaysRouteClients);
        }

        function updateAllClientsList() {
            const container = document.getElementById('all-clients-list');
            const searchInput = document.getElementById('client-search-input');
            const activeFilter = document.querySelector('.filter-btn.active');
            if (!container || !searchInput || !activeFilter) return;

            const searchTerm = searchInput.value.toLowerCase();
            const filter = activeFilter.dataset.filter;

            let filteredClients = allClients;

            if (filter !== 'all') {
                filteredClients = filteredClients.filter(c => c.status === filter);
            }

            if (searchTerm) {
                filteredClients = filteredClients.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    (c.address && c.address.toLowerCase().includes(searchTerm))
                );
            }
            renderClientCards(container, filteredClients);
        }
        
        function showClientDetails(clientId) {
            const clientDetailView = document.getElementById('clientDetailView');
            const client = allClients.find(c => c.id == clientId);
            if (!client) return;
            
            let historyHtml = `<p class="no-history">Nenhum pagamento registrado ainda.</p>`;
            if (client.history && client.history.length > 0) {
                historyHtml = [...client.history]
                    .sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0))
                    .map(p => {
                        let dateString = 'Data inválida';
                        if (p && p.date && typeof p.date.seconds === 'number') { dateString = new Date(p.date.seconds * 1000).toLocaleDateString('pt-BR'); }
                        return `<div class="payment-history-item"><span class="payment-date">${dateString}</span><span class="payment-history-amount">${money(p.amount)}</span></div>`;
                    }).join('');
            }

            let documentsHtml = '';
            if (client.documents && client.documents.length > 0) {
                documentsHtml = `
                    <section>
                        <h2 class="section-title" data-lang-key="attachedDocs">Documentos Anexados</h2>
                        <div class="client-list">
                            ${client.documents.map(doc => `
                                <div class="document-list-item">
                                    <span>${doc.name}</span>
                                    <a href="${doc.url}" target="_blank" rel="noopener noreferrer"><i data-lucide="eye"></i></a>
                                </div>
                            `).join('')}
                        </div>
                    </section>`;
            }

            clientDetailView.innerHTML = `
                <header class="modal-header" style="justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <button id="closeDetailView" class="header-btn" style="margin-right: 10px;"><i data-lucide="arrow-left"></i></button>
                        <span class="modal-title">${client.name}</span>
                    </div>
                    <button id="editClientBtn" class="header-btn" title="Editar Cliente"><i data-lucide="edit"></i></button>
                </header>
                <div class="modal-content-wrapper container">
                    <section class="loan-summary">
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="coins"></i> Total</h3><p class="kpi-value">${money(client.totalLoan)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="trending-up"></i> Pago</h3><p class="kpi-value green">${money(client.paid)}</p></div>
                    </section>
                    ${documentsHtml}
                    <section>
                        <h2 class="section-title">Histórico de Pagamentos</h2>
                        <div class="client-list">${historyHtml}</div>
                    </section>
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" id="viewMapBtn"><i data-lucide="map"></i> <span data-lang-key="viewOnMap">Ver no Mapa</span></button>
                    <button class="btn-primary" id="registerPaymentBtn"><i data-lucide="dollar-sign"></i> Registrar Pagamento</button>
                </div>`;
            
            clientDetailView.classList.add('active');
            lucide.createIcons({ nodes: clientDetailView.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);
            document.getElementById('closeDetailView').addEventListener('click', () => clientDetailView.classList.remove('active'));
            document.getElementById('registerPaymentBtn').addEventListener('click', () => showPaymentModal(clientId));
            document.getElementById('editClientBtn').addEventListener('click', () => showClientFormModal(clientId));
            
            const viewMapBtn = document.getElementById('viewMapBtn');
            if (client.location) {
                viewMapBtn.addEventListener('click', () => window.open(client.location, '_blank'));
            } else {
                viewMapBtn.disabled = true;
                viewMapBtn.style.opacity = '0.5';
            }
        }

        function showPaymentModal(clientId) {
            const paymentModal = document.getElementById('paymentModal');
            const client = allClients.find(c => c.id == clientId);
            if (!client) return;
            paymentModal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentModal"><i data-lucide="x"></i></button>
                    <span class="modal-title">Registrar Pagamento</span>
                </header>
                <div class="modal-content-wrapper container">
                    <h2 class="section-title" style="border: none; margin-bottom: 5px;">${client.name}</h2>
                    <p style="color: var(--text-secondary); margin-top:0; margin-bottom: 30px;">Parcela de hoje: ${money(client.amount)}</p>
                    <form id="payment-form" class="payment-form">
                        <div class="form-group">
                            <label for="payment-value">Valor Recebido</label>
                            <input type="number" id="payment-value" value="${client.amount.toFixed(2)}" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Método de Pagamento</label>
                            <div class="radio-group">
                                <input type="radio" id="method-cash" name="payment-method" value="dinheiro" checked>
                                <label for="method-cash"><i data-lucide="banknote" class="icon"></i>Dinheiro</label>
                                
                                <input type="radio" id="method-pix" name="payment-method" value="pix">
                                <label for="method-pix"><i data-lucide="send" class="icon"></i>PIX</label>
                                
                                <input type="radio" id="method-card" name="payment-method" value="cartao">
                                <label for="method-card"><i data-lucide="credit-card" class="icon"></i>Cartão</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="confirmPaymentBtn"><i data-lucide="check-circle"></i> Confirmar Pagamento</button>
                </div>`;
            paymentModal.classList.add('active');
            lucide.createIcons({ nodes: paymentModal.querySelectorAll('[data-lucide]') });
            document.getElementById('closePaymentModal').addEventListener('click', () => paymentModal.classList.remove('active'));
            document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
                const paymentValue = parseFloat(document.getElementById('payment-value').value);
                if (isNaN(paymentValue) || paymentValue <= 0) { alert('Valor de pagamento inválido.'); return; }
                const clientRef = doc(db, 'clients', clientId);
                try {
                    await updateDoc(clientRef, { status: 'paid', paid: (client.paid || 0) + paymentValue, history: arrayUnion({ amount: paymentValue, date: new Date() }) });
                    paymentModal.classList.remove('active');
                    document.getElementById('clientDetailView').classList.remove('active');
                } catch(error) { console.error("Error updating document: ", error); alert("Falha ao registrar pagamento."); }
            });
        }
        
        function showClientFormModal(clientId = null) {
            const isEditMode = clientId !== null;
            const client = isEditMode ? allClients.find(c => c.id === clientId) : {};

            let filesToUpload = [];
            let existingDocs = isEditMode ? [...(client.documents || [])] : [];

            const clientFormModal = document.getElementById('clientFormModal');
            
            const modalTitleKey = isEditMode ? 'editClient' : 'addNewClient';
            const saveButtonKey = isEditMode ? 'saveChanges' : 'saveClient';

            clientFormModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeClientFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="${modalTitleKey}"></span>
                </header>
                <div class="modal-content-wrapper container">
                    <form id="client-form">
                        <div class="form-group"><label data-lang-key="clientName">Nome do Cliente</label><input type="text" id="client-name" required value="${client.name || ''}"></div>
                        <div class="form-group"><label data-lang-key="address">Endereço</label><input type="text" id="client-address" required value="${client.address || ''}"></div>
                        <div class="form-group"><label data-lang-key="city">Cidade</label><input type="text" id="client-city" required value="${client.city || ''}"></div>
                        <div class="form-group">
                            <label data-lang-key="location">Localização GPS</label>
                            <input type="text" id="client-location" readonly placeholder="Clique no botão para obter" value="${client.location || ''}">
                            <button type="button" class="btn-secondary" id="get-location-btn" style="width: 100%; margin-top: 10px;">
                                <i data-lucide="map-pin"></i> Obter Localização GPS
                            </button>
                        </div>
                        <div class="form-group grid-2">
                            <div><label data-lang-key="totalLoan">Valor do Empréstimo</label><input type="number" id="client-loan-amount" required value="${(client.totalLoan && client.interestRate) ? (client.totalLoan / (1 + client.interestRate/100)) : ''}"></div>
                            <div><label data-lang-key="interest">Juros (%)</label><input type="number" id="client-interest" required value="${client.interestRate || '20'}"></div>
                        </div>
                        <div class="form-group"><label data-lang-key="totalToPay">Valor Total a Pagar</label><input type="text" id="client-total-to-pay" readonly></div>
                        <div class="form-group grid-2">
                             <div><label data-lang-key="numInstallments">Número de Parcelas</label><input type="number" id="client-installments" required value="${isEditMode ? (client.installments || '').split('/')[1] : ''}"></div>
                            <div><label data-lang-key="installmentValue">Valor da Parcela</label><input type="text" id="client-installment-value" readonly></div>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="paymentDays">Dias de Pagamento</label>
                            <div class="day-selector">
                                ${['D','S','T','Q','Q','S','S'].map((day, i) => `<div><input type="checkbox" id="form-day-${i}" value="${i}"><label for="form-day-${i}">${day}</label></div>`).join('')}
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="clientDocs">Documentos do Cliente</label>
                            <div class="grid-2">
                                <button type="button" class="btn-secondary" id="take-photo-btn"><i data-lucide="camera"></i> <span data-lang-key="takePhoto"></span></button>
                                <button type="button" class="btn-secondary" id="upload-file-btn"><i data-lucide="upload"></i> <span data-lang-key="uploadFile"></span></button>
                            </div>
                            <input type="file" id="doc-file-input" multiple accept="image/*,application/pdf" style="display: none;">
                            <div id="doc-preview-container" style="margin-top: 15px;"></div>
                        </div>
                    </form>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="saveClientBtn"><i data-lucide="save"></i> <span data-lang-key="${saveButtonKey}"></span></button>
                </div>`;
            clientFormModal.classList.add('active');
            
            const docPreviewContainer = document.getElementById('doc-preview-container');

            function renderDocPreviews() {
                docPreviewContainer.innerHTML = '';
                // Render existing docs
                existingDocs.forEach(doc => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `<span>${doc.name}</span><button type="button" class="remove-existing-doc" style="background:none; border:none; color: var(--text-secondary); cursor:pointer;"><i data-lucide="x-circle"></i></button>`;
                    docPreviewContainer.appendChild(previewItem);
                    previewItem.querySelector('button').addEventListener('click', () => {
                        existingDocs = existingDocs.filter(d => d.url !== doc.url);
                        renderDocPreviews();
                    });
                });
                // Render new files to upload
                 filesToUpload.forEach(file => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `<span>${file.name} (novo)</span><button type="button" class="remove-new-doc" style="background:none; border:none; color: var(--text-secondary); cursor:pointer;"><i data-lucide="x-circle"></i></button>`;
                    docPreviewContainer.appendChild(previewItem);
                    previewItem.querySelector('button').addEventListener('click', () => {
                         filesToUpload = filesToUpload.filter(f => f !== file);
                         renderDocPreviews();
                    });
                });
                lucide.createIcons({nodes: docPreviewContainer.querySelectorAll('i')});
            }

            if(isEditMode) renderDocPreviews();

            function handleFiles(selectedFiles) {
                filesToUpload.push(...selectedFiles);
                renderDocPreviews();
            }

            document.getElementById('take-photo-btn').addEventListener('click', () => {
                const docFileInput = document.getElementById('doc-file-input');
                docFileInput.setAttribute('capture', 'camera');
                docFileInput.click();
            });
            document.getElementById('upload-file-btn').addEventListener('click', () => {
                 const docFileInput = document.getElementById('doc-file-input');
                docFileInput.removeAttribute('capture');
                docFileInput.click();
            });
            document.getElementById('doc-file-input').addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

            const loanAmountInput = document.getElementById('client-loan-amount');
            const interestInput = document.getElementById('client-interest');
            const installmentsInput = document.getElementById('client-installments');
            const totalToPayInput = document.getElementById('client-total-to-pay');
            const installmentValueInput = document.getElementById('client-installment-value');

            function calculateLoanDetails() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const interest = parseFloat(interestInput.value) || 0;
                const installments = parseInt(installmentsInput.value) || 0;
                const totalToPay = loanAmount * (1 + (interest / 100));
                const installmentValue = installments > 0 ? totalToPay / installments : 0;
                totalToPayInput.value = money(totalToPay);
                installmentValueInput.value = money(installmentValue);
            }

            [loanAmountInput, interestInput, installmentsInput].forEach(input => input.addEventListener('input', calculateLoanDetails));
            calculateLoanDetails();

            // Pre-fill payment days
            const paymentDays = client.paymentDays || [1,2,3,4,5,6]; // Default for new clients
            paymentDays.forEach(day => {
                const checkbox = document.getElementById(`form-day-${day}`);
                if (checkbox) checkbox.checked = true;
            });
            
            document.getElementById('get-location-btn').addEventListener('click', () => {
                const locationInput = document.getElementById('client-location');
                if ('geolocation' in navigator) {
                    locationInput.placeholder = 'Obtendo localização...';
                    navigator.geolocation.getCurrentPosition(position => {
                        const { latitude, longitude } = position.coords;
                        locationInput.value = `https://maps.google.com/?q=${latitude},${longitude}`;
                    }, error => {
                        locationInput.placeholder = 'Não foi possível obter a localização.';
                        alert('Erro ao obter localização. Verifique as permissões do navegador.');
                    });
                } else {
                    alert('Geolocalização não é suportada neste navegador.');
                }
            });
            
            document.getElementById('closeClientFormModal').addEventListener('click', () => clientFormModal.classList.remove('active'));
            document.getElementById('saveClientBtn').addEventListener('click', async (e) => {
                const saveButton = e.currentTarget;
                saveButton.disabled = true; 
                const buttonSpan = saveButton.querySelector('span');
                buttonSpan.textContent = 'Salvando...';

                // 1. Upload new files
                let newUploadedDocuments = [];
                if (filesToUpload.length > 0) {
                    const clientFolderId = client.id || crypto.randomUUID();
                    const uploadPromises = filesToUpload.map(async file => {
                        const storageRef = ref(storage, `client_docs/${clientFolderId}/${file.name}`);
                        await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(storageRef);
                        return { name: file.name, url: downloadURL };
                    });
                    try {
                        newUploadedDocuments = await Promise.all(uploadPromises);
                    } catch (error) {
                        console.error("Error uploading new files:", error);
                        alert("Falha ao carregar os novos documentos.");
                        saveButton.disabled = false; buttonSpan.textContent = translations[currentLang][saveButtonKey];
                        return;
                    }
                }
                
                // 2. Combine with existing documents
                const finalDocuments = [...existingDocs, ...newUploadedDocuments];

                // 3. Gather all data from form
                const loanAmount = parseFloat(loanAmountInput.value);
                const interest = parseFloat(interestInput.value);
                const installments = parseInt(installmentsInput.value);
                const totalToPay = loanAmount * (1 + (interest / 100));
                const installmentValue = installments > 0 ? totalToPay / installments : 0;
                
                const clientData = {
                    name: document.getElementById('client-name').value,
                    address: document.getElementById('client-address').value,
                    city: document.getElementById('client-city').value,
                    location: document.getElementById('client-location').value,
                    totalLoan: totalToPay,
                    amount: installmentValue,
                    installments: isEditMode && client.installments ? `${client.installments.split('/')[0]}/${installments}` : `0/${installments}`,
                    paid: client.paid || 0,
                    status: client.status || 'pending',
                    history: client.history || [],
                    documents: finalDocuments,
                    paymentDays: Array.from(document.querySelectorAll('.day-selector input:checked')).map(el => parseInt(el.value)),
                    collectorId: client.collectorId || 'joao_silva',
                    startDate: client.startDate || new Date(),
                    interestRate: interest
                };

                if (!clientData.name || !clientData.totalLoan) { 
                    alert('Nome e Valor do Empréstimo são obrigatórios.'); 
                    saveButton.disabled = false; buttonSpan.textContent = translations[currentLang][saveButtonKey];
                    return;
                }

                // 4. Save or Update
                try {
                    if (isEditMode) {
                        const clientRef = doc(db, 'clients', clientId);
                        await updateDoc(clientRef, clientData);
                    } else {
                        await addDoc(collection(db, "clients"), clientData);
                    }
                    clientFormModal.classList.remove('active');
                } catch (err) {
                    console.error("Error saving document: ", err);
                    alert("Falha ao salvar cliente.");
                    saveButton.disabled = false; buttonSpan.textContent = translations[currentLang][saveButtonKey];
                }
            });

            lucide.createIcons({ nodes: clientFormModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);
        }
        
        function calculateClientStatus(client) {
            if (client.paid >= client.totalLoan) return 'paid';
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            let lastPaymentDate;
            if (client.history && client.history.length > 0) {
                const sortedHistory = [...client.history].filter(h => h.date && h.date.seconds).sort((a, b) => b.date.seconds - a.date.seconds);
                if (sortedHistory.length > 0) lastPaymentDate = new Date(sortedHistory[0].date.seconds * 1000);
            } 
            if (!lastPaymentDate && client.startDate && client.startDate.seconds) {
                lastPaymentDate = new Date(client.startDate.seconds * 1000);
            }

            if (!lastPaymentDate) return 'pending';
            lastPaymentDate.setHours(0, 0, 0, 0);
            
            let workingDaysToPay = 0;
            let checkDate = new Date(lastPaymentDate);

            if (checkDate >= today) return 'paid';

            while(checkDate < today) {
                checkDate.setDate(checkDate.getDate() + 1);
                const dayOfWeek = checkDate.getDay();
                const formattedDate = `${String(checkDate.getDate()).padStart(2, '0')}/${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
                const isHoliday = nationalHolidays.includes(formattedDate);
                const isPaymentDay = (client.paymentDays || []).includes(dayOfWeek);
                if (!isHoliday && isPaymentDay) workingDaysToPay++;
            }
            
            if (workingDaysToPay > 1) return 'late';
            if (workingDaysToPay === 1) return 'pending';
            return 'paid';
        }

        function initMap() {
            if (mapInstance) {
                mapInstance.invalidateSize();
                return;
            };
            mapInstance = L.map('map-container').setView([-16.68, -49.25], 13); // Centered on Goiânia
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
        }

        function plotClientsOnMap() {
            if (!mapInstance) return;

            // Clear existing markers
            mapMarkers.forEach(marker => marker.remove());
            mapMarkers = [];

            const clientsToPlot = getTodaysRouteClients();
            const locations = [];

            clientsToPlot.forEach(client => {
                if (client.location) {
                    const match = client.location.match(/q=([\d.-]+),([\d.-]+)/);
                    if (match) {
                        const lat = parseFloat(match[1]);
                        const lng = parseFloat(match[2]);
                        locations.push([lat, lng]);
                        
                        const popupContent = `
                            <div class="popup-client-name">${client.name}</div>
                            <div class="popup-client-amount">${money(client.amount)}</div>
                            <button class="btn-primary popup-navigate-btn" onclick="window.open('${client.location}', '_blank')">
                                <i data-lucide="navigation" style="width:14px; height:14px;"></i> ${translations[currentLang].navigate || 'Navigate'}
                            </button>
                        `;

                        const marker = L.marker([lat, lng]).addTo(mapInstance)
                            .bindPopup(popupContent);
                        
                        marker.on('popupopen', () => {
                           lucide.createIcons();
                        });

                        mapMarkers.push(marker);
                    }
                }
            });

            if (locations.length > 0) {
                mapInstance.fitBounds(locations, { padding: [50, 50] });
            }
        }

        function exportDailyReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const todayStr = new Date().toLocaleDateString('pt-BR');
            const lang = currentLang;

            const dailyPayments = [];
             allClients.forEach(client => {
                (client.history || []).forEach(h => {
                    if (h.date && h.date.seconds) {
                        const paymentDate = new Date(h.date.seconds * 1000);
                        if (paymentDate.toLocaleDateString('pt-BR') === todayStr) {
                            dailyPayments.push({
                                clientName: client.name,
                                amount: h.amount,
                                time: paymentDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                            });
                        }
                    }
                });
            });

            if (dailyPayments.length === 0) {
                alert(translations[lang].noPaymentsToday);
                return;
            }

            const totalCollected = dailyPayments.reduce((sum, p) => sum + p.amount, 0);

            doc.setFontSize(18);
            doc.text(translations[lang].reportTitle, 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text(`${translations[lang].reportDate}: ${todayStr}`, 14, 30);
            doc.text(`${translations[lang].reportCollector}: João Silva`, 14, 35);
            
            doc.text(`${translations[lang].reportTotalCollected}: ${money(totalCollected)}`, 196, 30, { align: 'right' });
            doc.text(`${translations[lang].reportNumPayments}: ${dailyPayments.length}`, 196, 35, { align: 'right' });

            doc.setLineWidth(0.5);
            doc.line(14, 40, 196, 40);

            let y = 50;
            doc.setFontSize(10);
            doc.text(translations[lang].reportClient, 14, y);
            doc.text(translations[lang].reportAmount, 150, y);
            doc.text(translations[lang].reportTime, 180, y);
            y += 7;

            dailyPayments.sort((a,b) => a.time.localeCompare(b.time)).forEach(p => {
                 if (y > 280) {
                    doc.addPage();
                    y = 20;
                 }
                doc.text(p.clientName, 14, y);
                doc.text(money(p.amount), 150, y);
                doc.text(p.time, 180, y);
                y += 7;
            });
            
            doc.save(`relatorio-diario-${todayStr.replace(/\//g, '-')}.pdf`);
        }
        
        function showCropperModal(file) {
            const cropperModal = document.getElementById('cropperModal');
            cropperModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeCropperModal"><i data-lucide="x"></i></button>
                    <span class="modal-title" data-lang-key="cropImage"></span>
                </header>
                <div class="modal-content-wrapper container" id="cropper-container">
                    <img id="cropper-image">
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" id="cancelCropBtn"><i data-lucide="x-circle"></i> <span data-lang-key="cancel"></span></button>
                    <button class="btn-primary" id="confirmCropBtn"><i data-lucide="check-circle"></i> <span data-lang-key="confirmCrop"></span></button>
                </div>
            `;
            cropperModal.classList.add('active');
            lucide.createIcons({nodes: cropperModal.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);

            const image = document.getElementById('cropper-image');
            const reader = new FileReader();
            let cropper;

            reader.onload = (e) => {
                image.src = e.target.result;
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    background: false,
                    responsive: true,
                    restore: false,
                    checkOrientation: false,
                    guides: false,
                    center: false,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            };
            reader.readAsDataURL(file);

            document.getElementById('closeCropperModal').addEventListener('click', () => cropperModal.classList.remove('active'));
            document.getElementById('cancelCropBtn').addEventListener('click', () => cropperModal.classList.remove('active'));
            document.getElementById('confirmCropBtn').addEventListener('click', () => {
                cropper.getCroppedCanvas({
                    width: 256,
                    height: 256,
                    imageSmoothingQuality: 'high',
                }).toBlob((blob) => {
                    handleProfilePictureChange(blob);
                    cropperModal.classList.remove('active');
                }, 'image/jpeg');
            });
        }

        async function handleProfilePictureChange(blob) {
            if (!blob) return;
            const profileImageView = document.getElementById('profile-view-img');
            const headerImageView = document.getElementById('header-profile-img');

            const localUrl = URL.createObjectURL(blob);
            profileImageView.src = localUrl;
            headerImageView.src = localUrl;
            
            profileImageView.classList.add('loading');
            
            const imageName = `${collectorId}-${Date.now()}.jpg`;
            const storageRef = ref(storage, `profile_pictures/${imageName}`);
            
            try {
                await uploadBytes(storageRef, blob);
                const downloadURL = await getDownloadURL(storageRef);
                
                const collectorRef = doc(db, 'collectors', collectorId);
                await setDoc(collectorRef, { profilePictureUrl: downloadURL }, { merge: true });

            } catch (error) {
                console.error("Error updating profile picture: ", error);
                alert("Falha ao atualizar a foto de perfil.");
            } finally {
                profileImageView.classList.remove('loading');
            }
        }

        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle && e.target.closest('#theme-toggle')) {
                    const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                }
                const langToggle = document.getElementById('lang-toggle');
                const langDropdown = document.getElementById('lang-dropdown');
                if (langToggle && e.target.closest('#lang-toggle')) {
                    e.stopPropagation();
                    langDropdown.style.display = langDropdown.style.display === 'block' ? 'none' : 'block';
                } else if (langDropdown) {
                    langDropdown.style.display = 'none';
                }
                if (langDropdown && e.target.closest('[data-lang]')) {
                    const newLang = e.target.dataset.lang;
                    localStorage.setItem('language', newLang);
                    applyLanguage(newLang);
                }
                const addClientBtn = document.getElementById('addClientBtn');
                if(addClientBtn && e.target.closest('#addClientBtn')) {
                    showClientFormModal();
                }
                if (e.target.closest('#logout-btn')) {
                    console.log("Logout a ser implementado.");
                }
                if (e.target.closest('#change-password-btn')) {
                    console.log("Mudar senha a ser implementado.");
                }
                if (e.target.closest('#export-report-btn')) {
                    exportDailyReport();
                }
            });
            
            document.body.addEventListener('change', e => {
                if (e.target.id === 'profile-pic-input') {
                    const file = e.target.files[0];
                    if (file) showCropperModal(file);
                }
            });

            const nav = document.querySelector('.bottom-nav');
            if(nav) {
                nav.addEventListener('click', e => {
                    const navItem = e.target.closest('.nav-item');
                    if (!navItem) return;
                    
                    const targetView = navItem.dataset.view;
                    if (!targetView) return;

                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');

                    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                    const viewToShow = document.getElementById(`${targetView}-view`);
                    if(viewToShow) viewToShow.classList.add('active');

                    const fab = document.getElementById('addClientBtn');
                    if (fab) {
                        const isVisible = targetView !== 'map' && targetView !== 'profile';
                        fab.style.display = isVisible ? 'flex' : 'none';
                    }

                    if (targetView === 'map') {
                        // Delay map initialization slightly to ensure container is visible
                        setTimeout(() => {
                           initMap();
                           plotClientsOnMap();
                        }, 50);
                    }
                });
            }

            const clientsView = document.getElementById('clients-view');
            if (clientsView) {
                clientsView.addEventListener('input', e => {
                    if (e.target.id === 'client-search-input') {
                        updateAllClientsList();
                    }
                });
                clientsView.addEventListener('click', e => {
                    if (e.target.classList.contains('filter-btn')) {
                        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        updateAllClientsList();
                    }
                });
            }
        }
        
        function init() {
            renderMainLayout();
            setupEventListeners();
            applyTheme(localStorage.getItem('theme') || 'light');
            
            let collectorData = null;

            // Listener for collector data
            onSnapshot(doc(db, 'collectors', collectorId), (docSnap) => {
                if (docSnap.exists()) {
                    collectorData = docSnap.data();
                    document.querySelectorAll('.profile-name').forEach(el => el.textContent = collectorData.name || 'João Silva');
                    
                    if (collectorData.profilePictureUrl) {
                        const cacheBustedUrl = `${collectorData.profilePictureUrl}&t=${new Date().getTime()}`;
                        document.getElementById('header-profile-img').src = cacheBustedUrl;
                        document.getElementById('profile-view-img').src = cacheBustedUrl;
                    } else {
                        const name = collectorData.name || 'C';
                        const initial = name.charAt(0).toUpperCase();
                        const placeholderUrl = `https://placehold.co/120x120/6f42c1/FFFFFF?text=${initial}`;
                        document.getElementById('header-profile-img').src = placeholderUrl.replace('120x120', '80x80');
                        document.getElementById('profile-view-img').src = placeholderUrl;
                    }

                } else {
                    // Create a default collector document if it doesn't exist
                    const collectorRef = doc(db, 'collectors', collectorId);
                    setDoc(collectorRef, { 
                        name: 'João Silva',
                        profilePictureUrl: '',
                        startingCapital: 30000
                    });
                }
                // Update profile view with collector data
                updateProfileView(collectorData);
            });

            // Listener for clients data
            onSnapshot(collection(db, 'clients'), (snapshot) => {
                allClients = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const client = { id: doc.id, ...data };
                    client.status = calculateClientStatus(client);
                    return client;
                });
                updateTodaysRouteList();
                updateAllClientsList();
                updateProfileView(collectorData);
                applyLanguage(currentLang);
                if (document.querySelector('#map-view.active')) {
                   plotClientsOnMap();
                }
            }, (error) => {
                console.error("Error fetching clients: ", error);
                const clientListContainer = document.getElementById('todays-route-list');
                if(clientListContainer) clientListContainer.innerHTML = '<div class="loading">Falha ao carregar clientes. Verifique a configuração do Firebase.</div>';
            });
        }
        init();
    </script>
</body>
</html>
