<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LUMIX Cobrador">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/dc6as14p0/image/upload/v1759873183/LOGO_LUMIX_REDUCI_czkw4p.png">
    <link rel="icon" href="https://res.cloudinary.com/dc6as14p0/image/upload/v1759873183/LOGO_LUMIX_REDUCI_czkw4p.png" type="image/png">
    <title>Painel do Cobrador</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-green: #28a745;
            --accent-yellow: #facc15;
            --accent-orange: #fb923c;
            --accent-purple: #6f42c1;
            --accent-purple-darker: #5a349c;
            --border-color: #e9ecef;
            --danger-color: #dc3545;
        }
        body.dark-mode {
            --bg: #020617;
            --surface: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
            --danger-color: #f87171;
            --accent-yellow: #fde047;
            --accent-orange: #fdba74;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        @keyframes subtle-glow {
            0%, 100% {
                filter: drop-shadow(0 0 8px rgba(138, 43, 226, 0.7));
            }
            50% {
                filter: drop-shadow(0 0 16px rgba(57, 255, 20, 0.7));
            }
        }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen img {
            width: 150px; 
            height: 150px; 
            animation: pulse 2.5s infinite ease-in-out;
        }

        #login-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            background-color: var(--bg);
        }
        .login-card {
            background-color: transparent;
            box-shadow: none;
            border: none;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-card .logo {
            display: flex;
            justify-content: center;
        }
        .login-card .logo img {
            width: 140px; 
            height: 140px; 
            margin-bottom: 30px; 
            animation: subtle-glow 5s ease-in-out infinite;
        }
        .login-card h2 {
            margin-bottom: 10px;
            font-size: 1.8em; 
            font-weight: 700;
            color: var(--text-primary);
        }
        .login-card p {
            margin-bottom: 40px;
            color: var(--text-secondary);
        }
        .login-card .form-group {
            text-align: left;
            margin-bottom: 20px;
        }
        .login-card .form-group label {
             display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary);
        }
        .login-card .form-group input { 
            width: 100%; 
            padding: 15px; 
            font-size: 1em; 
            border-radius: 8px; 
            border: 1px solid #334155; 
            background-color: #1e293b; 
            color: var(--text-primary); 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-card .form-group input:focus {
            border-color: var(--accent-purple);
            outline: none;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.3);
        }

        .login-card .btn-primary {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-purple);
            color: white;
            transition: background-color 0.2s;
        }
        .login-card .btn-primary:hover {
            background-color: var(--accent-purple-darker);
        }

        #app-container { 
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        main {
            flex-grow: 1; 
            overflow-y: auto; 
        }
        .container { padding: 20px; }
        
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; transition: background-color 0.3s, border-color 0.3s; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { height: 40px; width: 40px; object-fit: cover; }
        .logo-text { font-size: 1.2em; font-weight: 700; color: var(--text-primary); }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .header-btn:hover { background-color: var(--bg); }
        .lang-dropdown { display: none; position: absolute; top: 40px; right: 0; background-color: var(--surface); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid var(--border-color); overflow: hidden; z-index: 110; }
        .lang-dropdown button { display: block; width: 100%; text-align: left; padding: 10px 15px; background: none; border: none; color: var(--text-primary); cursor: pointer; }
        .lang-dropdown button:hover { background-color: var(--bg); }
        .profile { display: flex; align-items: center; gap: 10px; text-align: right; }
        .profile-info { display: flex; flex-direction: column; }
        .profile-name { font-weight: 600; font-size: 0.9em; }
        .profile-role { font-size: 0.8em; color: var(--text-secondary); }
        .profile img { height: 40px; width: 40px; border-radius: 50%; border: 2px solid var(--accent-purple); object-fit: cover; }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
        .kpi-card { background-color: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        body.dark-mode .kpi-card { box-shadow: none; }
        .kpi-title { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--text-secondary); margin: 0 0 10px; }
        .kpi-value {
            font-size: 1.6em; 
            font-weight: 700;
            margin: 0;
            overflow-wrap: break-word; 
            word-break: break-all;
        }
        .kpi-value.green { color: var(--accent-green); }

        .progress-card { text-align: center; }
        .progress-circle { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        .progress-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-circle circle { fill: none; stroke-width: 10; }
        .progress-circle .bg-circle { stroke: var(--border-color); }
        .progress-circle .progress-bar { stroke: var(--accent-green); stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; font-weight: 700; }

        .kpi-grid-profile {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; border-bottom: 2px solid var(--accent-purple); padding-bottom: 10px; }
        .client-list, .expense-list, .notification-list { display: flex; flex-direction: column; gap: 15px; }
        .client-card, .expense-card, .notification-card { background-color: var(--surface); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border-color); transition: background-color 0.2s, box-shadow 0.2s, border-color 0.3s, transform 0.2s; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); cursor: pointer; }
        .client-card:hover, .expense-card:hover, .notification-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.07); }
        body.dark-mode .client-card, body.dark-mode .expense-card, body.dark-mode .notification-card { box-shadow: none; }
        .client-card:active, .expense-card:active, .notification-card:active { background-color: var(--bg); transform: translateY(0); }
        .client-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        .client-info, .expense-info, .notification-info { flex-grow: 1; }
        .client-name, .expense-category, .notification-title { font-weight: 600; margin: 0 0 5px; }
        .client-address, .expense-obs, .notification-subtitle { font-size: 0.9em; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .payment-info, .expense-value-info { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .payment-amount, .expense-amount { font-size: 1.2em; font-weight: 700; color: var(--accent-green); }
        .expense-amount { color: var(--danger-color); }
        .payment-status, .expense-date { font-size: 0.8em; padding: 3px 8px; border-radius: 10px; font-weight: 500; margin-top: 5px; }
        .status-pending { background-color: #fff3cd; color: #856404; } .status-paid { background-color: #d4edda; color: #155724; } .status-late { background-color: #f8d7da; color: #721c24; }
        .status-finished { background-color: #e0e7ff; color: #4338ca; }
        body.dark-mode .status-pending { background-color: #b98c3633; color: #f6e05e; } body.dark-mode .status-paid { background-color: #38a16933; color: #68d391; } body.dark-mode .status-late { background-color: #c5303033; color: #fc8181; }
        body.dark-mode .status-finished { background-color: #4f46e533; color: #a5b4fc; }
        
        .reputation-score { display: flex; align-items: center; gap: 4px; font-size: 0.8em; font-weight: 700; padding: 3px 8px; border-radius: 10px; margin-top: 5px; }
        .rep-perfect { background-color: rgba(40, 167, 69, 0.15); color: var(--accent-green); }
        .rep-good { background-color: rgba(251, 146, 60, 0.15); color: #b45309; }
        body.dark-mode .rep-good { color: var(--accent-orange); }
        .rep-regular { background-color: rgba(250, 204, 21, 0.15); color: #856404; }
        body.dark-mode .rep-regular { color: var(--accent-yellow); }
        .rep-bad { background-color: rgba(220, 53, 69, 0.15); color: var(--danger-color); }
        .client-card .payment-info { flex-shrink: 0; }
        .reputation-bar-container { width: 100%; background-color: var(--border-color); border-radius: 8px; height: 16px; overflow: hidden; margin-bottom: 10px; }
        .reputation-bar { height: 100%; border-radius: 8px; width: 0%; transition: width 1s ease-out, background-color 0.5s; }
        .reputation-bar.status-perfect { background-color: var(--accent-green); }
        .reputation-bar.status-good { background-color: var(--accent-orange); }
        .reputation-bar.status-regular { background-color: var(--accent-yellow); }
        .reputation-bar.status-bad { background-color: var(--danger-color); }
        .reputation-status { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .reputation-value { font-weight: 700; }
        .reputation-text { font-weight: 500; padding: 2px 8px; border-radius: 10px; }
        .reputation-text.status-perfect { color: var(--accent-green); background-color: rgba(40, 167, 69, 0.1); }
        .reputation-text.status-good { color: #b45309; background-color: rgba(251, 146, 60, 0.15); }
        body.dark-mode .reputation-text.status-good { color: var(--accent-orange); background-color: rgba(253, 186, 116, 0.1); }
        .reputation-text.status-regular { color: #856404; background-color: rgba(250, 204, 21, 0.15); }
        body.dark-mode .reputation-text.status-regular { color: var(--accent-yellow); background-color: rgba(253, 224, 71, 0.1); }
        .reputation-text.status-bad { color: var(--danger-color); background-color: rgba(220, 53, 69, 0.1); }

        .bottom-nav { position: static; flex-shrink: 0; background-color: var(--surface); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05); transition: background-color 0.3s, border-color 0.3s; z-index: 150; }
        body.dark-mode .bottom-nav { box-shadow: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-secondary); text-decoration: none; font-size: 0.8em; padding: 5px 15px; cursor: pointer; position: relative; }
        .nav-item.active { color: var(--accent-purple); }
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--surface);
            transform: scale(0);
            transition: transform 0.2s;
        }
        .notification-badge.visible { transform: scale(1); }
        .notification-card img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .notification-card { cursor: pointer; } 
        #verification-receipt-img {
            width: 100%;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--bg);
        }
        
        .modal-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); z-index: 200; transform: translateX(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .modal-view.active { transform: translateX(0); }
        .modal-header { display: flex; align-items: center; padding: 15px 20px; background-color: var(--surface); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 210; flex-shrink: 0; }
        .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 0; margin-right: 15px; }
        .modal-title { font-size: 1.2em; font-weight: 600; }
        .modal-content-wrapper { flex-grow: 1; overflow-y: auto; }
        .loan-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .payment-history-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        .payment-history-details { flex-basis: 100%; }
        .payment-history-title { font-weight: 600; font-size: 1em; margin: 0 0 4px; }
        .payment-history-description { font-size: 0.9em; color: var(--text-secondary); margin: 0; }
        .payment-history-info { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .payment-date { color: var(--text-secondary); font-size: 0.9em; }
        .payment-history-amount { font-weight: 600; color: var(--accent-green); }
        .no-history, .no-items { color: var(--text-secondary); text-align: center; padding: 20px; }
        
        .loan-tabs-container {
            display: flex;
            gap: 5px;
            padding: 10px 20px;
            background-color: var(--bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        .loan-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background-color: var(--surface);
            color: var(--text-secondary);
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .loan-tab.active {
            background-color: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
        }

        .action-buttons {
    background-color: var(--surface);
    border-top: 1px solid var(--border-color);
    padding: 15px 20px;
    padding-bottom: calc(15px + env(safe-area-inset-bottom));
    display: flex;
    gap: 10px;
    margin-top: auto;
    position: sticky;
    bottom: 0;
    flex-shrink: 0;
    flex-wrap: wrap;
}
.action-buttons button, .action-buttons a {
    flex-grow: 1;
    flex-basis: 160px;
    padding: 15px;
    font-size: 1em;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
    text-decoration: none;
}

        .btn-primary { background-color: var(--accent-purple); color: white; }
        .btn-secondary { background-color: transparent; color: var(--accent-purple); border: 2px solid var(--accent-purple); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .action-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .action-buttons button:active { transform: translateY(0); }
        .btn-primary:hover { background-color: var(--accent-purple-darker); }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group input[readonly] { background-color: var(--bg); opacity: 0.7; }
        .radio-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .radio-group label, .day-selector label { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; background-color: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; cursor: pointer; text-align: center; }
        .radio-group input, .day-selector input { display: none; }
        .radio-group input:checked + label, .day-selector input:checked + label { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        .radio-group input:checked + label .icon { color: white !important; }
        .day-selector { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 20px; }
        .day-selector label { padding: 10px; flex-grow: 1; font-weight: 600; font-size: 0.9em; }
        .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        
        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--accent-purple); color: white; border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 160; transition: transform 0.2s, opacity 0.3s; }
        .fab:hover { transform: scale(1.1); }
        .fab.hidden { transform: scale(0.5); opacity: 0; pointer-events: none; }
        
        #doc-preview-container .preview-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg); padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; }
        .document-list-item a { color: var(--accent-purple); text-decoration: none; font-weight: 500; }
        .view { display: none; }
        .view.active { display: block; }
        .search-bar-wrapper { position: relative; margin-bottom: 20px; }
        .search-bar-wrapper input { width: 100%; padding: 12px 12px 12px 40px; font-size: 1em; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary); }
        .search-bar-wrapper .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .filter-buttons::-webkit-scrollbar { display: none; } /* Oculta scrollbar en webkit */
        .filter-buttons.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); } /* For expense categories */
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-secondary); border-radius: 20px; font-weight: 500; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        
        #map-view.view.active {
            display: flex; 
            height: 100%;
        }
        #map-container {
            flex-grow: 1; 
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-size: 1em; }
        .popup-client-name { font-weight: 600; margin-bottom: 5px; }
        .popup-client-amount { color: var(--accent-green); font-weight: 700; margin-bottom: 10px; }
        .popup-navigate-btn { width: 100%; padding: 10px; font-size: 0.9em; }
        
        .settings-item { display: flex; align-items: center; gap: 15px; background-color: var(--surface); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 500; text-decoration: none; color: var(--text-primary); }
        .settings-item:active { background-color: var(--bg); }
        .settings-item i { color: var(--text-secondary); }
        .settings-item.logout { color: var(--danger-color); }
        .settings-item.logout i { color: var(--danger-color); }
        .profile-pic-wrapper { position: relative; cursor: pointer; }
        .profile-pic-wrapper::after { content: '‚úé'; position: absolute; bottom: 5px; right: 5px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .profile-pic-wrapper img.loading { opacity: 0.5; }
        #profile-view-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent-purple); object-fit: cover; }
        #cropper-container { height: calc(100% - 150px); }
        #cropper-container img { max-width: 100%; height: auto; }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-error { background-color: var(--danger-color); }
        .toast.toast-success { background-color: var(--accent-green); }

        #confirmationModal.modal-view {
            background-color: rgba(10, 14, 26, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            padding: 20px;
            transform: none; /* Override the slide-in */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        #confirmationModal.modal-view.active {
            transform: none;
            opacity: 1;
            pointer-events: auto;
        }
        .confirmation-dialog {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 25px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }
        #confirmationModal.active .confirmation-dialog {
            transform: scale(1);
        }
        .confirmation-dialog h3 { margin: 0 0 10px; font-size: 1.3em; }
        .confirmation-dialog p { margin: 0 0 25px; color: var(--text-secondary); line-height: 1.5; }
        .confirmation-buttons { display: flex; gap: 10px; }
        .confirmation-buttons button { flex-grow: 1; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .form-group .grid-2 {
                grid-template-columns: 1fr; /* Apila los campos del formulario */
            }
            .profile-info {
                display: none; /* Oculta nombre y rol en cabecera muy peque√±a */
            }
            .day-selector label {
                padding: 8px;
                font-size: 0.8em;
            }
            .login-card {
                padding: 20px;
            }
        }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .switch label { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 34px; }
        .switch label:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .switch input:checked + label { background-color: var(--accent-purple); }
        .switch input:checked + label:before { transform: translateX(20px); }

        .leaflet-marker-icon.next-client-marker {
            background: none;
            border: none;
        }
        .next-client-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: var(--accent-purple);
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            animation: pulse-purple 2s infinite;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .next-client-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        @keyframes pulse-purple {
            0% {
                transform: rotate(-45deg) scale(0.95);
                box-shadow: 0 0 0 0 rgba(111, 66, 193, 0.7);
            }
            70% {
                transform: rotate(-45deg) scale(1);
                box-shadow: 0 0 0 10px rgba(111, 66, 193, 0);
            }
            100% {
                transform: rotate(-45deg) scale(0.95);
                box-shadow: 0 0 0 0 rgba(111, 66, 193, 0);
            }
        }
        .collector-marker-icon {
            background: none;
            border: none;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    
    <div id="install-banner" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 380px; background-color: var(--surface); color: var(--text-primary); padding: 25px; border-radius: 16px; z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid var(--border-color); text-align: center;">

    <button id="close-install-banner" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; line-height: 1; padding: 0;">&times;</button>

    <img src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759873183/LOGO_LUMIX_REDUCI_czkw4p.png" alt="App Icon" style="width: 64px; height: 64px; margin-bottom: 15px;">

    <h3 style="margin: 0 0 8px; font-size: 1.2em; font-weight: 600;" data-lang-key="installAppTitle">Instale nosso aplicativo</h3>

    <p style="margin: 0 0 25px; font-size: 0.9em; color: var(--text-secondary); line-height: 1.5;" data-lang-key="installAppMsg">Uma experi√™ncia mais r√°pida e completa.</p>

    <button id="install-btn" style="background-color: var(--accent-purple); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1em;" data-lang-key="installBtn">Instalar</button>

</div>

    <div id="splash-screen">
        <img id="splash-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo">
    </div>

    <div id="login-view">
        <div class="login-card">
            <div class="logo">
                <img id="login-logo" src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo">
            </div>
            <h2>Bem-vindo, Cobrador!</h2>
            <p>Fa√ßa login para acessar seu painel.</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usu√°rio</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <!-- El contenido principal se genera con JS -->
    </div>

    <div id="clientDetailView" class="modal-view"></div>
    <div id="paymentModal" class="modal-view"></div>
    <div id="clientFormModal" class="modal-view"></div>
    <div id="expenseFormModal" class="modal-view"></div>
    <div id="cropperModal" class="modal-view"></div>
    <div id="shareCredentialsModal" class="modal-view"></div>
    <div id="locationPermissionModal" class="modal-view" style="--bg: rgba(10, 14, 26, 0.8); backdrop-filter: blur(5px); z-index: 9999;"></div>
    <div id="paymentSettingsModal" class="modal-view"></div>
    <div id="refinanceModal" class="modal-view"></div>
    <div id="paymentDetailModal" class="modal-view"></div>
    <div id="confirmationModal" class="modal-view"></div>
    <div id="mapPinModal" class="modal-view"></div>
    <div id="toast-container"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, arrayUnion, addDoc, setDoc, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
            authDomain: "lumix-financas-app.firebaseapp.com",
            projectId: "lumix-financas-app",
            storageBucket: "lumix-financas-app.appspot.com",
            messagingSenderId: "463777495321",
            // [CORRECCI√ìN CR√çTICA] Se ha corregido el appId para que coincida con el del Service Worker y el de la app del cliente.
            appId: "1:463777495321:web:106118f53f56abd206ed88"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function setupFCM(collectorId, swRegistration) {
            const LOG_PREFIX = `[COBRADOR-FCM-DIAGNOSTICO]`;
            console.log(`${LOG_PREFIX} --- Iniciando setupFCM para el cobrador: ${collectorId} ---`);
            try {
                if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                    console.error(`${LOG_PREFIX} ERROR: Notificaciones Push no son soportadas en este navegador.`);
                    return;
                }
                console.log(`${LOG_PREFIX} El navegador soporta notificaciones.`);
        
                const messaging = getMessaging(app);
                console.log(`${LOG_PREFIX} Objeto de Messaging obtenido.`);
        
                console.log(`${LOG_PREFIX} Solicitando permiso del usuario...`);
                const permission = await Notification.requestPermission();
                console.log(`${LOG_PREFIX} El permiso del usuario es: ${permission}`);
                if (permission !== 'granted') {
                    console.warn(`${LOG_PREFIX} El usuario DENEG√ì el permiso para notificaciones.`);
                    showToast('Permiso para notificaciones denegado.', true);
                    return;
                }
                console.log(`${LOG_PREFIX} Permiso CONCEDIDO.`);
        
                const VAPID_KEY = "BAgKWBzKi_Z4eyNNgGtprgPRQhPzU2MqU1vyrHf0iQSMxy1UMkin4E3GJ7KQLtChcDJHtEx8mMYau4jtzQvtjfw";
                if (!VAPID_KEY) {
                    console.error(`${LOG_PREFIX} ERROR FATAL: La VAPID key no est√° configurada.`);
                    showToast('Configuraci√≥n de notificaciones incompleta (sin VAPID key).', true);
                    return;
                }
                console.log(`${LOG_PREFIX} VAPID Key encontrada y es v√°lida.`);
        
                console.log(`${LOG_PREFIX} Obteniendo token de FCM... (Este paso puede tardar)`);
                const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: swRegistration });
        
                if (currentToken) {
                    console.log(`${LOG_PREFIX} ¬°TOKEN OBTENIDO CON √âXITO!: ${currentToken.substring(0, 30)}...`);
                    const collectorRef = doc(db, 'collectors', collectorId);
                    console.log(`${LOG_PREFIX} Intentando guardar el token en Firestore...`);
                    await updateDoc(collectorRef, { fcmTokens: arrayUnion(currentToken) });
                    console.log(`${LOG_PREFIX} ¬°√âXITO! Token guardado/confirmado en Firestore.`);
                } else {
                    console.error(`${LOG_PREFIX} ERROR FATAL: No se pudo obtener el token. Causas comunes: 1) El archivo 'firebase-messaging-sw.js' no se encuentra en la ra√≠z del sitio. 2) La VAPID key es incorrecta. 3) Problema de registro del Service Worker.`);
                    showToast('Falha ao obter token de notifica√ß√£o.', true);
                }
        
                onMessage(messaging, (payload) => {
            const LOG_PREFIX = `[COBRADOR-FCM-DIAGNOSTICO]`;
            console.log(`${LOG_PREFIX} Notificaci√≥n recibida en PRIMER PLANO:`, payload);
        
            // [CORRECCI√ìN] Leemos desde payload.data para consistencia
            if (payload.data && payload.data.title && payload.data.body) {
                showToast(`${payload.data.title}: ${payload.data.body}`);
                updateNotifications(); // Esta funci√≥n ya existe y es correcta aqu√≠
            } else {
                console.warn(`${LOG_PREFIX} El payload en primer plano no tiene el formato esperado.`, payload);
                showToast('Voc√™ recebeu uma nova notifica√ß√£o.');
                updateNotifications();
            }
        });
        
            } catch (err) {
                console.error(`${LOG_PREFIX} ERROR CATASTR√ìFICO en setupFCM:`, err);
                if (err.code === 'messaging/permission-blocked') {
                    showToast('As notifica√ß√µes est√£o bloqueadas. Ative-as nas configura√ß√µes do seu navegador.', true);
                } else if (err.code === 'messaging/sw-registration-failed') {
                    showToast('Falha ao registrar o servi√ßo de notifica√ß√£o.', true);
                } else {
                    showToast('Falha ao configurar as notifica√ß√µes push.', true);
                }
            }
        }
        
        const CLOUDINARY_CLOUD_NAME = "dc6as14p0";
        const CLOUDINARY_UPLOAD_PRESET = "lumix-financas-uploads";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        const DEFAULT_LOGO_URL = "https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png";
        const LOGO_BASE64_JPG = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAOEAcIDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigA"

        let allClients = [];
        let allExpenses = [];
        let allSettlements = [];
        let currentLang = localStorage.getItem('language') || 'pt';
        let mapInstance = null;
        let mapMarkers = [];
        let collectorMarker = null; // Marker para la moto del cobrador
        let deferredPrompt; // Para la instalaci√≥n de PWA
        const collectorId = 'joao_silva'; 
        let collectorCurrentLocation = null; // Guardar√° tu ubicaci√≥n en tiempo real
        let locationWatchId = null; // ID para controlar el rastreador de GPS
        let lastLocationUpdateTime = 0; // Controla la frecuencia de actualizaci√≥n en Firestore
        
        const nationalHolidays = [ '01/01', '21/04', '01/05', '07/09', '12/10', '02/11', '15/11', '25/12' ];
        const translations = {
            pt: { postponePayment: 'Adiar Pagamento', postponeConfirmTitle: 'Confirmar Adiamento', postponeConfirmMsg: 'Isso mover√° a data de vencimento do cliente em um dia √∫til, sem gerar atraso. Deseja continuar?', confirm: 'Confirmar', paymentApproved: 'Pagamento aprovado com sucesso!', paymentRejected: 'Pagamento rejeitado.', approve: 'Aprovar', reject: 'Rejeitar', paymentReceipt: 'Comprovante de Pagamento', sentAmount: 'Valor Enviado', paymentVerification: 'Verifica√ß√£o de Pagamento', reputation: 'Reputa√ß√£o', reputationScore: 'Pontua√ß√£o de Reputa√ß√£o', reputationPerfect: 'Excelente', reputationGood: 'Bom', reputationRegular: 'Regular', reputationBad: 'Ruim', reputationInfo: 'Mantenha seus pagamentos em dia para uma boa reputa√ß√£o.', collector: 'Cobrador', dailyGoal: 'Meta Di√°ria', receivedToday: 'Recebido Hoje', clientsRemaining: 'Clientes Restantes', todaysRoute: 'Rota de Hoje', navHome: 'In√≠cio', navClients: 'Clientes', navMap: 'Mapa', navProfile: 'Perfil', pending: 'Pendente', paid: 'Pago', late: 'Atrasado', addNewClient: 'Adicionar Novo Cliente', clientName: 'Nome do Cliente', address: 'Endere√ßo', totalLoan: 'Valor do Empr√©stimo', installmentValue: 'Valor da Parcela', numInstallments: 'N√∫mero de Parcelas', paymentDays: 'Dias de Pagamento', saveClient: 'Salvar Cliente', city: 'Cidade', location: 'Localiza√ß√£o GPS', interest: 'Juros (%)', totalToPay: 'Valor Total a Pagar', clientDocs: 'Documentos do Cliente (Opcional)', takePhoto: 'Tirar Foto', uploadFile: 'Carregar Arquivo', attachedDocs: 'Documentos Anexados', editClient: 'Editar Cliente', saveChanges: 'Salvar Altera√ß√µes', startRoute: 'IR', searchClient: 'Buscar cliente...', all: 'Todos', navigate: 'Navegar', capitalTotal: 'Capital em M√£os', dailyTotal: 'Total do Dia', weeklyTotal: 'Total da Semana', monthlyTotal: 'Total do M√™s', accountSettings: 'Configura√ß√µes da Conta', changePassword: 'Mudar Senha', exportReport: 'Exportar Relat√≥rio Di√°rio', logout: 'Sair da Conta', reportTitle: 'Relat√≥rio Di√°rio de Cobran√ßa', reportDate: 'Data', reportCollector: 'Cobrador', reportTotalCollected: 'Total Arrecadado', reportNumPayments: 'N¬∫ de Pagamentos', reportClient: 'Cliente', reportAmount: 'Valor', reportTime: 'Hora', noPaymentsToday: 'Nenhum pagamento registrado hoje.', cropImage: 'Recortar Imagem', confirmCrop: 'Confirmar Recorte', cancel: 'Cancelar', navExpenses: 'Gastos', myExpenses: 'Meus Gastos', addExpense: 'Adicionar Gasto', expenseType: 'Tipo de Gasto', expenseValue: 'Valor do Gasto', observations: 'Observa√ß√µes (Opcional)', uploadReceipt: 'Anexar Recibo (Opcional)', saveExpense: 'Salvar Gasto', fuel: 'Combust√≠vel', food: 'Alimenta√ß√£o', rent: 'Aluguel', mechanics: 'Mec√¢nica', other: 'Outros', filterPeriod: 'Filtrar por Per√≠odo', filterCategory: 'Filtrar por Categoria', today: 'Hoje', thisWeek: 'Esta Semana', thisMonth: 'Este Mes', fromBeginning: 'Desde o In√≠cio', reportTotalExpenses: 'Total de Gastos', reportNetBalance: 'Saldo L√≠quido', clientAccess: 'Acesso do Cliente', username: 'Nome de Usu√°rio', password: 'Senha', usernameTaken: 'Este nome de usu√°rio j√° existe.', usernameAvailable: 'Nome de usu√°rio dispon√≠vel.', usernameRequired: 'O nome de usu√°rio √© obrigat√≥rio.', whatsapp: 'WhatsApp', shareOnWhatsApp: 'Compartilhar no WhatsApp', clientRegisteredSuccess: 'Cliente Registrado com Sucesso!', clientUpdatedSuccess: 'Cliente Atualizado com Sucesso!', accessData: 'Dados de Acesso', appInstructions: 'Use estes dados para acessar o app do cliente:', appLink: 'Link do App', whatsappMessageTemplate: `Ol√° {clientName}! üëã Seu acesso ao nosso app foi criado com sucesso.\n\n*LINK DO APP*\n{appLink}\n\n*USU√ÅRIO*\n{username}\n\n*SENHA*\n{password}`, navNotifications: 'Notifica√ß√µes', paymentSent: 'enviou um pagamento de', pleaseVerify: 'Por favor, verifique.', noNotifications: 'Nenhuma notifica√ß√£o pendente.', refinanceRequested: 'solicitou um refinanciamento de', reviewRequest: 'Revisar solicita√ß√£o.', installAppMsg: 'Instale o app para uma melhor experi√™ncia!', installBtn: 'Instalar', receivedInCash: 'Recebido em Dinheiro', receivedInDigital: 'Recebido em PIX/Cart√£o', finished: 'Finalizado', createNewLoan: 'Criar Novo Empr√©stimo', updateClientData: 'Atualizar Dados', paymentFrequency: 'Forma de Pagamento', daily: 'Di√°rio', weekly: 'Semanal', monthly: 'Mensal', dayOfWeek: 'Dia da Semana', dayOfMonth: 'Dia do M√™s', sunday: 'Domingo', monday: 'Segunda-feira', tuesday: 'Ter√ßa-feira', wednesday: 'Quarta-feira', thursday: 'Quinta-feira', friday: 'Sexta-feira', saturday: 'S√°bado', collectionTimeLabel: 'Hor√°rio de Cobran√ßa Preferencial', documentNumber: 'N√∫mero do Documento', systemHistory: 'Hist√≥rico no Sistema', verifySystem: 'Verificar no Sistema', searchingSystem: 'Buscando no sistema...', clientClean: 'Cliente Limpo', clientCleanMsg: 'Nenhum outro empr√©stimo ativo encontrado para este documento no sistema.', loansFound: 'Empr√©stimos Encontrados', loansFoundMsg: 'Os seguintes empr√©stimos ativos foram encontrados para este documento:', otherLoanCollector: 'Cobrador', otherLoanStatus: 'Status', loanDetails: 'Detalhes do Empr√©stimo', amountPaid: 'Valor Pago', paymentApprovedClientTitle: 'Pagamento Aprovado', paymentApprovedClientBody: 'Seu pagamento de {amount} foi aprovado!', paymentRejectedClientTitle: 'Pagamento Rejeitado', paymentRejectedClientBody: 'Seu comprovante foi rejeitado. Entre em contato com seu cobrador.', refinanceApprovedClientTitle: 'Refinanciamento Aprovado', refinanceApprovedClientBody: 'Sua solicita√ß√£o de refinanciamento foi aprovada com sucesso.', refinanceRejectedClientTitle: 'Refinanciamento Rejeitado', refinanceRejectedClientBody: 'Sua solicita√ß√£o de refinanciamento foi rejeitada.', realtimeTracking: 'Rastreamento em Tempo Real', paymentTitle: 'Pagamento Parcela #{start}', paymentTitleRange: 'Pagamento Parcelas #{start} - #{end}', paymentDescFull: 'Parcela #{start} paga integralmente.', paymentDescPartial: 'Pagamento parcial ({percent}%) da parcela.', paymentDescMultiple: 'Cobre {fullInstallments} parcela(s) e {percent}% da pr√≥xima.', paymentDescOverpay: 'Cobre a parcela #{start} e adianta {overpayAmount} para a pr√≥xima.', collectorOnTheWayTitle: 'Cobrador a caminho!', collectorOnTheWayBody: 'Nosso cobrador est√° a caminho e chegar√° em alguns minutos.', paymentSettings: 'Configura√ß√µes de Pagamento', currency: 'Moeda de Opera√ß√£o', paymentMethods: 'M√©todos de Pagamento', save: 'Salvar' },
            // [CORRECCI√ìN] Se elimin√≥ la coma sobrante que causaba el SyntaxError.
            es: { postponePayment: 'Aplazar Pago', postponeConfirmTitle: 'Confirmar Aplazamiento', postponeConfirmMsg: 'Esto mover√° la fecha de vencimiento del cliente un d√≠a h√°bil, sin generar atraso. ¬øDesea continuar?', confirm: 'Confirmar', paymentApproved: '¬°Pago aprobado con √©xito!', paymentRejected: 'Pago rechazado.', approve: 'Aprobar', reject: 'Rechazar', paymentReceipt: 'Comprobante de Pago', sentAmount: 'Monto Enviado', paymentVerification: 'Verificaci√≥n de Pago', reputation: 'Reputaci√≥n', reputationScore: 'Puntuaci√≥n de Reputaci√≥n', reputationPerfect: 'Excelente', reputationGood: 'Bueno', reputationRegular: 'Regular', reputationBad: 'Mala', reputationInfo: 'Mant√©n tus pagos al d√≠a para tener una buena reputaci√≥n.', collector: 'Cobrador', dailyGoal: 'Meta Diaria', receivedToday: 'Recibido Hoy', clientsRemaining: 'Clientes Restantes', todaysRoute: 'Ruta de Hoy', navHome: 'Inicio', navClients: 'Clientes', navMap: 'Mapa', navProfile: 'Perfil', pending: 'Pendiente', paid: 'Pagado', late: 'Atrasado', addNewClient: 'A√±adir Nuevo Cliente', clientName: 'Nombre del Cliente', address: 'Direcci√≥n', totalLoan: 'Valor del Pr√©stamo', installmentValue: 'Valor de la Cuota', numInstallments: 'N√∫mero de Cuotas', paymentDays: 'D√≠as de Pago', saveClient: 'Guardar Cliente', city: 'Ciudad', location: 'Ubicaci√≥n GPS', interest: 'Inter√©s (%)', totalToPay: 'Valor Total a Pagar', clientDocs: 'Documentos del Cliente (Opcional)', takePhoto: 'Tomar Foto', uploadFile: 'Cargar Archivo', attachedDocs: 'Documentos Adjuntos', editClient: 'Editar Cliente', saveChanges: 'Guardar Cambios', startRoute: 'IR', searchClient: 'Buscar cliente...', all: 'Todos', navigate: 'Navegar', capitalTotal: 'Capital en Mano', dailyTotal: 'Total del D√≠a', weeklyTotal: 'Total Semanal', monthlyTotal: 'Total Mensual', accountSettings: 'Ajustes de la Cuenta', changePassword: 'Cambiar Contrase√±a', exportReport: 'Exportar Reporte Diario', logout: 'Cerrar Sesi√≥n', reportTitle: 'Reporte Diario de Cobranza', reportDate: 'Fecha', reportCollector: 'Cobrador', reportTotalCollected: 'Total Recaudado', reportNumPayments: 'N¬∫ de Pagos', reportClient: 'Cliente', reportAmount: 'Valor', reportTime: 'Hora', noPaymentsToday: 'No hay pagos registrados hoy.', cropImage: 'Recortar Imagen', confirmCrop: 'Confirmar Recorte', cancel: 'Cancelar', navExpenses: 'Gastos', myExpenses: 'Mis Gastos', addExpense: 'A√±adir Gasto', expenseType: 'Tipo de Gasto', expenseValue: 'Valor del Gasto', observations: 'Observaciones (Opcional)', uploadReceipt: 'Adjuntar Recibo (Opcional)', saveExpense: 'Guardar Gasto', fuel: 'Combustible', food: 'Alimentaci√≥n', rent: 'Alquiler', mechanics: 'Mec√°nica', other: 'Otros', filterPeriod: 'Filtrar por Per√≠odo', filterCategory: 'Filtrar por Categor√≠a', today: 'Hoy', thisWeek: 'Esta Semana', thisMonth: 'Este Mes', fromBeginning: 'Desde el Inicio', reportTotalExpenses: 'Total de Gastos', reportNetBalance: 'Saldo Neto', clientAccess: 'Acceso del Cliente', username: 'Nombre de Usuario', password: 'Contrase√±a', usernameTaken: 'Este usuario ya existe.', usernameAvailable: 'Usuario disponible.', usernameRequired: 'El nombre de usuario es obligatorio.', whatsapp: 'WhatsApp', shareOnWhatsApp: 'Compartir por WhatsApp', clientRegisteredSuccess: '¬°Cliente Registrado con √âxito!', clientUpdatedSuccess: '¬°Cliente Actualizado con √âxito!', accessData: 'Datos de Acceso', appInstructions: 'Usa estos datos para acceder a la app del cliente:', appLink: 'Link de la App', whatsappMessageTemplate: `¬°Hola {clientName}! üëã Tu acceso a nuestra app ha sido creado con √©xito.\n\n*LINK DE LA APP*\n{appLink}\n\n*USU√ÅRIO*\n{username}\n\n*CONTRASE√ëA*\n{password}`, navNotifications: 'Notifica√ß√µes', paymentSent: 'envi√≥ un pago de', pleaseVerify: 'Por favor, verifique.', noNotifications: 'Ninguna notificaci√≥n pendiente.', refinanceRequested: 'solicit√≥ un refinanciamiento de', reviewRequest: 'Revisar solicitud.', installAppMsg: '¬°Instala la app para una mejor experiencia!', installBtn: 'Instalar', receivedInCash: 'Recibido en Efectivo', receivedInDigital: 'Recibido en PIX/Tarjeta', finished: 'Finalizado', createNewLoan: 'Crear Nuevo Pr√©stamo', updateClientData: 'Actualizar Datos', paymentFrequency: 'Forma de Pago', daily: 'Diario', weekly: 'Semanal', monthly: 'Mensual', dayOfWeek: 'D√≠a de la Semana', dayOfMonth: 'D√≠a del Mes', sunday: 'Domingo', monday: 'Lunes', tuesday: 'Martes', wednesday: 'Mi√©rcoles', thursday: 'Jueves', friday: 'Viernes', saturday: 'S√°bado', collectionTimeLabel: 'Hora de Cobro Preferida', documentNumber: 'N√∫mero de Documento', systemHistory: 'Historial en el Sistema', verifySystem: 'Verificar en el Sistema', searchingSystem: 'Buscando en el sistema...', clientClean: 'Cliente Limpio', clientCleanMsg: 'No se encontraron otros pr√©stamos activos para este documento en el sistema.', loansFound: 'Pr√©stamos Encontrados', loansFoundMsg: 'Se encontraron los siguientes pr√©stamos activos para este documento:', otherLoanCollector: 'Cobrador', otherLoanStatus: 'Estado', loanDetails: 'Detalles del Pr√©stamo', amountPaid: 'Monto Pagado', paymentApprovedClientTitle: 'Pago Aprobado', paymentApprovedClientBody: '¬°Tu pago de {amount} ha sido aprobado!', paymentRejectedClientTitle: 'Pago Rechazado', paymentRejectedClientBody: 'Tu comprobante fue rechazado. Por favor, contacta a tu cobrador.', refinanceApprovedClientTitle: 'Refinanciaci√≥n Aprobada', refinanceApprovedClientBody: 'Tu solicitud de refinanciaci√≥n ha sido aprobada con √©xito.', refinanceRejectedClientTitle: 'Refinanciaci√≥n Rechazada', refinanceRejectedClientBody: 'Tu solicitud de refinanciaci√≥n ha sido rechazada.', realtimeTracking: 'Seguimiento en Tiempo Real', paymentTitle: 'Pago Cuota #{start}', paymentTitleRange: 'Pago Cuotas #{start} - #{end}', paymentDescFull: 'Cuota #{start} pagada en su totalidad.', paymentDescPartial: 'Pago parcial ({percent}%) de la cuota.', paymentDescMultiple: 'Cubre {fullInstallments} cuota(s) y {percent}% de la pr√≥xima.', paymentDescOverpay: 'Cubre la cuota #{start} y adelanta {overpayAmount} para la pr√≥xima.', collectorOnTheWayTitle: '¬°Cobrador en camino!', collectorOnTheWayBody: 'Nuestro cobrador est√° en camino y llegar√° en unos minutos.', paymentSettings: 'Configuraci√≥n de Pagos', currency: 'Moneda de Operaci√≥n', paymentMethods: 'M√©todos de Pago', save: 'Guardar' },
            en: { postponePayment: 'Postpone Payment', postponeConfirmTitle: 'Confirm Postponement', postponeConfirmMsg: 'This will move the client\'s due date by one business day without generating a late status. Do you wish to continue?', confirm: 'Confirm', paymentApproved: 'Payment approved successfully!', paymentRejected: 'Payment rejected.', approve: 'Approve', reject: 'Reject', paymentReceipt: 'Payment Receipt', sentAmount: 'Amount Sent', paymentVerification: 'Payment Verification', reputation: 'Reputation', reputationScore: 'Reputation Score', reputationPerfect: 'Excellent', reputationGood: 'Good', reputationRegular: 'Regular', reputationBad: 'Bad', reputationInfo: 'Keep your payments up to date for a good reputation.', collector: 'Collector', dailyGoal: 'Daily Goal', receivedToday: 'Received Today', remainingClients: 'Remaining Clients', todaysRoute: 'Today\'s Route', navHome: 'Home', navClients: 'Clients', navMap: 'Map', navProfile: 'Profile', pending: 'Pending', paid: 'Paid', late: 'Late', addNewClient: 'Add New Client', clientName: 'Client Name', address: 'Address', totalLoan: 'Loan Amount', installmentValue: 'Installment Value', numInstallments: 'Number of Installments', paymentDays: 'Payment Days', saveClient: 'Save Client', city: 'City', location: 'GPS Location', interest: 'Interest (%)', totalToPay: 'Total Amount to Pay', clientDocs: 'Client Documents (Optional)', takePhoto: 'Take Photo', uploadFile: 'Upload File', attachedDocs: 'Attached Documents', editClient: 'Edit Client', saveChanges: 'Save Changes', startRoute: 'GO', searchClient: 'Search client...', all: 'All', navigate: 'Navigate', capitalTotal: 'Capital on Hand', dailyTotal: 'Daily Total', weeklyTotal: 'Weekly Total', monthlyTotal: 'Monthly Total', accountSettings: 'Account Settings', changePassword: 'Change Password', exportReport: 'Export Daily Report', logout: 'Log Out', reportTitle: 'Daily Collection Report', reportDate: 'Date', reportCollector: 'Collector', reportTotalCollected: 'Total Collected', reportNumPayments: '# of Payments', reportClient: 'Client', reportAmount: 'Amount', reportTime: 'Time', noPaymentsToday: 'No payments registered today.', cropImage: 'Crop Image', confirmCrop: 'Confirm Crop', cancel: 'Cancel', navExpenses: 'Expenses', myExpenses: 'My Expenses', addExpense: 'Add Expense', expenseType: 'Expense Type', expenseValue: 'Expense Value', observations: 'Observations (Optional)', attachReceipt: 'Attach Receipt (Optional)', saveExpense: 'Save Expense', fuel: 'Fuel', food: 'Food', rent: 'Rent', mechanics: 'Mechanics', other: 'Other', filterPeriod: 'Filter by Period', filterCategory: 'Filter by Category', today: 'Today', thisWeek: 'This Week', thisMonth: 'This Month', fromBeginning: 'From the Beginning', reportTotalExpenses: 'Total Expenses', reportNetBalance: 'Net Balance', clientAccess: 'Client Access', username: 'Username', password: 'Password', usernameTaken: 'This username is already taken.', usernameAvailable: 'Username available.', usernameRequired: 'Username is required.', whatsapp: 'WhatsApp', shareOnWhatsApp: 'Share on WhatsApp', clientRegisteredSuccess: 'Client Registered Successfully!', clientUpdatedSuccess: 'Client Updated Successfully!', accessData: 'Access Data', appInstructions: 'Use this data to access the client app:', appLink: 'App Link', whatsappMessageTemplate: `Hello {clientName}! üëã Your access to our app has been created.\n\n*APP LINK*\n{appLink}\n\n*USERNAME*\n{username}\n\n*PASSWORD*\n{password}`, navNotifications: 'Notifications', paymentSent: 'sent a payment of', pleaseVerify: 'Please verify.', noNotifications: 'No pending notifications.', refinanceRequested: 'requested a refinancing of', reviewRequest: 'Review request.', installAppMsg: 'Install the app for a better experience!', installBtn: 'Install', receivedInCash: 'Received in Cash', receivedInDigital: 'Received in PIX/Card', finished: 'Finished', createNewLoan: 'Create New Loan', updateClientData: 'Update Details', paymentFrequency: 'Payment Frequency', daily: 'Daily', weekly: 'Weekly', monthly: 'Monthly', dayOfWeek: 'Day of the Week', dayOfMonth: 'Day of the Month', sunday: 'Sunday', monday: 'Monday', tuesday: 'Tuesday', wednesday: 'Wednesday', thursday: 'Thursday', friday: 'Friday', saturday: 'Saturday', collectionTimeLabel: 'Preferred Collection Time', documentNumber: 'Document Number', systemHistory: 'System History', verifySystem: 'Verify in System', searchingSystem: 'Searching the system...', clientClean: 'Clean Client', clientCleanMsg: 'No other active loans were found for this document in the system.', loansFound: 'Loans Found', loansFoundMsg: 'The following active loans were found for this document:', otherLoanCollector: 'Collector', otherLoanStatus: 'Status', loanDetails: 'Loan Details', amountPaid: 'Amount Paid', paymentApprovedClientTitle: 'Payment Approved', paymentApprovedClientBody: 'Your payment of {amount} has been approved!', paymentRejectedClientTitle: 'Payment Rejected', paymentRejectedClientBody: 'Your receipt was rejected. Please contact your collector.', refinanceApprovedClientTitle: 'Refinancing Approved', refinanceApprovedClientBody: 'Your refinancing request has been successfully approved.', refinanceRejectedClientTitle: 'Refinancing Rejected', refinanceRejectedClientBody: 'Your refinancing request has been rejected.', realtimeTracking: 'Real-time Tracking', paymentTitle: 'Installment Payment #{start}', paymentTitleRange: 'Installment Payments #{start} - #{end}', paymentDescFull: 'Installment #{start} paid in full.', paymentDescPartial: 'Partial payment ({percent}%) of the installment.', paymentDescMultiple: 'Covers {fullInstallments} installment(s) and {percent}% of the next one.', paymentDescOverpay: 'Covers installment #{start} and pays {overpayAmount} towards the next.', collectorOnTheWayTitle: 'Collector on the way!', collectorOnTheWayBody: 'Our collector is on the way and will arrive in a few minutes.', paymentSettings: 'Payment Settings', currency: 'Operating Currency', paymentMethods: 'Payment Methods', save: 'Save' }
        };

        const money = val => (typeof val !== 'number' || isNaN(val)) ? (currentLang === 'pt' ? 'R$ 0,00' : '$ 0.00') : val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        function showToast(message, isError = false) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3500);
        }

        function getAllTodaysClients() {
            const clientsForToday = [];
            const today = new Date();
            const dayOfWeek = today.getDay();
            const dayOfMonth = today.getDate();

            allClients.forEach(client => {
                (client.loans || []).forEach((loan, index) => {
                    if (loan.status === 'finished') return;

                    let isPaymentDay = false;
                    const frequency = loan.paymentFrequency || 'daily';

                    if (frequency === 'daily') {
                        isPaymentDay = (loan.paymentDays || []).includes(dayOfWeek);
                    } else if (frequency === 'weekly') {
                        isPaymentDay = (loan.paymentDays || [])[0] === dayOfWeek;
                    } else if (frequency === 'monthly') {
                        isPaymentDay = (loan.paymentDays || [])[0] === dayOfMonth;
                    }
                    
                    if (isPaymentDay) {
                        clientsForToday.push({ client, loan, loanIndex: index });
                    }
                });
            });
            return clientsForToday;
        }

        function getTodaysRouteClients() {
            const todaysClients = getAllTodaysClients();
            return todaysClients.filter(item => item.loan.status === 'pending' || item.loan.status === 'late');
        }

        function renderMainLayout() {
            document.getElementById('app-container').innerHTML = `
                <header class="main-header">
                    <div class="logo"><img id="header-logo" src="${DEFAULT_LOGO_URL}" alt="Logo da Empresa"><span id="header-logo-text" class="logo-text">Portal do Cobrador</span></div>
                    <div class="header-controls">
                        <div style="position: relative;">
                            <button class="header-btn" id="lang-toggle" title="Mudar idioma"><i data-lucide="globe"></i></button>
                            <div class="lang-dropdown" id="lang-dropdown"><button data-lang="pt">Portugu√™s</button><button data-lang="es">Espa√±ol</button><button data-lang="en">English</button></div>
                        </div>
                        <button class="header-btn" id="theme-toggle" title="Mudar tema"><i data-lucide="moon"></i></button>
                        <div class="profile" id="header-profile-link" style="cursor: pointer;">
                            <div class="profile-info"><span class="profile-name">Jo√£o Silva</span><span class="profile-role" data-lang-key="collector"></span></div>
                            <img id="header-profile-img" src="" alt="Foto do Cobrador">
                        </div>
                    </div>
                </header>
                <main>
                    <div id="home-view" class="view active container">
                        <div class="kpi-card progress-card" style="margin-bottom: 20px;">
                            <h3 class="kpi-title" style="justify-content: center;">Progresso da Rota</h3>
                            <div class="progress-circle">
                                <svg><circle class="bg-circle" cx="60" cy="60" r="54"></circle><circle id="route-progress-bar" class="progress-bar" cx="60" cy="60" r="54" style="stroke-dasharray: 339.292;"></circle></svg>
                                <div class="progress-text" id="route-progress-text">0/0</div>
                            </div>
                        </div>
                        <section class="kpi-grid">
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="dailyGoal"><i data-lucide="target"></i></h3><p class="kpi-value" id="kpi-goal"></p></div>
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="receivedToday"><i data-lucide="check-circle"></i></h3><p class="kpi-value green" id="kpi-received"></p></div>
                            <div class="kpi-card"><h3 class="kpi-title" data-lang-key="clientsRemaining"><i data-lucide="users"></i></h3><p class="kpi-value" id="kpi-remaining"></p></div>
                        </section>
                        <section class="route-section"><h2 class="section-title" data-lang-key="todaysRoute"></h2><div class="client-list" id="todays-route-list"><div class="loading">Carregando clientes...</div></div></section>
                    </div>
                    <div id="clients-view" class="view container">
                        <div class="search-bar-wrapper">
                            <i class="icon" data-lucide="search"></i>
                            <input type="text" id="client-search-input">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" data-lang-key="all"></button>
                            <button class="filter-btn" data-filter="pending" data-lang-key="pending"></button>
                            <button class="filter-btn" data-filter="paid" data-lang-key="paid"></button>
                            <button class="filter-btn" data-filter="late" data-lang-key="late"></button>
                            <button class="filter-btn" data-filter="finished" data-lang-key="finished"></button>
                        </div>
                        <div class="client-list" id="all-clients-list"></div>
                    </div>
                    <div id="notifications-view" class="view container">
                         <h2 class="section-title" data-lang-key="navNotifications"></h2>
                         <div class="notification-list" id="notifications-list-container"></div>
                    </div>
                     <div id="expenses-view" class="view container">
                         <h2 class="section-title" data-lang-key="myExpenses"></h2>
                         <div class="filter-buttons">
                             <button class="filter-btn active" data-period="today" data-lang-key="today"></button>
                             <button class="filter-btn" data-period="week" data-lang-key="thisWeek"></button>
                             <button class="filter-btn" data-period="month" data-lang-key="thisMonth"></button>
                             <button class="filter-btn" data-period="all" data-lang-key="fromBeginning"></button>
                         </div>
                          <div class="filter-buttons grid">
                             <button class="filter-btn active" data-category="all" data-lang-key="all"></button>
                             <button class="filter-btn" data-category="fuel" data-lang-key="fuel"></button>
                             <button class="filter-btn" data-category="food" data-lang-key="food"></button>
                             <button class="filter-btn" data-category="rent" data-lang-key="rent"></button>
                             <button class="filter-btn" data-category="mechanics" data-lang-key="mechanics"></button>
                             <button class="filter-btn" data-category="other" data-lang-key="other"></button>
                         </div>
                         <div class="expense-list" id="expenses-list-container"></div>
                     </div>
                    <div id="map-view" class="view container">
                        <div id="map-container"></div>
                    </div>
                    <div id="profile-view" class="view container">
                        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                            <label for="profile-pic-input" class="profile-pic-wrapper">
                                <img id="profile-view-img" src="" alt="Foto do Cobrador">
                            </label>
                            <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                            <h2 style="margin: 15px 0 0; font-size: 1.5em;" class="profile-name"></h2>
                            <p style="margin: 5px 0 0; color: var(--text-secondary);" data-lang-key="collector"></p>
                        </div>

                        <div class="kpi-card" style="margin-bottom: 20px; text-align: center;">
                            <h3 class="kpi-title" style="justify-content: center;" data-lang-key="capitalTotal"><i data-lucide="wallet"></i></h3>
                            <p class="kpi-value" id="kpi-capital-total"></p>
                        </div>

                        <section class="kpi-grid-profile">
                             <div class="kpi-card">
                                 <h3 class="kpi-title" data-lang-key="dailyTotal"><i data-lucide="sun"></i></h3>
                                 <p class="kpi-value green" id="kpi-daily-total"></p>
                             </div>
                             <div class="kpi-card" style="background-color: color-mix(in srgb, var(--accent-green) 5%, var(--surface));">
                                 <h3 class="kpi-title" data-lang-key="receivedInCash"><i data-lucide="banknote" style="color: var(--accent-green);"></i></h3>
                                 <p class="kpi-value" id="kpi-daily-cash"></p>
                             </div>
                             <div class="kpi-card" style="background-color: color-mix(in srgb, var(--accent-purple) 5%, var(--surface));">
                             <h3 class="kpi-title" data-lang-key="receivedInDigital"><i data-lucide="smartphone" style="color: var(--accent-purple);"></i></h3>
                             <p class="kpi-value" id="kpi-daily-digital"></p>
                         </div>
                        </section>
                         <section>
                            <h2 class="section-title" data-lang-key="accountSettings"></h2>
                            <div class="client-list">
                                <div class="settings-item" id="realtime-tracking-item">
    <i data-lucide="map-pin"></i>
    <span data-lang-key="realtimeTracking" style="flex-grow: 1;"></span>
    <div class="switch">
        <input type="checkbox" id="realtime-tracking-toggle">
        <label for="realtime-tracking-toggle"></label>
    </div>
</div>
<a class="settings-item" id="payment-settings-btn">
    <i data-lucide="dollar-sign"></i><span data-lang-key="paymentSettings"></span>
</a>
<a class="settings-item" id="change-password-btn">
    <i data-lucide="key-round"></i><span data-lang-key="changePassword"></span>
</a>
                                </a>
                                <a class="settings-item" id="export-report-btn">
                                    <i data-lucide="download"></i><span data-lang-key="exportReport"></span>
                                </a>
                                 <a class="settings-item logout" id="logout-btn">
                                     <i data-lucide="log-out"></i><span data-lang-key="logout"></span>
                                 </a>
                            </div>
                        </section>
                    </div>
                </main>
                <nav class="bottom-nav">
                    <a class="nav-item active" data-view="home"><i data-lucide="home"></i><span data-lang-key="navHome"></span></a>
                    <a class="nav-item" data-view="clients"><i data-lucide="users"></i><span data-lang-key="navClients"></span></a>
                    <a class="nav-item" data-view="notifications">
                        <i data-lucide="bell"></i>
                        <span data-lang-key="navNotifications"></span>
                        <span class="notification-badge" id="notification-badge">0</span>
                    </a>
                    <a class="nav-item" data-view="expenses"><i data-lucide="receipt"></i><span data-lang-key="navExpenses"></span></a>
                    <a class="nav-item" data-view="map"><i data-lucide="map"></i><span data-lang-key="navMap"></span></a>
                </nav>
                <button class="fab" id="addClientBtn" title="Adicionar Cliente"><i data-lucide="plus"></i></button>
                <button class="fab hidden" id="addExpenseBtn" title="Adicionar Gasto"><i data-lucide="plus"></i></button>`;
        }
        
        function applyTheme(theme) {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            body.classList.toggle('dark-mode', theme === 'dark');
            if (themeToggle) {
                themeToggle.innerHTML = `<i data-lucide="${theme === 'dark' ? 'sun' : 'moon'}"></i>`;
                lucide.createIcons({ nodes: [themeToggle] });
            }
        }
        
        function updateNotifications() {
            const container = document.getElementById('notifications-list-container');
            const badge = document.getElementById('notification-badge');
            if (!container || !badge) return;

            let notifications = [];
            
            allClients.forEach(client => {
                // Notificaciones de Pagos Pendientes
                (client.history || []).forEach((payment, index) => {
                    if (payment.status === 'pending_verification') {
                        notifications.push({ 
                            type: 'payment',
                            date: payment.date,
                            clientName: client.name, 
                            clientId: client.id, 
                            amount: payment.amount,
                            historyIndex: index, 
                            profilePictureUrl: client.profilePictureUrl 
                        });
                    }
                });

                // Notificaciones de Refinanciamiento
                if (client.refinanceRequest && client.refinanceRequest.status === 'pending') {
                    notifications.push({
                        type: 'refinance',
                        date: client.refinanceRequest.requestDate,
                        ...client.refinanceRequest,
                        clientName: client.name,
                        clientId: client.id,
                        profilePictureUrl: client.profilePictureUrl
                    });
                }
            });

            badge.textContent = notifications.length;
            badge.classList.toggle('visible', notifications.length > 0);

            if (notifications.length === 0) {
                container.innerHTML = `<div class="no-items" data-lang-key="noNotifications">${translations[currentLang].noNotifications}</div>`;
                return;
            }

            container.innerHTML = notifications
                .sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0))
                .map(p => {
                    const nameInitial = (p.clientName || 'C').charAt(0).toUpperCase();
                    const placeholderUrl = `https://placehold.co/80x80/6f42c1/FFFFFF?text=${nameInitial}`;
                    const photoUrl = p.profilePictureUrl || placeholderUrl;
                    
                    let title = '';
                    let subtitle = '';

                    if (p.type === 'payment') {
                        title = p.clientName;
                        subtitle = `${translations[currentLang].paymentSent} ${money(p.amount)}. ${translations[currentLang].pleaseVerify}`;
                    } else if (p.type === 'refinance') {
                        title = p.clientName;
                        subtitle = `${translations[currentLang].refinanceRequested} ${money(p.amount)}. ${translations[currentLang].reviewRequest}`;
                    }

                    return `
                    <div class="notification-card" data-client-id="${p.clientId}" data-history-index="${p.historyIndex}" data-type="${p.type}">
                        <img src="${photoUrl}" alt="Foto do Cliente">
                        <div class="notification-info">
                            <h4 class="notification-title">${title}</h4>
                            <p class="notification-subtitle">${subtitle}</p>
                        </div>
                    </div>`;
                }).join('');

            container.querySelectorAll('.notification-card').forEach(card => {
                card.addEventListener('click', () => {
                    const type = card.dataset.type;
                    const clientId = card.dataset.clientId;
                    if(type === 'payment') {
                        const historyIndex = parseInt(card.dataset.historyIndex, 10);
                        showVerificationModal(clientId, historyIndex);
                    } else if (type === 'refinance') {
                        showRefinanceModal(clientId);
                    }
                });
            });
        }

        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            modal.innerHTML = `
                <div class="confirmation-dialog">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="confirmation-buttons">
                        <button class="btn-secondary" id="confirm-cancel-btn">${translations[currentLang].cancel || 'Cancelar'}</button>
                        <button class="btn-primary" id="confirm-action-btn">${translations[currentLang].confirm || 'Confirmar'}</button>
                    </div>
                </div>
            `;

            history.pushState({ modal: 'confirmationModal' }, 'Confirm', '#confirm');
            modal.classList.add('active');

            modal.querySelector('#confirm-cancel-btn').addEventListener('click', () => window.history.back());
            modal.querySelector('#confirm-action-btn').addEventListener('click', () => {
                onConfirm();
            });
        }

        function showRefinanceModal(clientId) {
            const refinanceModal = document.getElementById('refinanceModal');
            const client = allClients.find(c => c.id === clientId);
            if (!client || !client.refinanceRequest) {
                showToast('Solicita√ß√£o de refinanciamento n√£o encontrada.', true);
                return;
            }

            const request = client.refinanceRequest;

            const lateDays = calculateLatePaymentDays(client);
            const score = Math.max(0, 10 - lateDays);
            let reputationStatusKey = 'reputationBad';
            if (score === 10) reputationStatusKey = 'reputationPerfect';
            else if (score >= 7) reputationStatusKey = 'reputationGood';
            else if (score >= 3) reputationStatusKey = 'reputationRegular';

            let barStatusClass = 'status-bad';
            if (score === 10) barStatusClass = 'status-perfect';
            else if (score >= 7) barStatusClass = 'status-good';
            else if (score >= 3) barStatusClass = 'status-regular';

            const nameInitial = (client.name || 'C').charAt(0).toUpperCase();
            const placeholderUrl = `https://placehold.co/80x80/6f42c1/FFFFFF?text=${nameInitial}`;
            const photoUrl = client.profilePictureUrl || placeholderUrl;

            refinanceModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeRefinanceModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Solicita√ß√£o de Refinanciamento</span>
                </header>
                <div class="modal-content-wrapper container">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <img src="${photoUrl}" alt="Foto do Cliente" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <h3 style="margin: 0 0 5px;">${client.name}</h3>
                            <div class="reputation-status">
                                <span class="reputation-value">${score} / 10</span>
                                <span class="reputation-text ${barStatusClass}" data-lang-key="${reputationStatusKey}"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="kpi-card">
                        <h3 class="kpi-title">Detalhes da Solicita√ß√£o</h3>
                        <div class="loan-summary" style="grid-template-columns: 1fr; gap: 10px; text-align: center;">
                            <div>
                                <p class="kpi-title" style="justify-content: center;">Valor Solicitado</p>
                                <p class="kpi-value">${money(request.amount)}</p>
                            </div>
                            <div>
                                <p class="kpi-title" style="justify-content: center;">N¬∫ de Parcelas</p>
                                <p class="kpi-value">${request.installments}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-danger" id="reject-refinance-btn"><i data-lucide="x-circle"></i> <span data-lang-key="reject"></span></button>
                    <button class="btn-primary" id="approve-refinance-btn"><i data-lucide="check-circle"></i> <span data-lang-key="approve"></span></button>
                </div>`;
            
            history.pushState({ modal: 'refinanceModal' }, 'Refinance Modal', '#refinance');
            refinanceModal.classList.add('active');
            lucide.createIcons({ nodes: refinanceModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            document.getElementById('closeRefinanceModal').addEventListener('click', () => window.history.back());

            document.getElementById('approve-refinance-btn').addEventListener('click', async () => {
                const clientRef = doc(db, 'clients', clientId);
                const requestData = client.refinanceRequest;
                if (!requestData) {
                    showToast('Solicitud no encontrada.', true);
                    return;
                }

                // L√≥gica para crear el nuevo pr√©stamo a partir de la solicitud
                const interestRate = client.interestRate || 20;
                const totalToPay = requestData.amount * (1 + (interestRate / 100));
                const installmentValue = requestData.installments > 0 ? totalToPay / requestData.installments : 0;
                
                const newLoanData = {
                    totalLoan: totalToPay,
                    amount: installmentValue,
                    originalInstallmentAmount: installmentValue,
                    installments: `0/${requestData.installments}`,
                    paid: 0,
                    paymentBalance: 0,
                    status: 'active',
                    startDate: new Date(),
                    history: [],
                    // Se heredan estos valores del pr√©stamo principal para consistencia
                    paymentFrequency: client.loans[0].paymentFrequency, 
                    paymentDays: client.loans[0].paymentDays,
                    collectionTime: client.loans[0].collectionTime,
                };

                try {
                    await updateDoc(clientRef, {
                        refinanceRequest: null, // Elimina la solicitud pendiente
                        loans: arrayUnion(newLoanData) // A√±ade el nuevo pr√©stamo a la lista
                    });

                    showToast('Refinanciamento aprovado e novo empr√©stimo criado!');
                    window.history.back();

                    const notifTitle = translations[currentLang].refinanceApprovedClientTitle;
                    const notifBody = translations[currentLang].refinanceApprovedClientBody;
                    sendNotificationToClient(clientId, notifTitle, notifBody, 'refinance_approved', 'trending-up');
                } catch (error) {
                    console.error("Error approving refinance:", error);
                    showToast('Erro ao aprovar refinanciamento.', true);
                }
            });

            document.getElementById('reject-refinance-btn').addEventListener('click', async () => {
                const clientRef = doc(db, 'clients', clientId);
                try {
                    await updateDoc(clientRef, {
                        refinanceRequest: null
                    });
                    showToast('Solicita√ß√£o rejeitada.');
                    
                    // [BUG CORREGIDO] Notificaci√≥n de rechazo de refinanciamiento A√ëADIDA
                    const notifTitle = translations[currentLang].refinanceRejectedClientTitle;
                    const notifBody = translations[currentLang].refinanceRejectedClientBody;
                    sendNotificationToClient(clientId, notifTitle, notifBody, 'refinance_rejected', 'trending-down');
                    
                    window.history.back();
                } catch (error) {
                    console.error("Error rejecting refinance:", error);
                    showToast('Erro ao rejeitar solicita√ß√£o.', true);
                }
            });
        }

        function showPaymentDetailModal(clientId, historyIndex) {
            const modal = document.getElementById('paymentDetailModal');
            const client = allClients.find(c => c.id === clientId);
            if (!client || !client.history || !client.history[historyIndex]) {
                showToast('Detalhe do pagamento n√£o encontrado.', true);
                return;
            }

            const payment = client.history[historyIndex];
            
            let dateStr = 'N/A';
            let timeStr = 'N/A';

            if (payment.date?.seconds) {
                const d = new Date(payment.date.seconds * 1000);
                dateStr = d.toLocaleDateString('pt-BR');
                timeStr = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }

            let receiptPreviewHtml = `<p class="no-items">Nenhum comprovante anexado.</p>`;
            if (payment.receiptUrl) {
                receiptPreviewHtml = `<img src="${payment.receiptUrl}" alt="Comprovante de Pagamento" style="width: 100%; max-height: 60vh; object-fit: contain; border-radius: 8px; border: 1px solid var(--border-color);">`;
            }

            let receiptButtonHtml = '';
            if (payment.receiptUrl) {
                 receiptButtonHtml = `<a href="${payment.receiptUrl}" target="_blank" download="comprovante-${client.name.replace(/\s/g, '_')}-${dateStr}.jpg" class="btn-primary"><i data-lucide="download"></i> Baixar Comprovante</a>`;
            }
            const invoiceButtonHtml = `<button id="generate-invoice-btn" class="btn-secondary"><i data-lucide="receipt"></i> Emitir Fatura</button>`;


            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentDetailModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Detalhes do Pagamento</span>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="kpi-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 class="kpi-title">Data</h3>
                                <p class="kpi-value" style="font-size: 1.2em;">${dateStr} √†s ${timeStr}</p>
                            </div>
                            <div>
                                <h3 class="kpi-title" style="justify-content: flex-end;">Valor Pago</h3>
                                <p class="kpi-value green" style="font-size: 1.4em;">${money(payment.amount)}</p>
                            </div>
                        </div>
                    </div>
                    <h3 class="section-title" style="border: none;">Comprovante</h3>
                    <div class="kpi-card">
                        ${receiptPreviewHtml}
                    </div>
                </div>
                <div class="action-buttons">
                    ${receiptButtonHtml}
                    ${invoiceButtonHtml}
                </div>
            `;

            history.pushState({ modal: 'paymentDetailModal' }, 'Payment Details', '#payment-detail');
            modal.classList.add('active');

            lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });
            
            modal.querySelector('#closePaymentDetailModal').addEventListener('click', () => window.history.back());
            modal.querySelector('#generate-invoice-btn').addEventListener('click', () => generateInvoicePDF(client, payment));
        }

        async function generateInvoicePDF(client, payment) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const paymentDate = new Date(payment.date.seconds * 1000);
            const collectorName = document.querySelector('.profile-name')?.textContent || 'Jo√£o Silva';

            // --- Estilo y Contenido ---
            const primaryColor = '#6f42c1';
            const textColor = '#343a40';
            const secondaryTextColor = '#6c757d';
            const pageMargin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 0;

            // 1. Encabezado de la Empresa (Sin logo, centrado)
            y = 25;
            doc.setFontSize(16);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'bold');
            doc.text('LUMIX Finan√ßas', pageWidth / 2, y, { align: 'center' });

            // 2. T√≠tulo de la Factura
            y = 55;
            doc.setFontSize(26);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'bold');
            doc.text('FATURA', pageMargin, y);
            
            doc.setFontSize(11);
            doc.setTextColor(secondaryTextColor);
            doc.setFont(undefined, 'normal');
            doc.text(`Emitido em: ${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`, pageWidth - pageMargin, y, { align: 'right' });

            // L√≠nea divisoria
            doc.setLineWidth(0.5);
            doc.setDrawColor(primaryColor);
            doc.line(pageMargin, y + 5, pageWidth - pageMargin, y + 5);

            // 3. Detalles del Cliente y Pago
            y += 15;
            doc.setFontSize(10);
            doc.setTextColor(secondaryTextColor);
            doc.text('COBRADOR', pageMargin, y);
            doc.text('CLIENTE', pageWidth / 2, y);
            
            doc.setFontSize(12);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'bold');
            doc.text(collectorName, pageMargin, y + 6);
            doc.text(client.name, pageWidth / 2, y + 6);

            y += 15;
            doc.setFontSize(10);
            doc.setTextColor(secondaryTextColor);
            doc.text('DATA DO PAGAMENTO', pageMargin, y);
            
            doc.setFontSize(12);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'normal');
            doc.text(`${paymentDate.toLocaleDateString('pt-BR')} √†s ${paymentDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`, pageMargin, y + 6);

            // 4. Cuerpo de la factura (Tabla)
            y += 25;
            doc.setFillColor('#f0e9ff'); // Un lila muy claro
            doc.roundedRect(pageMargin, y, pageWidth - (pageMargin * 2), 10, 2, 2, 'F');
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(primaryColor);
            doc.text('Descri√ß√£o', pageMargin + 5, y + 7);
            doc.text('Valor Pago', pageWidth - pageMargin - 5, y + 7, { align: 'right' });

            y += 18;
            doc.setFontSize(12);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'normal');
            doc.text('Pagamento de parcela do empr√©stimo', pageMargin + 5, y);
            doc.setFont(undefined, 'bold');
            doc.setTextColor('#28a745'); // accent-green
            doc.setFontSize(14);
            doc.text(money(payment.amount), pageWidth - pageMargin - 5, y, { align: 'right' });

            // 5. Resumen del Pr√©stamo
            const paidInstallments = (client.history || []).filter(p => p.status !== 'pending_verification').length;
            const totalInstallmentsStr = (client.installments || "0/0").split('/')[1];
            const totalInstallments = totalInstallmentsStr ? parseInt(totalInstallmentsStr, 10) : 0;
            const remainingValue = Math.max(0, (client.totalLoan || 0) - (client.paid || 0));

            y += 20;
            doc.setFillColor('#fafafa');
            doc.roundedRect(pageMargin, y, pageWidth - (pageMargin * 2), 26, 3, 3, 'F');
            doc.setFontSize(12);
            doc.setTextColor(textColor);
            doc.setFont(undefined, 'bold');
            doc.text('Resumo do Empr√©stimo', pageMargin + 5, y + 8);
            
            y += 16;
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(secondaryTextColor);
            doc.text('Progresso das Parcelas:', pageMargin + 5, y);
            doc.setTextColor(textColor);
            doc.text(`${paidInstallments} de ${totalInstallments} pagas`, pageWidth - pageMargin - 5, y, { align: 'right' });
            
            y += 7;
            doc.setTextColor(secondaryTextColor);
            doc.text('Valor Restante:', pageMargin + 5, y);
            doc.setTextColor(primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text(money(remainingValue), pageWidth - pageMargin - 5, y, { align: 'right' });
            
            // 6. Pie de p√°gina
            y = doc.internal.pageSize.getHeight() - 30;
            doc.setLineWidth(0.2);
            doc.setDrawColor(secondaryTextColor);
            doc.line(pageMargin, y, pageWidth - pageMargin, y);
            
            y += 10;
            doc.setFontSize(12);
            doc.setTextColor(primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Obrigado pela prefer√™ncia!', pageWidth / 2, y, { align: 'center' });

            const fileName = `fatura-${client.name.replace(/\s/g, '_')}-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;

            // 1. Iniciar o download automaticamente
            doc.save(fileName);
            showToast('Download da fatura iniciado...');

            // 2. Tentar compartilhar usando a API de compartilhamento da web, apenas se estiver no modo App (PWA)
            const isAppMode = window.matchMedia('(display-mode: standalone)').matches;

            if (isAppMode && navigator.share && navigator.canShare) {
                const pdfBlob = doc.output('blob');
                const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
                
                const shareData = {
                    files: [pdfFile],
                    title: `Fatura - ${client.name}`,
                    text: `Segue a fatura do pagamento de ${money(payment.amount)} para ${client.name}.`,
                };

                // Verifica se o navegador pode compartilhar esses dados
                if (navigator.canShare(shareData)) {
                    try {
                        await navigator.share(shareData);
                    } catch (err) {
                        // O erro 'AbortError' ocorre se o usu√°rio fechar a janela de compartilhamento, n√£o √© um erro cr√≠tico.
                        if (err.name !== 'AbortError') {
                            console.error('Erro ao compartilhar a fatura:', err);
                            showToast('N√£o foi poss√≠vel abrir a janela de compartilhamento.', true);
                        }
                    }
                } else {
                     // Isso pode acontecer em desktops onde o compartilhamento de arquivos n√£o √© suportado
                    console.warn('O compartilhamento de arquivos n√£o √© suportado neste navegador.');
                }
            } else {
                if (!isAppMode) {
                    console.log('Modo Web detectado: a op√ß√£o de compartilhar fatura foi desativada.');
                }
            }
        }

        function showVerificationModal(clientId, historyIndex) {
            const verificationModal = document.getElementById('verificationModal');
            const client = allClients.find(c => c.id === clientId);
            if (!client || !client.history || !client.history[historyIndex]) {
                showToast('Notifica√ß√£o n√£o encontrada ou inv√°lida.', true);
                return;
            }

            const payment = client.history[historyIndex];

            verificationModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeVerificationModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="paymentVerification"></span>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="kpi-card">
                        <p class="kpi-title" style="margin-bottom: 5px;">${client.name}</p>
                        <p class="kpi-title" data-lang-key="sentAmount"></p>
                        <p class="kpi-value green">${money(payment.amount)}</p>
                    </div>
                    <div class="kpi-card" style="margin-top: 15px;">
                        <h3 class="kpi-title" data-lang-key="paymentReceipt"></h3>
                        <img id="verification-receipt-img" src="${payment.receiptUrl}" alt="Comprovante">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-danger" id="reject-payment-btn"><i data-lucide="x-circle"></i> <span data-lang-key="reject"></span></button>
                    <button class="btn-primary" id="approve-payment-btn"><i data-lucide="check-circle"></i> <span data-lang-key="approve"></span></button>
                </div>`;

            history.pushState({ modal: 'verificationModal' }, 'Verification Modal', '#verification');
            verificationModal.classList.add('active');
            lucide.createIcons({ nodes: verificationModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            document.getElementById('closeVerificationModal').addEventListener('click', () => window.history.back());

            document.getElementById('approve-payment-btn').addEventListener('click', async () => {
                const clientRef = doc(db, 'clients', clientId);
                const updatedHistory = [...client.history];
                const paymentBeingApproved = updatedHistory[historyIndex];

                if (!paymentBeingApproved) {
                    console.error("√çndice de historial de pago no v√°lido:", historyIndex);
                    showToast('Error: Pago no encontrado para aprobar.', true);
                    return;
                }
                paymentBeingApproved.status = 'approved';

                // --- INICIO DE LA NUEVA L√ìGICA FINANCIERA ---
                const approvedAmount = paymentBeingApproved.amount;
                const newTotalPaidAmount = (client.paid || 0) + approvedAmount;
                const newBalance = (client.paymentBalance || 0) + approvedAmount - client.originalInstallmentAmount;
                // --- FIN DE LA NUEVA L√ìGICA FINANCIERA ---

                try {
                    // Actualizamos el documento del cliente con el historial modificado, el nuevo total pagado y el nuevo saldo.
                    await updateDoc(clientRef, {
                        history: updatedHistory,
                        paid: newTotalPaidAmount,
                        paymentBalance: newBalance
                    });

                    const notifTitle = translations[currentLang].paymentApprovedClientTitle;
                    const notifBody = translations[currentLang].paymentApprovedClientBody.replace('{amount}', money(payment.amount));
                    sendNotificationToClient(clientId, notifTitle, notifBody, 'payment_approved', 'check-circle');

                    showToast(translations[currentLang].paymentApproved);
                    window.history.back(); // Cierra el modal de verificaci√≥n.
                } catch (error) {
                    console.error("Error approving payment:", error);
                    showToast('Erro ao aprovar pagamento.', true);
                }
            });

            document.getElementById('reject-payment-btn').addEventListener('click', async () => {
                const clientRef = doc(db, 'clients', clientId);
                const updatedHistory = client.history.filter((_, index) => index !== historyIndex);

                try {
                    await updateDoc(clientRef, { history: updatedHistory });
                    
                    // [BUG CORREGIDO] Notificaci√≥n de rechazo de pago ahora usa el texto y tipo correctos.
                    const notifTitle = translations[currentLang].paymentRejectedClientTitle;
                    const notifBody = translations[currentLang].paymentRejectedClientBody;
                    sendNotificationToClient(clientId, notifTitle, notifBody, 'payment_rejected', 'x-circle');

                    showToast(translations[currentLang].paymentRejected);
                    window.history.back();
                } catch (error) {
                    console.error("Error rejecting payment:", error);
                    showToast('Erro ao rejeitar pagamento.', true);
                }
            });
        }
        
        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) { el.textContent = translations[lang][key]; }
            });
            document.documentElement.lang = lang.startsWith('es') ? 'es' : (lang.startsWith('en') ? 'en' : 'pt-BR');
            const searchInput = document.getElementById('client-search-input');
            if(searchInput) searchInput.placeholder = translations[lang].searchClient;
            
            updateTodaysRouteList();
            updateAllClientsList();
            updateExpensesView();
            updateProfileView();
            updateNotifications();
        }

        function updateRouteProgress() {
            const todaysTotalClientsList = getAllTodaysClients();
            const totalClients = todaysTotalClientsList.length;
            const paidClients = todaysTotalClientsList.filter(c => c.loan.status === 'paid').length;

            const progressPercentage = totalClients > 0 ? (paidClients / totalClients) * 100 : 0;

            const progressBar = document.getElementById('route-progress-bar');
            const progressText = document.getElementById('route-progress-text');

            if (progressBar && progressText) {
                const circleCircumference = 2 * Math.PI * 54;
                const strokeDashoffset = circleCircumference - (progressPercentage / 100) * circleCircumference;
                progressBar.style.strokeDashoffset = strokeDashoffset;
                progressText.textContent = `${paidClients}/${totalClients}`;
            }
        }

        function updateDashboard(clientsForDashboard) {
            const kpiGoal = document.getElementById('kpi-goal');
            const kpiReceived = document.getElementById('kpi-received');
            const kpiRemaining = document.getElementById('kpi-remaining');
            if (!kpiGoal) return;
            if (!clientsForDashboard || clientsForDashboard.length === 0) {
                 kpiGoal.textContent = money(0);
                 kpiRemaining.textContent = 0;
            } else {
                const dailyGoal = clientsForDashboard.filter(c => c.status !== 'paid').reduce((sum, c) => sum + (c.amount || 0), 0);
                const remainingClients = clientsForDashboard.filter(c => c.status === 'pending' || c.status === 'late').length;
                kpiGoal.textContent = money(dailyGoal);
                kpiRemaining.textContent = remainingClients;
            }
            
            const todayStr = new Date().toLocaleDateString('pt-BR');
            const receivedToday = allClients
                .flatMap(c => c.loans || []) // B√∫squeda corregida para m√∫ltiples pr√©stamos
                .flatMap(l => l.history || []) // Extrae el historial de cada pr√©stamo
                .filter(h => h?.date?.seconds && new Date(h.date.seconds * 1000).toLocaleDateString('pt-BR') === todayStr && h.status !== 'pending_verification')
                .reduce((sum, h) => sum + h.amount, 0);
            kpiReceived.textContent = money(receivedToday);
        }

        function updateProfileView(collectorData = null) {
            const dailyTotalEl = document.getElementById('kpi-daily-total');
            const capitalTotalEl = document.getElementById('kpi-capital-total');
            const dailyCashEl = document.getElementById('kpi-daily-cash');
            const dailyDigitalEl = document.getElementById('kpi-daily-digital');
            if (!dailyTotalEl) return;

            const now = new Date();
            const todayStr = now.toLocaleDateString('pt-BR');
            
            let dailyTotal = 0, totalLoansMade = 0;
            let dailyTotalCash = 0, dailyTotalDigital = 0;

            // --- INICIO NUEVO C√ÅLCULO DE PAGOS RECIBIDOS ---
let totalPaymentsReceived = 0;
allClients.forEach(client => {
    (client.loans || []).forEach(loan => {
        // Suma el principal de este pr√©stamo al total prestado
        if (loan.principalAmount) { // Usa el principal fijo que guardamos antes
            totalLoansMade += loan.principalAmount;
        } else if (loan.totalLoan && client.interestRate) { // Fallback para pr√©stamos antiguos
            totalLoansMade += (loan.totalLoan / (1 + (client.interestRate / 100)));
        }

        // Suma los pagos aprobados del historial de este pr√©stamo
        (loan.history || []).forEach(h => {
            if (h.date?.seconds && h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed') {
                const paymentDate = new Date(h.date.seconds * 1000);
                const amount = h.amount || 0;
                totalPaymentsReceived += amount; // Suma al total general

                // Suma a los totales diarios si corresponde
                if (paymentDate.toLocaleDateString('pt-BR') === todayStr) {
                    dailyTotal += amount;
                    if (h.method === 'dinheiro') {
                        dailyTotalCash += amount;
                    } else if (h.method === 'pix' || h.method === 'cartao') {
                        dailyTotalDigital += amount;
                    }
                }
            }
        });
    });
});
// --- FIN NUEVO C√ÅLCULO ---
            
            const totalExpenses = allExpenses.reduce((sum, expense) => sum + expense.value, 0);
            
            const currentStartingCapital = (collectorData && collectorData.startingCapital) || 0;

// --- C√ÅLCULO A√ëADIDO PARA LIQUIDACIONES (COBRADOR) ---
const totalSettledByThisCollector = allSettlements.reduce((sum, s) => sum + (s.amount || 0), 0);
// --- FIN C√ÅLCULO A√ëADIDO ---

// Ajusta la f√≥rmula final de capitalTotal
const capitalTotal = currentStartingCapital - totalLoansMade + totalPaymentsReceived - totalExpenses - totalSettledByThisCollector; // <-- RESTA totalSettledByThisCollector

dailyTotalEl.textContent = money(dailyTotal);
capitalTotalEl.textContent = money(capitalTotal); // Usa el capitalTotal ajustado
if(dailyCashEl) dailyCashEl.textContent = money(dailyTotalCash);
if(dailyDigitalEl) dailyDigitalEl.textContent = money(dailyTotalDigital);
        }
        
        // Nueva funci√≥n mejorada que calcula d√≠as de atraso Y mora
function calculateLoanDetails(loan) {
    let details = {
        lateDays: 0,
        lateFeesAccumulated: 0,
        status: 'pending', // Estado por defecto
        nextDueDate: null, // Fecha del pr√≥ximo vencimiento
        amountDueToday: 0 // Cu√°nto deber√≠a pagar HOY si es d√≠a de pago
    };

    // --- INICIO C√ÅLCULO DEL TOTAL PAGADO DESDE HISTORIAL ---
    const currentTotalPaid = (loan.history || [])
        .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed') // Solo pagos aprobados/v√°lidos
        .reduce((sum, h) => sum + (h.amount || 0), 0);
    // --- FIN C√ÅLCULO ---

    // Si no hay pr√©stamo o ya est√° finalizado, no hay nada que calcular.
    if (!loan || !loan.totalLoan || loan.status === 'finished' || (loan.paid >= loan.totalLoan)) {
        details.status = 'finished';
        return details;
    }

    const today = new Date(); 
    today.setHours(0, 0, 0, 0);

    // Determinar la fecha de inicio relevante (inicio del pr√©stamo o √∫ltimo pago)
    let lastRelevantDate;
    if (loan.history && loan.history.length > 0) {
        const sortedHistory = [...loan.history]
            .filter(h => h.date?.seconds && h.status !== 'pending_verification' && h.status !== 'postponed') // Ignorar pendientes y aplazados
            .sort((a, b) => b.date.seconds - a.date.seconds);
        if (sortedHistory.length > 0) {
            lastRelevantDate = new Date(sortedHistory[0].date.seconds * 1000);
        }
    }
    if (!lastRelevantDate && loan.startDate?.seconds) {
        lastRelevantDate = new Date(loan.startDate.seconds * 1000);
    }

    if (!lastRelevantDate) {
        console.warn("No se puede calcular el estado: falta fecha de inicio o historial.");
        return details; // No podemos calcular sin una fecha base
    }
    lastRelevantDate.setHours(0, 0, 0, 0);

    // --- L√≥gica Principal de C√°lculo ---
    let checkDate = new Date(lastRelevantDate);
    let accumulatedLateDays = 0;
    let accumulatedLateFees = 0;
    const dailyLateRate = (loan.lateFeeRate || 0) / 100; // Tasa diaria como decimal
    const installmentAmount = loan.originalInstallmentAmount || 0;
    let installmentsDueCount = 0; // Cu√°ntas cuotas deber√≠an haberse pagado hasta hoy
    let nextDueDateFound = false;

    // Bucle para calcular cuotas vencidas, d√≠as de atraso y mora
    while (checkDate <= today) {
        const dayOfWeek = checkDate.getDay();
        const dayOfMonth = checkDate.getDate();
        const formattedDate = `${String(checkDate.getDate()).padStart(2, '0')}/${String(checkDate.getMonth() + 1).padStart(2, '0')}`;
        const isHoliday = nationalHolidays.includes(formattedDate);
        const frequency = loan.paymentFrequency || 'daily';
        let isPaymentDay = false;

        if (frequency === 'daily') isPaymentDay = (loan.paymentDays || []).includes(dayOfWeek);
        else if (frequency === 'weekly') isPaymentDay = (loan.paymentDays || [])[0] === dayOfWeek;
        else if (frequency === 'monthly') isPaymentDay = (loan.paymentDays || [])[0] === dayOfMonth;

        // Es un d√≠a de pago v√°lido (no feriado, no domingo si es diario/semanal)
        // [CORRECCI√ìN] Domingo (0) S√ç cuenta como d√≠a de pago si est√° expl√≠citamente seleccionado.
        // Solo se excluyen feriados.
        if (!isHoliday && isPaymentDay) {

            // Si la fecha es ANTERIOR a hoy, cuenta como cuota vencida
            if (checkDate < today) {
                installmentsDueCount++;

                // Calcular mora SOLO si la tasa es mayor a 0
                if (dailyLateRate > 0) {
                     // Calcula cu√°nto DEBER√çA haberse pagado hasta esta fecha
                    const expectedPaidByThisDate = installmentsDueCount * installmentAmount;
                    // Calcula cu√°nto falta por pagar de lo vencido
                    const outstandingDueAmount = Math.max(0, expectedPaidByThisDate - currentTotalPaid);

                    // Si hay monto vencido pendiente, calcula la mora diaria sobre ESE monto
                    if (outstandingDueAmount > 0) {
                        const dailyFee = outstandingDueAmount * dailyLateRate;
                        accumulatedLateFees += dailyFee;
                        accumulatedLateDays++; // Solo contamos d√≠as de mora si hab√≠a saldo pendiente ESE d√≠a
                    }
                } else {
                     // Si no hay tasa de mora, solo contamos d√≠as de atraso si la cuota est√° pendiente
                     const expectedPaidByThisDate = installmentsDueCount * installmentAmount;
                     if (currentTotalPaid < expectedPaidByThisDate) {
                         accumulatedLateDays++;
                     }
                }
            }

            // Si la fecha es HOY, marca cu√°nto se debe pagar hoy
            if (checkDate.getTime() === today.getTime()) {
                details.amountDueToday = installmentAmount;
            }

            // Guarda la pr√≥xima fecha de vencimiento (la primera que encuentre a partir de hoy)
            if (checkDate >= today && !nextDueDateFound) {
                details.nextDueDate = new Date(checkDate);
                nextDueDateFound = true;
            }
        }

        // Avanza al siguiente d√≠a (importante: hacerlo fuera del if de isPaymentDay)
        checkDate.setDate(checkDate.getDate() + 1);
    }

    // --- Determinar Estado Final ---
    details.lateDays = accumulatedLateDays;
    details.lateFeesAccumulated = accumulatedLateFees;

    const totalInstallments = parseInt((loan.installments || '0/0').split('/')[1]);
    const paidInstallmentsCalculated = Math.floor(currentTotalPaid / installmentAmount);

    if (paidInstallmentsCalculated >= totalInstallments || currentTotalPaid >= loan.totalLoan) {
         details.status = 'finished';
    } else if (accumulatedLateDays > 1) { // M√°s de 1 d√≠a de atraso (considerando mora o no)
        details.status = 'late';
    } else if (details.amountDueToday > 0 && currentTotalPaid < installmentsDueCount * installmentAmount) { // Si hoy es d√≠a de pago y no est√° cubierto
         details.status = 'pending';
    } else if (accumulatedLateDays === 1) { // Exactamente 1 d√≠a de atraso
         details.status = 'pending'; // Consideramos 'pending' el primer d√≠a, 'late' a partir del segundo
    } else {
        details.status = 'paid'; // Si no est√° terminado, ni atrasado, ni pendiente hoy, est√° al d√≠a.
    }

    return details;
}

        function renderClientCards(container, clientsWithLoans) {
            if (!container) return;
            if (clientsWithLoans.length === 0) {
                container.innerHTML = `<div class="no-items">Nenhum cliente encontrado.</div>`;
                return;
            }
            container.innerHTML = ''; 
            clientsWithLoans.forEach(item => {
                const { client, loan, loanIndex } = item;
                const card = document.createElement('div');
                card.className = 'client-card';
                card.dataset.clientId = client.id;
                card.dataset.loanIndex = loanIndex;
                const statusClass = `status-${loan.status}`;
                const statusText = (translations[currentLang] && translations[currentLang][loan.status]) || loan.status;
                
                const loanDetails = calculateLoanDetails(loan); // Llama a la nueva funci√≥n
const           lateDays = loanDetails.lateDays;         // Obtiene los d√≠as de atraso del resultado
                const reputationScore = Math.max(0, 10 - lateDays);
                let repClass = 'rep-bad';
                if (reputationScore === 10) repClass = 'rep-perfect';
                else if (reputationScore >= 7) repClass = 'rep-good';
                else if (reputationScore >= 3) repClass = 'rep-regular';

                const nameInitial = (client.name || 'C').charAt(0).toUpperCase();
                const placeholderUrl = `https://placehold.co/80x80/6f42c1/FFFFFF?text=${nameInitial}`;
                const photoUrl = client.profilePictureUrl || placeholderUrl;
                
                const loanLabel = clientsWithLoans.filter(c => c.client.id === client.id).length > 1 ? ` - Pr√©stamo ${loanIndex + 1}` : '';

                card.innerHTML = `
                    <img src="${photoUrl}" alt="Foto do Cliente" class="client-avatar">
                    <div class="client-info">
                        <h4 class="client-name">${client.name}${loanLabel}</h4>
                        <p class="client-address"><i data-lucide="map-pin" style="width: 14px; height: 14px; stroke-width: 2.5;"></i>${client.address}</p>
                    </div>
                    <div class="payment-info">
                        <span class="payment-amount">${money(loan.amount)}</span>
                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 5px;">
                           <span class="reputation-score ${repClass}"><i data-lucide="star" style="width: 12px; height: 12px;"></i> ${reputationScore}/10</span>
                           <span class="payment-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
            container.querySelectorAll('.client-card').forEach(card => card.addEventListener('click', (e) => {
                const clientId = e.currentTarget.dataset.clientId;
                const loanIndex = parseInt(e.currentTarget.dataset.loanIndex, 10);
                showClientDetails(clientId, loanIndex);
            }));
        }

        const PAYMENT_CONFIGS = {
            // Suram√©rica
            "BRL": { name: "Real Brasileiro", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'brl_pix', label: 'Chave PIX', type: 'text', placeholder: 'CPF, e-mail, telefone...' }, { id: 'brl_qrcode_text', label: 'PIX Copia e Cola', type: 'textarea', placeholder: 'Cole o c√≥digo BR...' }, { id: 'brl_qrcode_image', label: 'Imagem QR Code PIX', type: 'image' } ]},
            "ARS": { name: "Peso Argentino", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'ars_mercadopago', label: 'Mercado Pago (CVU/Alias)', type: 'text', placeholder: 'CVU ou Alias da conta' }, { id: 'ars_transferencia', label: 'Transferencia Bancaria (CBU)', type: 'text', placeholder: 'CBU da conta banc√°ria' } ]},
            "BOB": { name: "Boliviano", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'bob_qr', label: 'QR Simple', type: 'image' }, { id: 'bob_tigomoney', label: 'Tigo Money', type: 'tel', placeholder: 'N√∫mero de Tel√©fono' } ]},
            "CLP": { name: "Peso Chileno", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'clp_transferencia', label: 'Transferencia (Cuenta RUT)', type: 'text', placeholder: 'RUT o datos de la cuenta' } ]},
            "COP": { name: "Peso Colombiano", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'cop_nequi', label: 'Nequi', type: 'tel', placeholder: 'N√∫mero de telefone Nequi' }, { id: 'cop_daviplata', label: 'Daviplata', type: 'tel', placeholder: 'N√∫mero de telefone Daviplata' }, { id: 'cop_bancolombia', label: 'Bancolombia A la Mano', type: 'text', placeholder: 'N√∫mero de cuenta o tel√©fono' }, { id: 'cop_qrcode_image', label: 'Imagem QR Code Gen√©rico', type: 'image' } ]},
            "USD_EC": { name: "D√≥lar (Ecuador)", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'ec_transferencia_pichincha', label: 'Transferencia Banco Pichincha', type: 'text', placeholder: 'Datos de la cuenta' }, { id: 'ec_transferencia_guayaquil', label: 'Transferencia Banco Guayaquil', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "PYG": { name: "Guaran√≠ Paraguayo", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'pyg_giros', label: 'Giros Tigo / Personal', type: 'tel', placeholder: 'N√∫mero de Tel√©fono' }, { id: 'pyg_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "PEN": { name: "Sol Peruano", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'pen_yape', label: 'Yape', type: 'tel', placeholder: 'N√∫mero de Celular o QR' }, { id: 'pen_plin', label: 'Plin', type: 'tel', placeholder: 'N√∫mero de Celular' } ]},
            "UYU": { name: "Peso Uruguayo", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'uyu_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "VES": { name: "Bol√≠var Venezuelano", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'ves_pagomovil', label: 'Pago M√≥vil', type: 'text', placeholder: 'C.I, Banco, Tel√©fono' } ]},
            // Centroam√©rica
            "CRC": { name: "Col√≥n Costarricense", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'crc_sinpe', label: 'SINPE M√≥vil', type: 'tel', placeholder: 'N√∫mero de Tel√©fono' } ]},
            "GTQ": { name: "Quetzal Guatemalteco", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'gtq_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta (BAC, BI, etc.)' } ]},
            "HNL": { name: "Lempira Hondure√±a", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'hnl_tigomoney', label: 'Tigo Money', type: 'tel', placeholder: 'N√∫mero de Tel√©fono' }, { id: 'hnl_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            "NIO": { name: "C√≥rdoba Nicarag√ºense", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'nio_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta (Lafise, BAC)' } ]},
            "PAB": { name: "Balboa Paname√±o / USD", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'pab_yappy', label: 'Yappy (Banco General)', type: 'tel', placeholder: 'N√∫mero de Tel√©fono' }, { id: 'pab_nequi', label: 'Nequi Panam√°', type: 'tel', placeholder: 'N√∫mero de Tel√©fono' } ]},
            "USD_SV": { name: "D√≥lar (El Salvador)", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'sv_chivo', label: 'Chivo Wallet', type: 'text', placeholder: 'N√∫mero de DUI o Tel√©fono' }, { id: 'sv_transferencia', label: 'Transferencia Bancaria', type: 'text', placeholder: 'Datos de la cuenta' } ]},
            // Norteam√©rica y General
            "USD": { name: "D√≥lar Americano (General)", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'usd_zelle', label: 'Zelle', type: 'email', placeholder: 'E-mail ou telefone Zelle' }, { id: 'usd_cashapp', label: 'Cash App', type: 'text', placeholder: '$Cashtag' }, { id: 'usd_paypal', label: 'PayPal', type: 'email', placeholder: 'E-mail do PayPal.me' } ]},
            "MXN": { name: "Peso Mexicano", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'mxn_spei', label: 'Transferencia SPEI (CLABE)', type: 'text', placeholder: 'CLABE Interbancaria' }, { id: 'mxn_oxxo', label: 'Pago en OXXO', type: 'text', placeholder: 'N√∫mero de refer√™ncia para OXXO Pay' } ]},
            "CAD": { name: "D√≥lar Canadiense", methods: [ { id: 'cash', label: 'Dinheiro em Esp√©cie', type: 'cash' }, { id: 'cad_interac', label: 'Interac e-Transfer', type: 'email', placeholder: 'Email para transferencia' } ]}
        };

        function showPaymentSettingsModal(collectorData) {
            const modal = document.getElementById('paymentSettingsModal');
            const currentSettings = collectorData.paymentSettings || { currency: 'BRL', methods: {} };
            let filesToUpload = {};

            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentSettingsModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="paymentSettings"></span>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="form-group">
                        <label data-lang-key="currency"></label>
                        <select id="currency-selector">
                            ${Object.keys(PAYMENT_CONFIGS).map(code => 
                                `<option value="${code}" ${currentSettings.currency === code ? 'selected' : ''}>${code} - ${PAYMENT_CONFIGS[code].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <h3 class="section-title" data-lang-key="paymentMethods" style="margin-top: 30px;"></h3>
                    <div id="payment-methods-container"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="save-payment-settings-btn"><i data-lucide="save"></i> <span data-lang-key="save"></span></button>
                </div>
            `;
            
            history.pushState({ modal: 'paymentSettingsModal' }, 'Payment Settings', '#payment-settings');
            modal.classList.add('active');

            const currencySelector = document.getElementById('currency-selector');
            const methodsContainer = document.getElementById('payment-methods-container');

            function renderMethodsUI(currency) {
                const config = PAYMENT_CONFIGS[currency];
                if (!config) {
                    methodsContainer.innerHTML = '<p>Configura√ß√£o n√£o encontrada para esta moeda.</p>';
                    return;
                }

                methodsContainer.innerHTML = config.methods.map(method => {
                    const methodSettings = currentSettings.methods[method.id] || { active: false, data: '' };
                    const isChecked = methodSettings.active;
                    
                    if (method.type === 'cash') {
                        return `
                        <div class="kpi-card" style="margin-bottom: 15px; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-weight: 600; flex-grow: 1;">${method.label}</label>
                                <div class="switch">
                                    <input type="checkbox" id="toggle-${method.id}" data-method-id="${method.id}" checked disabled>
                                    <label for="toggle-${method.id}"></label>
                                </div>
                            </div>
                        </div>`;
                    } else if (method.type === 'image') {
                        return `
                        <div class="kpi-card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label for="toggle-${method.id}" style="font-weight: 600; flex-grow: 1;">${method.label}</label>
                                <div class="switch">
                                    <input type="checkbox" id="toggle-${method.id}" data-method-id="${method.id}" ${isChecked ? 'checked' : ''}>
                                    <label for="toggle-${method.id}"></label>
                                </div>
                            </div>
                            <div id="fields-${method.id}" style="display: ${isChecked ? 'block' : 'none'};">
                                <label for="input-${method.id}" style="border: 2px dashed var(--border-color); padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; display: block;">
                                    <i data-lucide="upload-cloud"></i>
                                    <span id="label-text-${method.id}">Clique para anexar imagem</span>
                                    <img id="preview-${method.id}" src="${methodSettings.data || ''}" style="display:${methodSettings.data ? 'block' : 'none'}; max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">
                                </label>
                                <input type="file" id="input-${method.id}" accept="image/*" style="display:none;" data-method-id="${method.id}">
                            </div>
                        </div>`;
                    } else {
                         const inputType = method.type === 'textarea' ? 
                            `<textarea id="input-${method.id}" rows="4" placeholder="${method.placeholder || ''}" data-method-id="${method.id}">${methodSettings.data || ''}</textarea>` :
                            `<input type="${method.type}" id="input-${method.id}" placeholder="${method.placeholder || ''}" value="${methodSettings.data || ''}" data-method-id="${method.id}">`;

                        return `
                        <div class="kpi-card" style="margin-bottom: 15px;">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label for="toggle-${method.id}" style="font-weight: 600; flex-grow: 1;">${method.label}</label>
                                <div class="switch">
                                    <input type="checkbox" id="toggle-${method.id}" data-method-id="${method.id}" ${isChecked ? 'checked' : ''}>
                                    <label for="toggle-${method.id}"></label>
                                </div>
                            </div>
                            <div id="fields-${method.id}" class="form-group" style="display: ${isChecked ? 'block' : 'none'};">
                                ${inputType}
                            </div>
                        </div>`;
                    }
                }).join('');
                lucide.createIcons({nodes: methodsContainer.querySelectorAll('[data-lucide]')});
            }

            methodsContainer.addEventListener('change', e => {
                if (e.target.type === 'checkbox') {
                    const methodId = e.target.dataset.methodId;
                    document.getElementById(`fields-${methodId}`).style.display = e.target.checked ? 'block' : 'none';
                }
                 if (e.target.type === 'file') {
                    const file = e.target.files[0];
                    if (!file) return;
                    const methodId = e.target.dataset.methodId;
                    filesToUpload[methodId] = file;
                    const preview = document.getElementById(`preview-${methodId}`);
                    const label = document.getElementById(`label-text-${methodId}`);
                    preview.src = URL.createObjectURL(file);
                    preview.style.display = 'block';
                    label.textContent = file.name;
                }
            });
            
            currencySelector.addEventListener('change', (e) => renderMethodsUI(e.target.value));

            document.getElementById('save-payment-settings-btn').addEventListener('click', async (e) => {
                const saveBtn = e.currentTarget;
                const originalHTML = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Salvando...`;
                lucide.createIcons({nodes: [saveBtn.querySelector('i')]});

                try {
                    const newSettings = {
                        currency: currencySelector.value,
                        methods: {
                            'cash': { active: true, data: '' } // Siempre se guarda el efectivo como activo
                        }
                    };
                    
                    const methodToggles = methodsContainer.querySelectorAll('input[type="checkbox"]');
                    for (const toggle of methodToggles) {
                        const methodId = toggle.dataset.methodId;
                        if (methodId === 'cash') continue; // Ya lo manejamos, saltar

                        const isActive = toggle.checked;
                        const inputEl = document.getElementById(`input-${methodId}`);
                        let data = '';

                        if (isActive) {
                            if (inputEl.type === 'file') {
                                if (filesToUpload[methodId]) {
                                    const formData = new FormData();
                                    formData.append('file', filesToUpload[methodId]);
                                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                                    if (!response.ok) throw new Error(`Upload da imagem para ${methodId} falhou.`);
                                    const result = await response.json();
                                    data = result.secure_url;
                                } else {
                                    data = currentSettings.methods[methodId]?.data || ''; // Mant√©m a imagem antiga se n√£o houver nova
                                }
                            } else {
                                data = inputEl.value;
                            }
                        }
                        
                        newSettings.methods[methodId] = { active: isActive, data: data };
                    }
                    
                    const collectorRef = doc(db, 'collectors', collectorId);
                    await updateDoc(collectorRef, { paymentSettings: newSettings });

                    showToast('Configura√ß√µes de pagamento salvas com sucesso!');
                    window.history.back();

                } catch(error) {
                    console.error("Erro ao salvar configura√ß√µes de pagamento:", error);
                    showToast(error.message || 'Falha ao salvar configura√ß√µes.', true);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalHTML;
                    lucide.createIcons({nodes: [saveBtn.querySelector('i')]});
                }
            });

            document.getElementById('closePaymentSettingsModal').addEventListener('click', () => window.history.back());
            
            renderMethodsUI(currentSettings.currency);
            applyLanguage(currentLang);
            lucide.createIcons({nodes: modal.querySelectorAll('[data-lucide]')});
        }

        function getClientsWithActiveLoans() {
            const result = [];
            allClients.forEach(client => {
                (client.loans || []).forEach((loan, index) => {
                    if (loan.status === 'active') {
                        result.push({ client, loan, loanIndex: index });
                    }
                });
            });
            return result;
        }

        function updateTodaysRouteList() {
            const clientsForRoute = [];
            const today = new Date();
            const dayOfWeek = today.getDay();
            const dayOfMonth = today.getDate();

            allClients.forEach(client => {
                (client.loans || []).forEach((loan, index) => {
                    if (loan.status === 'finished') return; // [CORRECCI√ìN] Se cambi√≥ la condici√≥n para incluir correctamente a todos los clientes del d√≠a (pendientes, atrasados, etc.) y excluir √∫nicamente los pr√©stamos ya finalizados.
                    
                    let isPaymentDay = false;
                    const frequency = loan.paymentFrequency || 'daily';
                    if (frequency === 'daily') isPaymentDay = (loan.paymentDays || []).includes(dayOfWeek);
                    else if (frequency === 'weekly') isPaymentDay = (loan.paymentDays || [])[0] === dayOfWeek;
                    else if (frequency === 'monthly') isPaymentDay = (loan.paymentDays || [])[0] === dayOfMonth;

                    if (isPaymentDay) {
                        // [CORRECCI√ìN 2] Se a√±aden a la ruta solo los clientes cuyo pago de hoy est√° pendiente o atrasado.
                        if (loan.status === 'pending' || loan.status === 'late') {
                            clientsForRoute.push({ client, loan, loanIndex: index });
                        }
                    }
                });
            });

            const optimizedClients = optimizeRoute(clientsForRoute, collectorCurrentLocation);
            renderClientCards(document.getElementById('todays-route-list'), optimizedClients);
            updateDashboard(clientsForRoute.map(item => item.loan));
        }

        function updateAllClientsList() {
            const container = document.getElementById('all-clients-list');
            const searchInput = document.getElementById('client-search-input');
            const activeFilter = document.querySelector('#clients-view .filter-btn.active');
            if (!container || !searchInput || !activeFilter) return;

            const searchTerm = searchInput.value.toLowerCase();
            const filter = activeFilter.dataset.filter;

            let clientsWithLoans = [];
            allClients.forEach(client => {
                (client.loans || []).forEach((loan, loanIndex) => {
                    let passesFilter = true;
                    if (filter !== 'all' && loan.status !== filter) {
                        passesFilter = false;
                    }
                    if (searchTerm && !(client.name.toLowerCase().includes(searchTerm) || (client.address && client.address.toLowerCase().includes(searchTerm)))) {
                        passesFilter = false;
                    }
                    if(passesFilter) {
                        clientsWithLoans.push({ client, loan, loanIndex });
                    }
                });
            });
            
            // Ordena a lista de clientes em ordem alfab√©tica pelo nome
            clientsWithLoans.sort((a, b) => a.client.name.localeCompare(b.client.name));
            
            renderClientCards(container, clientsWithLoans);
        }
        
        function showClientDetails(clientId, loanIndex = 0) {
            const clientDetailView = document.getElementById('clientDetailView');
            const client = allClients.find(c => c.id == clientId);
            if (!client || !client.loans || !client.loans[loanIndex]) return;

            const loan = client.loans[loanIndex];

            // --- INICIO C√ÅLCULO DEL TOTAL PAGADO (PARA MOSTRAR) ---
            const displayTotalPaid = (loan.history || [])
                .filter(h => h.status !== 'pending_verification' && h.status !== 'rejected' && h.status !== 'postponed')
                .reduce((sum, h) => sum + (h.amount || 0), 0);
            // --- FIN C√ÅLCULO ---
            
            let historyHtml = `<p class="no-history">Nenhum pagamento registrado ainda.</p>`;
            if (loan.history && loan.history.length > 0) {
                let paidAmountCounter = 0;
                // [CORRECCI√ìN 1] Procesar el historial en orden cronol√≥gico (del m√°s antiguo al m√°s nuevo) para que el c√°lculo sea correcto.
                const sortedHistory = loan.history
                    .filter(p => p.status !== 'pending_verification') // Ignora los pagos pendientes para el c√°lculo
                    .map((p, index) => ({ ...p, originalIndex: index }))
                    .sort((a, b) => (a.date?.seconds || 0) - (b.date?.seconds || 0));

                // Se mapea en orden cronol√≥gico y luego se invierte el resultado final para mostrar el m√°s nuevo primero.
                historyHtml = sortedHistory.map(p => {
                    if (p.status === 'pending_verification') {
                         // L√≥gica para pagos pendientes, que no afectan el c√°lculo.
                    } else {
                        // L√≥gica para pagos aprobados, que s√≠ afectan.
                        const paymentAmount = p.amount;
                        // [CORRECCI√ìN 2] Usar siempre el valor original y fijo de la cuota para los c√°lculos.
                        const installmentValue = loan.originalInstallmentAmount;
                        
                        let title = '';
                        let description = '';

                        if (installmentValue > 0) {
                            const startInstallment = Math.floor(paidAmountCounter / installmentValue) + 1;
                            const endInstallment = Math.floor((paidAmountCounter + paymentAmount - 0.01) / installmentValue) + 1;
                            
                            if (startInstallment === endInstallment) {
                                title = translations[currentLang].paymentTitle.replace('{start}', startInstallment);
                                const percentage = Math.round((paymentAmount / installmentValue) * 100);
                                if (percentage >= 100) {
                                    const overpay = paymentAmount - installmentValue;
                                    if (overpay > 0.01) {
                                        description = translations[currentLang].paymentDescOverpay.replace('{start}', startInstallment).replace('{overpayAmount}', money(overpay));
                                    } else {
                                        description = translations[currentLang].paymentDescFull.replace('{start}', startInstallment);
                                    }
                                } else {
                                    description = translations[currentLang].paymentDescPartial.replace('{percent}', percentage);
                                }
                            } else {
                                title = translations[currentLang].paymentTitleRange.replace('{start}', startInstallment).replace('{end}', endInstallment);
                                const fullInstallmentsPaid = endInstallment - startInstallment;
                                const remainingAmountForNext = (paidAmountCounter + paymentAmount) % installmentValue;
                                const percentageOfNext = Math.round((remainingAmountForNext / installmentValue) * 100);
                                description = translations[currentLang].paymentDescMultiple.replace('{fullInstallments}', fullInstallmentsPaid).replace('{percent}', percentageOfNext);
                            }
                        }
                        
                        paidAmountCounter += paymentAmount;
                        
                        let dateString = 'Data inv√°lida';
                        let timeString = '';
                        if (p?.date?.seconds) { 
                            const d = new Date(p.date.seconds * 1000);
                            dateString = d.toLocaleDateString('pt-BR'); 
                            timeString = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        }
                        const hasReceipt = p.receiptUrl ? '<i data-lucide="file-text" style="width: 16px; height: 16px; color: var(--text-secondary);"></i>' : '';

                        return `<div class="payment-history-item" data-history-index="${p.originalIndex}" style="cursor: pointer;">
                                    <div class="payment-history-details">
                                        <h4 class="payment-history-title">${title}</h4>
                                        <p class="payment-history-description">${description}</p>
                                    </div>
                                    <div class="payment-history-info">
                                        <span class="payment-date">${dateString} - ${timeString}</span>
                                        <span class="payment-history-amount">${money(p.amount)}</span>
                                        ${hasReceipt}
                                    </div>
                                </div>`;
                    }
                }).reverse().join(''); // Se invierte el array de HTML aqu√≠
            }

            const loanDetails = calculateLoanDetails(loan); // Llama a la nueva funci√≥n
            const lateDays = loanDetails.lateDays;         // Obtiene los d√≠as de atraso del resultado
            const score = Math.max(0, 10 - lateDays);
            let reputationStatusKey = 'reputationBad';
            if (score === 10) reputationStatusKey = 'reputationPerfect';
            else if (score >= 7) reputationStatusKey = 'reputationGood';
            else if (score >= 3) reputationStatusKey = 'reputationRegular';

            let barStatusClass = 'status-bad';
            if (score === 10) barStatusClass = 'status-perfect';
            else if (score >= 7) barStatusClass = 'status-good';
            else if (score >= 3) barStatusClass = 'status-regular';

            const activeLoans = client.loans.filter(l => l.status === 'active');
            const hasMultipleLoans = activeLoans.length > 1;

            clientDetailView.innerHTML = `
                <header class="modal-header" style="justify-content: space-between;">
                    
                    <div style="display: flex; align-items: center;">
    <button id="closeDetailView" class="header-btn" style="margin-right: 10px;"><i data-lucide="arrow-left"></i></button>
    <div>
        <span class="modal-title">${client.name}</span>
        ${client.documentNumber ? `<span style="font-size: 0.8em; color: var(--text-secondary); display: block;">Doc: ${client.documentNumber}</span>` : ''}
    </div>
</div>

                    <button id="editClientBtn" class="header-btn" title="Editar Cliente"><i data-lucide="edit"></i></button>
                </header>
                ${hasMultipleLoans ? `
                <div class="loan-tabs-container" id="loan-tabs-container">
                    ${activeLoans.map((l, index) => `
                        <button class="loan-tab ${index === loanIndex ? 'active' : ''}" data-loan-index="${index}">
                            Pr√©stamo ${index + 1}
                        </button>
                    `).join('')}
                </div>` : ''}
                <div class="modal-content-wrapper">
                  <div class="container">
                    <div class="kpi-card progress-card" style="margin-bottom: 20px;">
                        <h3 class="kpi-title" style="justify-content: center;">Progresso do Empr√©stimo</h3>
                        <div class="progress-circle">
                            <svg><circle class="bg-circle" cx="60" cy="60" r="54"></circle><circle id="client-detail-progress-bar" class="progress-bar" cx="60" cy="60" r="54" style="stroke-dasharray: 339.292; stroke: var(--accent-purple);"></circle></svg>
                            <div class="progress-text" id="client-detail-progress-text"></div>
                        </div>
                    </div>
                    <section class="kpi-grid-profile" style="margin-bottom: 30px;">
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="coins"></i> Total</h3><p class="kpi-value">${money(loan.totalLoan)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="receipt"></i> <span data-lang-key="installmentValue"></span></h3><p class="kpi-value" style="color: var(--accent-purple);">${money(loan.originalInstallmentAmount)}</p></div>
                        <div class="kpi-card"><h3 class="kpi-title"><i data-lucide="trending-up"></i> Pago</h3><p class="kpi-value green">${money(displayTotalPaid)}</p></div>
                    
                        <div class="kpi-card" style="background-color: color-mix(in srgb, var(--danger-color) 5%, var(--surface));">
                            <h3 class="kpi-title"><i data-lucide="alert-triangle" style="color: var(--danger-color);"></i> Mora Acumulada</h3>
                            <p class="kpi-value" style="color: var(--danger-color);">${money(loan.lateFeesAccumulated || 0)}</p>
                   </div>

                   <div class="kpi-card" style="border-color: var(--danger-color);">
                       <h3 class="kpi-title"><i data-lucide="receipt-text"></i> Total Devido Agora</h3>
                       <p class="kpi-value" style="...">${money((loan.totalLoan - displayTotalPaid) + (loan.lateFeesAccumulated || 0))}</p>
                   </div>
                    
                    </section>
                    
                    <section>
                         <h2 class="section-title" data-lang-key="reputationScore"></h2>
                         <div class="kpi-card">
                             <div class="reputation-bar-container">
                                 <div class="reputation-bar ${barStatusClass}" style="width: ${score * 10}%"></div>
                             </div>
                             <div class="reputation-status">
                                 <span class="reputation-value">${score} / 10</span>
                                 <span class="reputation-text ${barStatusClass}" data-lang-key="${reputationStatusKey}"></span>
                             </div>
                         </div>
                    </section>

                    
                    <section style="margin-top: 30px;">
                        <h2 class="section-title">Hist√≥rico de Pagamentos</h2>
                        <div class="client-list">${historyHtml}</div>
                    </section>
                  </div>
                </div>
                <div class="action-buttons">
                    ${loan.status === 'finished' ? `
                        <button class="btn-secondary" id="updateClientDataBtn"><i data-lucide="user-cog"></i> <span data-lang-key="updateClientData"></span></button>
                        <button class="btn-primary" id="createNewLoanBtn" ${activeLoans.length >= 4 ? 'disabled' : ''}><i data-lucide="plus-circle"></i> <span data-lang-key="createNewLoan"></span></button>
                    ` : `
                        <button class="btn-secondary" id="startRouteBtn"><i data-lucide="navigation"></i> <span data-lang-key="startRoute"></span></button>
                        <button class="btn-secondary" id="postponePaymentBtn"><i data-lucide="calendar-plus"></i> <span data-lang-key="postponePayment"></span></button>
                        <button class="btn-secondary" id="createNewLoanBtn" ${activeLoans.length >= 4 ? 'disabled' : ''}><i data-lucide="plus-circle"></i> <span data-lang-key="createNewLoan"></span></button>
                        <button class="btn-primary" id="registerPaymentBtn"><i data-lucide="dollar-sign"></i> Registrar Pagamento</button>
                    `}
                </div>`;
            
            history.pushState({ modal: 'clientDetailView', clientId: clientId, loanIndex: loanIndex }, `Details for ${client.name}`, `#client/${clientId}/${loanIndex}`);
            clientDetailView.classList.add('active');

            const paidInstallments = loan.originalInstallmentAmount > 0 ? Math.floor(displayTotalPaid / loan.originalInstallmentAmount) : 0;
            const totalInstallmentsString = (loan.installments || "0/0").split('/')[1];
            const totalInstallments = totalInstallmentsString ? parseInt(totalInstallmentsString, 10) : 0;
            const progressPercentage = totalInstallments > 0 ? (paidInstallments / totalInstallments) * 100 : 0;
            const circleCircumference = 2 * Math.PI * 54;
            const strokeDashoffset = circleCircumference - (progressPercentage / 100) * circleCircumference;
            
            const progressBar = document.getElementById('client-detail-progress-bar');
            const progressText = document.getElementById('client-detail-progress-text');

            if(progressBar && progressText) {
                progressBar.style.strokeDashoffset = strokeDashoffset;
                progressText.textContent = `${paidInstallments}/${totalInstallments}`;
            }

            if (hasMultipleLoans) {
                clientDetailView.querySelectorAll('.loan-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const newLoanIndex = parseInt(e.currentTarget.dataset.loanIndex, 10);
                        showClientDetails(clientId, newLoanIndex);
                    });
                });
            }

            lucide.createIcons({ nodes: clientDetailView.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);
            document.getElementById('closeDetailView').addEventListener('click', () => window.history.back());
            document.getElementById('editClientBtn').addEventListener('click', () => showClientFormModal(clientId, false, loanIndex));
            
            if (loan.status === 'finished') {
                document.getElementById('createNewLoanBtn').addEventListener('click', () => showClientFormModal(clientId, true));
                document.getElementById('updateClientDataBtn').addEventListener('click', () => showClientFormModal(clientId, false, loanIndex));
            } else {
                document.getElementById('registerPaymentBtn').addEventListener('click', () => showPaymentModal(clientId, loanIndex));
                document.getElementById('createNewLoanBtn').addEventListener('click', () => showClientFormModal(clientId, true));
                document.getElementById('postponePaymentBtn').addEventListener('click', () => {
                    showConfirmationModal(
                        translations[currentLang].postponeConfirmTitle,
                        translations[currentLang].postponeConfirmMsg,
                        async () => {
                            const clientRef = doc(db, 'clients', clientId);
                            try {
                                const updatedLoans = [...client.loans];
                                updatedLoans[loanIndex].history.push({ amount: 0, date: new Date(), status: 'postponed' });
                                await updateDoc(clientRef, { loans: updatedLoans });
                                window.history.back(); 
                                setTimeout(() => window.history.back(), 50);
                                showToast('Pagamento adiado com sucesso!');
                            } catch(error) {
                                console.error("Error postponing payment: ", error);
                                showToast('Falha ao adiar pagamento.', true);
                            }
                        }
                    );
                });
            
                const startRouteBtn = document.getElementById('startRouteBtn');
                if (client.location) {
                    startRouteBtn.addEventListener('click', () => {
                        // 1. Enviar notificaci√≥n al cliente
                        const notifTitle = translations[currentLang].collectorOnTheWayTitle;
                        const notifBody = translations[currentLang].collectorOnTheWayBody;
                        sendNotificationToClient(clientId, notifTitle, notifBody, 'on_the_way', 'navigation');
                        showToast('Notifica√ß√£o enviada ao cliente!');

                        // 2. Abrir el mapa para la navegaci√≥n
                        window.open(client.location, '_blank');
                    });
                } else {
                    startRouteBtn.disabled = true;
                    startRouteBtn.style.opacity = '0.5';
                }
            }
            
            clientDetailView.querySelectorAll('.payment-history-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const historyIndex = e.currentTarget.dataset.historyIndex;
                    showPaymentDetailModal(clientId, parseInt(historyIndex, 10));
                });
            });

            
        }

        function showMapPinModal() {
            const mapPinModal = document.getElementById('mapPinModal');
            mapPinModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeMapPinModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Selecionar Localiza√ß√£o</span>
                </header>
                <div class="modal-content-wrapper" style="padding:0; position:relative; display:flex; justify-content:center; align-items:center; background-color: var(--border-color);">
                    <div id="pin-map-container" style="width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s;"></div>
                    <div id="map-loading-overlay" style="position: absolute; z-index: 1001; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <i data-lucide="loader-circle" style="animation: spin 1s linear infinite; width: 32px; height: 32px;"></i>
                        <p style="margin: 10px 0 0;">Obtendo sua localiza√ß√£o...</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="confirmPinLocationBtn" disabled><i data-lucide="check-circle"></i> Confirmar Localiza√ß√£o</button>
                </div>
            `;
            history.pushState({ modal: 'mapPinModal' }, 'Map Pin', '#map-pin');
            mapPinModal.classList.add('active');
            lucide.createIcons({ nodes: mapPinModal.querySelectorAll('[data-lucide]') });

            const mapContainer = document.getElementById('pin-map-container');
            const loadingOverlay = document.getElementById('map-loading-overlay');
            const confirmBtn = document.getElementById('confirmPinLocationBtn');

            const initializeMap = (centerCoords) => {
                loadingOverlay.style.display = 'none';
                confirmBtn.disabled = false;
                mapContainer.style.opacity = '1';
                
                const map = L.map(mapContainer).setView(centerCoords, 16); // Centrado din√°micamente
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                // A√±ade un pin fijo en el centro del mapa para una mejor UX
                const pinHtml = `<div style="position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); z-index: 1000; pointer-events: none;"><i data-lucide="map-pin" style="width: 48px; height: 48px; color: var(--danger-color); filter: drop-shadow(0 3px 5px rgba(0,0,0,0.5));"></i></div>`;
                mapContainer.insertAdjacentHTML('beforeend', pinHtml);
                lucide.createIcons({ nodes: [mapContainer.querySelector('i')] });

                mapPinModal.querySelector('#confirmPinLocationBtn').addEventListener('click', () => {
                    const { lat, lng } = map.getCenter(); // Obtiene las coordenadas del centro del mapa
                    const locationUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                    const locationInput = document.getElementById('client-location');
                    if (locationInput) {
                        locationInput.value = locationUrl;
                    }
                    window.history.back();
                });
            };

            mapPinModal.querySelector('#closeMapPinModal').addEventListener('click', () => window.history.back());
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        initializeMap([position.coords.latitude, position.coords.longitude]);
                    },
                    (error) => {
                        console.warn(`Error de geolocalizaci√≥n (${error.code}): ${error.message}`);
                        showToast('N√£o foi poss√≠vel obter a localiza√ß√£o. Usando localiza√ß√£o padr√£o.', true);
                        initializeMap([-16.68, -49.25]); // Fallback a Goi√¢nia si falla
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showToast('Geolocaliza√ß√£o n√£o √© suportada neste navegador.', true);
                initializeMap([-16.68, -49.25]); // Fallback para navegadores antiguos
            }
        }
        function showPaymentModal(clientId, loanIndex) {
            const paymentModal = document.getElementById('paymentModal');
            const client = allClients.find(c => c.id === clientId);
            const loan = client.loans[loanIndex];

            paymentModal.innerHTML = `
                <header class="modal-header">
                    <button id="closePaymentModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">Registrar Pagamento para ${client.name} (Pr√©stamo ${loanIndex + 1})</span>
                </header>
                <div class="modal-content-wrapper container">
                    <div class="kpi-card" style="text-align:center;">
                        <h3 class="kpi-title" style="justify-content:center;" data-lang-key="installmentValue"></h3>
                        <p class="kpi-value green">${money(loan.amount)}</p>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                    <label for="payment-amount-input" data-lang-key="amountPaid"></label>
                    <input type="number" id="payment-amount-input" step="0.01" value="${loan.amount.toFixed(2)}" style="font-size: 1.2em; text-align: center; font-weight: 600;">
                </div>
                    <h3 class="section-title" style="margin-top: 30px;">M√©todo de Pagamento</h3>
                    <div class="radio-group" id="payment-method-selector">
                        <input type="radio" name="paymentMethod" id="method-dinheiro" value="dinheiro" checked>
                        <label for="method-dinheiro"><i class="icon" data-lucide="banknote"></i><span data-lang-key="receivedInCash"></span></label>
                        
                        <input type="radio" name="paymentMethod" id="method-pix" value="pix">
                        <label for="method-pix"><i class="icon" data-lucide="smartphone"></i><span>PIX</span></label>
                        
                        <input type="radio" name="paymentMethod" id="method-cartao" value="cartao">
                        <label for="method-cartao"><i class="icon" data-lucide="credit-card"></i><span>Cart√£o</span></label>
                    </div>
                    <div class="form-group" id="receipt-upload-section" style="display: none; margin-top: 20px;">
                        <label data-lang-key="uploadReceipt"></label>
                        <label for="payment-receipt-input" style="border: 2px dashed var(--border-color); padding: 20px; border-radius: 12px; cursor: pointer; text-align: center; display: block;">
                            <i data-lucide="upload-cloud"></i>
                            <span id="payment-upload-label-text">Clique para anexar</span>
                            <img id="payment-receipt-preview" style="display:none; max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">
                        </label>
                        <input type="file" id="payment-receipt-input" accept="image/*" style="display:none;">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="confirmPaymentBtn"><i data-lucide="check-circle"></i> Confirmar Pagamento</button>
                </div>`;
            
            history.pushState({ modal: 'paymentModal' }, 'Payment', '#payment');
            paymentModal.classList.add('active');
            lucide.createIcons({ nodes: paymentModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);

            paymentModal.querySelector('#closePaymentModal').addEventListener('click', () => window.history.back());
            
            const paymentMethodSelector = paymentModal.querySelector('#payment-method-selector');
            const receiptUploadSection = paymentModal.querySelector('#receipt-upload-section');
            let receiptFile = null;

            paymentMethodSelector.addEventListener('change', (e) => {
                const selectedInputs = document.querySelectorAll('input[name="paymentMethod"]');
                selectedInputs.forEach(input => {
                    const method = input.value;
                     if(input.checked && (method === 'pix' || method === 'cartao')) {
                        receiptUploadSection.style.display = 'block';
                     } else if (input.checked && method === 'dinheiro') {
                        receiptUploadSection.style.display = 'none';
                        receiptFile = null;
                        const preview = document.getElementById('payment-receipt-preview');
                        if (preview) {
                            preview.style.display = 'none';
                            preview.src = '';
                        }
                        const label = document.getElementById('payment-upload-label-text');
                        if (label) label.textContent = 'Clique para anexar';
                     }
                });
            });

            paymentModal.querySelector('#payment-receipt-input').addEventListener('change', e => {
                if (e.target.files && e.target.files[0]) {
                    receiptFile = e.target.files[0];
                    const preview = document.getElementById('payment-receipt-preview');
                    const uploadLabel = document.getElementById('payment-upload-label-text');
                    preview.src = URL.createObjectURL(receiptFile);
                    preview.style.display = 'block';
                    uploadLabel.textContent = receiptFile.name;
                }
            });
            
            paymentModal.querySelector('#confirmPaymentBtn').addEventListener('click', async (e) => {
            const confirmBtn = e.currentTarget;
            const originalBtnHTML = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> Processando...`;
            lucide.createIcons({nodes: confirmBtn.querySelectorAll('[data-lucide]')});

            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            try {
                let receiptUrl = '';
                if (receiptFile && (selectedMethod === 'pix' || selectedMethod === 'cartao')) {
                    const formData = new FormData();
                    formData.append('file', receiptFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Cloudinary receipt upload failed');
                    const data = await response.json();
                    receiptUrl = data.secure_url;
                }

                const actualPaidAmount = parseFloat(document.getElementById('payment-amount-input').value);
                if (isNaN(actualPaidAmount) || actualPaidAmount < 0) {
                    showToast('Por favor, insira um valor de pagamento v√°lido.', true);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = originalBtnHTML;
                    lucide.createIcons({nodes: confirmBtn.querySelectorAll('[data-lucide]')});
                    return;
                }

                const clientRef = doc(db, "clients", clientId);
                
                

                const newPayment = {
                    amount: actualPaidAmount,
                    date: new Date(),
                    status: 'approved',
                    method: selectedMethod
                };

                if(receiptUrl) {
                    newPayment.receiptUrl = receiptUrl;
                }
                
                if (!currentLoan.history) currentLoan.history = [];
                currentLoan.history.push(newPayment);

                await updateDoc(clientRef, {
                    loans: updatedLoans
                });

                window.history.back();
                setTimeout(() => window.history.back(), 50);
                showToast('Pagamento registrado com sucesso!');

            } catch(error) {
                console.error("Error updating document: ", error);
                showToast('Falha ao registrar pagamento.', true);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalBtnHTML;
                lucide.createIcons({nodes: confirmBtn.querySelectorAll('[data-lucide]')});
            }
        });
        }
        
        function showClientFormModal(clientId = null, isNewLoan = false, loanIndex = 0) {
            const isEditMode = clientId !== null && !isNewLoan;
            const client = isEditMode ? allClients.find(c => c.id === clientId) : (clientId ? allClients.find(c => c.id === clientId) : {});
            const loan = isEditMode ? client.loans[loanIndex] : {};

            let filesToUpload = [];
            let existingDocs = isEditMode ? [...(client.documents || [])] : (client.documents || []);

            const clientFormModal = document.getElementById('clientFormModal');
            
            const modalTitleKey = isEditMode ? 'editClient' : 'addNewClient';
            const saveButtonKey = isEditMode ? 'saveChanges' : 'saveClient';

            clientFormModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeClientFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="${modalTitleKey}"></span>
                </header>
                <div class="modal-content-wrapper">
                  <div class="container">
                    <form id="client-form">
                        <div class="form-group"><label data-lang-key="clientName"></label><input type="text" id="client-name" required value="${client.name || ''}" ${isNewLoan ? 'readonly' : ''}></div>
                        <div class="form-group"><label data-lang-key="documentNumber"></label><input type="text" id="client-document" value="${client.documentNumber || ''}" ${isNewLoan ? 'readonly' : ''}></div>
                        <div id="system-verification-results" style="margin-bottom: 20px;"></div>
                        <div class="form-group"><label data-lang-key="address"></label><input type="text" id="client-address" required value="${client.address || ''}"></div>
                        <div class="form-group"><label data-lang-key="city"></label><input type="text" id="client-city" required value="${client.city || ''}"></div>
                        <div class="form-group"><label data-lang-key="whatsapp"></label><input type="tel" id="client-whatsapp" required value="${client.whatsapp || ''}"></div>
                        <div class="form-group">
                            <label data-lang-key="location"></label>
                            <input type="text" id="client-location" readonly placeholder="Clique no bot√£o para obter" value="${client.location || ''}">
                            <button type="button" class="btn-secondary" id="get-location-btn" style="width: 100%; margin-top: 10px;">
                                <i data-lucide="map-pin"></i> Obter Localiza√ß√£o GPS
                            </button>
                        </div>
                        
                        <!-- Client Access Section -->
                        <h3 class="section-title" data-lang-key="clientAccess" style="margin-top:30px; border-top: 1px solid var(--border-color); padding-top: 20px;"></h3>
                        <div class="form-group">
                            <label data-lang-key="username"></label>
                            <input type="text" id="client-username" required value="${client.username || ''}" ${ (isEditMode && client.username) || isNewLoan ? 'readonly' : '' }>
                            <div id="username-validation-msg"></div>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="password"></label>
                            <input type="password" id="client-password" required value="${client.password || ''}">
                        </div>

                        <h3 class="section-title" style="margin-top:30px; border-top: 1px solid var(--border-color); padding-top: 20px;">Detalhes do Empr√©stimo</h3>
                        
                        <div class="form-group grid-2">
                            <div><label data-lang-key="totalLoan"></label><input type="number" id="client-loan-amount" required value="${isEditMode ? (loan.totalLoan / (1 + client.interestRate/100)) : ''}"></div>
                            <div><label data-lang-key="interest"></label><input type="number" id="client-interest" required value="${client.interestRate || '20'}" ${isEditMode ? 'readonly' : ''}></div>
                        </div>

                        <div class="form-group">
                        <label for="client-late-fee">Tasa de Mora Diaria (%)</label>
                        <input type="number" id="client-late-fee" step="0.1" value="${loan.lateFeeRate !== undefined ? loan.lateFeeRate : '0'}" placeholder="0.0">
                        </div>

                        <div class="form-group"><label data-lang-key="totalToPay"></label><input type="text" id="client-total-to-pay" readonly></div>
                        <div class="form-group grid-2">
                            <div><label data-lang-key="numInstallments"></label><input type="number" id="client-installments" required value="${isEditMode ? (loan.installments || '').split('/')[1] : ''}"></div>
                            <div><label data-lang-key="installmentValue"></label><input type="text" id="client-installment-value" readonly></div>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="paymentFrequency"></label>
                            <select id="payment-frequency" class="form-control">
                                <option value="daily" data-lang-key="daily"></option>
                                <option value="weekly" data-lang-key="weekly"></option>
                                <option value="monthly" data-lang-key="monthly"></option>
                            </select>
                        </div>
                        <div id="payment-days-container">
                            <div id="daily-payment-selector">
                                <label data-lang-key="paymentDays"></label>
                                <div class="day-selector">
                                    ${['D','S','T','Q','Q','S','S'].map((day, i) => `<div><input type="checkbox" id="form-day-${i}" value="${i}"><label for="form-day-${i}">${day}</label></div>`).join('')}
                                </div>
                            </div>
                            <div id="weekly-payment-selector" style="display: none;">
                                 <div class="form-group">
                                    <label data-lang-key="dayOfWeek"></label>
                                    <select id="weekly-day-select" class="form-control">
                                        <option value="1" data-lang-key="monday"></option>
                                        <option value="2" data-lang-key="tuesday"></option>
                                        <option value="3" data-lang-key="wednesday"></option>
                                        <option value="4" data-lang-key="thursday"></option>
                                        <option value="5" data-lang-key="friday"></option>
                                        <option value="6" data-lang-key="saturday"></option>
                                        <option value="0" data-lang-key="sunday"></option>
                                    </select>
                                </div>
                            </div>
                            <div id="monthly-payment-selector" style="display: none;">
                                 <div class="form-group">
                                    <label data-lang-key="dayOfMonth"></label>
                                    <input type="number" id="monthly-day-input" min="1" max="31" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="collectionTimeLabel"></label>
                            <input type="time" id="client-collection-time" value="${client.collectionTime || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label data-lang-key="clientDocs"></label>
                            <div id="doc-preview-container" style="margin-bottom: 15px;"></div>
                            <div class="grid-2">
                                <button type="button" class="btn-secondary" id="take-photo-btn"><i data-lucide="camera"></i> <span data-lang-key="takePhoto"></span></button>
                                <button type="button" class="btn-secondary" id="upload-file-btn"><i data-lucide="upload"></i> <span data-lang-key="uploadFile"></span></button>
                            </div>
                            <input type="file" id="doc-file-input" multiple accept="image/*,application/pdf" style="display: none;">
                        </div>
                    </form>
                  </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="saveClientBtn"><i data-lucide="save"></i> <span data-lang-key="${saveButtonKey}"></span></button>
                </div>`;
            history.pushState({ modal: 'clientFormModal' }, 'Client Form', '#client-form');
            clientFormModal.classList.add('active');
            
            const paymentFrequencySelect = document.getElementById('payment-frequency');
            const dailySelector = document.getElementById('daily-payment-selector');
            const weeklySelector = document.getElementById('weekly-payment-selector');
            const monthlySelector = document.getElementById('monthly-payment-selector');

            const handleFrequencyChange = (frequency) => {
                dailySelector.style.display = 'none';
                weeklySelector.style.display = 'none';
                monthlySelector.style.display = 'none';
                if (frequency === 'daily') {
                    dailySelector.style.display = 'block';
                } else if (frequency === 'weekly') {
                    weeklySelector.style.display = 'block';
                } else if (frequency === 'monthly') {
                    monthlySelector.style.display = 'block';
                }
            };

            paymentFrequencySelect.addEventListener('change', (e) => handleFrequencyChange(e.target.value));

            if (isEditMode) {
                paymentFrequencySelect.value = loan.paymentFrequency || 'daily';
                handleFrequencyChange(loan.paymentFrequency || 'daily');

                if ((loan.paymentFrequency || 'daily') === 'daily') {
                    (loan.paymentDays || []).forEach(day => {
                        const checkbox = document.getElementById(`form-day-${day}`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else if (loan.paymentFrequency === 'weekly') {
                    document.getElementById('weekly-day-select').value = (loan.paymentDays || [1])[0];
                } else if (loan.paymentFrequency === 'monthly') {
                    document.getElementById('monthly-day-input').value = (loan.paymentDays || [1])[0];
                }
            } else {
                paymentFrequencySelect.value = 'daily';
                handleFrequencyChange('daily');
                // Default days for new client or new loan
                [1,2,3,4,5,6].forEach(day => { 
                    const checkbox = document.getElementById(`form-day-${day}`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            let isUsernameAvailable = (isEditMode || isNewLoan); 
            const usernameInput = document.getElementById('client-username');
            const validationMsg = document.getElementById('username-validation-msg');

            usernameInput.addEventListener('blur', async () => {
                const username = usernameInput.value.trim();
                if (!username) {
                    validationMsg.textContent = '';
                    isUsernameAvailable = false;
                    return;
                }
                if ((isEditMode || isNewLoan) && username === client.username) {
                     validationMsg.textContent = '';
                     isUsernameAvailable = true;
                     return;
                }
                
                validationMsg.textContent = 'Verificando...';
                validationMsg.className = '';

                const q = query(collection(db, "clients"), where("username", "==", username));
                const querySnapshot = await getDocs(q);
                
                let isTaken = false;
                if (!querySnapshot.empty) {
                    if (isEditMode) {
                        isTaken = querySnapshot.docs.some(doc => doc.id !== clientId);
                    } else {
                        isTaken = true;
                    }
                }

                if (isTaken) {
                    validationMsg.textContent = translations[currentLang].usernameTaken;
                    validationMsg.classList.add('invalid');
                    isUsernameAvailable = false;
                } else {
                    validationMsg.textContent = translations[currentLang].usernameAvailable;
                    validationMsg.classList.add('valid');
                    isUsernameAvailable = true;
                }
            });

            const docPreviewContainer = document.getElementById('doc-preview-container');

            function renderDocPreviews() {
                docPreviewContainer.innerHTML = '';
                if(existingDocs.length === 0 && filesToUpload.length === 0){
                    docPreviewContainer.innerHTML = `<p class="no-items" style="padding: 10px 0;">Nenhum documento anexado.</p>`;
                }

                existingDocs.forEach((doc, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `<span><a href="${doc.url}" target="_blank" rel="noopener noreferrer" style="color: var(--text-primary); text-decoration: none;">${doc.name}</a></span><button type="button" data-index="${index}" class="remove-existing-doc" style="background:none; border:none; color: var(--danger-color); cursor:pointer;"><i data-lucide="trash-2"></i></button>`;
                    docPreviewContainer.appendChild(previewItem);
                });
                 filesToUpload.forEach((file, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `<span>${file.name} (novo)</span><button type="button" data-index="${index}" class="remove-new-doc" style="background:none; border:none; color: var(--danger-color); cursor:pointer;"><i data-lucide="trash-2"></i></button>`;
                    docPreviewContainer.appendChild(previewItem);
                });
                lucide.createIcons({nodes: docPreviewContainer.querySelectorAll('i')});
            }

            docPreviewContainer.addEventListener('click', (e) => {
                const removeExistingBtn = e.target.closest('.remove-existing-doc');
                if (removeExistingBtn) {
                    const index = parseInt(removeExistingBtn.dataset.index, 10);
                    existingDocs.splice(index, 1);
                    renderDocPreviews();
                }

                const removeNewBtn = e.target.closest('.remove-new-doc');
                if (removeNewBtn) {
                    const index = parseInt(removeNewBtn.dataset.index, 10);
                    filesToUpload.splice(index, 1);
                    renderDocPreviews();
                }
            });


            if(isEditMode) renderDocPreviews();

            function handleFiles(selectedFiles) {
                filesToUpload.push(...selectedFiles);
                renderDocPreviews();
            }

            document.getElementById('take-photo-btn').addEventListener('click', () => {
                const docFileInput = document.getElementById('doc-file-input');
                docFileInput.setAttribute('capture', 'camera');
                docFileInput.click();
            });
            document.getElementById('upload-file-btn').addEventListener('click', () => {
                 const docFileInput = document.getElementById('doc-file-input');
                docFileInput.removeAttribute('capture');
                docFileInput.click();
            });
            document.getElementById('doc-file-input').addEventListener('change', (e) => handleFiles(Array.from(e.target.files)));

            const loanAmountInput = document.getElementById('client-loan-amount');
            const interestInput = document.getElementById('client-interest');
            const installmentsInput = document.getElementById('client-installments');
            const totalToPayInput = document.getElementById('client-total-to-pay');
            const installmentValueInput = document.getElementById('client-installment-value');

            function calculateLoanDetails() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const interest = parseFloat(interestInput.value) || 0;
                const installments = parseInt(installmentsInput.value) || 0;
                const totalToPay = loanAmount * (1 + (interest / 100));
                const installmentValue = installments > 0 ? totalToPay / installments : 0;
                totalToPayInput.value = money(totalToPay);
                installmentValueInput.value = money(installmentValue);
            }

            [loanAmountInput, interestInput, installmentsInput].forEach(input => input.addEventListener('input', calculateLoanDetails));
            calculateLoanDetails();

            document.getElementById('get-location-btn').addEventListener('click', () => {
                showMapPinModal();
            });
            
            document.getElementById('closeClientFormModal').addEventListener('click', () => window.history.back());
            
            document.getElementById('saveClientBtn').addEventListener('click', async (e) => {
                const saveButton = e.currentTarget;
                const originalButtonHTML = saveButton.innerHTML;
                
                const clientNameInput = document.getElementById('client-name');
                const loanAmountInputVal = document.getElementById('client-loan-amount');
                const usernameInputVal = document.getElementById('client-username');
                const passwordInputVal = document.getElementById('client-password');
                const whatsappInputVal = document.getElementById('client-whatsapp');
                
                
                if (!clientNameInput.value || !loanAmountInputVal.value || !usernameInputVal.value || !passwordInputVal.value || !whatsappInputVal.value) {
                    showToast('Nome, WhatsApp, Valor do Empr√©stimo, Usu√°rio e Senha s√£o obrigat√≥rios.', true);
                    return;
                }
                
                if (!isUsernameAvailable) {
                     showToast(translations[currentLang].usernameTaken, true);
                     return;
                }

                saveButton.disabled = true;
                saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> <span>Salvando...</span>`;
                lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

                try {
                    let newUploadedDocuments = [];
                    if (filesToUpload.length > 0) {
                        const uploadPromises = filesToUpload.map(async (file) => {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                            const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                            if (!response.ok) { throw new Error(`Cloudinary upload failed: ${response.statusText}`); }
                            const data = await response.json();
                            return { name: file.name, url: data.secure_url };
                        });
                        newUploadedDocuments = await Promise.all(uploadPromises);
                    }

                    const finalDocuments = [...existingDocs, ...newUploadedDocuments];
                    const loanAmount = parseFloat(document.getElementById('client-loan-amount').value);
                    const interest = parseFloat(document.getElementById('client-interest').value);
                    const installments = parseInt(document.getElementById('client-installments').value);
                    const totalToPay = loanAmount * (1 + (interest / 100));
                    const installmentValue = installments > 0 ? totalToPay / installments : 0;
                    const principalAmount = loanAmount;
                   

                    const paymentFrequency = document.getElementById('payment-frequency').value;
                    let paymentDaysValue = [];

                    if (paymentFrequency === 'daily') {
                        paymentDaysValue = Array.from(document.querySelectorAll('#daily-payment-selector input:checked')).map(el => parseInt(el.value));
                    } else if (paymentFrequency === 'weekly') {
                        paymentDaysValue = [parseInt(document.getElementById('weekly-day-select').value)];
                    } else if (paymentFrequency === 'monthly') {
                        const day = parseInt(document.getElementById('monthly-day-input').value);
                        if (day >= 1 && day <= 31) {
                            paymentDaysValue = [day];
                        } else {
                            showToast('Por favor, insira um dia do m√™s v√°lido (1-31).', true);
                            saveButton.disabled = false;
                            saveButton.innerHTML = originalButtonHTML;
                            lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
                            return;
                        }
                    }

                    const clientGeneralData = {
                        name: document.getElementById('client-name').value,
                        documentNumber: document.getElementById('client-document').value,
                        address: document.getElementById('client-address').value,
                        city: document.getElementById('client-city').value,
                        whatsapp: document.getElementById('client-whatsapp').value,
                        location: document.getElementById('client-location').value,
                        username: document.getElementById('client-username').value.trim(),
                        password: document.getElementById('client-password').value,
                        documents: finalDocuments,
                        collectorId: collectorId,
                        interestRate: interest
                    };

                    const loanSpecificData = {
                        principalAmount: principalAmount,
                        lateFeeRate: parseFloat(document.getElementById('client-late-fee').value) || 0,
                        totalLoan: totalToPay,
                        amount: installmentValue,
                        originalInstallmentAmount: installmentValue,
                        installments: `0/${installments}`,
                        paid: 0,
                        paymentBalance: 0,
                        status: 'active',
                        startDate: new Date(),
                        history: [],
                        paymentFrequency: paymentFrequency,
                        paymentDays: paymentDaysValue,
                        collectionTime: document.getElementById('client-collection-time').value,
                    };

                    if (isNewLoan) {
                        const clientRef = doc(db, 'clients', clientId);
                        await updateDoc(clientRef, {
                            loans: arrayUnion(loanSpecificData),
                             // Actualiza tambi√©n los datos generales por si cambiaron
                            ...clientGeneralData
                        });
                    } else if (isEditMode) {
                         const clientRef = doc(db, 'clients', clientId);
                         const updatedLoans = [...client.loans];
                         updatedLoans[loanIndex] = {
                             ...updatedLoans[loanIndex], // Mant√©n datos antiguos como historial, paid, etc.
                             lateFeeRate: parseFloat(document.getElementById('client-late-fee').value) || 0,
                             totalLoan: totalToPay,
                             amount: installmentValue,
                             originalInstallmentAmount: installmentValue,
                             installments: `${(loan.installments || '0/0').split('/')[0]}/${installments}`,
                             paymentFrequency: paymentFrequency,
                             paymentDays: paymentDaysValue,
                             collectionTime: document.getElementById('client-collection-time').value,
                         };
                         await updateDoc(clientRef, {
                             loans: updatedLoans,
                             ...clientGeneralData
                         });
                    } else { // Creando cliente nuevo
                        const newClientData = {
                            ...clientGeneralData,
                            loans: [loanSpecificData]
                        };
                        await addDoc(collection(db, "clients"), newClientData);
                    }
                    
                    window.history.back(); // Cierra el modal de formulario
                    
                    const successToastMessage = isEditMode ? translations[currentLang].clientUpdatedSuccess : translations[currentLang].clientRegisteredSuccess;
                    showToast(successToastMessage);

                    // Para clientes nuevos o si se est√° creando un nuevo pr√©stamo, muestra el modal para compartir credenciales.
                    if (!isEditMode || isNewLoan) { 
                        setTimeout(() => {
                           showShareCredentialsModal(clientGeneralData, isEditMode);
                        }, 400); // Peque√±o retraso para permitir que el modal anterior se cierre.
                    }

                } catch (error) {
                    console.error("Error al guardar cliente:", error);
                    showToast(error.message || 'Ocurri√≥ un error al guardar los datos.', true);
                } finally {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonHTML;
                    lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
                }
            });

            lucide.createIcons({ nodes: clientFormModal.querySelectorAll('[data-lucide]') });
            applyLanguage(currentLang);
            const docInput = document.getElementById('client-document');
if (docInput) {
    docInput.addEventListener('blur', () => triggerSystemVerification(clientId));
}
// Si estamos editando un cliente que ya tiene documento, ejecuta la verificaci√≥n al cargar
if (isEditMode && client.documentNumber) {
    triggerSystemVerification(clientId);
}
        }

        function showShareCredentialsModal(clientData, isEditMode) {
            const modal = document.getElementById('shareCredentialsModal');
            const titleKey = isEditMode ? 'clientUpdatedSuccess' : 'clientRegisteredSuccess';
            const appLink = 'https://cliente.lumixartificial.com'; // Link actualizado

            let messageTemplate = translations[currentLang].whatsappMessageTemplate;
            messageTemplate = messageTemplate.replace('{clientName}', clientData.name)
                                             .replace('{appLink}', appLink)
                                             .replace('{username}', clientData.username)
                                             .replace('{password}', clientData.password);
            
            const cleanPhoneNumber = clientData.whatsapp.replace(/\D/g, '');
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${cleanPhoneNumber}&text=${encodeURIComponent(messageTemplate)}`;

            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closeShareModal"><i data-lucide="x"></i></button>
                    <span class="modal-title" data-lang-key="${titleKey}"></span>
                </header>
                <div class="modal-content-wrapper">
                    <div class="container" style="text-align: center;">
                        <i data-lucide="check-circle" style="color: var(--accent-green); width: 80px; height: 80px; stroke-width: 1.5; margin-bottom: 20px;"></i>
                        <h3 data-lang-key="appInstructions"></h3>
                        <div style="background-color: var(--surface); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; margin-top: 20px; text-align: left; display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <strong data-lang-key="appLink"></strong>: <a href="${appLink}" target="_blank" style="color: var(--accent-purple);">${appLink}</a>
                            </div>
                            <div>
                                <strong data-lang-key="username"></strong>: ${clientData.username}
                            </div>
                            <div>
                                <strong data-lang-key="password"></strong>: ${clientData.password}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="share-whatsapp-btn">
                        <i data-lucide="send"></i> <span data-lang-key="shareOnWhatsApp"></span>
                    </button>
                </div>
            `;

            history.pushState({ modal: 'shareCredentialsModal' }, 'Share Credentials', '#share');
            modal.classList.add('active');
            
            applyLanguage(currentLang);
            lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });

            document.getElementById('closeShareModal').addEventListener('click', () => {
                window.history.back();
            });

            document.getElementById('share-whatsapp-btn').addEventListener('click', () => {
                window.open(whatsappUrl, '_blank');
            });
        }

        

        // --- M√ìDULO DE GASTOS ---
        function renderExpensesList(expenses) {
            const container = document.getElementById('expenses-list-container');
            if (!container) return;
            if (expenses.length === 0) {
                container.innerHTML = `<div class="no-items">Nenhum gasto encontrado.</div>`;
                return;
            }
            container.innerHTML = expenses
                .sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0))
                .map(expense => {
                    const categoryText = (translations[currentLang] && translations[currentLang][expense.category]) || expense.category;
                    const dateText = expense.date?.seconds ? new Date(expense.date.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A';
                    return `
                        <div class="expense-card" data-expense-id="${expense.id}">
                            <div class="expense-info">
                                <h4 class="expense-category">${categoryText}</h4>
                                <p class="expense-obs">${expense.observations || 'Sem observa√ß√µes'}</p>
                            </div>
                            <div class="expense-value-info">
                                <span class="expense-amount">-${money(expense.value)}</span>
                                <span class="expense-date">${dateText}</span>
                            </div>
                        </div>`;
                }).join('');
        }

        function updateExpensesView() {
            const container = document.getElementById('expenses-list-container');
            const periodFilter = document.querySelector('#expenses-view [data-period].active');
            const categoryFilter = document.querySelector('#expenses-view [data-category].active');
            if (!container || !periodFilter || !categoryFilter) return;

            const period = periodFilter.dataset.period;
            const category = categoryFilter.dataset.category;
            
            let filteredExpenses = [...allExpenses];

            // Filter by period
            const now = new Date();
            if (period !== 'all') {
                let startDate;
                if (period === 'today') {
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                } else if (period === 'week') {
                    startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                    startDate.setHours(0,0,0,0);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                
                if(startDate) {
                    filteredExpenses = filteredExpenses.filter(e => e.date?.seconds && new Date(e.date.seconds * 1000) >= startDate);
                }
            }

            // Filter by category
            if (category !== 'all') {
                filteredExpenses = filteredExpenses.filter(e => e.category === category);
            }

            renderExpensesList(filteredExpenses);
        }

        function showExpenseFormModal() {
            const expenseFormModal = document.getElementById('expenseFormModal');
            let receiptFile = null;

            expenseFormModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeExpenseFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title" data-lang-key="addExpense"></span>
                </header>
                <div class="modal-content-wrapper">
                  <div class="container">
                    <form id="expense-form">
                        <div class="form-group">
                            <label data-lang-key="expenseType"></label>
                            <select id="expense-category" required>
                                <option value="fuel" data-lang-key="fuel"></option>
                                <option value="food" data-lang-key="food"></option>
                                <option value="rent" data-lang-key="rent"></option>
                                <option value="mechanics" data-lang-key="mechanics"></option>
                                <option value="other" data-lang-key="other"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="expenseValue"></label>
                            <input type="number" id="expense-value" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label data-lang-key="observations"></label>
                            <textarea id="expense-obs"></textarea>
                        </div>
                         <div class="form-group">
                            <label data-lang-key="uploadReceipt"></label>
                            <div id="receipt-preview-container" style="margin-bottom: 15px;"></div>
                            <button type="button" class="btn-secondary" id="upload-receipt-btn" style="width: 100%;">
                                <i data-lucide="upload"></i> <span>Anexar Recibo</span>
                            </button>
                            <input type="file" id="receipt-file-input" accept="image/*,application/pdf" style="display: none;">
                        </div>
                    </form>
                  </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" id="saveExpenseBtn"><i data-lucide="save"></i> <span data-lang-key="saveExpense"></span></button>
                </div>`;
            history.pushState({ modal: 'expenseFormModal' }, 'Expense Form', '#expense-form');
            expenseFormModal.classList.add('active');
            
            document.getElementById('upload-receipt-btn').addEventListener('click', () => {
                document.getElementById('receipt-file-input').click();
            });

            document.getElementById('receipt-file-input').addEventListener('change', e => {
                receiptFile = e.target.files[0];
                if (receiptFile) {
                    document.getElementById('receipt-preview-container').innerHTML = `<div class="preview-item"><span>${receiptFile.name}</span></div>`;
                }
            });

            document.getElementById('closeExpenseFormModal').addEventListener('click', () => window.history.back());

            document.getElementById('saveExpenseBtn').addEventListener('click', async (e) => {
                const saveButton = e.currentTarget;
                const valueInput = document.getElementById('expense-value');

                if (!valueInput.value || parseFloat(valueInput.value) <= 0) {
                    showToast('O valor do gasto √© obrigat√≥rio.', true);
                    valueInput.style.borderColor = 'var(--danger-color)';
                    setTimeout(() => { valueInput.style.borderColor = ''; }, 2500);
                    return;
                }
                
                saveButton.disabled = true;
                saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> <span>Salvando...</span>`;
                lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

                try {
                    let receiptUrl = '';
                    if (receiptFile) {
                         const formData = new FormData();
                        formData.append('file', receiptFile);
                        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                        const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                        if (!response.ok) throw new Error('Cloudinary upload failed');
                        const data = await response.json();
                        receiptUrl = data.secure_url;
                    }

                    const expenseData = {
                        collectorId,
                        category: document.getElementById('expense-category').value,
                        value: parseFloat(valueInput.value),
                        observations: document.getElementById('expense-obs').value,
                        receiptUrl,
                        date: serverTimestamp()
                    };

                    await addDoc(collection(db, 'expenses'), expenseData);
                    window.history.back();
                    showToast('Gasto salvo com sucesso!');

                } catch (err) {
                    console.error("Falha ao salvar gasto:", err);
                    showToast('Falha ao salvar o gasto.', true);
                    saveButton.disabled = false;
                    saveButton.innerHTML = `<i data-lucide="save"></i> <span data-lang-key="saveExpense"></span>`;
                    applyLanguage(currentLang);
                    lucide.createIcons({nodes: [saveButton.querySelector('i')]});
                }
            });
            
            applyLanguage(currentLang);
            lucide.createIcons({ nodes: expenseFormModal.querySelectorAll('[data-lucide]') });
        }


        // --- MAPA E OUTRAS FUN√á√ïES ---
        function initMap() {
            if (mapInstance) {
                mapInstance.invalidateSize();
                return;
            };
            mapInstance = L.map('map-container').setView([-16.68, -49.25], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
        }

        function plotClientsOnMap() {
            if (!mapInstance) return;
            
            // [REPARACI√ìN] Forzar una revalidaci√≥n del tama√±o del mapa cada vez que se intenta dibujar.
            // Esto resuelve problemas de renderizado en vistas que cambian de visibilidad, 
            // especialmente en la app instalada (PWA), asegurando que los pines se muestren correctamente.
            mapInstance.invalidateSize();

            mapMarkers.forEach(marker => marker.remove());
            mapMarkers = [];

            // --- INICIO: L√ìGICA DEL MARCADOR DEL COBRADOR ---
            const collectorIcon = L.icon({
                iconUrl: 'https://firebasestorage.googleapis.com/v0/b/lumix-financas-app.firebasestorage.app/o/MotoIcono.png?alt=media&token=e8add7cd-e8d3-424d-8f05-5d04e0d10ec1',
                iconSize: [40, 40], // Tama√±o del icono [ancho, alto]
                iconAnchor: [20, 20], // Punto del icono que corresponder√° a la ubicaci√≥n del marcador
                popupAnchor: [0, -20] // Punto desde donde se abrir√° el popup, relativo al iconAnchor
            });

            const collectorPosition = collectorCurrentLocation 
                ? [collectorCurrentLocation.lat, collectorCurrentLocation.lng]
                : [-16.68, -49.25]; // Posici√≥n por defecto: Goi√¢nia

            if (!collectorMarker) {
                collectorMarker = L.marker(collectorPosition, { icon: collectorIcon, zIndexOffset: 1000 }).addTo(mapInstance);
                collectorMarker.bindPopup("Sua Posi√ß√£o Atual");
            } else {
                collectorMarker.setLatLng(collectorPosition);
            }
            // --- FIN: L√ìGICA DEL MARCADOR DEL COBRADOR ---

            const clientsToPlot = getTodaysRouteClients();
            const locations = [];
            
            // A√±ade la posici√≥n del cobrador para el auto-zoom del mapa
            locations.push(collectorPosition);

            const nextClientIcon = L.divIcon({
                className: 'next-client-marker',
                html: '<div class="next-client-pin"></div>',
                iconSize: [30, 42],
                iconAnchor: [15, 42],
                popupAnchor: [0, -42]
            });

            clientsToPlot.forEach((item, index) => {
                const { client, loan, loanIndex } = item;
                if (client.location) {
                    const match = client.location.match(/query=([\d.-]+),([\d.-]+)/);
                    if (match) {
                        const lat = parseFloat(match[1]);
                        const lng = parseFloat(match[2]);
                        locations.push([lat, lng]);
                        
                        const popupContent = `
                            <div class="popup-client-name">${client.name}</div>
                            <div class="popup-client-amount">${money(loan.amount)}</div>
                            <button class="btn-primary popup-details-btn" data-client-id="${client.id}" data-loan-index="${loanIndex}" style="width: 100%; margin-top: 10px;">
                                Ver Detalhes
                            </button>
                        `;

                        let marker;
                        if (index === 0) { // Si es el primer cliente de la ruta
                            marker = L.marker([lat, lng], { icon: nextClientIcon }).addTo(mapInstance).bindPopup(popupContent);
                        } else {
                            marker = L.marker([lat, lng]).addTo(mapInstance).bindPopup(popupContent);
                        }
                        
                        marker.on('popupopen', (e) => {
                            const btn = e.popup.getElement().querySelector('.popup-details-btn');
                            if (btn) {
                                btn.onclick = () => {
                                    // Primero, cambia la vista para cerrar el mapa
                                    location.hash = 'home';
                                    // Despu√©s de un breve retraso, muestra los detalles del cliente
                                    setTimeout(() => {
                                        showClientDetails(btn.dataset.clientId, parseInt(btn.dataset.loanIndex, 10));
                                    }, 100); 
                                };
                            }
                        });

                        mapMarkers.push(marker);
                    }
                }
            });
            
            if (locations.length > 0) {
                mapInstance.fitBounds(locations, { padding: [50, 50] });
            }
        }

        function exportDailyReport() {
            const { jsPDF } = window.jspdf;
            const todayStr = new Date().toLocaleDateString('pt-BR');
            const lang = currentLang;

            const dailyPayments = [];
             allClients.forEach(client => {
                (client.history || []).forEach(h => {
                    if (h.date?.seconds) {
                        const paymentDate = new Date(h.date.seconds * 1000);
                        if (paymentDate.toLocaleDateString('pt-BR') === todayStr) {
                            dailyPayments.push({
                                clientName: client.name,
                                amount: h.amount,
                                time: paymentDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                            });
                        }
                    }
                });
            });

            const dailyExpenses = allExpenses.filter(e => {
                if (!e.date?.seconds) return false;
                const expenseDate = new Date(e.date.seconds * 1000);
                return expenseDate.toLocaleDateString('pt-BR') === todayStr;
            });
            
            if (dailyPayments.length === 0 && dailyExpenses.length === 0) {
                showToast("Nenhuma atividade registrada hoje.", true);
                return;
            }

            const totalCollected = dailyPayments.reduce((sum, p) => sum + p.amount, 0);
            const totalExpenses = dailyExpenses.reduce((sum, e) => sum + e.value, 0);
            const netBalance = totalCollected - totalExpenses;

            doc.setFontSize(18);
            doc.text(translations[lang].reportTitle, 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.text(`${translations[lang].reportDate}: ${todayStr}`, 14, 30);
            doc.text(`${translations[lang].reportCollector}: Jo√£o Silva`, 14, 35);
            
            doc.text(`${translations[lang].reportTotalCollected}: ${money(totalCollected)}`, 196, 30, { align: 'right' });
            doc.text(`${translations[lang].reportTotalExpenses}: ${money(totalExpenses)}`, 196, 35, { align: 'right' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`${translations[lang].reportNetBalance}: ${money(netBalance)}`, 196, 42, { align: 'right' });
            doc.setFont(undefined, 'normal');


            let y = 55;
            doc.setLineWidth(0.5);
            doc.line(14, y - 5, 196, y - 5);

            if(dailyPayments.length > 0) {
                 doc.setFontSize(12);
                 doc.setFont(undefined, 'bold');
                 doc.text(translations[lang].receivedToday, 14, y);
                 y += 7;
                 doc.setFontSize(10);
                 doc.setFont(undefined, 'normal');
                 doc.text(translations[lang].reportClient, 14, y);
                 doc.text(translations[lang].reportAmount, 150, y);
                 doc.text(translations[lang].reportTime, 180, y);
                 y += 7;
                 dailyPayments.sort((a,b) => a.time.localeCompare(b.time)).forEach(p => {
                     if (y > 280) { doc.addPage(); y = 20; }
                     doc.text(p.clientName, 14, y);
                     doc.text(money(p.amount), 150, y);
                     doc.text(p.time, 180, y);
                     y += 7;
                 });
            }

            if(dailyExpenses.length > 0) {
                y += 10;
                doc.setLineWidth(0.2);
                doc.line(14, y - 5, 196, y - 5);
                 doc.setFontSize(12);
                 doc.setFont(undefined, 'bold');
                 doc.text(translations[lang].myExpenses, 14, y);
                 y += 7;
                 doc.setFontSize(10);
                 doc.setFont(undefined, 'normal');
                 doc.text(translations[lang].expenseType, 14, y);
                 doc.text(translations[lang].reportAmount, 150, y);
                 doc.text(translations[lang].reportTime, 180, y);
                 y += 7;
                 dailyExpenses.sort((a,b) => (a.date.seconds || 0) - (b.date.seconds || 0)).forEach(e => {
                     if (y > 280) { doc.addPage(); y = 20; }
                     const categoryText = translations[lang][e.category] || e.category;
                     const time = new Date(e.date.seconds * 1000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                     doc.text(categoryText, 14, y);
                     doc.text(`-${money(e.value)}`, 150, y);
                     doc.text(time, 180, y);
                     y += 7;
                 });
            }
            
            doc.save(`relatorio-diario-${todayStr.replace(/\//g, '-')}.pdf`);
        }
        
        function showCropperModal(file) {
            const cropperModal = document.getElementById('cropperModal');
            cropperModal.innerHTML = `
                <header class="modal-header">
                    <button id="closeCropperModal"><i data-lucide="x"></i></button>
                    <span class="modal-title" data-lang-key="cropImage"></span>
                </header>
                <div class="modal-content-wrapper">
                    <div id="cropper-container" class="container">
                        <img id="cropper-image">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" id="cancelCropBtn"><i data-lucide="x-circle"></i> <span data-lang-key="cancel"></span></button>
                    <button class="btn-primary" id="confirmCropBtn"><i data-lucide="check-circle"></i> <span data-lang-key="confirmCrop"></span></button>
                </div>
            `;
            history.pushState({ modal: 'cropperModal' }, 'Crop Image', '#crop');
            cropperModal.classList.add('active');
            lucide.createIcons({nodes: cropperModal.querySelectorAll('[data-lucide]')});
            applyLanguage(currentLang);

            const image = document.getElementById('cropper-image');
            const reader = new FileReader();
            let cropper;

            reader.onload = (e) => {
                image.src = e.target.result;
                cropper = new Cropper(image, { aspectRatio: 1, viewMode: 1, background: false });
            };
            reader.readAsDataURL(file);

            document.getElementById('closeCropperModal').addEventListener('click', () => window.history.back());
            document.getElementById('cancelCropBtn').addEventListener('click', () => window.history.back());
            document.getElementById('confirmCropBtn').addEventListener('click', () => {
                cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' }).toBlob((blob) => {
                    handleProfilePictureChange(blob);
                    window.history.back();
                }, 'image/jpeg');
            });
        }

        async function handleProfilePictureChange(blob) {
            if (!blob) return;
            const profileImageView = document.getElementById('profile-view-img');
            const headerImageView = document.getElementById('header-profile-img');

            const localUrl = URL.createObjectURL(blob);
            profileImageView.src = localUrl;
            headerImageView.src = localUrl;
            profileImageView.classList.add('loading');
            
            try {
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Cloudinary profile picture upload failed');
                const data = await response.json();
                const downloadURL = data.secure_url;
                
                const collectorRef = doc(db, 'collectors', collectorId);
                await setDoc(collectorRef, { profilePictureUrl: downloadURL }, { merge: true });
                showToast('Foto de perfil atualizada!');
            } catch (error) {
                console.error("Error al actualizar foto de perfil: ", error);
                showToast('Falha ao atualizar a foto de perfil.', true);
            } finally {
                profileImageView.classList.remove('loading');
            }
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            if (viewName !== 'profile') {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const navItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
                if (navItem) navItem.classList.add('active');
            } else {
                 document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            }

            const viewEl = document.getElementById(`${viewName}-view`);
            if (viewEl) viewEl.classList.add('active');

            document.getElementById('addClientBtn').classList.toggle('hidden', !['home', 'clients'].includes(viewName));
            document.getElementById('addExpenseBtn').classList.toggle('hidden', viewName !== 'expenses');
            
            if (viewName === 'map') {
                setTimeout(() => {
                    initMap();
                    plotClientsOnMap();
                }, 50);
            }
        }

        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const target = e.target;
                if (target.closest('#header-profile-link')) {
                    location.hash = 'profile';
                }
                const navItem = target.closest('.nav-item[data-view]');
                if (navItem) {
                    location.hash = navItem.dataset.view;
                }
                if (target.closest('#theme-toggle')) {
                    const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                }
                const langToggle = document.getElementById('lang-toggle');
                const langDropdown = document.getElementById('lang-dropdown');
                if (langToggle && target.closest('#lang-toggle')) {
                    e.stopPropagation();
                    langDropdown.style.display = langDropdown.style.display === 'block' ? 'none' : 'block';
                } else if (langDropdown) {
                    langDropdown.style.display = 'none';
                }
                if (langDropdown && target.closest('[data-lang]')) {
                    const newLang = target.dataset.lang;
                    localStorage.setItem('language', newLang);
                    applyLanguage(newLang);
                }
                if(target.closest('#addClientBtn')) showClientFormModal();
                if(target.closest('#addExpenseBtn')) showExpenseFormModal();
                if (target.closest('#logout-btn')) {
                    stopRealtimeGeolocation(); // <-- A√ëADE ESTA L√çNEA
                    sessionStorage.removeItem('isLoggedIn');
                    location.reload();
                }
                if (target.closest('#change-password-btn')) console.log("Mudar senha a ser implementado.");
                if (target.closest('#export-report-btn')) exportDailyReport();
            });
            
            window.addEventListener('popstate', (event) => {
                // Oculta todos los modales activos para limpiar el estado
                document.querySelectorAll('.modal-view.active').forEach(modal => {
                    modal.classList.remove('active');
                });

                // Si el estado de la historia es para un modal, lo muestra y detiene
                if (event.state && event.state.modal) {
                    const modalToShow = document.getElementById(event.state.modal);
                    if (modalToShow) {
                        modalToShow.classList.add('active');
                    }
                    return;
                }
                
                // Si no, maneja la navegaci√≥n de la vista principal basada en el hash
                const viewName = location.hash.substring(1) || 'home';
                showView(viewName);
            });

            document.body.addEventListener('change', e => {
                if (e.target.id === 'profile-pic-input') {
                    const file = e.target.files[0];
                    if (file) showCropperModal(file);
                }
            });

            const clientsView = document.getElementById('clients-view');
            if (clientsView) {
                clientsView.addEventListener('input', e => {
                    if (e.target.id === 'client-search-input') updateAllClientsList();
                });
                clientsView.addEventListener('click', e => {
                    const filterBtn = e.target.closest('.filter-btn');
                    if (filterBtn) {
                        clientsView.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                        filterBtn.classList.add('active');
                        updateAllClientsList();
                    }
                });
            }

            const expensesView = document.getElementById('expenses-view');
            if (expensesView) {
                expensesView.addEventListener('click', e => {
                     const filterBtn = e.target.closest('.filter-btn');
                     if(filterBtn) {
                         const parent = filterBtn.parentElement;
                         parent.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                         filterBtn.classList.add('active');
                         updateExpensesView();
                     }
                });
            }
            const realtimeToggle = document.getElementById('realtime-tracking-toggle');
            if(realtimeToggle) {
                realtimeToggle.addEventListener('change', async (e) => {
                    const isActive = e.target.checked;
                    try {
                        const collectorRef = doc(db, 'collectors', collectorId);
                        await updateDoc(collectorRef, { isRealtimeTrackingActive: isActive });
                        if (isActive) {
                            startRealtimeGeolocation();
                        } else {
                            stopRealtimeGeolocation();
                        }
                    } catch (error) {
                        console.error("Error al actualizar el estado de rastreo:", error);
                        showToast('Falha ao atualizar prefer√™ncia de rastreamento.', true);
                    }
                });
            }
        }
        
        function showMainApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            renderMainLayout();
            lucide.createIcons();
            setupEventListeners();
            const preferredTheme = localStorage.getItem('theme') || 'light';
            applyTheme(preferredTheme);
            
            const initialView = location.hash.substring(1) || 'home';
            showView(initialView);

            let isFirstLoad = true; // Flag para ejecutar la configuraci√≥n solo una vez
            let collectorData = null;

            onSnapshot(doc(db, 'collectors', collectorId), (docSnap) => {
                if (docSnap.exists()) {
                    collectorData = docSnap.data();
                    document.querySelectorAll('.profile-name').forEach(el => el.textContent = collectorData.name || 'Jo√£o Silva');
                    
                    const imageUrl = collectorData.profilePictureUrl;
                    const nameInitial = (collectorData.name || 'C').charAt(0).toUpperCase();
                    const placeholderUrl = `https://placehold.co/120x120/6f42c1/FFFFFF?text=${nameInitial}`;
                    
                    document.getElementById('header-profile-img').src = imageUrl || placeholderUrl.replace('120x120', '80x80');
                    document.getElementById('profile-view-img').src = imageUrl || placeholderUrl;
                    const realtimeToggle = document.getElementById('realtime-tracking-toggle');
                    if(realtimeToggle) realtimeToggle.checked = collectorData.isRealtimeTrackingActive || false;

                    if (collectorData.isRealtimeTrackingActive) {
                        startRealtimeGeolocation();
                    }

                    // Event listener for the new button
                    const paymentSettingsBtn = document.getElementById('payment-settings-btn');
                    if (paymentSettingsBtn) {
                        paymentSettingsBtn.addEventListener('click', () => showPaymentSettingsModal(collectorData));
                    }

                    if (isFirstLoad) {
                        console.log('[COBRADOR-APP] Carga inicial completa. Configurando FCM...');
                        if ('serviceWorker' in navigator) {
                            // Espera a que el Service Worker est√© 100% activo antes de pedir el token.
                            navigator.serviceWorker.ready.then(registration => {
                                console.log('[COBRADOR-APP] Service Worker est√° activo y listo. Procediendo a configurar FCM.');
                                // Llama a la funci√≥n para obtener y guardar el token en Firestore.
                                setupFCM(collectorId, registration);
                            }).catch(err => {
                                console.error('[COBRADOR-APP] ERROR CR√çTICO: El Service Worker no estuvo listo.', err);
                            });
                        }
                        isFirstLoad = false;
                    }
                }
            });

            onSnapshot(collection(db, "clients"), (snapshot) => {
                allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                allClients.forEach(client => {
                    // Capa de compatibilidad
                    if (!client.loans && client.totalLoan) {
                        client.loans = [{
                            totalLoan: client.totalLoan,
                            paid: client.paid || 0,
                            installments: client.installments,
                            originalInstallmentAmount: client.amount,
                            totalInstallments: (client.installments || "0/0").split('/').map(Number)[1] || 0,
                            startDate: client.startDate,
                            history: client.history || [],
                            paymentBalance: client.paymentBalance || 0,
                            status: 'active', // Asumimos activo si no est√° finalizado
                            paymentFrequency: client.paymentFrequency,
                            paymentDays: client.paymentDays,
                            collectionTime: client.collectionTime,
                            amount: client.amount
                        }];
                    } else if (!client.loans) {
                        client.loans = [];
                    }

                    client.loans.forEach(loan => {
                        const loanDetails = calculateLoanDetails(loan);
                        loan.status = loanDetails.status;
                        loan.lateFeesAccumulated = loanDetails.lateFeesAccumulated; // Guardamos la mora calculada
                        // Podr√≠amos guardar tambi√©n loan.lateDays = loanDetails.lateDays si quisi√©ramos mostrarlo
                    });
                });

                updateTodaysRouteList();
                updateRouteProgress();
                updateAllClientsList();
                updateProfileView(collectorData);
                updateNotifications();
                if (document.querySelector('#map-view.active')) plotClientsOnMap();
                applyLanguage(currentLang);
            }, (error) => {
                console.error("Error al obtener clientes: ", error);
                showToast('Falha ao carregar clientes.', true);
            });

            const expensesQuery = query(collection(db, 'expenses'), where("collectorId", "==", collectorId));
            onSnapshot(expensesQuery, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateExpensesView();
                updateProfileView(collectorData);
            }, (error) => {
                console.error("Error al obtener gastos: ", error);
                showToast('Falha ao carregar gastos.', true);
            });

            // --- LISTENER A√ëADIDO PARA LIQUIDACIONES (FILTRADO) ---
            const settlementsQuery = query(collection(db, 'settlements'), where("collectorId", "==", collectorId));
            onSnapshot(settlementsQuery, (snapshot) => {
                allSettlements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Actualizamos la vista de perfil que muestra el capital en mano
                updateProfileView(collectorData); 
            }, (error) => {
                console.error("Error al obtener liquidaciones: ", error);
                showToast('Falha ao carregar dados de liquida√ß√£o.', true);
            });
    // --- FIN DEL LISTENER A√ëADIDO ---

        }
        
        function loadGlobalSettings(settings) {
            const companyName = settings.companyName || 'LUMIX Finan√ßas';
            const companyLogo = settings.companyLogo || DEFAULT_LOGO_URL;
            
            const elements = {
                headerLogoText: document.getElementById('header-logo-text'),
                headerLogo: document.getElementById('header-logo'),
                splashLogo: document.getElementById('splash-logo'),
                loginLogo: document.getElementById('login-logo')
            };

            if (elements.headerLogoText) elements.headerLogoText.textContent = companyName;
            if (elements.headerLogo) elements.headerLogo.src = companyLogo;
            if (elements.splashLogo) elements.splashLogo.src = companyLogo;
            if (elements.loginLogo) elements.loginLogo.src = companyLogo;
        }

        function handleLogin(event) {
            event.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            if (user === 'cobrador1' && pass === '0000') {
                sessionStorage.setItem('isLoggedIn', 'true');
                // CORRECCI√ìN: Eliminamos location.reload() y mostramos la app directamente.
                showMainApp();
            } else {
                showToast('Usu√°rio ou senha inv√°lidos.', true);
            }
        }
        
        // --- INICIO: L√ìGICA DE OPTIMIZACI√ìN DE RUTA ---
        
        // Calcula la distancia haversine entre dos puntos en la Tierra
        function getDistance(coords1, coords2) {
            if (!coords1 || !coords2) return Infinity;
            const toRad = x => x * Math.PI / 180;
            const R = 6371; // Radio de la Tierra en km
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lng - coords1.lng);
            const lat1 = toRad(coords1.lat);
            const lat2 = toRad(coords2.lat);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Extrae las coordenadas de una URL de Google Maps
        function parseCoordinates(locationUrl) {
            if (!locationUrl) return null;
            const match = locationUrl.match(/query=([\d.-]+),([\d.-]+)/);
            if (match) {
                return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
            }
            return null;
        }

        // Funci√≥n principal para optimizar la ruta
        function optimizeRoute(clients, startCoords) {
            if (clients.length === 0) return [];
            
            // Si no tenemos la ubicaci√≥n del cobrador, ordena por hora y luego alfab√©ticamente
            if (!startCoords) {
                return clients.sort((a, b) => {
                    // [CORRECCI√ìN] Se accede a las propiedades correctas 'loan' y 'client' dentro del objeto.
                    const timeA = a.loan.collectionTime;
                    const timeB = b.loan.collectionTime;
                    if (timeA && timeB) return timeA.localeCompare(timeB);
                    if (timeA) return -1;
                    if (timeB) return 1;
                    return a.client.name.localeCompare(b.client.name);
                });
            }

            clients.forEach(item => item.coords = parseCoordinates(item.client.location));
            const clientsWithTime = clients.filter(item => item.loan.collectionTime).sort((a, b) => a.loan.collectionTime.localeCompare(b.loan.collectionTime));
            let clientsWithoutTime = clients.filter(item => !item.loan.collectionTime);

            let optimizedRoute = [];
            let lastCoords = startCoords;

            const findAndRemoveNearest = (fromCoords, clientList) => {
                let nearestClient = null;
                let minDistance = Infinity;
                let nearestIndex = -1;

                clientList.forEach((clientItem, index) => {
                    if (clientItem.coords) {
                        const distance = getDistance(fromCoords, clientItem.coords);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestClient = clientItem;
                            nearestIndex = index;
                        }
                    }
                });

                if (nearestIndex !== -1) {
                    clientList.splice(nearestIndex, 1);
                }
                return nearestClient;
            };

            // Procesa clientes con hora primero
            clientsWithTime.forEach(timedClient => {
                // Antes de a√±adir el cliente con hora, busca los clientes sin hora m√°s cercanos
                while (clientsWithoutTime.length > 0) {
                    const nearestUntimed = findAndRemoveNearest(lastCoords, clientsWithoutTime);
                    if (!nearestUntimed) break; 

                    // Heur√≠stica simple: ¬øEs m√°s corto ir a este cliente sin hora y LUEGO al cliente con hora?
                    const distToNearest = getDistance(lastCoords, nearestUntimed.coords);
                    const distFromNearestToTimed = getDistance(nearestUntimed.coords, timedClient.coords);
                    const distDirectToTimed = getDistance(lastCoords, timedClient.coords);

                    if (distToNearest + distFromNearestToTimed < distDirectToTimed * 1.5) { // Factor de desv√≠o
                        optimizedRoute.push(nearestUntimed);
                        lastCoords = nearestUntimed.coords;
                    } else {
                        clientsWithoutTime.push(nearestUntimed); // Lo devolvemos a la lista
                        break;
                    }
                }
                
                optimizedRoute.push(timedClient);
                if (timedClient.coords) {
                    lastCoords = timedClient.coords;
                }
            });

            // A√±ade los clientes restantes sin hora al final, en orden de proximidad
            while (clientsWithoutTime.length > 0) {
                const nearest = findAndRemoveNearest(lastCoords, clientsWithoutTime);
                if (nearest) {
                    optimizedRoute.push(nearest);
                    if (nearest.coords) {
                        lastCoords = nearest.coords;
                    }
                } else {
                    // Si quedan clientes pero no tienen coordenadas, a√±√°delos al final
                    const withoutCoords = clientsWithoutTime.filter(c => !c.coords);
                    optimizedRoute.push(...withoutCoords);
                    break;
                }
            }
            
            return optimizedRoute;
        }
        
        async function startRealtimeGeolocation() {
            if (locationWatchId) return; // Ya est√° activo
            if (!('geolocation' in navigator) || !('permissions' in navigator)) {
                showToast('Geolocaliza√ß√£o n√£o √© suportada neste navegador.', true);
                stopRealtimeGeolocation();
                return;
            }

            try {
                // 1. Verifica el estado del permiso ANTES de solicitar la ubicaci√≥n
                const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });

                if (permissionStatus.state === 'denied') {
                    // Si el permiso ya fue denegado, informa al usuario c√≥mo solucionarlo.
                    showToast('Permiss√£o de localiza√ß√£o bloqueada. Ative-a nas configura√ß√µes do seu dispositivo para este site.', true);
                    stopRealtimeGeolocation(); // Asegura que el interruptor se apague.
                    return;
                }

                // Si el estado es 'granted' o 'prompt', procede a solicitar la ubicaci√≥n.
                // El navegador pedir√° permiso si es 'prompt'.
                locationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        // √âxito: se obtuvo la ubicaci√≥n
                        collectorCurrentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('Ubicaci√≥n actualizada:', collectorCurrentLocation);
                        
                        // [REPARACI√ìN] Env√≠a la ubicaci√≥n a Firestore peri√≥dicamente.
                        const now = Date.now();
                        if (now - lastLocationUpdateTime > 30000) { // Actualiza cada 30 segundos
                            lastLocationUpdateTime = now;
                            const collectorRef = doc(db, 'collectors', collectorId);
                            updateDoc(collectorRef, {
                                lastLocation: {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude
                                },
                                lastLocationUpdate: serverTimestamp()
                            }).then(() => {
                                console.log("Localizaci√≥n enviada a Firestore.");
                            }).catch(error => {
                                console.error("Error al enviar localizaci√≥n a Firestore:", error);
                            });
                        }

                        // --- INICIO: Actualizaci√≥n en tiempo real del marcador del cobrador ---
                        if (mapInstance && collectorMarker) {
                            const newLatLng = [collectorCurrentLocation.lat, collectorCurrentLocation.lng];
                            collectorMarker.setLatLng(newLatLng);
                            
                            // Si la vista del mapa est√° activa, centra el mapa en la nueva ubicaci√≥n
                            if (document.getElementById('map-view').classList.contains('active')) {
                                mapInstance.panTo(newLatLng);
                            }
                        }
                        // --- FIN: Actualizaci√≥n en tiempo real del marcador ---

                        updateTodaysRouteList();
                    },
                    (error) => {
                        // Error: El usuario neg√≥ el permiso en el pop-up o hubo un fallo del GPS.
                        console.error("Error durante el seguimiento en tiempo real:", error);
                        showToast('N√£o foi poss√≠vel obter a localiza√ß√£o. Permiss√£o negada ou GPS indispon√≠vel.', true);
                        stopRealtimeGeolocation(); 
                    },
                    // [CORRECCI√ìN] Se aument√≥ el timeout a 20 segundos (20000ms) para dar m√°s tiempo al dispositivo
                    // para obtener una se√±al de GPS, especialmente en el primer intento. El valor anterior de 5 segundos
                    // era muy bajo y pod√≠a causar que la funci√≥n fallara prematuramente, desactivando el interruptor.
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 20000 }
                );

            } catch (error) {
                console.error("Error al verificar permisos de geolocalizaci√≥n:", error);
                showToast('Erro ao verificar permiss√µes de GPS.', true);
                stopRealtimeGeolocation();
            }
        }
        function stopRealtimeGeolocation() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            // Apaga el interruptor en la interfaz si el seguimiento se detiene por cualquier motivo.
            const trackingToggle = document.getElementById('realtime-tracking-toggle');
            if (trackingToggle && trackingToggle.checked) {
                trackingToggle.checked = false;
                // Tambi√©n actualiza el estado en la base de datos para que sea consistente.
                updateDoc(doc(db, 'collectors', collectorId), { isRealtimeTrackingActive: false });
            }
            collectorCurrentLocation = null;
            console.log('Rastreo en tiempo real detenido.');
            updateTodaysRouteList(); // Reordena una √∫ltima vez sin ubicaci√≥n
        }

        // --- FIN: L√ìGICA DE OPTIMIZACI√ìN DE RUTA ---
        
        function renderSystemHistoryResults(results, container) {
    if (results.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 10px;">
                <i data-lucide="check-circle" style="color: var(--accent-green); width: 48px; height: 48px; margin-bottom: 10px;"></i>
                <h4 data-lang-key="clientClean" style="margin: 0 0 5px;"></h4>
                <p data-lang-key="clientCleanMsg" style="color: var(--text-secondary); font-size: 0.9em; margin: 0;"></p>
            </div>
        `;
    } else {
        const resultsHtml = results.map(loan => {
            const lateDays = calculateLatePaymentDays(loan);
            const score = Math.max(0, 10 - lateDays);
            let repClass = 'rep-bad';
            if (score === 10) repClass = 'rep-perfect';
            else if (score >= 7) repClass = 'rep-good';
            else if (score >= 3) repClass = 'rep-regular';

            const statusClass = `status-${loan.status}`;
            const statusText = (translations[currentLang] && translations[currentLang][loan.status]) || loan.status;

            return `
            <div class="client-card" style="cursor: default; margin-bottom: 15px; flex-wrap: wrap;">
                <div class="client-info">
                    <p class="client-address" style="font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px;" data-lang-key="otherLoanCollector"></p>
                    <h4 class="client-name" style="font-size: 1em;">${loan.collectorId || 'Desconhecido'}</h4>
                </div>
                <div class="payment-info">
                     <p class="client-address" style="font-size: 0.8em; text-transform: uppercase; margin-bottom: 8px; text-align: right;" data-lang-key="otherLoanStatus"></p>
                     <span class="payment-status ${statusClass}" style="align-self: flex-end;">${statusText}</span>
                </div>
                <div style="width: 100%; border-top: 1px solid var(--border-color); margin: 15px 0; padding-top: 15px;">
                    <p class="kpi-title" style="margin-bottom: 10px;" data-lang-key="loanDetails"></p>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em;">
                        <span><strong data-lang-key="reputation"></strong>:</span>
                        <span class="reputation-score ${repClass}"><i data-lucide="star" style="width: 12px; height: 12px;"></i> ${score}/10</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-top: 8px;">
                        <span><strong>Total</strong>:</span>
                        <span>${money(loan.totalLoan)}</span>
                    </div>
                     <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-top: 8px;">
                        <span style="color: var(--accent-green);"><strong>Pago</strong>:</span>
                        <span style="color: var(--accent-green);">${money(loan.paid)}</span>
                    </div>
                </div>
            </div>
            `;
        }).join('');

        container.innerHTML = `
            <h4 data-lang-key="loansFound" style="margin-bottom: 10px;"></h4>
            ${resultsHtml}
        `;
    }
    lucide.createIcons({ nodes: container.querySelectorAll('[data-lucide]') });
    applyLanguage(currentLang);
}

async function sendNotificationToClient(clientId, title, body, type, icon = 'info') {
    if (!clientId) return;
    try {
        const clientRef = doc(db, 'clients', clientId);

        // 1. La notificaci√≥n interna (para ver dentro de la app) sigue igual, es correcta.
        const internalNotif = {
            title: title,
            body: body,
            icon: icon,
            read: false,
            timestamp: new Date(),
            id: `${type}_${Date.now()}`
        };
        await setDoc(clientRef, { notifications: arrayUnion(internalNotif) }, { merge: true });
        console.log(`Notificaci√≥n INTERNA para cliente [${clientId}] creada.`);

        // 2. [CORRECCI√ìN APLICADA] Ahora se escribe el ticket en la sub-colecci√≥n
        //    correcta ('clients/{id}/pushNotificationTickets'), que es donde la
        //    Cloud Function 'sendPushNotificationToClient' est√° escuchando.
        const ticketRef = collection(db, 'clients', clientId, 'pushNotificationTickets');
        await addDoc(ticketRef, {
            // Ya no necesitamos 'target' ni 'userId' porque la ruta los define.
            title: title,
            body: body,
            type: type,
            createdAt: serverTimestamp()
        });
        console.log(`Ticket PUSH para cliente [${clientId}] enviado a su cola espec√≠fica.`);
    } catch (error) {
        console.error(`Error al enviar notificaci√≥n/ticket al cliente [${clientId}]:`, error);
    }
}

function triggerSystemVerification(editingClientId = null) {
    const docInput = document.getElementById('client-document');
    const resultsContainer = document.getElementById('system-verification-results');
    if (!docInput || !resultsContainer) return;

    const documentNumber = docInput.value.trim();
    if (!documentNumber) {
        resultsContainer.innerHTML = ''; // Limpia los resultados si el campo est√° vac√≠o
        return;
    }

    // Muestra un indicador de "Buscando..."
    resultsContainer.innerHTML = `
        <div class="kpi-card" style="text-align:center; padding: 15px;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i>
                <span data-lang-key="searchingSystem"></span>
            </div>
        </div>
    `;
    lucide.createIcons({ nodes: resultsContainer.querySelectorAll('[data-lucide]') });
    applyLanguage(currentLang);

    // Simula la b√∫squeda en la base de datos
    setTimeout(() => {
        const foundLoans = allClients.filter(c => 
            c.documentNumber && c.documentNumber === documentNumber &&
            (!editingClientId || c.id !== editingClientId) && // Excluye al cliente actual si se est√° editando
            c.status !== 'finished'
        );

        // Prepara el contenedor y renderiza los resultados
        resultsContainer.innerHTML = '<div class="kpi-card"></div>';
        renderSystemHistoryResults(foundLoans, resultsContainer.querySelector('.kpi-card'));
    }, 1500); // Un retraso de 1.5 segundos para simular la b√∫squeda
}

        function init() {
            // --- Service Worker Registration with Environment Check ---
            if ('serviceWorker' in navigator) {
                // Service Workers n√£o podem ser registrados a partir de uma URL 'blob:', usada por ambientes de pr√©-visualiza√ß√£o.
                // Esta verifica√ß√£o evita a tentativa de registro e o erro resultante nesses ambientes.
                if (window.location.protocol === 'blob:') {
                    console.warn("Service Worker: Registro ignorado. O ambiente de pr√©-visualiza√ß√£o ('blob:') n√£o suporta Service Workers. As notifica√ß√µes e o rastreamento em tempo real funcionar√£o corretamente online.");
                } else {
                    navigator.serviceWorker.register('firebase-messaging-sw.js')
                    .then(reg => {
                        console.log('Service Worker: Registro iniciado.');
                        
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            console.log('Service Worker: Nova vers√£o encontrada.');
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('Service Worker: Nova vers√£o instalada, recarregando a p√°gina.');
                                    location.reload();
                                }
                            });
                        });

                        return navigator.serviceWorker.ready;
                    })
                    
                    .then(registration => {
    console.log('Service Worker: Ativo e pronto para ser usado ap√≥s o login.');
})

                    .catch(error => {
                        console.error('Service Worker: Falha no registro ou na ativa√ß√£o.', error);
                    });

                    let refreshing;
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (refreshing) return;
                        window.location.reload();
                        refreshing = true;
                    });
                }
            }
            
            document.body.classList.add('dark-mode');

            // L√≥gica del Banner de Instalaci√≥n PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBanner = document.getElementById('install-banner');
                if (installBanner) installBanner.style.display = 'block';
            });

            const installBtn = document.getElementById('install-btn');
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    const installBanner = document.getElementById('install-banner');
                    if (installBanner) installBanner.style.display = 'none';
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to the install prompt: ${outcome}`);
                        deferredPrompt = null;
                    }
                });
            }

            const closeInstallBtn = document.getElementById('close-install-banner');
if (closeInstallBtn) {
    closeInstallBtn.addEventListener('click', () => {
        const installBanner = document.getElementById('install-banner');
        if (installBanner) installBanner.style.display = 'none';
    });
}
            
            onSnapshot(doc(db, 'config', 'global'), (docSnap) => {
                if (docSnap.exists()) {
                    loadGlobalSettings(docSnap.data());
                } else {
                    loadGlobalSettings({});
                }
            });

            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    if (sessionStorage.getItem('isLoggedIn') === 'true') {
                        showMainApp();
                    } else {
                        document.getElementById('login-view').style.display = 'flex';
                        document.getElementById('login-form').addEventListener('submit', handleLogin);
                    }
                }, 500);
            }, 1500);
        }
        init();
    </script>
</body>
</html>


